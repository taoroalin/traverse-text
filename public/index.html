<script>
  let user = { user: "default user",theme: "light",graphName: "graphminer" }
  let database = null;
  let listeners = {};
  let oldestLoadedDailyNoteDate = null;
  let eitherDataOrCodeLoaded = false;

  let idb = null
  const dbReq = indexedDB.open("microroam",1)
  dbReq.onerror = (event) => {
    alert(`In order to save your notes between sessions, Micro Roam needs access to IndexedDB. 
    You can allow access by exiting "private browsing" mode, or by using a newer browser, or by changing browser settings`)
  }
  dbReq.onupgradeneeded = (event) => {
    const db = dbReq.result
    console.log(db)
    db.createObjectStore("graphs",{ keyPath: "graphName" })
    db.createObjectStore("user",{ keyPath: "user" })
    const userStore = dbReq.transaction.objectStore("user")
    const userReq = userStore.add(user)
  }
  dbReq.onsuccess = (event) => {
    idb = event.target.result
    const transaction = idb.transaction(["user"],"readonly")
    const userStore = transaction.objectStore("user")
    const userReq = userStore.get("default user")
    userReq.onsuccess = (event) => {
      user = event.target.result
      document.body.className = user.theme
      console.log(user)
      const transaction = idb.transaction(["graphs"],"readwrite")
      const graphsStore = transaction.objectStore("graphs")
      const graphReq = graphsStore.get(user.graphName)
      graphReq.onsuccess = (event) => {
        if (event.target.result) {
          database = JSON.parse(event.target.result.graph)
          if (eitherDataOrCodeLoaded) {
            gotoDailyNotes()
            setTimeout(() => saveWorker.postMessage(["db",database]),0)
          }
          eitherDataOrCodeLoaded = true;

        } else {
          console.log("no graph to load")
        }
      }
      graphReq.onerror = (event) => {
        console.log("graphReq error")
        console.log(event)
      }
    }
    userReq.onerror = (event) => {
      console.log("userReq error")
      console.log(error)
    }
  }

  const save = () => {
    console.log("posting save message")
    saveWorker.postMessage(["save",database])
  }

</script>
<link rel="stylesheet" href="index.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter">

<body class="light">

  <template id="page">
    <div class="page">
      <h1 class="page__title" contenteditable="true" tabindex="-1"></h1>

      <div class="page__body">

      </div>
      <div class="page__backlinks">

      </div>
    </div>
  </template>

  <template id="block">
    <div class="block">
      <svg class="block__bullet" width="20" height="20">
        <circle cx="10" cy="10.5" r="3" fill="var(--bullet)" />
      </svg>
      <div class="block__body" contenteditable="true" tabindex="-1">
      </div>
      <div class="block__children">

      </div>
    </div>
  </template>

  <template id="backrefs-list">
    <div class="backrefs-list">
      <div class="backrefs-list__title"><span class="bckrefs-list__count"></span>Linked References</div>
      <div class="backrefs-list__body"></div>
    </div>
  </template>

  <template id="page-break">
    <div class="page-break"></div>
  </template>

  <template id="block-focus-frame">
    <div class="block-focus-frame">
    </div>
  </template>

  <template id="page-ref">
    <span class="page-ref" spellcheck="false"><span class="page-ref__brackets"></span><span
        class="page-ref__body"></span><span class="page-ref__brackets"></span></span>
  </template>

  <template id="tag">
    <span class="tag"></span>
  </template>

  <template id="block-ref">
    <span class="block-ref"></span>
  </template>

  <template id="block-ref">
    <span class="block-ref"></span>
  </template>

  <template id="bold">
    <span class="bold"></span>
  </template>

  <template id="url">
    <a class="url" target="_blank" contenteditable="false"></a>
  </template>

  <div id="app">
    <div id="top-bar">
      <button id="switch-graph-button">
        Switch Graph
      </button>
      <input id="search-input" placeholder="search">
      <button id="upload-button">
        <input style="display:none" type="file" id="upload-input">
        Upload JSON
      </button>
      <a id="download-button">
        Download JSON
      </a>
    </div>
    <div id="page-frame-outer">
      <div id="page-frame">

      </div>
    </div>

  </div>
  <script src="utils.js"></script>
  <script src="parse.js"></script>
  <script src="datalog.js"></script>
  <script src="index.js"></script>
</body>