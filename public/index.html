<body>
  <script>
    const r = indexedDB.open("microroam",1);
    let user = { theme: "light",graphName: "default",logging: false,spellcheck: false,prettyUntilFocused: false }
    const storedUser = localStorage.getItem("user")
    if (storedUser) {
      user = JSON.parse(storedUser)
    }
    let w = false; // flag for whether either code or data loaded
    let store = null;
    let idb = null
    r.onsuccess = (e1) => {
      idb = e1.target.result
      idb.transaction(["stores"],"readonly").objectStore("stores").get(user.graphName).onsuccess = (e) => {
        console.log("target")
        console.log(e.target)
        if (e.target.result) {
          store = JSON.parse(e.target.result.store)
          if (w) {
            gotoDailyNotes()
            setTimeout(() => saveWorker.postMessage(["save",store]),0)
          } else
            w = true;
        } else {
          console.log("adding default graph")
          fetch("./default-store.json").then(text => text.json().then(json => {
            // store = { graphName: "default",ownerRoamId: "default",blocks: {},pages: {},pagesByTitle: {} }
            store = json
            user.graphName = json.graphName
            if (w) {
              gotoPageTitle("Welcome to Micro Roam")
              setTimeout(() => saveWorker.postMessage(["save",store]),0)
            } else
              w = true;
          }))
        }
      }
    }
    r.onupgradeneeded = (event) => {
      const db = r.result
      db.createObjectStore("stores",{ keyPath: "graphName" })
    }
    r.onerror = (event) => {
      alert(`In order to save your notes between sessions, Micro Roam needs access to IndexedDB. 
    You can allow access by exiting "private browsing" mode, or by using a newer browser, or by changing browser settings`)
    }
    const saveUser = () => {
      document.body.className = user.theme
      localStorage.setItem("user",JSON.stringify(user))
    }
    saveUser()


    let oldestLoadedDailyNoteDate = null
    let commitDebounce = null

    let editingLink = null
    let editingTitle = null
    let focusedBlock = null
    let cursorPositionInBlock = null
    let focusedNode = null
    let focusOffset = null
    // editingLink, focusedBlock, cursorPositionInBlock are all about where the cursor is. They are all set at the beginning of each event handler


    /* This is some nasty concurrency stuff. It's all about starting the critical path of loading (loading graph) as quickly as possible.
    What happens is:
    Script 1: IndexedDB Open request sent. This script is one line to reduce the script compile time before the request is sent.
    Script 2: Add onsuccess listener to request (if the request somehow succeeds before then, it fails). Then get user settings from localstorage, which tells you which graph to get out of indexeddb once the idb request succeeds (if request succeeds first, it loads default graph). Then set body class to user's color theme (which is why this script is in the html body) quickly so they don't see the screen flash the wrong color. Then add upgradeneeded, onerror listeners, then initialize global variables
    Onsuccess handler: sets store, then checks whether last script has finished loading, if it has, start rendering. That script also checks whether data loded, and triggers render if data is loaded
    */
  </script>

  <title>Micro Roam</title>
  <link rel="stylesheet" href="index.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter">


  <template id="page">
    <div class="page">
      <h1 class="page__title" contenteditable="true" tabindex="-1"></h1>

      <div class="page__body">

      </div>
      <div class="page__backlinks">

      </div>
    </div>
  </template>

  <template id="block">
    <div class="block">
      <svg class="block__bullet" width="20" height="20">
        <circle cx="10" cy="10.5" r="3" fill="var(--bullet)" />
      </svg>
      <div class="block__body" contenteditable="true" tabindex="-1">
      </div>
      <div class="block__children">

      </div>
    </div>
  </template>

  <template id="backrefs-list">
    <div class="backrefs-list">
      <div class="backrefs-list__title"><span class="bckrefs-list__count"></span>Linked References</div>
      <div class="backrefs-list__body"></div>
    </div>
  </template>

  <template id="page-break">
    <div class="page-break"></div>
  </template>

  <template id="block-focus-frame">
    <div class="block-focus-frame">
    </div>
  </template>

  <template id="page-ref">
    <span class="page-ref"><span class="page-ref__brackets"></span><span class="page-ref__body"></span><span
        class="page-ref__brackets"></span></span>
  </template>

  <template id="tag">
    <span class="tag"></span>
  </template>

  <template id="block-ref">
    <span class="block-ref"></span>
  </template>

  <template id="block-ref">
    <span class="block-ref"></span>
  </template>

  <template id="bold">
    <span class="bold"></span>
  </template>

  <template id="italic">
    <span class="italic"></span>
  </template>

  <template id="highlight">
    <span class="highlight"></span>
  </template>

  <!--using spans with event handlers as links because they play nice with contenteditable-->
  <template id="url">
    <span class="url"></span>
  </template>

  <template id="autocomplete__suggestion">
    <div class="autocomplete__suggestion"></div>
  </template>

  <div id="app">

    <div id="top-bar">
      <a id="report-issue-button" target="_blank" href="mailto:taoroalin@gmail.com?subject=You Made Micro Roam Wrong"
        tabindex="-1">
        Report Issue
      </a>
      <button id="daily-notes-button" tabindex="-1">
        Daily Notes
      </button>
      <input id="search-input" placeholder="search" tabindex="-1">
      <button id="upload-button" tabindex="-1">
        <input style="display:none" type="file" id="upload-input">
        Upload JSON
      </button>
      <a id="download-button" tabindex="-1">
        Download JSON
      </a>
    </div>

    <div id="page-frame-outer">
      <div id="page-frame">

      </div>
    </div>

    <div id="autocomplete-list" style="display:none"></div>

  </div>

  <script src="store.js"></script>
  <script src="main-worker-shared.js"></script>
  <script src="utils.js"></script>
  <script src="parse.js"></script>
  <script src="index.js"></script>
</body>