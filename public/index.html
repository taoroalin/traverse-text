<body>
  <div id="app">
    <div id="top-bar" style="margin-top:0px">
      <a id="report-issue-button" target="_blank" href="mailto:taoroalin@gmail.com?subject=You Made Micro Roam Wrong"
        tabindex="-1">
        Report Issue
      </a>
      <button id="help-button" tabindex="-1">
        Help
      </button>
      <button id="daily-notes-button" tabindex="-1">
        Daily Notes
      </button>
      <input id="search-input" placeholder="search" tabindex="-1">
      <button id="upload-button" tabindex="-1">
        <input style="display:none" type="file" id="upload-input">
        Upload JSON
      </button>
      <a id="download-button" tabindex="-1">
        Download JSON
      </a>
    </div>

    <div id="top-bar-hidden-hitbox" style="position:fixed;height:15px;width:100%"></div>

    <div id="terminal" contenteditable="true" style="display:none"></div>

    <div id="page-frame-outer">
      <div id="page-frame">

      </div>
    </div>
    <div id="autocomplete-list" style="display:none"></div>
    <!-- inline styles on this site are all edited directly by js -->
    <div id="search-result-list" style="display:none"></div>


  </div>
  <script>
    const r = indexedDB.open("microroam",4);// I had this as line 1, saves ~5ms start time, don't now cause I'm lazy
    // This needs to be the exact same db version as in worker.js
    const blankUser = { graphName: "default",theme: "light",topBar: "visible",logging: false,spellcheck: false }
    let user = blankUser
    const storedUser = localStorage.getItem("user")
    if (storedUser) user = JSON.parse(storedUser)
    let w = false; // flag for whether either code or data loaded
    let store = null;
    let idb = null
    r.onsuccess = (e1) => {
      idb = e1.target.result
      idb.transaction(["stores"],"readonly").objectStore("stores").get(user.graphName).onsuccess = (e) => {
        if (e.target.result) {
          store = JSON.parse(e.target.result.store)
          if (w) {
            gotoReplaceHistory("dailyNotes")
            setTimeout(() => saveWorker.postMessage(["save",store]),0)
          } else
            w = true;
        } else {
          console.log("adding default graph")
          fetch("./default-store.json").then(text => text.json().then(json => {
            store = json
            user.graphName = json.graphName
            if (w) {
              gotoReplaceHistory("pageTitle","Welcome to Micro Roam")
              setTimeout(() => saveWorker.postMessage(["save",store]),0)
            } else
              w = true;
          }))
        }
      }
    }
    r.onupgradeneeded = (event) => {
      const db = r.result
      const stores = Array.from(db.objectStoreNames)
      if (!stores.includes("stores"))
        db.createObjectStore("stores",{ keyPath: "graphName" })
    }
    r.onerror = (event) => {
      alert(`In order to save your notes between sessions, Micro Roam needs access to IndexedDB. 
      You can allow access by exiting "private browsing" mode, or by using a newer browser, or by changing browser settings`)
    }

    let commitDebounce = null

    let editingLink = null
    let editingTitle = null
    let focusNode = null
    let focusOffset = null

    let focusBlock = null

    let focusSuggestion = null
    let sessionState = { pageFrame: "dailyNotes",focusId: null,scroll: 0,position: null }

    const topBar = document.getElementById("top-bar")
    const topBarHiddenHitbox = document.getElementById("top-bar-hidden-hitbox")

    const showTopBar = () => {
      topBar.style.marginTop = "0px"
      topBarHiddenHitbox.style.display = "none"
    }
    const hideTopBar = () => {
      topBar.style.marginTop = "-46px"
      topBarHiddenHitbox.style.display = "block"
    }
    const saveUser = () => {
      document.body.className = user.theme
      if (user.topBar === "visible") showTopBar()
      else hideTopBar()
      localStorage.setItem("user",JSON.stringify(user))
    }
    saveUser()


    /* This inline script is all about opening a connection to IndexedDB and setting the user's theme ASAP. This allows IndexedDB to run in parallel with main script compilation, and avoids layout thrashing
    What happens is:
    1: IndexedDB Open request sent.
    2: Add onsuccess listener to request (if the request somehow succeeds before then, it fails). Then get user settings from localstorage, which tells you which graph to get out of indexeddb once the idb request succeeds (if request succeeds first, it loads default graph). Then set body class to user's color theme (which is why this script is in the html body) quickly so they don't see the screen flash the wrong color. Then add upgradeneeded, onerror listeners, then initialize global variables
    Onsuccess handler: sets store, then checks whether last script has finished loading, if it has, start rendering. That script also checks whether data loded, and triggers render if data is loaded
    */
  </script>

  <title>Micro Roam</title>

  <link rel="stylesheet" href="index.css">

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata">

  <template id="page">
    <div class="page">
      <h1 class="page__title" contenteditable="true" tabindex="-1"></h1>

      <div class="page__body">

      </div>
      <div class="page__backlinks">

      </div>
    </div>
  </template>

  <template id="block">
    <div class="block">
      <svg class="block__bullet" width="20" height="20">
        <circle cx="10" cy="10.5" r="3" fill="var(--bullet)" />
      </svg>
      <div class="block__body" contenteditable="true" tabindex="-1">
      </div>
      <div class="block__children">

      </div>
    </div>
  </template>

  <template id="backrefs-list">
    <div class="backrefs-list">
      <div class="backrefs-list__title">Linked References</div>
      <div class="backrefs-list__body"></div>
    </div>
  </template>

  <template id="page-break">
    <div class="page-break"></div>
  </template>

  <template id="block-focus-frame">
    <div class="block-focus-frame">
      <div class="block-focus-frame__breadcrumbs"></div>
      <div class="block-focus-frame__body"></div>
      <div class="block-focus-frame__backlinks"></div>
    </div>
  </template>

  <template id="page-ref">
    <span class="page-ref"><span class="page-ref__brackets"></span><span class="page-ref__body"></span><span
        class="page-ref__brackets"></span></span>
  </template>

  <template id="tag">
    <span class="tag"></span>
  </template>

  <template id="block-ref">
    <span class="block-ref"></span>
  </template>

  <template id="block-ref">
    <span class="block-ref"></span>
  </template>

  <template id="bold">
    <span class="bold"></span>
  </template>

  <template id="italic">
    <span class="italic"></span>
  </template>

  <template id="highlight">
    <span class="highlight"></span>
  </template>

  <template id="literal">
    <span class="literal"></span>
  </template>

  <!--using spans with event handlers as links because they play nice with contenteditable-->
  <template id="url">
    <span class="url"></span>
  </template>

  <template id="autocomplete__suggestion">
    <div class="autocomplete__suggestion"></div>
  </template>

  <template id="search-result">
    <div class="search-result"></div>
  </template>

  <template id="breadcrumb-block">
    <span class="breadcrumb-block"><span class="breadcrumb-block__arrow">-></span><span
        class="breadcrumb-block__body"></span></span>
  </template>

  <template id="breadcrumb-page">
    <span class="breadcrumb-page"></span>
  </template>

  <script src="utils.js"></script>
  <script src="save-between-versions.js"></script>
  <script src="main-worker-shared.js"></script>
  <script src="commands.js"></script>
  <script src="store.js"></script>

  <script src="dom-decarations.js"></script>
  <script src="render.js"></script>

  <script src="events.js"></script>
  <script src="index.js"></script>
  <script src="terminal.js"></script>
</body>