<script>
  const r = indexedDB.open("microroam",1);
  r.onsuccess = (e) => {
    idb = e.target.result
    idb.transaction(["graphs"],"readwrite").objectStore("graphs").get(user.graphName).onsuccess = (e) => {
      if (e.target.result) {
        database = JSON.parse(e.target.result.graph)
        if (w) {
          gotoDailyNotes()
          setTimeout(() => saveWorker.postMessage(["db",database]),0)
        }
        w = !0;
      }
    }
  }
  r.onerror = (event) => {
    alert(`In order to save your notes between sessions, Micro Roam needs access to IndexedDB. 
    You can allow access by exiting "private browsing" mode, or by using a newer browser, or by changing browser settings`)
  }
  r.onupgradeneeded = (event) => {
    const db = r.result
    console.log(db)
    db.createObjectStore("graphs",{ keyPath: "graphName" })
  }

  let w = !1; // either code or data loaded
  let user = { theme: "light",graphName: "graphminer" }
  let database = null;
  let graph = null;
  let listeners = {};
  let oldestLoadedDailyNoteDate = null;
  let idb = null
  let commitDebounce = null

  const localStorageUser = localStorage.getItem('user')
  if (localStorageUser) {
    user = JSON.parse(localStorageUser)
  } else {
    localStorage.setItem('user',JSON.stringify(user))
  }
</script>
<title>Micro Roam</title>
<link rel="stylesheet" href="index.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter">

<body class="light">

  <template id="page">
    <div class="page">
      <h1 class="page__title" contenteditable="true" tabindex="-1"></h1>

      <div class="page__body">

      </div>
      <div class="page__backlinks">

      </div>
    </div>
  </template>

  <template id="block">
    <div class="block">
      <svg class="block__bullet" width="20" height="20">
        <circle cx="10" cy="10.5" r="3" fill="var(--bullet)" />
      </svg>
      <span class="block__body" contenteditable="true" tabindex="-1">
      </span>
      <div class="block__children">

      </div>
    </div>
  </template>

  <template id="backrefs-list">
    <div class="backrefs-list">
      <div class="backrefs-list__title"><span class="bckrefs-list__count"></span>Linked References</div>
      <div class="backrefs-list__body"></div>
    </div>
  </template>

  <template id="page-break">
    <div class="page-break"></div>
  </template>

  <template id="block-focus-frame">
    <div class="block-focus-frame">
    </div>
  </template>

  <template id="page-ref">
    <span class="page-ref" spellcheck="false"><span class="page-ref__brackets"></span><span
        class="page-ref__body"></span><span class="page-ref__brackets"></span></span>
  </template>

  <template id="tag">
    <span class="tag"></span>
  </template>

  <template id="block-ref">
    <span class="block-ref"></span>
  </template>

  <template id="block-ref">
    <span class="block-ref"></span>
  </template>

  <template id="bold">
    <span class="bold"></span>
  </template>

  <template id="italic">
    <span class="italic"></span>
  </template>

  <template id="highlight">
    <span class="highlight"></span>
  </template>

  <template id="url">
    <a class="url" target="_blank" contenteditable="false"></a>
  </template>

  <template id="autocomplete__suggestion">
    <div class="autocomplete__suggestion"></div>
  </template>


  <div id="app">
    <div id="top-bar">
      <a id="report-issue-button" href="mailto:taoroalin@gmail.com">
        Report Issue
      </a>
      <button id="switch-graph-button">
        Switch Graph
      </button>
      <input id="search-input" placeholder="search">
      <button id="upload-button">
        <input style="display:none" type="file" id="upload-input">
        Upload JSON
      </button>
      <a id="download-button">
        Download JSON
      </a>
    </div>
    <div id="page-frame-outer">
      <div id="page-frame">

      </div>
    </div>

    <div id="autocomplete-list" style="display:none">
    </div>
  </div>
  <script src="utils.js"></script>
  <script src="parse.js"></script>
  <script src="datalog.js"></script>
  <script src="data-legit.js"></script>
  <script src="index.js"></script>
</body>