<script>let idb=null,store=null,otherStores={},r;const basicBitchServerUrl="http://localhost:3000";let user,userText=localStorage.getItem("user"),usingLocalStore=!0,startFn=()=>gotoNoHistory("dailyNotes"),dataLoaded=!1,scriptsLoaded=!1;const setDataLoaded=()=>{scriptsLoaded&&start(),dataLoaded=!0},start=()=>{saveUser(),startFn(),user.h&&user.s.commitId!==user.s.syncCommitId&&debouncedSaveStore()},invalidateLocal=()=>{indexedDB.deleteDatabase("microroam");console.error("Local replica invalid. Resetting from server"),user.s.commitId=void 0,user.s.syncCommitId=void 0,localStorage.setItem("user",JSON.stringify(user)),localStorage.removeItem("store"),window.location.href=window.location.href};if(userText){if(user=JSON.parse(userText),user.h){const c=new Headers;c.set("h",user.h),user.s.syncCommitId&&c.set("commitid",user.s.syncCommitId);let e=`${basicBitchServerUrl}/get/${user.s.graphName}`;fetch(e,{method:"POST",headers:c}).then(async s=>{304!==s.status?200===s.status?(console.log(`server on commit ${s.headers.get("commitid")} local on commit ${user.s.syncCommitId}`),usingLocalStore=!1,s.json().then(e=>{console.log("got blox");const o=startFn;startFn=()=>{store=hydrateFromBlox(user.s.graphName,e),user.s.syncCommitId=s.headers.get("commitid"),o()},setDataLoaded()})):console.log("STORE NOT ON SERVER"):console.log("already up to date")})}const b=localStorage.getItem("store");if(b){try{store=JSON.parse(b),setDataLoaded()}catch(e){invalidateLocal()}r=indexedDB.open("microroam",5),r.onsuccess=e=>idb=e.target.result}else r=indexedDB.open("microroam",5),r.onsuccess=e=>{if(console.log("normal success"),idb=e.target.result,!0===usingLocalStore)try{idb.transaction(["stores"],"readonly").objectStore("stores").get(user.graphName).onsuccess=e=>{if(!0===usingLocalStore)if(e.target.result)try{store=JSON.parse(e.target.result.store),setDataLoaded()}catch(e){invalidateLocal()}else console.log("adding default graph")}}catch(e){}}}else user={s:{graphName:"default",theme:window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",topBar:"visible",logging:!1,spellcheck:!1,editingSpotlight:!0}},fetch("./default-store.json").then(e=>{e.json().then(e=>{store=e,startFn=()=>gotoNoHistory("pageTitle","Welcome to Micro Roam"),setDataLoaded()})}),r=indexedDB.open("microroam",5),r.onsuccess=e=>idb=e.target.result;r.onupgradeneeded=o=>{console.log("upgradeneeded");const s=r.result,e=Array.from(s.objectStoreNames);e.includes("stores")?(console.log(o),console.log(s),r.onsuccess=()=>{console.log("new success"),idb=o.target.result;const e=s.transaction(["stores"],"readonly").objectStore("stores");e.get(user.s.graphName).onsuccess=e=>{store=e.target.result.store;e=oldStoreToRoamJSON[s.version](store);roamJsonToStore(user.s.graphName,e),saveStore(),setDataLoaded()}}):s.createObjectStore("stores",{keyPath:"graphName"})},r.onerror=e=>{console.log("error"),console.log(e),alert('In order to save your notes between sessions, Micro Roam needs access to IndexedDB. \nYou can allow access by exiting "private browsing" mode, or by using a newer browser, or by changing browser settings')};</script><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400&display=swap" rel="stylesheet"><style>*{outline:0;scrollbar-width:none}.dark{--background:#000000;--click:rgb(100, 100, 100);--text:#dbdbdb;--link:#3f84c0;--brackets:#a7b6c2;--block-ref:rgb(63, 63, 63);--bullet:#8f9091;--border:#afbeca;--bar:#565d63;--break:#838e97;--highlight:#685000;--page-ref:#3ac263;--shadow:rgb(98, 98, 98);--notification:#183d23;--query-background:#051809;--editing-background:#141414;--selected:#2d4a66}.light{--background:white;--click:rgb(197, 197, 197);--text:black;--link:rgb(54, 123, 184);--brackets:#a7b6c2;--block-ref:lightgrey;--bullet:#394b59;--border:#585e64;--bar:#7c858d;--shadow:#585e64;--break:#a8b4be;--highlight:rgb(255, 247, 128);--page-ref:#1cce37;--notification:#a4d1b1;--query-background:#b0dfbd;--editing-background:#e6e6e6;--selected:#abcdeb}a,button,input{font-family:Inter}input{border:none;background-color:var(--background);color:var(--text)}button{appearance:none;border:none;box-shadow:none;cursor:pointer;background-color:inherit;color:inherit;font-size:inherit}span{margin:0;padding:0}::-webkit-scrollbar{width:0%;height:0%}::selection{background-color:#85b7e8;color:var(--text)}body{scrollbar-width:0;font-family:Inter;font-weight:400;margin:0;color:var(--text);background-color:var(--background)}a{color:var(--link)}a:visited{color:var(--link)}#app{height:100%;width:100%;display:flex;flex-direction:column}#page-frame-outer{width:100%;overflow-y:scroll}#page-frame{margin:0 auto 30px;max-width:min(900px,100%)}#top-bar{width:100%;display:flex;flex-direction:row;align-content:space-between;background-color:var(--background)}#top-bar button{font-size:.9em;color:var(--bullet);padding:10px 10px 8px}.top-bar-transition{transition:margin-top .1s}#top-bar-left,#top-bar-right{display:flex;flex-direction:row}#top-connect,#top-hamburger{padding:7px 6px 2px 4px;cursor:pointer}#options-frame{position:fixed;top:36px;right:5px;display:flex;flex-direction:column}#options-frame button{border-radius:10px;padding:6px;display:block}#create-new-store{border-radius:10px;padding:6px;font-size:1.1em}#search-input{background-color:var(--background);color:var(--text);padding:3px 13px;margin:5px 3px 4px;display:block;font-size:1.1em;box-shadow:0 0 2px var(--bullet);border-radius:100px;flex-grow:1}#search-input::placeholder{color:var(--bullet)}#autocomplete-list,#command-list,#options-frame,#template-list{position:absolute;display:flex;flex-direction:column;background-color:var(--background);font-size:1.3em;border-radius:10px;box-shadow:0 0 6px 0 var(--shadow)}.autocomplete__suggestion[data-selected=true],.command__suggestion[data-selected=true],.template__suggestion[data-selected=true]{background-color:var(--click)}.autocomplete__suggestion,.command__suggestion,.template__suggestion{padding:10px;cursor:pointer;border-radius:5px}#search-result-list{position:absolute;display:flex;flex-direction:column;background-color:var(--background);font-size:1.3em;border-radius:5px;box-shadow:0 0 8px var(--shadow)}.search-result[data-selected=true]{background-color:var(--click)}.search-result{padding:7px;cursor:pointer;border-radius:5px}.page{margin-right:30px;margin-left:30px;position:relative}.page__title{font-size:38px;margin:35px 0 20px 0;font-weight:300}.backref-frame__body,.page__body{margin-left:20px}.backref-list__body{margin-left:10px}.backref-list__title{font-size:1.3em;padding:20px 0 0}.page-break{height:0;margin:50px 25px;border:1px solid var(--break);border-width:1px 0 0 0}.block{position:relative;border-radius:5px}.block[data-selected=true]{background-color:var(--selected)}.block__body{padding:5px 2px;white-space:pre-wrap}[data-editingspotlight=true] .block__body[data-editmode=true]{background-color:var(--editing-background);border-radius:4px}.block__bullet{cursor:pointer;position:absolute;left:-21px;top:4px}.block__children{margin-left:22px;position:relative}.block__children::before{display:block;position:absolute;content:"\200B";top:0;height:100%;width:6px;transform:translateX(-34px);border-left:1px solid var(--bar)}.block-focus-frame{margin:60px 0}.breadcrumb-page{cursor:pointer}.breadcrumb-block{cursor:pointer}.backref-frame__breadcrumb{margin:15px 0 5px 0;font-size:1.2em}.block-focus-frame__breadcrumb{margin:15px 0 5px 0;font-size:1.2em}.page-ref{position:relative}.page-ref__brackets{font-weight:lighter;color:var(--brackets)}.page-ref__graphname{font-weight:lighter;color:var(--page-ref)}.page-ref__body{color:var(--page-ref);font-weight:600}.page-ref:hover{cursor:pointer}.page-ref:hover>.page-ref__body{text-decoration:underline}.tag__body{color:var(--page-ref);position:relative;font-weight:600}.tag__graph-name{color:var(--page-ref);position:relative;font-weight:300}.tag:hover{text-decoration:underline;cursor:pointer}.block-ref{background-color:var(--block-ref)}.block-ref:hover{text-decoration:underline;cursor:pointer}.bold{font-weight:700}.italic{font-style:italic}.highlight{background-color:var(--highlight);border-radius:2px;padding:1px}.block-focus-frame{margin:35px 0 0 60px}.url{color:var(--link);text-decoration:underline;cursor:pointer}.literal{font-family:Inconsolata;font-size:1.15em}.code-block{font-family:Inconsolata;font-size:1.15em}.attribute{font-weight:700}.attribute:hover{cursor:pointer}.image-embed{max-width:100%}.todo-checkbox{transform:translateY(1px);height:14px;width:14px;margin:0 2px}.compute-failed{background-color:var(--query-background);border-radius:4px;padding:5px 2px;margin-left:-2px}#terminal{font-family:Inconsolata;width:100%;padding:8px;background-color:#000;color:#fff}.query-frame{background-color:var(--query-background);border-radius:8px;padding:1px 12px 18px;margin:3px 0}.notification{text-align:center;min-width:300px;position:fixed;left:50%;transform:translateX(-50%);top:-40px;margin-top:0;opacity:1;transition:top .25s ease-out,opacity .2s linear;padding:20px;background-color:var(--notification);border-radius:8px}#login,#signup{position:fixed;top:0;left:0;right:0;bottom:0;background-color:var(--background);text-align:center}#login-form,#signup-form{position:fixed;top:28%;left:50%;transform:translateX(-50%);padding:13px 20px 20px;border-radius:12px;display:flex;flex-direction:column;justify-content:space-between}#login input,#signup input{background-color:var(--background);color:var(--text);font-size:1.4em;border-radius:3px;display:block;padding:4px;margin-bottom:13px}#login button,#signup button{position:fixed;bottom:19%;left:50%;transform:translateX(-50%);display:block;padding:4px;border-radius:3px;background-color:var(--background);color:var(--placeholder)}#login button:focus,#signup button:focus{font-weight:700}#login p,#signup p{left:50%;font-size:1.7em;color:var(--placeholder);padding:4px;margin-bottom:20px;margin-top:65px}#login .exit-to-main,#signup .exit-to-main{bottom:9%}.really-want-to{padding:80px;position:fixed;top:30%;right:50%;transform:translateX(50%);background-color:var(--background);box-shadow:0 0 2px var(--shadow);border-radius:8px;text-align:center;flex-direction:column}.really-want-to button{margin-top:30px;display:block}</style><div id="html"><p style="font-family:Inter">please enable JavaScript</div><script>const elById=e=>document.getElementById(e),getTemp=e=>elById(e).content.firstElementChild,allHtml=`<div id="app">
  <div id="top-bar" style="margin-top:-43px">
    <div id="top-bar-left">
      
    </div>
    <input id="search-input" placeholder="search" tabindex="-1">
    <div id="top-bar-right">
      
    </div>
    
    <svg id="top-connect" width="25" height="25">
      <line x1="12.5" y1="20" x2="21" y2="9" stroke="var(--bullet)" />
      <line x1="12.5" y1="20" x2="4" y2="9" stroke="var(--bullet)" />
      <line x1="12.5" y1="20" x2="12.5" y2="5" stroke="var(--bullet)" />
      
      <circle cx="4" cy="9" r="3.5" stroke="var(--bullet)" />
      <circle cx="12.5" cy="5" r="3.5" stroke="var(--bullet)" />
      <circle cx="21" cy="9" r="3.5" stroke="var(--bullet)" />
      
      <circle cx="12.5" cy="20" r="4.5" stroke="var(--bullet)" />
      <circle cx="12.5" cy="20" r="2.5" fill="var(--bullet)" />
    </svg>
    
    <svg id="top-hamburger" width="25" height="25">
      <circle cx="12.5" cy="5" r="2.5" fill="var(--bullet)" />
      <circle cx="12.5" cy="13" r="2.5" fill="var(--bullet)" />
      <circle cx="12.5" cy="21" r="2.5" fill="var(--bullet)" />
    </svg>
    
  </div>

  <div id="top-bar-hidden-hitbox" style="position:fixed;height:20px;width:100%;display:none;"></div>


  <div id="terminal" contenteditable="true" style="display:none"></div>

  <div id="page-frame-outer">
    <div id="page-frame">

    </div>
  </div>
  
  <div id="options-frame" style="display:none">
  </div>

  <!-- inline styles on this site are all edited directly by js -->
  <div id="autocomplete-list" style="display:none"></div>
  <div id="command-list" style="display:none"></div>
  <div id="search-result-list" style="display:none"></div>
  <div id="template-list" style="display:none"></div>

  <div id="login" style="display:none">
    <p>Login</p>
    <form id="login-form">
      <input type="email" id="login-email" placeholder="email">
      <input type="password" id="login-password" placeholder="password">
      <input type="submit" style="height:0px" tabindex="-1">
    </form>
    <button id="switch-to-signup">Sign up</button>
    <button class="exit-to-main">Back</button>
  </div>

  <div id="signup" style="display:none">
    <p>Sign up</p>
    <form id="signup-form">
      <input type="email" id="signup-email" placeholder="email">
      <input type="text" id="signup-username" placeholder="username">
      <input type="password" id="signup-password" placeholder="password">
      <input type="submit" style="height:0px" tabindex="-1">
    </form>
    <button id="switch-to-login">Login</button>
    <button class="exit-to-main">Back</button>
  </div>

  <div id="really-want-to-leave" class="really-want-to" style="display:none">
    Your data will be lost if you sign out now
    <button>Continue</button>
  </div>
</div>

<title>Micro Roam</title>


<template id="page">
  <div class="page">
    <h1 class="page__title" contenteditable="true" tabindex="-1"></h1>

    <div class="page__body">

    </div>
    <div class="page__backlinks">

    </div>
  </div>
</template>

<template id="block">
  <div class="block">
    <svg class="block__bullet" width="20" height="20">
      <circle cx="10" cy="10.5" r="3" fill="var(--bullet)" />
    </svg>
    <div class="block__body" contenteditable="true" tabindex="-1"></div>
    <div class="block__children">

    </div>
  </div>
</template>

<template id="backref-list">
  <div class="backref-list">
    <div class="backref-list__title">Linked References</div>
    <div class="backref-list__body"></div>
  </div>
</template>

<template id="query-frame">
  <div class="query-frame"></div>
</template>

<template id="block-focus-frame">
  <div class="block-focus-frame">
    <div class="block-focus-frame__breadcrumb"></div>
    <div class="block-focus-frame__body"></div>
    <div class="block-focus-frame__backlinks"></div>
  </div>
</template>

<template id="backref-frame">
  <div class="backref-frame">
    <div class="backref-frame__breadcrumb"></div>
    <div class="backref-frame__body"></div>
  </div>
</template>

<template id="page-ref">
  <span class="page-ref"><span class="page-ref__brackets"></span><span class="page-ref__graphname"></span><span class="page-ref__body"></span><span
      class="page-ref__brackets"></span></span>
</template>

<template id="tag">
  <span class="tag"><span class="tag__graph-name"></span><span class="tag__body"></span></span>
</template>

<template id="image-embed">
  <img class="image-embed">
</template>

<template id="compute-failed">
  <span class="compute-failed"><span class="compute-failed__brackets"></span><span
      class="compute-failed__body"></span><span class="compute-failed__brackets"></span></span>
</template>

<template id="todo-checkbox">
  <input type="checkbox" class="todo-checkbox">
</template>

<template id="video-embed">
  <iframe class="video-embed" width="560" height="315" title="YouTube video player" frameborder="0"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
    allowfullscreen></iframe>
</template>

<template id="breadcrumb-page">
  <span class="breadcrumb-page"></span>
</template>

<template id="notification">
  <div class="notification"></div>
</template>

<template id="breadcrumb-block">
  <span class="breadcrumb-block"><span class="breadcrumb-block__arrow">-></span><span
      class="breadcrumb-block__body"></span></span>
</template>

<template id="autocomplete__suggestion">
  <div class="autocomplete__suggestion"></div>
</template>

<template id="command__suggestion">
  <div class="command__suggestion"></div>
</template>

<template id="template__suggestion">
  <div class="template__suggestion"></div>
</template>

<template id="search-result">
  <div class="search-result"></div>
</template>`,allFrame=elById("html");allFrame.innerHTML=allHtml;const topBarRight=elById("top-bar-right"),topBarLeft=elById("top-bar-left"),optionsFrame=elById("options-frame"),topButtons={};let topButtonNames=["Help","Daily Notes","Report Issue","Sign Up","Sign Out","Login","Upload","Download"];for(let e of topButtonNames)topButtons[e]=document.createElement("button"),topButtons[e].innerText=e,topButtons[e].tabindex=-1;topButtons["Create New Graph"]=document.createElement("input"),topButtons["Create New Graph"].placeholder="Create New Graph",topButtons["Create New Graph"].id="create-new-store",topButtons["Create New Graph"].type="text",topButtons["Create New Graph"].size=15;const disconnectedFileInput=document.createElement("input");disconnectedFileInput.type="file",topButtonNames=Object.keys(topButtons);let toShowOnTopBar=["help","Daily Notes","Report Issue","Sign Up"];const layoutTopBar=()=>{var e,t=Math.round(toShowOnTopBar.length/2);for(let e=0;e<t;e++)topBarLeft.appendChild(topButtons[topButtonNames[e]]);for(let e=t;e<toShowOnTopBar.length;e++)topBarRight.appendChild(topButtons[topButtonNames[e]]);for(e of topButtonNames)toShowOnTopBar.includes(e)||optionsFrame.appendChild(topButtons[e])};layoutTopBar();let sessionState={pageFrame:"dailyNotes",focusId:null,scroll:0,position:null},focusNode=null,focusOffset=null,focusBlock=null,focusBlockBody=null,editingTemplateExpander=null,editingCommandElement=null,editingLink=null,editingTitle=null,focusSuggestion=null,dragSelectStartBlock=null,dragSelect=null,clipboardData=null;const SEARCH_RESULT_LENGTH=12;document.body.className=user.s.theme;const topBar=document.getElementById("top-bar"),topBarHiddenHitbox=document.getElementById("top-bar-hidden-hitbox");"visible"===user.s.topBar&&(topBar.style.marginTop="0px",topBarHiddenHitbox.style.display="none"),setTimeout(()=>topBar.className="top-bar-transition",200);const pageFrame=elById("page-frame"),pageFrameOuter=elById("page-frame-outer"),searchInput=elById("search-input"),terminalElement=elById("terminal"),searchResultList=elById("search-result-list");searchResultList.dataset.templateName="search-result";const autocompleteList=elById("autocomplete-list");autocompleteList.dataset.templateName="autocomplete__suggestion";const inlineCommandList=elById("command-list");inlineCommandList.dataset.templateName="command__suggestion";const templateList=elById("template-list");templateList.dataset.templateName="template__suggestion";const switchToLogin=elById("switch-to-login"),switchToSignup=elById("switch-to-signup"),signupElement=elById("signup"),loginElement=elById("login"),reallyWantToLeaveElement=elById("really-want-to-leave"),appElement=elById("app"),topHamburgerElement=elById("top-hamburger"),connectFrame=elById("connect-frame"),loginForm=elById("login-form"),loginEmailElement=elById("login-email"),loginPasswordElement=elById("login-password"),signupForm=elById("signup-form"),signupUsernameElement=elById("signup-username"),signupEmailElement=elById("signup-email"),signupPasswordElement=elById("signup-password"),pageTemplate=getTemp("page"),blockTemplate=getTemp("block"),backrefListTemplate=getTemp("backref-list"),blockFocusFrameTemplate=getTemp("block-focus-frame"),searchResultTemplate=getTemp("search-result"),breadcrumbBlockTemplate=getTemp("breadcrumb-block"),breadcrumbPageTemplate=getTemp("breadcrumb-page"),backrefFrameTemplate=getTemp("backref-frame"),notificationTemplate=getTemp("notification"),tagTemplate=getTemp("tag"),pageRefTemplate=getTemp("page-ref"),imageEmbedTemplate=getTemp("image-embed"),computeFailedTemplate=getTemp("compute-failed"),todoCheckboxTemplate=getTemp("todo-checkbox"),videoEmbedTemplate=getTemp("video-embed"),queryFrameTemplate=getTemp("query-frame"),textEncoder=new TextEncoder;

const CHARS_64="-_0123456789abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ",CHARS_16="0123456789abcdef";let newUid;{let r=new Uint8Array(9);newUid=()=>{let t;do{crypto.getRandomValues(r),t="";for(let e=0;e<9;e++)t+=CHARS_64[r[e]%64]}while(void 0!==store.blox[t]);return t}}let newUUID;{let r=new Uint8Array(21);newUUID=()=>{crypto.getRandomValues(r);let t="";for(let e=0;e<21;e++)t+=CHARS_64[r[e]%64];return t}}const applyDif=(e,t)=>{let r=e.length;void 0!==t.s&&(r=t.s);var s=r-(void 0!==t.d&&t.d.length||0);return e.substring(0,s)+(t.i||"")+e.substring(r)},unapplyDif=(e,t)=>{var r=void 0!==t.d&&t.d.length||0,s=void 0!==t.i&&t.i.length||0;if(void 0!==t.s){var o=t.s-r,a=o+s;return e.substring(0,o)+(t.d||"")+e.substring(a)}s=e.length-r-s;return e.substring(0,s)+(t.d||"")},undoEditBlox=(e,t)=>{const[r,s,o,a,i,n]=e;switch(r){case"cr":var c=t[s].p;c&&(t[c].k=t[c].k.filter(e=>e!==s)),delete t[s];break;case"dl":var l=(t[s]=o).p,c=a;l&&(t[l].k||(t[l].k=[]),void 0!==c?t[l].k.splice(c,0,s):t[l].k.push(s));break;case"mv":var l=i,d=n;const p=t[s];t[o].k=t[o].k.filter(e=>e!=s),t[p.p=l].k||(t[l].k=[]),t[l].k.splice(d,0,s);break;case"df":d=o;const m=t[s];m.et=commit.time,m.s=unapplyDif(m.s,d)}},doEditBlox=(e,t,r)=>{const[s,o,a,i,n]=e;switch(s){case"dl":var c=t[o].p;c&&(t[c].k=t[c].k.filter(e=>e!==o)),delete t[o];break;case"cr":t[o]={ct:r,s:""};var c=a,l=i;void 0!==c&&(t[o].p=c,void 0===t[c].k&&(t[c].k=[]),void 0===l?t[c].k.push(o):t[c].k.splice(l,0,o));break;case"mv":var l=a,d=i;const p=t[o];t[n].k=t[n].k.filter(e=>e!=o),t[p.p=l].k||(t[l].k=[]),t[l].k.splice(d,0,o);break;case"df":d=a;const m=t[o];m.et=r,m.s=applyDif(m.s,d)}};let getProcessMemory;try{performance.memory.heapUsed,getProcessMemory=()=>performance.memory&&performance.memory.heapUsed}catch(e){process.memoryUsage().heapUsed,getProcessMemory=()=>process.memoryUsage().heapUsed}class LruCache{constructor(e,t=15e8){this.maxProcessMemory=t,this.fetcher=e,this.map=new Map}async get(e){var t=this.map.get(e);if(void 0!==t)return this.map.delete(e),this.map.set(e,t),t;t=await this.fetcher(e);if(t&&this.map.set(e,t),getProcessMemory()>this.maxProcessMemory)for(const r of this.map){this.map.delete(r[0]);break}return t}}const promisify=s=>(...r)=>new Promise((e,t)=>s(...r,e)),intToBase64=t=>{if(void 0!==t){let e="";for(;0<t;)e=""+CHARS_64[t%64]+e,t=Math.floor(t/64);return e}},base64ToInt=t=>{let r=0;for(let e=0;e<t.length;e++)r+=CHARS_64.indexOf(t[e])*Math.pow(64,t.length-e-1);return r};

const cpy=t=>{if("object"!=typeof t)return t;if(t instanceof Array)return t.map(cpy);{const a={};for(var e in t)a[e]=cpy(t[e]);return a}},monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"],getOrdinal=t=>{var e=t%10,a=t%100;return 1==e&&11!=a?t+"st":2==e&&12!=a?t+"nd":3==e&&13!=a?t+"rd":t+"th"},formatDate=t=>`${monthNames[t.getMonth()]} ${getOrdinal(t.getDate())}, ${t.getFullYear()}`,formatTime=t=>t.getHours()+":"+t.getMinutes(),unFormatDate=t=>{t=t.match(/([a-zA-Z]+) ([0-9]{1,2})(?:st|nd|rd|th), ([0-9]{4})/);if(t&&monthNames.includes(t[1]))return new Date},formatDateYMD=t=>`${t.getFullYear()}-${formatInt(t.getMonth()+1,2)}-${formatInt(t.getDate(),2)}`,truncateElipsis=(t,e=40)=>t.length>e?t.substring(0,e-3)+"...":t,getTomorrowDateString=()=>formatDate(new Date(Date.now()+864e5)),getYesterdayDateString=()=>formatDate(new Date(Date.now()-864e5)),getLastWeekDateString=()=>{const t=new Date(Date.now());return t.setDate(t.getDate()-7),formatDate(t)},getNextWeekDateString=()=>{const t=new Date(Date.now());return t.setDate(t.getDate()+7),formatDate(t)},formatInt=(t,e)=>{t=t.toString();return"0".repeat(e-t.length)+t},clamp=(t,e,a)=>Math.max(e,Math.min(t,a)),ustime=()=>{var t=Math.floor(1e3*(performance.timing.navigationStart+performance.now()));return console.log(t),t},pushToArrInObj=(t,e,a)=>{void 0===t[e]?t[e]=[a]:t[e].push(a)};

const canWriteBloc=e=>!0,isSynced=()=>user.s.commitId===user.s.syncCommitId,diff=(e,o)=>({d:o,i:e});let undoCommitList=[],undoCommitSessionStateList=[],undoCommitInProgress=[],masterCommitList=[],masterCommitInProgress=[];const undoEditCacheStuff=e=>{var[o,t,s]=e;switch(console.log(e),o){case"cr":void 0===s&&delete store.titles[s.s];break;case"df":setLinks(store,t);var r,i=store.blox[t];void 0===i.p&&(r=applyDif(i.s,s),delete store.titles[r],store.titles[i.s]=t)}},undo=()=>{var o=undoCommitList.pop();sessionState=undoCommitSessionStateList.pop();for(let e=o.edits.length-1;0<=e;e--){var t=o.edits[e];undoEditBlox(t,store.blox),undoEditCacheStuff(t)}},doEditCacheStuff=(e,o=!1)=>{const[t,s,r]=e;switch(t){case"dl":r.p||delete store.titles[r.s];var i=store.forwardRefs[s];if(i)for(var d of i){const n=store.refs[d];1===n.length?delete store.refs[d]:store.refs[d]=n.filter(e=>e!=s)}store.refs[s];break;case"df":setLinks(store,s,o);var a=store.blox[s];if(void 0===a.p){i=unapplyDif(a.s,r);if(delete store.titles[i],void 0!==store.titles[a.s])return void console.error(`duplicate block title ${a.s}`);store.titles[a.s]=s}}},doEdit=(...e)=>{var o=intToBase64(Date.now());undoCommitInProgress.push(e),masterCommitInProgress.push(e),print(e),doEditBlox(e,store.blox,o),doEditCacheStuff(e)},commit=()=>{var e=newUUID();undoCommitList.push({id:e,t:intToBase64(Date.now()),edits:undoCommitInProgress}),undoCommitSessionStateList.push(cpy(sessionState)),user.s.commitId=e,undoCommitInProgress=[],setTimeout(()=>{debouncedSaveStore(),saveUserJustLocalStorage()},0)},commitEdit=(...e)=>{doEdit(...e),commit()},saveStore=(e=!1)=>{var o,t=store.blox,t=JSON.stringify(t);let s="{";for(o in store)"blox"!==o&&void 0!==store[o]&&(s+='"'+o+'":'+JSON.stringify(store[o])+",");s+='"blox":'+t+"}",saveStoreToBasicBitchServer(t,e),saveStoreStringLocal(s)},saveStoreIncremental=()=>{syncEditsWithBasicBitchServer(),saveStoreStringLocal(JSON.stringify(store))},saveStoreStringLocal=e=>{try{localStorage.setItem("store",e)}catch(e){localStorage.removeItem("store"),console.error(`Local Storage Failure: ${e}`)}const o=idb.transaction(["stores"],"readwrite"),t=o.objectStore("stores"),s=t.put({graphName:store.graphName,store:e});s.onsuccess=()=>{console.log("saved")},s.onerror=e=>{console.log("save error"),console.log(e)}};let saveStoreTimeout=null;const debouncedSaveStore=()=>{user.s.commitId!==user.s.syncCommitId&&(clearTimeout(saveStoreTimeout),saveStoreTimeout=setTimeout(saveStoreIncremental,300))},print=e=>{user.s.logging&&console.log(e)},mergeEdits=o=>{for(let e=0;e<o.length;e++)o[e]},macros={};macros.nocommit={copyBlock:(e,o,t)=>{const d=(e,o,t)=>{var s=newUid(),r=store.blox[e];if(doEdit("cr",s,o,t),doEdit("df",s,diff(r.s,"")),r.k)for(let e=0;e<r.k.length;e++){var i=r.k[e];d(i,s,e)}return s};return d(e,o,t)},delete:e=>{var o=store.blox[e];let t=void 0;o.p&&(t=store.blox[o.p].k.indexOf(e)),doEdit("dl",e,cpy(o),t)},write:(e,o)=>{doEdit("df",e,diff(o,store.blox[e].s))},writePageTitle:(e,o)=>{var t,s=store.blox[e].s;doEdit("df",e,diff(o,s));for(t of store.refs[e]||[]){const d=store.blox[t];var r=d.s,i=d.s.replaceAll(s,o);console.log(r),console.log(i),doEdit("df",t,diff(i,r))}},createPage:e=>{if(!store.titles[e]){console.log(`making page ${e}`);var o=newUid();return doEdit("cr",o),doEdit("df",o,diff(e,"")),o}console.error(`tried to create page that already exists ${e}`)},create:(e,o)=>{var t=newUid();return doEdit("cr",t,e,o),t},move:(e,o,t)=>{var s=store.blox[e];void 0===t&&(t=store.blox[o].k.length),doEdit("mv",e,o,t,s.p,store.blox[s.p].k.indexOf(e))}};for(let o in macros.nocommit)macros[o]=(...e)=>{e=macros.nocommit[o](...e);return commit(),e};

const blankStore=()=>({blox:{},titles:{},refs:{},forwardRefs:{},innerRefs:{},outerRefs:{},roamProps:{},ownerRoamId:void 0,graphName:void 0}),bloxProps=["s","p","ct","k","et","cu","eu"],gcPage=(e,r)=>{isPageEmpty(e,r)&&macros.nocommit.delete(r)},isPageEmpty=(e,r)=>{var t=e.blox[r];if(void 0!==e.refs[r]&&0<e.refs[r].length)return!1;if(t.k){if(1<t.k.length)return!1;if(0===t.k.length)return!0;t=t.k[0];return isBlockEmpty(e,t)}return!0},isBlockEmpty=(e,r)=>{r=e.blox[r];return""===r.s&&(void 0===r.k||0===r.k.length)},fixParents=()=>{for(var e in store.blox)delete store.blox[e].p;for(var r in store.blox){var t;for(t of store.blox[r].k||[])store.blox[t].p=r}},fixDuplicatePages=()=>{var e,r,t={};for(e in store.blox)store.blox[e].p||pushToArrInObj(t,store.blox[e].s,e);for(r in t){var o=t[r];for(let e=1;e<o.length;e++){for(var s of store.blox[o[e]].k||[])macros.move(s,o[0]);macros.delete(o[e])}}},parseRegexJustLinks=/(\[\[)|(\]\])|#([\/a-zA-Z0-9_-]+)|\(\(([a-zA-Z0-9\-_]+)\)\)|(^[\/a-zA-Z0-9_-]+)::|`([^`]+)`|```/g,setLinks=(t,r,e=!1,o=!1)=>{for(var s of t.forwardRefs[r]||[])t.refs[s]=t.refs[s].filter(e=>e!==r),o||gcPage(t,s);const a=[];t.forwardRefs[r]=a;let l;l=e?e=>{e in t.refs?t.refs[e].push(r):t.refs[e]=[r],a.push(e)}:e=>{e in t.refs?t.refs[e].push(r):t.refs[e]=[r],a.push(e)};var n,f=e=>{let r=t.titles[e];void 0===r&&(r=macros.nocommit.createPage(e)),l(r)};const i=t.blox[r].s;let c=0,h=void 0,x=[];for(n of i.matchAll(parseRegexJustLinks)){if(0===x.length||"cb"===h.t)n[1]?(x.push({t:"pr",s:""}),h=x[x.length-1]):n[3]?f(n[3]):n[5]?f(n[5]):n[4]?void 0!==t.blox[n[4]]&&l(n[4]):n[7]&&(h&&"cb"===h.t?x.pop():(x.push({t:"cb",s:""}),h=x[x.length-1]));else if(h.s=h.s+i.substring(c,n.index),c=n.index,n[1]){var p={t:"pr",s:""};h.s=h.s+"[[",x.push(p),h=x[x.length-1]}else if(n[2]){let e="]]";"pr"===h.t&&(e=h.s+"]]",f([h.s]),x.pop(),h=x[x.length-1]),void 0!==h&&(h.s=h.s+e)}else n[3]?(f(n[3]),h.s=h.s+n[0]):n[5]?(h.s=h.s+n[0],f(n[5])):n[4]?(void 0!==t.blox[n[4]]&&l(n[4]),h.s=h.s+n[0]):n[7]?h&&"cb"===h.t?x.pop():(x.push({t:"cb",s:""}),h=x[x.length-1]):h.s=h.s+n[0];c=n.index+n[0].length}0===a.length&&delete t.forwardRefs[r]},generateRefs=e=>{var r,t=performance.now();for(r in e.refs={},e.forwardRefs={},e.blox)setLinks(e,r);console.log(`gen refs took ${performance.now()-t}`)},mergeLists=(e,r)=>{for(var t of r)e.includes(t)||e.push(t)},arrSetDiff=(e,r)=>{let t=[],o=[];for(var s of e)r.includes(s)||t.push(s);for(var a of r)e.includes(a)||o.push(a);return{added:t,deleted:o}},propagateRefs=(r,e,t)=>{const{added:o}=arrSetDiff(e,t);r=store.blox[r];if(r.p){let e=r.p;for(;e;){var s=store.blox[e];const n=store.forwardRefs[e];for(let e=0;e<o.length;e++){var a=o[e];n.includes(a)?(o[e]=o.pop(),--e):n.push(a)}e=s.p}}let l=r;do{l=store.blox[l.p];for(let e=0;e<o.length;e++);}while(l.p)},generateInnerRefs=()=>{performance.now();for(var r in store.innerRefs={},store.forwardRefs){var t=store.forwardRefs[r];let e=r;for(;e;)store.innerRefs[e]||(store.innerRefs[e]=[]),mergeLists(store.innerRefs[e],t),e=store.blox[e].p}},generateOuterRefs=()=>{performance.now();for(var e in store.outerRefs={},store.forwardRefs){const t=store.forwardRefs[e],o=e=>{store.outerRefs[e]||(store.outerRefs[e]=[]),mergeLists(store.outerRefs[e],t);for(var r of store.blox[e].k||[])o(r)};o(e)}},generateInnerOuterRefs=()=>{generateInnerRefs(),generateOuterRefs()},mergeStore=l=>{const n={};for(var e in l.blox){var r=l.blox[e];store.titles[r.s]?store.blox[e]&&(n[e]=newUid()):n[e]=store.titles[r.s]}const f=(e,r)=>{var t=n[e]||e,e=l.blox[e];const o={...e};if(store.blox[t]=o,o.p=r,e.k){o.k=[];for(var s of e.k){var a=n[s]||s;f(s,t),o.k.push(a)}}};for(var t in l.titles){var o=l.titles[t],t=l.blox[o];if(void 0===store.titles[t.s]){var s=n(o)||o;const p={...t};if(store.blox[s]=p,store.titles[t.s]=s,t.k){p.k=[];for(var a of kids){var i=getNewId(a);f(a,s),p.k.push(i)}}}else if(t.k){var c,h=store.titles[t.s];const g=store.blox[h];g.k||(g.k=[]);for(c of t.k){var x=n[c]||c;f(c,h),g.k.push(x)}}}},escapeRegex=e=>e.replaceAll(/([\[\]\(\)])/g,"\\$1").replaceAll("\\\\",""),newSearchRegex=e=>new RegExp(escapeRegex(e),"i"),searchRefCountWeight=.05,pageOverBlockWeight=1;let titleExactFullTextSearchCache=[];const titleExactFullTextSearch=e=>{var r,t=newSearchRegex(e);for(r in titleExactFullTextSearchCache=[],store.titles){var o=store.titles[r],s=(store.blox[o],r.match(t));s&&titleExactFullTextSearchCache.push({title:r,id:o,idx:s.index-(store.refs[o]?store.refs[o].length:0)*searchRefCountWeight})}return titleExactFullTextSearchCache.sort((e,r)=>e.idx-r.idx),titleExactFullTextSearchCache};let exactFullTextSearchCache=[];const exactFullTextSearch=e=>{var r,t=newSearchRegex(e);for(r in exactFullTextSearchCache=[],store.blox){var o=store.blox[r];const e=o.s;var s=e.match(t);if(s){const a={id:r,idx:s.index-(store.refs[r]?store.refs[r].length:0)*searchRefCountWeight-(void 0===o.p)*pageOverBlockWeight};o.p?a.string=o.s:a.title=o.s,exactFullTextSearchCache.push(a)}}return exactFullTextSearchCache.sort((e,r)=>e.idx-r.idx),exactFullTextSearchCache};let templateSearchCache=[];const searchTemplates=e=>{var r=store.titles["roam/templates"],t=store.blox[r];templateSearchCache=[];let o;try{o=newSearchRegex(e)}catch{return templateSearchCache}if(t){var s=e=>{const r=store.blox[e];console.log(r.s);var t=r.s.match(o);console.log(t),t&&templateSearchCache.push({id:e,string:r.s,idx:t.idx})};if(store.refs[r])for(var a of store.refs[r])s(a);if(store.blox[r].k)for(var l of store.blox[r].k)s(l);console.log(templateSearchCache),templateSearchCache=templateSearchCache.sort((e,r)=>r.idx-e.idx),console.log(templateSearchCache)}return templateSearchCache},generateTitles=e=>{for(var r in e.titles={},e.blox){var t=e.blox[r];void 0===t.p&&(e.titles[t.s]=r)}},hydrateFromBlox=(e,r)=>{console.log("hydratefromblox");let t=blankStore();return t.blox=r,t.graphName=e,generateTitles(t),generateRefs(t),t},sortByLastEdited=e=>{e.sort((e,r)=>store.blox[e].et>store.blox[r].et?-1:1)},createAndSwitchToNewStore=async e=>{store=blankStore(),store.graphName=e,user.s.graphName=e,user.s.commitId="MYVERYFIRSTCOMMITEVER",saveUser(),await addGraph(),saveStore(),window.location.href=window.location.href};

const prepFocusIdForCursor=()=>{if(focusBlock&&focusBlock.isConnected&&focusBlock.dataset.id!==sessionState.focusId&&(focusBlockBody.textContent="",renderBlockBody(focusBlockBody,store.blox[focusBlock.dataset.id].s)),focusBlock=document.querySelector(`.block[data-id="${sessionState.focusId}"]`),focusBlockBody=focusBlock.children[1],void 0===focusBlock)throw new Error(`tried to focus block that doesn't exist: ${sessionState.focusId}`);sessionState.isFocused=!0;var o=store.blox[sessionState.focusId].s;focusBlockBody.innerText="",renderBlockBody(focusBlockBody,o,!0)},focusIdPosition=()=>{prepFocusIdForCursor();const s=o=>{for(var e of o.childNodes)if("#text"===e.nodeName){if(sessionState.position>=(e.startIdx||0)&&sessionState.position<=(e.startIdx||0)+e.textContent.length){scanResult=e;var t=sessionState.position-e.startIdx;return getSelection().collapse(e,t),e}}else{e=s(e);if(e)return e}};s(focusBlockBody),updateCursorSpanInfo()},selectIdWholeNode=o=>{prepFocusIdForCursor(),updateCursorSpanInfo()},setFocusedBlockString=(o,e)=>{let t=o;void 0===t&&(t=store.blox[sessionState.focusId].s),void 0!==e?commitEdit("df",sessionState.focusId,e):macros.write(sessionState.focusId,t),focusIdPosition()},getEditingSimpleSpan=o=>{var e;for(e of focusBlockBody.querySelectorAll("."+o))if(e.childNodes[0].endIdx>=sessionState.position&&e.childNodes[0].startIdx<sessionState.position)return e},updateCursorPosition=()=>{focusNode=getSelection().focusNode,focusOffset=getSelection().focusOffset;var o=focusNode.parentNode.closest(".block");sessionState.focusId=o.dataset.id,sessionState.position=(focusNode.startIdx||0)+focusOffset},updateCursorSpanInfo=()=>{var o,e;editingLink=void 0;for(o of focusBlockBody.querySelectorAll(".tag"))o.children[1].firstChild.endIdx>=sessionState.position&&o.children[0].firstChild.startIdx<sessionState.position&&(editingLink=o);for(e of focusBlockBody.querySelectorAll(".page-ref"))e.children[2].firstChild.endIdx>=sessionState.position&&e.children[1].firstChild.startIdx<sessionState.position&&(editingLink=e);editingTitle=editingLink&&editingLink.title,editingTemplateExpander=getEditingSimpleSpan("template-expander"),editingUrlElement=getEditingSimpleSpan("url"),editingCommandElement=getEditingSimpleSpan("command"),void 0===editingCommandElement&&(inlineCommandList.style.display="none"),void 0===editingTemplateExpander&&(templateList.style.display="none"),void 0===editingLink&&(autocompleteList.style.display="none")},focusBlockEnd=o=>{sessionState.focusId=o.dataset.id,sessionState.position=store.blox[sessionState.focusId].s.length,focusIdPosition()},focusBlockStart=o=>{sessionState.focusId=o.dataset.id,sessionState.position=0,focusIdPosition()},focusBlockVerticalOffset=(o,e=focusBlock,t=!1)=>{const s=Array.from(document.querySelectorAll(".block")),i=s[s.indexOf(e)+o];i&&(i.scrollIntoView({block:"nearest",inline:"nearest"}),(t?focusBlockStart:focusBlockEnd)(i))},getChildren=o=>("block"===o.className?o.children[2]:o.children[1]).children,getClosestPageLink=o=>o.closest(".tag")||o.closest(".attribute")||o.closest(".page-ref"),getPageTitleOfNode=o=>{o=getClosestPageLink(o);return o&&o.title};

undefined

const reset=()=>{localStorage.clear();indexedDB.deleteDatabase("microroam");window.location.href=window.location.href},syncEditsWithBasicBitchServer=async()=>{if(0!==masterCommitInProgress.length){const a=new Headers;a.set("h",user.h);var e=newUUID(),s={id:e,t:intToBase64(Date.now()),edits:masterCommitInProgress};masterCommitInProgress=[],a.set("body",JSON.stringify(s)),a.set("synccommitid",user.s.syncCommitId);var t=await fetch(`${basicBitchServerUrl}/edit/${store.graphName}`,{headers:a});200===t.status?(user.s.syncCommitId=e,masterCommitList.push(s)):409===t.status?(console.log("conflicting edit"),invalidateLocal()):masterCommitInProgress=[...s.edits,...masterCommitInProgress]}},saveStoreToBasicBitchServer=async(e,s=!1)=>{var t=performance.now();const a=new Headers;a.set("h",user.h);var r=user.s.commitId;a.set("commitid",r),a.set("synccommitid",user.s.syncCommitId),s&&a.set("force","true");e=await fetch(`${basicBitchServerUrl}/put/${store.graphName}`,{method:"POST",body:e,headers:a});200===e.status||304===e.status?(user.s.syncCommitId=r,console.log(`save confirmed in ${performance.now()-t}`)):console.warn("failed to save to server")},getBloxFromBasicBitchServer=async e=>{var s=performance.now();const t=await fetch(`${basicBitchServerUrl}/get/${e}`,{headers:{passwordHash:user.h}});if(200===reponse.status){e=await t.json();return console.log(`got in ${performance.now()-s}`),e}console.warn("failed to get store")},addOtherStore=async e=>{var s=await getBloxFromBasicBitchServer(e),s=hydrateFromBlox(s);otherStores[e]=s},saveSettingsToBasicBitchServer=async()=>{const e=new Headers;e.set("h",user.h),e.set("body",JSON.stringify(user.s)),200!==(await fetch(`${basicBitchServerUrl}/settings`,{headers:e})).status&&console.log("failed to save settings")},middlePepper="76pCgT0lW6ES9yjt01MeH",beginPepper="CeoPPOv9rIq6O7YiYlSFX",endPepper="Rzw1dagomQGpoo2s7iGE3lYL2yruaJDGrUk6bFCvz",hashPassword=async(e,s)=>{var s=`${beginPepper}${e}${middlePepper}${s}${endPepper}`,s=textEncoder.encode(s),s=await crypto.subtle.digest("SHA-512",s),t=new Uint8Array(s);let a="";for(let e=0;e<t.length;e++)a+=String.fromCharCode(t[e]);return a=btoa(a),a=a.replaceAll("/","-").replaceAll("+","_").replaceAll("=",""),a};loginForm.addEventListener("submit",async e=>{e.preventDefault();var s=loginEmailElement.value;loginEmailElement.value="";e=loginPasswordElement.value;loginPasswordElement.value="";s=await hashPassword(e,s);const t=await fetch(`${basicBitchServerUrl}/auth`,{method:"POST",headers:{h:s}});200===t.status?(user=await t.json(),saveUser(),invalidateLocal(),console.log(user)):notifyText("Don't know that username + password.")}),signupForm.addEventListener("submit",async e=>{e.preventDefault();var s=signupEmailElement.value;signupEmailElement.value="";var t=signupUsernameElement.value;signupUsernameElement.value="";e=signupPasswordElement.value;signupPasswordElement.value="";e=await hashPassword(e,s),s=JSON.stringify({h:e,u:t,e:s,s:user.s});console.log(s);const a=new Headers;a.set("body",s);const r=await fetch(`${basicBitchServerUrl}/signup`,{method:"POST",headers:a});200===r.status?(console.log(r),user=await r.json(),saveUser(),invalidateLocal(),console.log("signed up")):(s=await r.json(),notifyText(s))});const addGraph=async()=>{const e=new Headers;e.set("h",user.h),e.set("commitid",user.s.commitId);var s=user.s.commitId;(await fetch(`${basicBitchServerUrl}/creategraph/${store.graphName}`,{headers:e,method:"POST",body:JSON.stringify(store.blox)})).ok?user.s.syncCommitId=s:notifyText("failed to add graph")};

const initialDailyNotes=5,renderSessionState=()=>{switch(searchResultList.style.display="none",pageFrameOuter.removeEventListener("scroll",dailyNotesInfiniteScrollListener),pageFrame.innerHTML="",searchInput.value="",sessionState.pageFrame){case"pageTitle":let e=store.titles[sessionState.page];void 0===e&&(e=macros.createPage(sessionState.page)),renderPage(pageFrame,e);break;case"block":const i=blockFocusFrameTemplate.cloneNode(!0);pageFrame.appendChild(i),renderBreadcrumb(i.children[0],sessionState.block),renderBlock(i.children[1],sessionState.block);const n=store.refs[sessionState.block];if(n){n.sort((e,t)=>store.blox[t].et-store.blox[e].et);var o,a=backrefListTemplate.cloneNode(!0);i.children[2].appendChild(a);for(o of n)renderBlock(a.children[1],o)}break;case"dailyNotes":pageFrameOuter.addEventListener("scroll",dailyNotesInfiniteScrollListener),sessionState.oldestDate=new Date(Date.now());let t=0;console.log(store.titles);let s=formatDate(sessionState.oldestDate);generateTitles(store),store.titles[s]||(console.log(`creating page ${s}`),macros.createPage(s));for(let e=0;e<1e3;e++){var r=store.titles[s];if(r){renderPage(pageFrame,r);const l=document.createElement("div");if(l.className="page-break",pageFrame.appendChild(l),t+=1,t>=initialDailyNotes)break}sessionState.oldestDate.setDate(sessionState.oldestDate.getDate()-1),s=formatDate(sessionState.oldestDate)}t<initialDailyNotes&&pageFrame.lastChild.remove()}var e;sessionState.isFocused&&pageFrame.querySelector(`.block[data-id="${sessionState.focusId}"]`)?console.log(`SESSION STATE ALREADY FOCUSED ON ${sessionState.focusId}`):(e=pageFrame.querySelector(".block"),sessionState.position=0,sessionState.focusId=e.dataset.id),focusIdPosition(),pageFrameOuter.scrollTop=sessionState.scroll||0},gotoNoHistory=(e,...t)=>{switch(e){case"dailyNotes":sessionState.pageFrame="dailyNotes";break;case"pageTitle":sessionState.pageFrame="pageTitle",sessionState.page=t[0];break;case"block":sessionState.pageFrame="block",sessionState.block=t[0]}renderSessionState()},goto=(...e)=>{sessionState.scroll=pageFrameOuter.scrollTop;const t=JSON.parse(JSON.stringify(sessionState));sessionState.isFocused=!1,sessionState.scroll=0,gotoNoHistory(...e),setTimeout(()=>{history.replaceState(t,"Micro Roam"),history.pushState(sessionState,"Micro Roam")},0)},gotoReplaceHistory=(...e)=>{gotoNoHistory(...e),history.replaceState(sessionState,"Micro Roam")};window.addEventListener("popstate",e=>{console.log(e.state),e.state&&(sessionState=e.state,renderSessionState())});const dailyNotesInfiniteScrollListener=()=>{if(pageFrame.getBoundingClientRect().bottom-innerHeight<700)for(let e=0;e<100;e++){sessionState.oldestDate.setDate(sessionState.oldestDate.getDate()-1);var t=store.titles[formatDate(sessionState.oldestDate)];if(t){renderPage(pageFrame,t);const s=document.createElement("div");s.className="page-break",pageFrame.appendChild(s);break}}},parseStackTrace=e=>{const t=[];var s;for(s of e.matchAll(/([^ ]+) \(([^\)]+):([0-9]+):([0-9]+)\)(?:\n|$)/g))t.push({function:s[1],file:s[2],line:s[3],column:s[4]});return t},logError=(e,t,s,o,a)=>{e={line:s,file:t,stack:parseStackTrace(a.stack),message:e,column:o},o=localStorage.getItem("error_log");if(o){const r=JSON.parse(o);r.push(e),localStorage.setItem("error_log",JSON.stringify(r))}else localStorage.setItem("error_log",JSON.stringify([e]));return!1};window.onerror=logError;const showTopBar=()=>{topBar.style.marginTop="0px",topBarHiddenHitbox.style.display="none"},hideTopBar=()=>{topBar.style.marginTop="-36px",topBarHiddenHitbox.style.display="block"},saveUser=()=>{document.body.className=user.s.theme,("visible"===user.s.topBar?showTopBar:hideTopBar)(),document.body.spellcheck=user.s.spellcheck,document.body.dataset.editingspotlight=user.s.editingSpotlight,user.h?(topButtons["Sign Out"].style.display="block",topButtons["Sign Up"].style.display="none",topButtons.Login.style.display="none"):(topButtons["Sign Out"].style.display="none",topButtons["Sign Up"].style.display="block",topButtons.Login.style.display="block"),saveUserJustLocalStorage(),saveSettingsToBasicBitchServer()},saveUserJustLocalStorage=()=>{localStorage.setItem("user",JSON.stringify(user))};dataLoaded&&start(),scriptsLoaded=!0;const ptest=()=>{var e=performance.now();for(let e=0;e<100;e++)generateInnerOuterRefs();e=performance.now()-e;console.log(`thing took ${e}`)};</script><script async>const downloadHandler=()=>{console.log("download");var e=storeToRoamJSON(store),e=new Blob([e],{type:"text/json"}),e=URL.createObjectURL(e);const t=document.createElement("a");t.setAttribute("href",e),t.setAttribute("download",`${store.graphName}-${formatDateYMD(new Date(Date.now()))}.json`),t.click()},downloadMd=()=>{console.log("download md");var e=storeToMdZip(),e=URL.createObjectURL(e);const t=document.createElement("a");t.setAttribute("href",e),t.setAttribute("download",`${store.graphName}-md-${formatDateYMD(new Date(Date.now()))}.zip`),t.click()},expandTemplate=()=>{var e=focusSuggestion.dataset.id,t=store.blox[sessionState.focusId];if(void 0===t.k||0===t.k.length){var o=store.blox[sessionState.focusId].p,s=store.blox[e].k,n=store.blox[o].k.indexOf(sessionState.focusId);macros.nocommit.delete(sessionState.focusId,!1);var a=focusBlock.parentNode;focusBlock.remove();for(let e=0;e<s.length;e++){var l=s[e],i=n+e,l=macros.nocommit.copyBlock(l,o,i),i=renderBlock(a,l,i);0===e&&focusBlockEnd(i)}commit()}else notifyText("can't use a template inside a block that has children");templateList.style.display="none"},pasteBlocks=()=>{var o=store.blox[sessionState.focusId].p;let s=store.blox[o].k.indexOf(sessionState.focusId);var n=focusBlock.parentNode;if(""===focusBlockBody.innerText?(macros.nocommit.delete(sessionState.focusId),focusBlock.remove()):s+=1,clipboardData.dragSelect.rooted){var e=macros.nocommit.copyBlock(clipboardData.dragSelect.root,o,s),e=renderBlock(n,e,s);focusBlockEnd(e)}else{let t=null;for(let e=0;e<clipboardData.dragSelect.endIdx+1-clipboardData.dragSelect.startIdx;e++){var a=store.blox[clipboardData.dragSelect.root].k[e+clipboardData.dragSelect.startIdx],a=macros.nocommit.copyBlock(a,o,e+s),a=renderBlock(n,a,e+s);t=a}focusBlockEnd(t)}commit()},autocomplete=()=>{const e=store.blox[sessionState.focusId].s;var t,o;"tag"===editingLink.className?(editingLink.childNodes[0],focusSuggestion.dataset.title.match(/^[a-zA-Z0-9\-_]+$/)?(t=e.slice(0,editingLink.startIdx)+"#"+focusSuggestion.dataset.title+e.slice(editingLink.endIdx),sessionState.position=editingLink.startIdx+focusSuggestion.dataset.title.length+1,setFocusedBlockString(t)):(o=e.slice(0,editingLink.startIdx)+"[["+focusSuggestion.dataset.title+"]]"+e.slice(editingLink.endIdx),console.log(o),sessionState.position=editingLink.startIdx+focusSuggestion.dataset.title.length+4,setFocusedBlockString(o))):(o=e.slice(0,editingLink.startIdx)+"[["+focusSuggestion.dataset.title+"]]"+e.slice(editingLink.endIdx),console.log(o),sessionState.position=editingLink.startIdx+focusSuggestion.dataset.title.length+4,setFocusedBlockString(o)),autocompleteList.style.display="none"},indentFocusedBlock=()=>{var e,t,o=sessionState.focusId;const s=focusBlock.previousElementSibling;s&&s.dataset&&s.dataset.id&&(e=s.dataset.id,console.log(e),t=store.blox[e].k&&store.blox[e].k.length||0,macros.move(o,e,t),s.children[2].appendChild(focusBlock),getSelection().collapse(focusNode,focusOffset))},dedentFocusedBlock=()=>{var e=sessionState.focusId,t=store.blox[e].p,o=store.blox[t];if(o){o=o.p,t=store.blox[o].k.indexOf(t);macros.move(e,o,t+1);t=focusBlock.parentNode.parentNode;const s=t.parentNode;t=t.nextElementSibling;t?s.insertBefore(focusBlock,t):s.appendChild(focusBlock),getSelection().collapse(focusNode,focusOffset)}};document.addEventListener("input",s=>{var e,n;if(sessionState.isFocused)if(updateCursorPosition()," "!==focusBlockBody.innerText&&""!==focusBlockBody.innerText){let t=focusBlockBody.innerText,o=null!==s.data&&1===s.data.length&&"insertText"===s.inputType;if(null!==s.data)if("["===s.data){var a,l=s.target.querySelectorAll(".page-ref-close-missing-open");let e=!1;for(a of l)if(console.log(a),a.childNodes[0].startIdx>sessionState.position){e=!0;break}e||(t=t.substring(0,sessionState.position)+"]"+t.substring(sessionState.position),o=!1)}else"]"===s.data&&"]"===t[sessionState.position]&&(t=t.substring(0,sessionState.position-1)+t.substring(sessionState.position),o=!1);let e={d:store.blox[sessionState.focusId].s,i:t};o&&(e=sessionState.position===t.length?{i:s.data}:{i:s.data,s:sessionState.position-1}),setFocusedBlockString(t,e),editingCommandElement&&(l=matchInlineCommand(editingCommandElement.innerText.substring(1)),renderResultSet(editingCommandElement,l,inlineCommandList,0)),editingTitle&&(n=titleExactFullTextSearch(editingTitle),renderResultSet(editingLink,n,autocompleteList,0)),editingTemplateExpander&&(n=editingTemplateExpander.innerText.substring(2),n=searchTemplates(n),renderResultSet(editingTemplateExpander,n,templateList,0))}else macros.write(sessionState.focusId,"");else"search-input"===s.target.id?(e=exactFullTextSearch(s.target.value),renderResultSet(searchInput,e,searchResultList,0)):"page__title"===s.target.className&&(console.log("edit title"),e=s.target.parentNode.dataset.id,macros.writePageTitle(e,s.target.innerText))});const globalHotkeys={"hide top bar":{key:"b",control:!0,fn:()=>{"0px"===topBar.style.marginTop?user.s.topBar="hidden":user.s.topBar="visible",saveUser()}},escape:{key:"Escape",fn:()=>{autocompleteList.style.display="none",templateList.style.display="none"}},upload:{key:"d",control:!0,fn:()=>{topButtons.Upload.click()}},download:{key:"s",control:!0,shift:!0,fn:downloadHandler},save:{key:"s",control:!0,fn:debouncedSaveStore},"toggle color theme":{key:"m",control:!0,fn:()=>{"light"===document.body.className?user.s.theme="dark":user.s.theme="light",saveUser()}},search:{key:"u",control:!0,fn:()=>{"0px"!==topBar.style.marginTop&&(topBar.style.marginTop="0px"),searchInput.focus()}},open:{key:"o",control:!0,fn:e=>{editingTitle?goto("pageTitle",editingTitle):editingUrlElement&&editingUrlElement.click()}},"daily notes":{key:"d",alt:!0,fn:()=>{goto("dailyNotes")}},undo:{key:"z",control:!0,fn:()=>{0<undoCommitList.length&&(undo(),renderSessionState())}},"delete block":{key:"k",control:!0,shift:!0,fn:()=>{var e=store.blox[sessionState.focusId];if(void 0===e.k||0===e.k.length){const t=focusBlock;e=sessionState.focusId;focusBlockVerticalOffset(-1),t.remove(),macros.delete(e)}else notifyText('no "delete block" for blocks with children (at least right now)')}},terminal:{key:"i",control:!0,alt:!0,fn:()=>{"none"===terminalElement.style.display?(terminalElement.style.display="block",terminalElement.focus()):terminalElement.style.display="none"}},p:{key:"p",control:!0,fn:()=>{console.log("at least it wasn't print")}}};document.addEventListener("keydown",event=>{for(var hotkeyName in globalHotkeys){const hotkey=globalHotkeys[hotkeyName];if(event.key.toLowerCase()===hotkey.key&&event.shiftKey===!!hotkey.shift&&event.ctrlKey===!!hotkey.control&&event.altKey===!!hotkey.alt)return hotkey.fn(event),void event.preventDefault()}if(dragSelect){let did=!1;if(("c"===event.key||"x"===event.key)&&event.ctrlKey){let text="";console.log("copy blocks");const id=dragSelect.root.dataset.id;if(dragSelect.rooted)text=blocToMd(id);else{const kids=store.blox[id].k;for(let i=dragSelect.startIdx;i<dragSelect.endIdx+1;i++)text+=blocToMd(kids[i])}clipboardData={dragSelect:{root:id,startIdx:dragSelect.startIdx,endIdx:dragSelect.endIdx,rooted:dragSelect.rooted},text:text},console.log(clipboardData),navigator.clipboard.writeText(text),did=!0}if("Backspace"===event.key||"Delete"===event.key||"x"===event.key&&event.ctrlKey){if(console.log(dragSelect),dragSelect.rooted)focusBlockVerticalOffset(-1,dragSelect.root),macros.nocommit.delete(dragSelect.root.dataset.id),document.querySelectorAll(`.block[data-id="${dragSelect.root.dataset.id}"]`).forEach(e=>e.remove());else{const childNodes=getChildren(dragSelect.root);focusBlockVerticalOffset(-1,childNodes[dragSelect.startIdx]),console.log(`cnl ${childNodes.length} start ${dragSelect.startIdx} end ${dragSelect.endIdx}`);for(let i=dragSelect.endIdx;i>=dragSelect.startIdx;i--){const node=childNodes[i];macros.nocommit.delete(node.dataset.id),document.querySelectorAll(`.block[data-id="${node.dataset.id}"]`).forEach(e=>e.remove())}commit()}dragSelect=null,did=!0}did&&event.preventDefault()}else if("none"!==autocompleteList.style.display)"Enter"===event.key&&(autocomplete(),event.preventDefault()),updownythingey(editingLink,autocompleteList,titleExactFullTextSearchCache,focusSuggestion)&&event.preventDefault();else if("none"!==templateList.style.display)"Tab"!==event.key&&"Enter"!==event.key||(expandTemplate(),event.preventDefault()),updownythingey(editingTemplateExpander,templateList,templateSearchCache,focusSuggestion)&&event.preventDefault();else if("none"!==inlineCommandList.style.display)"Tab"!==event.key&&"Enter"!==event.key||(execInlineCommand(),event.preventDefault()),updownythingey(editingCommandElement,inlineCommandList,commandSearchCache,focusSuggestion)&&event.preventDefault();else if(sessionState.isFocused){let blocks,newActiveBlock;switch(event.key){case"Enter":if(!event.shiftKey){let idx=store.blox[store.blox[sessionState.focusId].p].k.indexOf(sessionState.focusId);event.ctrlKey||(idx+=1),console.log(idx);const newBlockUid=newUid();commitEdit("cr",newBlockUid,store.blox[sessionState.focusId].p,idx);const newBlockElement=renderBlock(focusBlock.parentNode,newBlockUid,idx);newBlockElement.children[1].focus(),event.preventDefault()}break;case"Tab":(event.shiftKey?dedentFocusedBlock:indentFocusedBlock)(),event.preventDefault();break;case"Backspace":if(0===sessionState.position){const parent=store.blox[store.blox[sessionState.focusId].p];if(void 0!==parent.p||1!==parent.k.length){const currentFocusBlock=focusBlock;focusBlockVerticalOffset(-1),macros.delete(currentFocusBlock.dataset.id),currentFocusBlock.remove(),event.preventDefault()}}break;case"ArrowDown":if(event.altKey&&event.shiftKey){const parentId=store.blox[sessionState.focusId].p,parentElement=focusBlock.parentNode,currentIdx=store.blox[parentId].k.indexOf(sessionState.focusId);focusBlock.nextElementSibling&&(macros.move(sessionState.focusId,parentId,currentIdx+1),focusBlock.nextElementSibling.nextElementSibling?parentElement.insertBefore(focusBlock,focusBlock.nextElementSibling.nextElementSibling):parentElement.appendChild(focusBlock),getSelection().collapse(focusNode,focusOffset),event.preventDefault())}else event.shiftKey||event.altKey||(focusBlockVerticalOffset(1),event.preventDefault());break;case"ArrowUp":if(event.altKey&&event.shiftKey){const parentId=store.blox[sessionState.focusId].p,parentElement=focusBlock.parentNode,currentIdx=store.blox[parentId].k.indexOf(sessionState.focusId);focusBlock.previousElementSibling&&(macros.move(sessionState.focusId,parentId,currentIdx-1),parentElement.insertBefore(focusBlock,focusBlock.previousElementSibling),getSelection().collapse(focusNode,focusOffset),event.preventDefault())}else event.shiftKey||event.altKey||(focusBlockVerticalOffset(-1),event.preventDefault());break;case"ArrowLeft":event.shiftKey&&event.altKey?dedentFocusedBlock():0===sessionState.position?(focusBlockVerticalOffset(-1),event.preventDefault()):--sessionState.position;break;case"ArrowRight":event.shiftKey&&event.altKey?indentFocusedBlock():sessionState.position===focusBlockBody.innerText.length?(focusBlockVerticalOffset(1,focusBlock,!0),event.preventDefault()):sessionState.position+=1;break;case"c":event.ctrlKey&&(clipboardData=null)}}if(document.activeElement&&"search-input"===document.activeElement.id){if("Enter"===event.key)return!event.ctrlKey&&focusSuggestion?focusSuggestion.dataset.title?goto("pageTitle",focusSuggestion.dataset.title):goto("block",focusSuggestion.dataset.id):goto("pageTitle",event.target.value),void event.preventDefault();const didUpDowny=updownythingey(searchInput,searchResultList,exactFullTextSearchCache,focusSuggestion);didUpDowny&&event.preventDefault()}if("none"!==terminalElement.style.display&&"Enter"===event.key&&!event.ctrlKey&&!event.shiftKey&&!event.altKey){const string=event.target.innerText,first=string.match(/^[a-z]+/);if(first&&terminalCommands[first[0]]){const fn=terminalCommands[first[0]];fn(string.substring(first[0].length)),event.preventDefault(),terminalElement.style.display="none",terminalElement.innerHTML=""}else try{eval(string),event.ctrlKey||(terminalElement.style.display="none",terminalElement.innerHTML="")}catch(error){console.log(error),event.preventDefault()}}print(sessionState)}),document.addEventListener("paste",e=>{if(console.log(e),clipboardData){const t=e.clipboardData.getData("text");t.replaceAll(/\r/g,"")==clipboardData.text?(pasteBlocks(),e.preventDefault()):clipboardData=void 0}});const updownythingey=(e,t,o,s)=>{var n="ArrowUp"===event.key||"Tab"===event.key&&event.shiftKey?-1:("ArrowDown"===event.key||"Tab"===event.key)&&1;if(n){const a=-1===n?s.previousElementSibling:s.nextElementSibling;return a?(a.dataset.selected="true",focusSuggestion=a,delete s.dataset.selected):(s=parseInt(t.dataset.resultStartIdx),s=clamp(s+n*SEARCH_RESULT_LENGTH,0,o.length-SEARCH_RESULT_LENGTH),renderResultSet(e,o,t,s),-1===n&&(delete t.firstElementChild.dataset.selected,t.lastElementChild.dataset.selected=!0)),!0}};document.addEventListener("mousedown",t=>{var o=getClosestPageLink(t.target);if(o)goto("pageTitle",o.title,o.graphName);else{var s=t.target.closest(".block__bullet");if("search-result"!==t.target.className){"search-input"!==t.target.id&&(searchResultList.style.display="none");var n=t.target.closest(".breadcrumb-page"),o=t.target.closest(".breadcrumb-block");if(s)goto("block",s.parentNode.dataset.id);else if("block-ref"===t.target.className)goto("block",t.target.dataset.id);else if("url"===t.target.className){const e=document.createElement("a");e.target="_blank",e.href=t.target.innerText,e.click()}else if(t.target===topButtons.Download)downloadHandler();else if("template__suggestion"===t.target.className)focusSuggestion&&(focusSuggestion.dataset.selected=!1),t.target.dataset.selected=!0,focusSuggestion=t.target,expandTemplate();else if(t.target===topButtons.Upload)disconnectedFileInput.click();else if(t.target===topButtons["Daily Notes"])goto("dailyNotes");else if("autocomplete__suggestion"===t.target.className)focusSuggestion&&(focusSuggestion.dataset.selected=!1),t.target.dataset.selected=!0,autocomplete();else if(t.target===topButtons.Help)goto("pageTitle","Welcome to Micro Roam");else if(n)goto("pageTitle",n.dataset.title);else if(o)goto("block",o.dataset.id);else if("exit-to-main"==t.target.className)signupElement.style.display="none",loginElement.style.display="none";else if("command__suggestion"===t.target.className)execInlineCommand();else if("image-embed"===t.target.className)focusBlockStart(t.target.closest(".block")),t.preventDefault();else if("todo-checkbox"===t.target.className){s=t.target.checked?"TODO":"DONE",n=t.target.closest(".block").dataset.id,o=t.target.closest(".compute");let e=store.blox[n].s;e=e.substring(0,o.startIdx)+"[["+s+"]]"+e.substring(o.endIdx),macros.write(n,e);const a=t.target.closest(".block__body");a.textContent="",renderBlockBody(a,e),t.preventDefault()}else if("top-connect"===t.target.id)if("none"===connectFrame.style.display)connectFrame.style.display="block",otherStores;else connectFrame.style.display="none"}else t.target.dataset.title?goto("pageTitle",t.target.dataset.title):goto("block",t.target.dataset.id)}});const commonAncestorNode=(e,t)=>{const o=[];for(;void 0!==e.dataset.id;)o.push(e.dataset.id),e=e.parentNode.parentNode;const s=[];for(;void 0!==t.dataset.id;){if(s.push(t.dataset.id),-1!==o.indexOf(t.dataset.id)){var n=o[o.indexOf(t.dataset.id)-1],a=s[s.length-2];const i=store.blox[t.dataset.id].k;var l=i?i.indexOf(a):-1,a=i?i.indexOf(n):-1,n=Math.max(a,l);return{root:t,startIdx:Math.max(Math.min(a,l),0),endIdx:-1===n?i.length:n,rooted:-1===l||-1===a}}t=t.parentNode.parentNode}},setDragSelected=t=>{if(dragSelect)if(dragSelect.rooted)dragSelect.root.dataset.selected=t;else{const o=getChildren(dragSelect.root);for(let e=dragSelect.startIdx;e<dragSelect.endIdx+1;e++)o[e].dataset.selected=t}},mouseMoveListener=e=>{setDragSelected(!1);e=e.target.closest(".block");e&&e!==dragSelectStartBlock?(getSelection().empty(),(e=commonAncestorNode(dragSelectStartBlock,e))&&(dragSelect=e,setDragSelected(!0))):dragSelect=null};document.addEventListener("mousedown",e=>{setDragSelected(!1),dragSelect=null,e.target.closest(".block")&&(document.addEventListener("mousemove",mouseMoveListener),dragSelectStartBlock=e.target.closest(".block"))}),document.addEventListener("mouseup",e=>{null!==dragSelectStartBlock&&(document.removeEventListener("mousemove",mouseMoveListener),dragSelectStartBlock=null)}),document.addEventListener("selectionchange",e=>{if(focusNode=getSelection().focusNode,focusOffset=getSelection().focusOffset,focusNode){var t=focusNode.parentNode.closest(".block");if(t&&canWriteBloc(t.dataset.id))return sessionState.isFocused=!0,sessionState.position=(focusNode.startIdx||0)+focusOffset,void(t.dataset.id!==sessionState.focusId&&(sessionState.focusId=t.dataset.id,focusIdPosition()))}sessionState.isFocused=!1});const showTopBarFn=()=>{user.s.topBar="visible",saveUser()};let showTopBarTimeout=null;topBarHiddenHitbox.addEventListener("mouseover",()=>{clearTimeout(showTopBarTimeout),showTopBarTimeout=setTimeout(showTopBarFn,400)}),topBarHiddenHitbox.addEventListener("mouseout",()=>{clearTimeout(showTopBarTimeout),showTopBarTimeout=null}),disconnectedFileInput.addEventListener("change",e=>{const t=e.target.files[0];console.log(t);const{name:o,ext:s}=splitFileName(t.name);console.log(`name ${o} extension ${s}`),"zip"===s?t.arrayBuffer().then(e=>{e=zipToFiles(e);if(console.log(e),1===e.length&&"json"===e[0].ext)store=roamJsonToStore(e[0].name,e[0].text),preprocessImportedStore();else throw notifyText("Markdown import doesn't work yet. Upload a .json file, or a .zip file containing a .json file instead.",12),new Error("md import doesn't work")}):"json"===s?t.text().then(e=>{user.s.graphName=o,store=roamJsonToStore(o,e),preprocessImportedStore()}):notifyText("Micro Roam only accepts a .json file or .zip file containing 1 .json file")});const preprocessImportedStore=async()=>{startFn=()=>gotoNoHistory("dailyNotes"),await addGraph(),start()};topButtons["Sign Up"].addEventListener("click",e=>{focusSignup(),e.stopPropagation(),e.preventDefault()});const focusSignup=()=>{signupElement.style.display="block",loginElement.style.display="none",signupEmailElement.focus()},focusLogin=()=>{loginElement.style.display="block",signupElement.style.display="none",loginEmailElement.focus()};switchToSignup.addEventListener("click",focusSignup),switchToLogin.addEventListener("click",focusLogin);const rwlClickOutListener=e=>{console.log("rwlclick"),null===e.target.closest(".really-want-to")&&(reallyWantToLeaveElement.style.display="none",document.removeEventListener("click",rwlClickOutListener))};topButtons["Sign Out"].addEventListener("click",()=>{isSynced()?reset():(reallyWantToLeaveElement.style.display="flex",document.addEventListener("click",e=>rwlClickOutListener(e)),event.stopPropagation())}),reallyWantToLeaveElement.children[0].addEventListener("click",reset),topHamburgerElement.addEventListener("click",()=>{"block"==optionsFrame.style.display?optionsFrame.style.display="none":optionsFrame.style.display="block"}),topButtons["Create New Graph"].addEventListener("keydown",e=>{"Enter"===e.key&&createAndSwitchToNewStore(e.target.value)});

const inlineCommandReplaceString=(e,n=0)=>{sessionState.position=editingCommandElement.firstChild.startIdx+e.length+n,editingCommandElement.innerText=e,setFocusedBlockString(focusBlockBody.innerText)},inlineCommands={TODO:()=>{var e=editingCommandElement.firstChild.startIdx+9;editingCommandElement.remove();var n="{{#TODO}}"+(n=focusBlockBody.innerText);sessionState.position=e,setFocusedBlockString(n)},"page link":()=>{inlineCommandReplaceString("[[]]",-2)},today:()=>{inlineCommandReplaceString("[["+formatDate(new Date(Date.now()))+"]]")},video:()=>{inlineCommandReplaceString("{{#video: }}",-2)},query:()=>{inlineCommandReplaceString("{{#query: }}",-2)},"current time":()=>{var e=new Date(Date.now());inlineCommandReplaceString(formatTime(e))},tomorrow:()=>{inlineCommandReplaceString("[["+getTomorrowDateString()+"]]")},yesterday:()=>{inlineCommandReplaceString("[["+getYesterdayDateString()+"]]")},"next week":()=>{inlineCommandReplaceString("[["+getNextWeekDateString()+"]]")},"last week":()=>{inlineCommandReplaceString("[["+getLastWeekDateString()+"]]")},bold:()=>{inlineCommandReplaceString("****",-2)},italic:()=>{inlineCommandReplaceString("____",-2)},highlight:()=>{inlineCommandReplaceString("^^^^",-2)}};let commandSearchCache=[];const matchInlineCommand=e=>{commandSearchCache=[];let n;try{n=newSearchRegex(e)}catch(e){return commandSearchCache}for(var i in inlineCommands)i.match(n)&&commandSearchCache.push({string:i});return commandSearchCache},execInlineCommand=()=>{inlineCommandList.style.display="none",inlineCommands[focusSuggestion.dataset.string]()};

const roamBloxProps={children:"k",string:"s",title:"s","create-time":"ct","edit-time":"et",":create/user":"cu",":edit/user":"eu",uid:"uid",refs:"",":block/refs":""},roamJsonToStore=(e,r)=>{console.log("roamJsontostore");var t=performance.now();const a=intToBase64(Date.now());var o,r=JSON.parse(r);store=blankStore(),store.graphName=e,r[0][":edit/user"]&&(store.ownerRoamId=r[0][":edit/user"][":user/uid"]),ownerRoamId=store.ownerRoamId;const n=(r,e)=>{var t,o=intToBase64(r["create-time"])||a;const s={s:r.string,p:e,ct:o,et:intToBase64(r["edit-time"])||o};for(t in store.blox[r.uid]=s,r[":create/user"]&&r[":create/user"][":user/uid"]!==ownerRoamId?s.cu=r[":create/user"][":user/uid"]:delete s.cu,r[":edit/user"]&&r[":edit/user"][":user/uid"]!==ownerRoamId?s.eu=r[":edit/user"][":user/uid"]:delete s.eu,r.children&&(s.k=r.children.map(e=>e.uid),r.children.forEach(e=>n(e,r.uid))),r)t in roamBloxProps||(store.roamProps[r.uid]||(store.roamProps[r.uid]={}),store.roamProps[r.uid][t]=r[t])};for(o of r){store.titles[o.title]=o.uid;var s,i=intToBase64(o["create-time"])||a;const u={s:o.title,ct:i,et:intToBase64(o["edit-time"])||i};for(s in store.blox[o.uid]=u,o)s in roamBloxProps||(store.roamProps[o.uid]||(store.roamProps[o.uid]={}),store.roamProps[o.uid][s]=o[s]);if(o[":create/user"]&&o[":create/user"][":user/uid"]!==ownerRoamId?u.cu=o[":create/user"][":user/uid"]:delete u.cu,o[":edit/user"]&&o[":edit/user"][":user/uid"]!==ownerRoamId?u.eu=o[":edit/user"][":user/uid"]:delete u.eu,void 0!==o.children){const c=[];u.k=c;for(let e=0;e<o.children.length;e++){var l=o.children[e];c.push(l.uid),n(l,o.uid)}}}return generateRefs(store),user.s.commitId="MYVERYFIRSTCOMMITEVER",console.log(`roamJsonToStore took ${performance.now()-t}`),console.log(store),store},storeToRoamJSON=o=>{const e=[],s=e=>{const r=o.blox[e],t={uid:e,string:r.s};r.ct&&(t["create-time"]=base64ToInt(r.ct)),r.et&&(t["edit-time"]=base64ToInt(r.et));e=o.roamProps[e];return e&&Object.assign(t,e),r.k&&(t.children=r.k.map(s)),t[":create/user"]={":user/uid":o.ownerRoamId},t[":edit/user"]={":user/uid":o.ownerRoamId},r.cu&&(t[":create/user"]={":user/uid":r.cu}),r.eu&&(t[":edit/user"]={":user/uid":r.eu}),t};for(var r in o.titles){var t=o.titles[r];const a=o.blox[t];r=o.roamProps[t];const n={uid:t,title:a.s};a.ct&&(n["create-time"]=base64ToInt(a.ct)),a.et&&(n["edit-time"]=base64ToInt(a.et)),e.push(n),Object.assign(n,r),a.k&&(n.children=a.k.map(s)),n[":create/user"]={":user/uid":o.ownerRoamId},n[":edit/user"]={":user/uid":o.ownerRoamId},a[":create/user"]&&(n[":create/user"]={":user/uid":a[":create/user"]}),a[":edit/user"]&&(n[":edit/user"]={":user/uid":a[":edit/user"]})}return console.log(e),JSON.stringify(e)},oldStoreToRoamJSON={4:o=>{const e=[],s=e=>{const r={uid:e},t=o.blocks[e];return Object.assign(r,t),t.children&&(r.children=t.children.map(s)),r[":create/user"]={":user/uid":o.ownerRoamId},r[":edit/user"]={":user/uid":o.ownerRoamId},t[":create/user"]&&(r[":create/user"]={":user/uid":t[":create/user"]}),t[":edit/user"]&&(r[":edit/user"]={":user/uid":t[":edit/user"]}),t.refs&&(r.refs=t.refs.map(e=>({uid:e}))),t[":block/refs"]&&(r[":block/refs"]=t[":block/refs"].map(e=>({":block/uid":e}))),delete r.backRefs,delete r.parent,r};for(var r in o.pages){const t=o.pages[r],a={uid:r};e.push(a),Object.assign(a,t),delete a.backRefs,t.children&&(a.children=t.children.map(s)),a[":create/user"]={":user/uid":o.ownerRoamId},a[":edit/user"]={":user/uid":o.ownerRoamId},t[":create/user"]&&(a[":create/user"]={":user/uid":t[":create/user"]}),t[":edit/user"]&&(a[":edit/user"]={":user/uid":t[":edit/user"]})}return console.log(e),JSON.stringify(e)}},mdToStore=e=>{const t=intToBase64(Date.now());store;const o={};store=blankStore();var r,s;for(r of e){var a=r.name;const u=r.text;var n=(s=a,store.pagesByTitle[s]||newUid());const c={"create-time":t,title:a};if(store.pages[n]=c,store.pagesByTitle[a]=n,0<u.length){c.children=[];var i,l=e=>{var r=newUid();o[e]=r;e={"create-time":t,string:e};store.blocks[r]=e,c.children.push(r)},n=(c,u.matchAll(/\n((?:    )*)- /g));let e=2;for(i of n)l(u.substring(e,i.index)),e=i.index+i[0].length;l(u.substring(e))}}console.log(store)},parseMdBlock=e=>{},blocToMd=e=>{let s="";const a=(e,r)=>{const t=store.blox[e];void 0===t&&console.log(e);for(let e=0;e<r;e++)s+="    ";s+="- "+t.s.replaceAll(/\(\(([a-zA-Z0-9\-_]+)\)\)/g,(e,r)=>{return store.blox[r]?'"'+store.blox[r].s+'"':e})+"\n";for(var o of t.k||[])a(o,r+1)};return a(e,0),s},storeToMdObjects=()=>{const r=[];for(var t in store.titles){var o,s=store.blox[store.titles[t]];let e="";for(o of s.k||[])e+=blocToMd(o);r.push({fullName:t+".md",text:e})}return r},storeToMdZip=()=>filesToZip(storeToMdObjects()),LOCAL_FILE_SIGNATURE=67324752,LOCAL_FILE_HEADER_LENGTH=30,END_CENTRAL_DIR_SIGNATURE=101010256,END_CENTRAL_DIR_HEADER_LENGTH=46,CENTRAL_FILE_SIGNATURE=33639248,ARCHIVE_EXTRA_RECORD_SIGNATURE=134630224,CRC_32_MAGIC=2869187666,splitFileName=e=>{var r=e.match(/\.([a-z]+)$/);return{name:e.substring(0,r.index),ext:r[1]}},zipToFiles=e=>{var r=new Uint8Array(e);let t=0;const o=[];for(;t<r.length;){var s=new ArrayBuffer(4);const c=new Uint8Array(s);for(let e=0;e<4;e++)c[e]=r[t+e];var a=new Uint32Array(s)[0];if(a!==LOCAL_FILE_SIGNATURE){if(a===END_CENTRAL_DIR_SIGNATURE){console.log("got end central dir signature");break}console.log(`got signature ${a}`);break}var n=new Uint16Array(e,8,1)[0];if(0!==n)return console.log(n),void notifyText("Micro Roam can't handle .zip files that are actually compressed. use a .json file or an uncompressed .zip file, like ones exported by Roam Research or Micro Roam",10);{var i=new ArrayBuffer(12);const d=new Uint8Array(i);for(let e=0;e<12;e++)d[e]=r[e+18+t];var l=new Uint32Array(i),u=(l[0],l[1]),s=l[2];if(1441805<=s)break;const m=new TextDecoder;var a=m.decode(new Uint8Array(e,t+30,s)),{name:n,ext:i}=splitFileName(a),l=m.decode(new Uint8Array(e,t+30+s,u));o.push({name:n,ext:i,text:l,fullName:a}),t+=30+s+u}}return o};let crcTable=null;const makeCRCTable=()=>{let r;crcTable=[];for(let e=0;e<256;e++){r=e;for(let e=0;e<8;e++)r=1&r?3736805603^r>>>1:r>>>1;crcTable[e]=r}};function crc32(r,t,o){null===crcTable&&makeCRCTable();let s=-1;for(let e=t;e<o;e++)s=s>>>8^crcTable[255&(s^r[e])];return(-1^s)>>>0}const dateUnixToMsDosFormat=e=>{const r=new Date(e);let t=r.getDate()+(r.getMonth()+1<<5)+(r.getFullYear()-1980<<9);return console.log(t),console.log(t.toString(2)),t},writeU16ToU8Array=(e,r,t)=>{e[r]=t<<24>>>24,e[r+1]=t<<16>>>24},writeIntToU8Array=(e,r,t)=>{e[r]=t<<24>>>24,e[r+1]=t<<16>>>24,e[r+2]=t<<8>>>24,e[r+3]=t>>>24},ZIP_VERSION=10,blankLocalHeader=new Uint8Array(30);writeIntToU8Array(blankLocalHeader,0,LOCAL_FILE_SIGNATURE),writeIntToU8Array(blankLocalHeader,14,CRC_32_MAGIC),writeU16ToU8Array(blankLocalHeader,4,ZIP_VERSION);const blankCentralHeader=new Uint8Array(46);writeIntToU8Array(blankCentralHeader,0,CENTRAL_FILE_SIGNATURE),writeU16ToU8Array(blankCentralHeader,4,16),writeU16ToU8Array(blankCentralHeader,6,ZIP_VERSION);const copyBuffer=(r,t,o,s,a)=>{for(let e=0;e<a;e++)o[s+e]=r[t+e]},filesToZip=e=>{var r,t=Date.now(),o=dateUnixToMsDosFormat(t),s=performance.now();let a="",n=0;for(r of e)a+=r.fullName+r.text,n+=30+r.fullName.length+r.text.length;t=textEncoder.encode(a).length+LOCAL_FILE_HEADER_LENGTH*e.length+END_CENTRAL_DIR_HEADER_LENGTH;console.log(a.length-n),console.log(`mstime ${performance.now()-s}`);var i,t=new ArrayBuffer(t);let l=new Uint8Array(t),u=0;for(i of e){var c=u;copyBuffer(blankLocalHeader,0,l,u,blankLocalHeader.length),writeU16ToU8Array(l,c+10,o),writeU16ToU8Array(l,c+12,o),u+=blankLocalHeader.length;var d=l.subarray(u),{read:m}=textEncoder.encodeInto(i.fullName,d);u+=m;var f=l.subarray(u),{read:d}=textEncoder.encodeInto(i.text,f),f=crc32(l,u,u+d);writeIntToU8Array(l,c+14,f),u+=d,writeIntToU8Array(l,c+18,d),writeIntToU8Array(l,c+22,d),writeU16ToU8Array(l,c+26,m)}t=new Blob([t]);return console.log(`filestozip ${performance.now()-s}`),t};

const testRoundTrip=()=>{var e=storeToRoamJSON(store);store=roamJsonToStore(store.graphName,e);var o=storeToRoamJSON(store);e===o?console.log("Round trip test passed!"):(console.log(e),console.log(o),console.error("round trip failed"))},createPageTest=()=>{var e=store;store=blankStore(),macros.createPage("Test Page"),store=e};let testSTime;const renderMulti=(e,o=void 0,r=100,t=!1)=>{t||(testSTime=performance.now()),0<r?e(o)||setTimeout(()=>renderMulti(e,o,r-1,!0),0):console.log(`test func took ${performance.now()-testSTime}`)},benchmarkPageLoad=()=>renderMulti(()=>goto("pageTitle","Welcome to Micro Roam"));let benchmarkRandomWalkSTime=null;const benchmarkRandomWalk=()=>renderMulti(()=>{let e=[];var o,r,t,n=document.querySelectorAll(".page-ref"),a=document.querySelectorAll(".tag"),l=document.querySelectorAll(".breadcrumb-page");for(o of n)e.push(o.children[2].innerText);for(r of a)e.push(r.innerText.substring(1));for(t of l)e.push(t.innerText);e=e.filter(e=>store.titles[e]&&store.blox[store.titles[e]]);l=e[Math.floor(Math.random()*(e.length-1))];goto("pageTitle",l)}),benchmarkRenderAll=async()=>{var e,o=performance.now();let r=0,t=0;for(e in store.titles){var n=performance.now();gotoNoHistory("pageTitle",e),r+=performance.now()-n,t+=1,await new Promise(e=>setTimeout(e,0))}o=performance.now()-o,o=`rendered ${t} pages in ${Math.round(o)}ms, avg ${Math.round(o/t)}ms \nfunction time avg ${Math.round(r/t)}`;console.log(o),notifyText(o,10)},testAll=()=>{testRoundTrip(),benchmarkPageLoad(),benchmarkRandomWalk(),benchmarkRenderAll()},benchmarkGen=()=>{var e=performance.now();for(let e=0;e<100;e++)generateInnerRefs();console.log(`gen took ${performance.now()-e}`)},log=()=>{user.s.logging=!0,saveUser()},nolog=()=>{user.s.logging=!1,saveUser()},flash=benchmarkRenderAll,blank=(e="default")=>{store=blankStore(),store.graphName=e,user={s:{graphName:"default",theme:window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",topBar:"visible",logging:!1,spellcheck:!1,editingSpotlight:!0}},user.s.graphName=e,saveUser(),debouncedSaveStore(),goto("dailyNotes")},pr=()=>{console.log(JSON.stringify(store))},downloadBinary=()=>{var e=storeToBinary(),e=new Blob([e],{type:"application/x-micro-roam"}),e=URL.createObjectURL(e);const o=document.createElement("a");o.setAttribute("href",e),o.setAttribute("download",`${store.graphName}.mrm`),o.click()},monitor=string=>{const js=`setInterval(()=>console.log(${string}), 500)`;eval(js)},terminalCommands={blank:blank,reset:reset,flash:flash,log:log,page:page,nolog:nolog,pr:pr,downloadBinary:downloadBinary,monitor:monitor};</script>