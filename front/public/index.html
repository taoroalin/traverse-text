<body>
  <div id="app">
    <div id="top-bar" style="margin-top:0px">

      <a id="report-issue-button" target="_blank" href="mailto:taoroalin@gmail.com?subject=You Made Micro Roam Wrong"
        tabindex="-1">
        Report Issue
      </a>
      <button id="help-button" tabindex="-1">
        Help
      </button>
      <button id="daily-notes-button" tabindex="-1">
        Daily Notes
      </button>
      <input id="search-input" placeholder="search" tabindex="-1">
      <button id="upload-button" tabindex="-1">
        <input style="display:none" type="file" id="upload-input">
        Upload JSON
      </button>
      <a id="download-button" tabindex="-1">
        Download JSON
      </a>
    </div>

    <div id="top-bar-hidden-hitbox" style="position:fixed;height:15px;width:100%"></div>

    <div id="terminal" contenteditable="true" style="display:none"></div>

    <div id="page-frame-outer">
      <div id="page-frame">

      </div>
    </div>

    
<script>
const r=indexedDB.open("microroam",4),blankUser={graphName:"default",theme:"light",topBar:"visible",logging:!1,spellcheck:!1};let user=blankUser;const storedUser=localStorage.getItem("user");storedUser&&(user=JSON.parse(storedUser));let w=!1,store=null,idb=null,startCommand=["dailyNotes"];const theresANewStore=()=>{user.graphName=store.graphName,saveUser(),gotoNoHistory(...startCommand),debouncedSaveStore()};r.onsuccess=e=>{idb=e.target.result,idb.transaction(["stores"],"readonly").objectStore("stores").get(user.graphName).onsuccess=e=>{e.target.result?(store=JSON.parse(e.target.result.store),w?theresANewStore():w=!0):(console.log("adding default graph"),fetch("./default-store.json").then(e=>e.json().then(e=>{store=e,user.graphName=e.graphName,startCommand=["pageTitle","Welcome to Micro Roam"],w?theresANewStore():w=!0})))}},r.onupgradeneeded=e=>{const t=r.result,o=Array.from(t.objectStoreNames);o.includes("stores")||t.createObjectStore("stores",{keyPath:"graphName"})},r.onerror=e=>{alert(`In order to save your notes between sessions, Micro Roam needs access to IndexedDB. 
      You can allow access by exiting "private browsing" mode, or by using a newer browser, or by changing browser settings`)};let commitDebounce=null,editingTemplateExpander=null,editingLink=null,editingTitle=null,focusNode=null,focusOffset=null,focusBlock=null,focusSuggestion=null,sessionState={pageFrame:"dailyNotes",focusId:null,scroll:0,position:null},dragSelectStartBlock=null;const topBar=document.getElementById("top-bar"),topBarHiddenHitbox=document.getElementById("top-bar-hidden-hitbox"),showTopBar=()=>{topBar.style.marginTop="0px",topBarHiddenHitbox.style.display="none"},hideTopBar=()=>{topBar.style.marginTop="-46px",topBarHiddenHitbox.style.display="block"},saveUser=()=>{document.body.className=user.theme,("visible"===user.topBar?showTopBar:hideTopBar)(),localStorage.setItem("user",JSON.stringify(user))};saveUser();
</script>


    <div id="autocomplete-list" style="display:none"></div>
    <!-- inline styles on this site are all edited directly by js -->
    <div id="search-result-list" style="display:none"></div>
    <div id="template-list" style="display:none"></div>

  </div>

  <title>Micro Roam</title>

  
<style>
/* global styles ----------------------------------------------------------------------------- */
*{
  outline:none;
  scrollbar-width:none;
}

.dark{
  --background:#161616;
  --text: white;
  --link: #3f84c0;
  --brackets:#A7B6C2;
  --block-ref:rgb(63, 63, 63);
  --bullet:#758897;
  --border:#afbeca;
  --break: #838e97;
  --highlight:rgb(110, 93, 16);
  --click:darkgrey;
  --page-ref:#2bcc5b;
  --shadow:rgb(98, 98, 98);
  --notification:#2e4736;
  --selected:#2a4761;
}

.light{
  --background:white;
  --text:black;
  --link: rgb(54, 123, 184);
  --brackets:#A7B6C2;
  --block-ref:lightgrey;
  --bullet:#394B59;
  --border:#585e64;
  --shadow:#585e64;
  --break:#a8b4be;
  --highlight:rgb(255, 239, 146);
  --click:rgb(197, 197, 197);
  --page-ref:rgb(73, 197, 91);
  --notification:#a4d1b1;
  --selected:#5998cf;
}

input, button, a{
  font-family: 'Inter', Verdana;
}

input{
  border:none;
}

button{
  appearance: none;
  border:none;
  box-shadow: none;
  cursor:pointer;
  background-color:inherit;
  color:inherit;
  font-size:inherit;
}

span{
  margin:0;
  padding:0;
}

::-webkit-scrollbar{
  width:0%;
  height:0%;
}

::selection{
  background-color:#85b7e8;
  color:var(--text);
}

body {
    scrollbar-width: 0px;
    font-family: 'Inter', Verdana, Arial;
    font-weight: normal;
    margin: 0;
    color:var(--text);
    background-color: var(--background);
}

a{
  color:var(--link);
}

a:visited { color:var(--link) }

.notification{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  top:-40px; /* transitions to more px */
  margin-top: 0px;
  opacity:1;
  transition: top 0.25s ease-out, opacity 0.2s linear;
  padding:20px;
  background-color:var(--notification);
  border-radius:8px;
}


/* singular element styles --------------------------------------------------------------------------------------- */

#app{
  height:100%;
  width:100%;
  display:flex;
  flex-direction: column;
}

#page-frame-outer{
  width:100%;
  overflow-y:scroll;
}

#page-frame{
  margin: 0 auto 30px;
  max-width: min(900px, 100%);
}

#top-bar{
  width:100%;
  display: flex;
  flex-direction: row;
  align-content: space-between;
  background-color:var(--background);
  transition:margin-top 0.1s;
}

/* these have different paddings, but look the same because weird stuff. todo investigate */
#top-bar a{
  padding: 14px 10px 10px;
  font-size:0.9em;
}
#top-bar button{
  padding: 12px 10px 10px;
  font-size:0.9em;
}


#download-button, #report-issue-button {
  color:var(--text);
  display:block;
  cursor:pointer;
  text-decoration: none;
}

#search-input{
  background-color:var(--background);
  color:var(--text);
  padding:3px 13px;
  margin: 7px 5px 5px;
  display:block;
  font-size:1.2em;
  box-shadow:0 0 2px var(--shadow);
  border-radius:100px;
  flex-grow: 1;
}

#autocomplete-list, #template-list{
  position:absolute;
  display:flex;
  flex-direction: column;
  background-color:var(--background);
  font-size:1.3em;
  border-radius:5px;
  box-shadow: 0 0 8px var(--shadow);
}

.autocomplete__suggestion[data-selected="true"],.template__suggestion[data-selected="true"]{
  background-color:var(--click);
}

.autocomplete__suggestion, .template__suggestion{
  padding:7px;
  cursor:pointer;
  border-radius: 5px;
}


#search-result-list{
  position:absolute;
  display:flex;
  flex-direction: column;
  background-color:var(--background);
  font-size:1.3em;
  border-radius:5px;
  box-shadow: 0 0 8px var(--shadow);
}

.search-result[data-selected="true"]{
  background-color:var(--click);
}

.search-result{
  padding:7px;
  cursor:pointer;
  border-radius: 5px;
}

/* Page styles --------------------------------------------------------------------------------------------------- */

.page{
  margin-right:30px;
  margin-left:30px;
  position:relative;
}

.page__title{
  font-size: 36px;
  margin: 40px 0 20px 0;
}

.page__body, .backref-frame__body{
  margin-left:20px;
}

.backref-list__body{
  margin-left:10px;
}

.backref-list__title{
  font-size: 1.2em;
  font-weight:bold;
  padding: 20px 0 0;
}

.page-break{
  height:0px;
  margin: 60px 25px;
  border:1px solid var(--break);
  border-width: 1px 0 0 0;
}


.block{
  position:relative;
}

.block[data-selected="true"]{
  background-color:var(--selected);
}

.block__body{
  padding:5px 0;
}

.block__bullet{
  cursor:pointer;
  position:absolute;
  left:-21px;
  top:4px;
}

.block__children{
  margin-left: 25px;
}

.block-focus-frame{
  margin: 60px 0;
}

.breadcrumb-page{
  cursor:pointer;
}

.breadcrumb-block{
  cursor:pointer;
}

.backref-frame__breadcrumb{
  margin:15px 0 5px 0;
  font-size:1.2em;
}

.block-focus-frame__breadcrumb{
  margin:15px 0 5px 0;
  font-size:1.2em;
}

/* Parsed block styles -------------------------------------------------------------------------------------- */

.page-ref{
  position:relative;
}

.page-ref__brackets{
  font-weight: lighter;
  color:var(--brackets);
}

.page-ref__body{
  color:var(--page-ref);
  font-weight: 800;
}

.page-ref__body:hover{
  text-decoration: underline;
  cursor:pointer;
}

.tag{
  color:var(--page-ref);
  font-weight: 800;
  position:relative;
}

.tag:hover{
  text-decoration: underline;
  cursor:pointer;
}

.block-ref{
  background-color:var(--block-ref);
}

.block-ref:hover{
  text-decoration: underline;
  cursor:pointer;
}

.bold{
  font-weight:bold;
}

.italic{
  font-style:italic;
}

.highlight{
  background-color: var(--highlight);
  border-radius:2px;
  padding:1px;
}

.block-focus-frame{
  margin: 35px 0 0 60px;
}

.url{
  color:var(--link);
  text-decoration: underline;
  cursor:pointer;
}

.literal{
  font-family:'Inconsolata';
  font-size:1.15em;
}

#terminal{
  font-family:'Inconsolata';
  width:100%;
  padding:8px;
  background-color: black;
  color:white;
}
</style>


  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata">

  <template id="page">
    <div class="page">
      <h1 class="page__title" contenteditable="true" tabindex="-1" spellcheck="false"></h1>

      <div class="page__body">

      </div>
      <div class="page__backlinks">

      </div>
    </div>
  </template>

  <template id="block">
    <div class="block">
      <svg class="block__bullet" width="20" height="20">
        <circle cx="10" cy="10.5" r="3" fill="var(--bullet)" />
      </svg>
      <div class="block__body" contenteditable="true" tabindex="-1" spellcheck="false">
      </div>
      <div class="block__children">

      </div>
    </div>
  </template>

  <template id="backref-list">
    <div class="backref-list">
      <div class="backref-list__title">Linked References</div>
      <div class="backref-list__body"></div>
    </div>
  </template>

  <template id="page-break">
    <div class="page-break"></div>
  </template>

  <template id="block-focus-frame">
    <div class="block-focus-frame">
      <div class="block-focus-frame__breadcrumb"></div>
      <div class="block-focus-frame__body"></div>
      <div class="block-focus-frame__backlinks"></div>
    </div>
  </template>

  <template id="backref-frame">
    <div class="backref-frame">
      <div class="backref-frame__breadcrumb"></div>
      <div class="backref-frame__body"></div>
    </div>
  </template>

  <template id="page-ref">
    <span class="page-ref"><span class="page-ref__brackets"></span><span class="page-ref__body"></span><span
        class="page-ref__brackets"></span></span>
  </template>

  <template id="tag">
    <span class="tag"></span>
  </template>

  <template id="block-ref">
    <span class="block-ref"></span>
  </template>

  <template id="block-ref">
    <span class="block-ref"></span>
  </template>

  <template id="bold">
    <span class="bold"></span>
  </template>

  <template id="italic">
    <span class="italic"></span>
  </template>

  <template id="highlight">
    <span class="highlight"></span>
  </template>

  <template id="literal">
    <span class="literal"></span>
  </template>

  <!-- this is a bit silly, since this element doesn't show up as anyting, but for consistancy?? -->
  <template id="template-expander">
    <span class="template-expander"></span>
  </template>

  <!--using spans with event handlers as links because they play nice with contenteditable-->
  <template id="url">
    <span class="url"></span>
  </template>

  <template id="autocomplete__suggestion">
    <div class="autocomplete__suggestion"></div>
  </template>

  <template id="template__suggestion">
    <div class="template__suggestion"></div>
  </template>

  <template id="search-result">
    <div class="search-result"></div>
  </template>

  <template id="breadcrumb-block">
    <span class="breadcrumb-block"><span class="breadcrumb-block__arrow">-></span><span
        class="breadcrumb-block__body"></span></span>
  </template>

  <template id="breadcrumb-page">
    <span class="breadcrumb-page"></span>
  </template>

  <template id="notification">
    <div class="notification"></div>
  </template>

  
<script>
const monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"],getOrdinal=e=>{var t=e%10,r=e%100;return 1==t&&11!=r?e+"st":2==t&&12!=r?e+"nd":3==t&&13!=r?e+"rd":e+"th"},formatDate=e=>`${monthNames[e.getMonth()]} ${getOrdinal(e.getDate())}, ${e.getFullYear()}`,truncateElipsis=(e,t=40)=>e.length>t?e.substring(0,t-3)+"...":e;

const storeToRoamJSON=u=>{const e=[],d=e=>{const r={uid:e},s=u.blocks[e];return Object.assign(r,s),s.children&&(r.children=s.children.map(d)),r[":create/user"]={":user/uid":u.ownerRoamId},r[":edit/user"]={":user/uid":u.ownerRoamId},s[":create/user"]&&(r[":create/user"]={":user/uid":s[":create/user"]}),s[":edit/user"]&&(r[":edit/user"]={":user/uid":s[":edit/user"]}),s.refs&&(r.refs=s.refs.map(e=>({uid:e}))),s[":block/refs"]&&(r[":block/refs"]=s[":block/refs"].map(e=>({":block/uid":e}))),delete r.backRefs,delete r.parent,r};for(var r in u.pages){const s=u.pages[r],i={uid:r};e.push(i),Object.assign(i,s),delete i.backRefs,s.children&&(i.children=s.children.map(d)),i[":create/user"]={":user/uid":u.ownerRoamId},i[":edit/user"]={":user/uid":u.ownerRoamId},s[":create/user"]&&(i[":create/user"]={":user/uid":s[":create/user"]}),s[":edit/user"]&&(i[":edit/user"]={":user/uid":s[":edit/user"]})}return console.log(e),JSON.stringify(e)};

const cpy=e=>JSON.parse(JSON.stringify(e)),getIn=(t,o)=>{let r=store;for(let e=0;e<t.length-o;e++)void 0===r[t[e]]&&(r[t[e]]={}),r=r[t[e]];return r},doEdits=e=>{if(e.subtract)for(var t of e.subtract){const a=getIn(t,2);var o=t[t.length-2];a[o]=a[o].filter(e=>e!=t[t.length-1])}if(e.write)for(var r of e.write){const c=getIn(r,2);c[r[r.length-2]]=cpy(r[r.length-1])}if(e.add)for(var s of e.add){const f=getIn(s,2);f[s[s.length-2]].push(cpy(s[s.length-1]))}if(e.insert)for(var n of e.insert){const d=getIn(n,3);var l=n[n.length-3],i=n[n.length-2],n=n[n.length-1];let e=d[l];if(void 0===e)e=[i],d[l]=e;else{if(e.length<n)throw console.log(e),console.log(l),new Error("tried to insert past end of list");d[l]=e.slice(0,n),d[l].push(cpy(i)),d[l].push(...e.slice(n))}}if(e.delete)for(var g of e.delete){const h=getIn(g,1);delete h[g[g.length-1]]}},saveStore=()=>{const e=idb.transaction(["stores"],"readwrite"),t=e.objectStore("stores");var o=JSON.stringify(store);const r=t.put({graphName:store.graphName,store:o});r.onsuccess=()=>{console.log("saved")},r.onerror=e=>{console.log("save error"),console.log(error)}};let saveStoreTimeout=null;const debouncedSaveStore=()=>{clearTimeout(saveStoreTimeout),saveStoreTimeout=setTimeout(saveStore,500)},print=e=>{user.logging&&console.log(e)};

const CHARS_64="-_0123456789abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ",newUid=()=>{let r;do{r="";for(let e=0;e<9;e++)r+=CHARS_64[Math.floor(64*Math.random())]}while(void 0!==store.pages[r]||void 0!==store.blocks[r]);return console.trace(),console.log(r),r},blockOrPageFromId=e=>store.blocks[e]||store.pages[e],parentThingey=e=>store.pages[e]?"pages":"blocks",commands={deleteBlock:r=>{var e=store.blocks[r],t=e.parent;const s=e[":block/refs"],i=e.backRefs;return{edits:{subtract:[[parentThingey(e.parent),t,"children",r],...s.map(e=>[parentThingey(e),e,"backRefs",r]),...i.map(e=>[parentThingey(e),e,"refs",r])],delete:[["blocks",r]]}}},moveBlock:(e,r,t,s)=>{var i=store.blocks[e].parent;return{edits:{write:[["blocks",e,"parent",r]],insert:[[parentThingey(r),r,"children",e,t]],subtract:[[parentThingey(i),i,"children",e]]},returns:void 0}},writeBlock:(t,e,r,s)=>{var i;const a=store.blocks[t][":block/refs"],n={write:[],subtract:[],add:[],delete:[]},o=r.map(e=>{let r=store.pagesByTitle[e];return void 0!==r?a.includes(r)||n.add.push(["pages",r,"backRefs",t]):(r=newUid(),n.write.push(["pages",r,{title:e,children:[],":create/time":s,backRefs:[t]}]),n.write.push(["pagesByTitle",e,r])),r});if(n.write.push(["blocks",t,"string",e],["blocks",t,"edit-time",s],["blocks",t,":block/refs",o]),a)for(var c of a)o.includes(c)||(i=store.pages[c],"pages"!==parentThingey(c)||void 0!==i.children&&0!==i.children.length||!(void 0===i.backRefs||i.backRefs.length<=1)?n.subtract.push([parentThingey(c),c,"backRefs",t]):(n.delete.push(["pagesByTitle",i.title]),n.delete.push(["pages",c])));return{edits:n}},createBlock:(e,r,t)=>{var s=newUid(),i=store.pages[e]?"pages":"blocks";return{edits:{write:[["blocks",s,{string:"",parent:e,":create/time":t,children:[],backRefs:[],":block/refs":[],refs:store[i].refs}]],insert:[[i,e,"children",s,r]]},returns:s}},createPage:(e,r)=>{var t=newUid();return{edits:{write:[["pages",t,{title:e,":create/time":r}],["pagesByTitle",e,t]]},returns:t}},writePageTitle:(e,r,t)=>{var s=store.pages[e],i=s.title;const a={write:[["pages",e,"title",r],["pages",e,"edit-time",t],["pagesByTitle",r,e]],delete:[["pagesByTitle",i]]};if(s.backRefs)for(var n of s.backRefs){let e=store.blocks[n].string;a.write.push(["blocks",n,"string",e.replaceAll(i,r)])}return{edits:a}},copyBlock:(e,r,t,c)=>{var s=newUid();const l={write:[],insert:[[parentThingey(r),r,"children",s,t]],subtract:[]},d=(e,r,t)=>{var s,i=store.blocks[e];const a={"create-time":c,string:i.string,parent:t};for(s of LIST_PROPS)i[s]&&(a[s]=Array.from(i[s]));if(i.children){a.children=[];for(var n of i.children){var o=newUid();d(n,o,r),a.children.push(o)}}l.write.push(["blocks",r,a])};return d(e,s,r),{edits:l,returns:s}}},runCommand=(...e)=>{console.log(e);var{edits:r,returns:e}=commands[e[0]](...e.slice(1),Date.now());return doEdits(r),debouncedSaveStore(),e};

const blankStore=()=>({graphName:"default",ownerRoamId:"default",blocks:{},pages:{},pagesByTitle:{}}),LIST_PROPS=["refs",":block/refs","backRefs"],LIST_PROPS_FORWARD=["refs",":block/refs"],LOCAL_FILE_SIGNATURE=67324752,END_CENTRAL_DIR_SIGNATURE=101010256,CENTRAL_FILE_SIGNATURE=33639248,ARCHIVE_EXTRA_RECORD_SIGNATURE=134630224,ZIP64_END_CENTRAL_SIGNATURE=101075792,splitFileName=e=>{var r=e.match(/\.([a-z]+)$/);return{name:e.substring(0,r.index),ext:r[1]}},zipToFiles=e=>{var r=new Uint8Array(e),o=r.length;let t=0;const s=[];for(;t<o;){var a=new ArrayBuffer(4);const f=new Uint8Array(a);for(let e=0;e<4;e++)f[e]=r[t+e];var n=new Uint32Array(a)[0];if(n!==LOCAL_FILE_SIGNATURE){if(n===END_CENTRAL_DIR_SIGNATURE)break;console.log(`got signature ${n}`);break}var i=new Uint16Array(e,8,1)[0];if(0!==i)return console.log(i),void notifyText("Micro Roam can't handle .zip files that are actually compressed. use a .json file or an uncompressed .zip file, like ones exported by Roam Research or Micro Roam",10);{var l=new ArrayBuffer(12);const p=new Uint8Array(l);for(let e=0;e<12;e++)p[e]=r[e+18+t];var c=new Uint32Array(l),d=(c[0],c[1]),a=c[2];if(1441805<=a)break;const u=new TextDecoder;var n=u.decode(new Uint8Array(e,t+30,a)),{name:i,ext:l}=splitFileName(n),c=u.decode(new Uint8Array(e,t+30+a,d));s.push({name:i,ext:l,text:c,fullName:n}),t+=30+a+d}}return s},roamJsonToStore=(e,r)=>{var o,t,s,a=performance.now(),r=JSON.parse(r);const n={},i={},l={};let c=null;r[0][":edit/user"]&&(c=r[0][":edit/user"][":user/uid"]);const d=(r,e)=>{if((i[r.uid]=r).parent=e,r[":create/user"]&&r[":create/user"][":user/uid"]!==c?r[":create/user"]=r[":create/user"][":user/uid"]:delete r[":create/user"],r[":edit/user"]&&r[":edit/user"][":user/uid"]!==c?r[":edit/user"]=r[":edit/user"][":user/uid"]:delete r[":edit/user"],r.children){const s=r.children;r.children=s.map(e=>e.uid),s.forEach(e=>d(e,r.uid))}if(r.refs&&(r.refs=r.refs.map(e=>e.uid)),r[":block/refs"]&&(r[":block/refs"]=r[":block/refs"].map(e=>e[":block/uid"])),delete r.uid,r.backRefs=[],r[":block/props"]&&r[":block/props"][":drawing/lines"])for(var o of r[":block/props"][":drawing/lines"])o[":points"]=o[":points"].map(e=>[Math.round(e[0]),Math.round(e[1])]);if(r.props&&r.props.lines)for(var t of r.props.lines)t.points=t.points.map(e=>[Math.round(e[0]),Math.round(e[1])])};for(o of r){if(l[o.title]=o.uid,n[o.uid]=o,o[":create/user"]&&o[":create/user"][":user/uid"]!==c?o[":create/user"]=o[":create/user"][":user/uid"]:delete o[":create/user"],o[":edit/user"]&&o[":edit/user"][":user/uid"]!==c?o[":edit/user"]=o[":edit/user"][":user/uid"]:delete o[":edit/user"],void 0!==o.children){var f,p=o.children;o.children=[];for(f of p)o.children.push(f.uid),d(f,o.uid)}delete o.uid,o.backRefs=[]}for(t in i){var u=i[t];if(u[":block/refs"])for(var g of u[":block/refs"])void 0!==i[g]?i[g].backRefs.push(t):void 0!==n[g]?n[g].backRefs.push(t):(g=new Error(`bad ref ${g}`),console.log(g),console.log("ERROR"))}for(s in n){var h=n[s];h.children&&0!==h.children.length||0!==h.backRefs.length||(delete l[h.title],delete n[s])}e={graphName:e,pages:n,blocks:i,pagesByTitle:l,ownerRoamId:c};return console.log(`roamJsonToStore took ${performance.now()-a}`),console.log(e),e},mdToStore=e=>{var o=Date.now();store;const t={};store=blankStore();var r,s;for(r of e){var a=r.name;const c=r.text;var n=(s=a,store.pagesByTitle[s]||newUid());const d={"create-time":o,title:a};if(store.pages[n]=d,store.pagesByTitle[a]=n,0<c.length){d.children=[];var i,l=e=>{var r=newUid();t[e]=r;e={"create-time":o,string:e};store.blocks[r]=e,d.children.push(r)},n=(d,c.matchAll(/\n((?:    )*)- /g));let e=2;for(i of n)l(c.substring(e,i.index)),e=i.index+i[0].length;l(c.substring(e))}}console.log(store)},parseMdBlock=e=>{},exampleStore={blocks:{bnslSbnd:{string:"",":block/refs":["steklsne","nslkeDk"]}},pages:{nslkeDk:{title:"I have title",backRefs:["bnslSbnd"]}}},mergeStore=l=>{const r={};var e,o,t,c=e=>r[e]||(void 0!==store.blocks[e]||void 0!==store.pages[e]?newUid():l.pages[e]&&store.pagesByTitle[l.pages[e].title]?(r[e]=store.pagesByTitle[l.pages[e].title],r[e]):e);for(e in l.blocks)c(e);for(o in l.pages)c(o);const d=(e,r,o)=>{var t,s=l.blocks[e];const a={...s};if(store.blocks[r]=a,a.parent=o,s.children){a.children=[];for(var n of s.children){var i=c(n);d(n,i,r),a.children.push(i)}}for(t of LIST_PROPS){let e=s[t];e&&(a[t]=e.map(c))}};for(t in l.pages){var s=c(t),a=l.pages[t];if(void 0===store.pages[s]){const v={...a};if(store.pages[s]=v,store.pagesByTitle[a.title]=s,a.children){v.children=[];for(var n of a.children){var i=c(n);d(n,i,s),v.children.push(i)}}for(var f of LIST_PROPS){let e=a[f];e&&(v[f]=e.map(c))}}else{const k=store.pages[s];if(a.children){void 0===k.children&&(k.children=[]);for(var p of a.children){var u=c(p);d(p,u,s),k.children.push(u)}}for(var g of LIST_PROPS)if(a[g]){void 0===k[g]&&(k[g]=[]);for(var h of a[g])k[g].push(c(h))}}}},gcBlocks=()=>{for(var e of Array.from(store.blocks)){var r=store.blocks[e];void 0===store.pages[r.parent]&&void 0===store.blocks[r.parent]&&delete store.blocks[e]}},escapeRegex=e=>e.replaceAll(/(?<=^|[^`])([\[\]\(\)])/g,"\\$1").replaceAll("`",""),searchRefCountWeight=.05,titleExactFullTextSearch=e=>{var r,o=new RegExp(escapeRegex(e),"i");const t=[];for(r in store.pages){var s=store.pages[r];const n=s.title;var a=n.match(o);a&&t.push({title:n,id:r,idx:a.index-s.backRefs.length*searchRefCountWeight})}return t.sort((e,r)=>e.idx-r.idx),t.slice(0,10)},exactFullTextSearch=e=>{var r,o,t=new RegExp(escapeRegex(e),"i");const s=[];for(r in store.pages){var a=store.pages[r];const l=a.title;var n=l.match(t);n&&s.push({title:l,id:r,idx:n.index-a.backRefs.length*searchRefCountWeight})}for(o in store.blocks){const c=store.blocks[o];var i=c.string.match(t);i&&s.push({string:c.string,id:o,idx:i.index+1-c.backRefs.length*searchRefCountWeight})}return s.sort((e,r)=>e.idx-r.idx).slice(0,10)},searchTemplates=s=>{var e=store.pages[store.pagesByTitle["roam/templates"]];const a=[];if(e){var r=(e,r)=>{const o=store.blocks[e],t=o.string.match(r?/^([^ \r\n]+)\s*$/:/^([^ \r\n]+)\s*(?:(?:#roam\/templates)|(?:\[\[roam\/templates\]\]))$/);console.log(t),t&&t.length>=s.length&&t[1].substring(0,s.length).toLowerCase()===s.toLowerCase()&&a.push({id:e,string:t[1]})};if(e.backRefs)for(var o of e.backRefs)r(o,0);if(e.children)for(var t of e.children)r(t,1)}return a},makePagesByTitle=()=>{var e,r=performance.now();for(e in store.pagesByTitle={},store.pages)store.pagesByTitle[store.pages[e].title]=e;console.log(`makepbt took ${performance.now()-r}`)},storeToFlat=()=>{const e=[],r=[];for(var o in store.pages)e.push(o),r.push(JSON.stringify(store.pages[o]));for(var t in store.blocks)e.push(t),r.push(JSON.stringify(store.blocks[t]));return{keys:e,values:r}},storeToBinary=()=>{var e=performance.now();const r=new TextEncoder;var{keys:o,values:t}=storeToFlat(store);let s=4,a=[];for(let e=0;e<o.length;e++){var n=r.encode(o[e]).length,i=r.encode(t[e]).length;s+=n+i+8,a.push(n,i)}var l=new ArrayBuffer(s);const c=new Uint8Array(l),d=new Uint32Array(l,0,a.length+10);d[0]=Math.floor(a.length/2);for(let e=0;e<a.length;e++)d[e+1]=a[e];let f=4+4*a.length;for(let e=0;e<o.length;e++){var p=o[e],u=t[e],g=a[2*e],h=a[2*e+1];r.encodeInto(p,c.subarray(f)),f+=g,r.encodeInto(u,c.subarray(f)),f+=h}return console.log(`store to binary took ${performance.now()-e}`),l};

const getTemp=e=>document.getElementById(e).content.firstElementChild,pageTemplate=getTemp("page"),blockTemplate=getTemp("block"),backrefListTemplate=getTemp("backref-list"),blockFocusFrameTemplate=getTemp("block-focus-frame"),pageBreakTemplate=getTemp("page-break"),suggestionTemplate=getTemp("autocomplete__suggestion"),searchResultTemplate=getTemp("search-result"),templateSuggestionTemplate=getTemp("template__suggestion"),breadcrumbBlockTemplate=getTemp("breadcrumb-block"),breadcrumbPageTemplate=getTemp("breadcrumb-page"),backrefFrameTemplate=getTemp("backref-frame"),notificationTemplate=getTemp("notification"),pageRefTemplate=getTemp("page-ref"),tagTemplate=getTemp("tag"),urlTemplate=getTemp("url"),blockRefTemplate=getTemp("block-ref"),boldTemplate=getTemp("bold"),italicTemplate=getTemp("italic"),highlightTemplate=getTemp("highlight"),literalTemplate=getTemp("literal"),templateExpanderTemplate=getTemp("template-expander"),pageFrame=document.getElementById("page-frame"),pageFrameOuter=document.getElementById("page-frame-outer"),searchInput=document.getElementById("search-input"),downloadButton=document.getElementById("download-button"),terminalElement=document.getElementById("terminal"),searchResultList=document.getElementById("search-result-list"),autocompleteList=document.getElementById("autocomplete-list"),templateList=document.getElementById("template-list");

const renderPage=(e,l)=>{const n=store.pages[l],d=pageTemplate.cloneNode(!0),t=d.firstElementChild,a=d.children[1];a.dataset.id=l,d.dataset.id=l,t.innerText=n.title;let i=n.children;i&&0!==i.length||(runCommand("createBlock",l,0),i=n.children);for(var o of i)renderBlock(a,o);if(n.backRefs&&0<n.backRefs.length){const p=backrefListTemplate.cloneNode(!0);d.children[2].appendChild(p),n.backRefs.sort((e,l)=>store.blocks[l]["edit-time"]-store.blocks[e]["edit-time"]);for(var s of n.backRefs){var r=backrefFrameTemplate.cloneNode(!0);renderBreadcrumb(r.children[0],s),renderBlock(r.children[1],s),p.children[1].appendChild(r)}}return e.appendChild(d),d},renderBlock=(e,l,n)=>{const d=blockTemplate.cloneNode(!0),t=d.children[1],a=d.children[2];d.dataset.id=l,a.dataset.id=l,t.dataset.id=l;var i=store.blocks[l].string;i&&renderBlockBody(t,i);l=store.blocks[l].children;if(l)for(var o of l)renderBlock(a,o);return void 0!==n&&e.children.length>=n?e.insertBefore(d,e.children[n]):e.appendChild(d),d},renderBlockBody=(e,l)=>{" "!==l[l.length-1]&&(l+=" ");const n=[e];var d=l.matchAll(/(\[\[)|(\]\])|(#[\/a-zA-Z0-9_-]+)|(\(\([a-zA-Z0-9\-_]{8,50}\)\))|(\*\*)|(\^\^)|(__)|((?:https?\:\/\/)(?:[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6})\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/\/=]*))|`([^`]+)`|(;;(?:[^ \n\r]*))/g);let t=0,a=e;var i,o=e=>{const l=document.createTextNode(e);return l.startIdx=t,l.endIdx=t+e.length,l};const s=[];for(i of d){if(a.appendChild(o(l.substring(t,i.index))),t=i.index,i[1]){const c=pageRefTemplate.cloneNode(!0);a.appendChild(c),c.children[0].appendChild(o("[[")),n.push(c.children[1]),a=n[n.length-1]}else if(i[2])if("page-ref__body"===a.className)a.parentNode.children[2].appendChild(o("]]")),s.push(a.innerText),n.pop(),a=n[n.length-1];else{const h=document.createElement("span");h.className="page-ref-close-missing-open",h.appendChild(o("]]")),a.appendChild(h)}else if(i[3]){s.push(i[3].substring(1));const m=tagTemplate.cloneNode(!0);m.appendChild(o(i[3])),a.appendChild(m)}else if(i[4]){var r=i[4].substring(2,i[4].length-2),p=store.blocks[r];if(p){const f=blockRefTemplate.cloneNode(!0);f.innerText=p.string,f.dataset.id=r,a.appendChild(f)}else a.appendChild(o(i[0]))}else if(i[5])if("bold"===a.className)a.appendChild(o("**")),n.pop(),a=n[n.length-1];else{const g=boldTemplate.cloneNode(!0);a.appendChild(g),g.appendChild(o("**")),n.push(g),a=g}else if(i[6])if("highlight"===a.className)a.appendChild(o("^^")),n.pop(),a=n[n.length-1];else{const C=highlightTemplate.cloneNode(!0);a.appendChild(C),C.appendChild(o("^^")),n.push(C),a=C}else if(i[7])if("italic"===a.className)a.appendChild(o("__")),n.pop(),a=n[n.length-1];else{const b=italicTemplate.cloneNode(!0);a.appendChild(b),b.appendChild(o("__")),n.push(b),a=b}else if(i[8]){const N=urlTemplate.cloneNode(!0);N.appendChild(o(i[8])),N.href=i[8],a.appendChild(N)}else if(i[9]){const u=literalTemplate.cloneNode(!0);u.appendChild(o(i[0])),a.appendChild(u)}else if(i[10]){const k=templateExpanderTemplate.cloneNode(!0);k.appendChild(o(i[0])),a.appendChild(k)}t=i.index+i[0].length}for(n[n.length-1].appendChild(o(l.substring(t)));a!==e;)"page-ref"===a.className&&(a.children[0].className=a.children[0].className+"-incomplete"),a.className=a.className+"-incomplete",a=a.parentNode;return s},renderBreadcrumb=(l,e)=>{const n=[];for(;;){if(e=store.blocks[e].parent,void 0===store.blocks[e]){n.push({title:store.pages[e].title,id:e});break}n.push({string:store.blocks[e].string,id:e})}const d=breadcrumbPageTemplate.cloneNode(!0);var t=n[n.length-1].title;renderBlockBody(d,t),d.dataset.title=t,l.appendChild(d);for(let e=n.length-2;0<=e;e--){const d=breadcrumbBlockTemplate.cloneNode(!0);var a=d.children[1];renderBlockBody(a,n[e].string),d.dataset.id=n[e].id,l.appendChild(d)}},notifyText=(e,l)=>{const n=notificationTemplate.cloneNode(!0);n.innerText=e,document.getElementById("app").appendChild(n),setTimeout(()=>n.style.top="60px",50);l=l&&1e3*l||5e3;setTimeout(()=>n.style.opacity="0",l),setTimeout(()=>{n.remove()},l+300)};

const focusBlockEnd=e=>{const t=e.children[1],o=document.createTextNode(" ");t.appendChild(o),getSelection().collapse(o,0),o.remove()},focusBlockStart=e=>{const t=e.children[1],o=document.createTextNode(" ");t.insertBefore(o,t.firstChild),getSelection().collapse(o,0),o.remove()},dailyNotesInfiniteScrollListener=()=>{if(pageFrame.getBoundingClientRect().bottom-innerHeight<700)for(let e=0;e<100;e++){sessionState.oldestDate.setDate(sessionState.oldestDate.getDate()-1);var t=store.pagesByTitle[formatDate(sessionState.oldestDate)];if(t){renderPage(pageFrame,t),pageFrame.appendChild(pageBreakTemplate.cloneNode(!0));break}}},downloadHandler=()=>{console.log("download");var e=storeToRoamJSON(store),e=new Blob([e],{type:"text/json"}),e=URL.createObjectURL(e);downloadButton.setAttribute("href",e),downloadButton.setAttribute("download",`${store.graphName}-micro-roam.json`)},expandTemplate=()=>{var e=focusSuggestion.dataset.id,t=store.blocks[sessionState.focusId];if(void 0===t.children||0===t.children.length){var o=store.blocks[sessionState.focusId].parent,n=store.blocks[e].children,s=blockOrPageFromId(o).children.indexOf(sessionState.focusId);runCommand("deleteBlock",sessionState.focusId);var l=focusBlock.parentNode;focusBlock.remove();for(let e=0;e<n.length;e++){var a=n[e],i=s+e,a=runCommand("copyBlock",a,o,i),i=renderBlock(l,a,i);0===e&&focusBlockEnd(i)}}else notifyText("can't use a template inside a block that has children");templateList.style.display="none"},autocomplete=()=>{const e=store.blocks[sessionState.focusId].string;var t,o,n;"tag"===editingLink.className?(o=editingLink.childNodes[0],/[^\/a-zA-Z0-9_-]/.test(focusSuggestion.dataset.title)?(t=e.slice(0,o.startIdx)+"[["+focusSuggestion.dataset.title+"]]"+e.slice(o.endIdx),sessionState.position=o.startIdx+focusSuggestion.dataset.title.length+4,setFocusedBlockString(t)):(n=e.slice(0,o.startIdx)+"#"+focusSuggestion.dataset.title+e.slice(o.endIdx),sessionState.position=o.startIdx+focusSuggestion.dataset.title.length+1,setFocusedBlockString(n))):(o=editingLink.children[1].childNodes[0],n=e.slice(0,o.startIdx)+focusSuggestion.dataset.title+e.slice(o.endIdx),sessionState.position=o.startIdx+focusSuggestion.dataset.title.length+2,setFocusedBlockString(n)),autocompleteList.style.display="none"},indentFocusedBlock=()=>{var e,t,o=sessionState.focusId;const n=focusBlock.previousElementSibling;n&&n.dataset&&n.dataset.id&&(e=n.dataset.id,t=blockOrPageFromId(e).children.length,runCommand("moveBlock",o,e,t),n.children[2].appendChild(focusBlock),getSelection().collapse(focusNode,focusOffset))},dedentFocusedBlock=()=>{var e=sessionState.focusId,t=store.blocks[e].parent,o=store.blocks[t];if(o){o=o.parent;const n=blockOrPageFromId(o);t=n.children.indexOf(t);runCommand("moveBlock",e,o,t+1);t=focusBlock.parentNode.parentNode;const s=t.parentNode;t=t.nextElementSibling;t?s.insertBefore(focusBlock,t):s.appendChild(focusBlock),getSelection().collapse(focusNode,focusOffset)}};document.addEventListener("input",o=>{if(updateCursorInfo(),autocompleteList.style.display="none",templateList.style.display="none",sessionState.isFocused)if(" "!==focusBlockBody.innerText&&""!==focusBlockBody.innerText){let t=focusBlockBody.innerText;if("["===o.data){var n,s=o.target.querySelectorAll(".page-ref-close-missing-open");let e=!1;for(n of s)if(console.log(n),n.childNodes[0].startIdx>sessionState.position){e=!0;break}e||(t=t.substring(0,sessionState.position)+"]"+t.substring(sessionState.position))}if(store.blocks[sessionState.focusId].string=t,setFocusedBlockString(t),editingTitle){var l=titleExactFullTextSearch(editingTitle);if(0<l.length){autocompleteList.innerHTML="",autocompleteList.style.display="block";s=editingLink.getBoundingClientRect();autocompleteList.style.top=s.bottom,autocompleteList.style.left=s.left;for(let e=0;e<l.length;e++){matchingTitle=l[e];const i=suggestionTemplate.cloneNode(!0);0===e&&(i.dataset.selected="true"),i.dataset.id=matchingTitle.id,matchingTitle.title?(i.dataset.title=matchingTitle.title,i.innerText=truncateElipsis(matchingTitle.title,50)):(i.dataset.string=matchingTitle.string,i.innerText=truncateElipsis(matchingTitle.string,50)),autocompleteList.appendChild(i)}}}if(editingTemplateExpander){console.log("editingTemplateExpander");var e=editingTemplateExpander.innerText.substring(2),a=searchTemplates(e);if(console.log(a),0<a.length){templateList.innerHTML="";for(let e=0;e<Math.min(a.length,10);e++){const c=templateSuggestionTemplate.cloneNode(!0);0===e&&(c.dataset.selected="true"),c.dataset.string=a[e].string,c.dataset.id=a[e].id,c.innerText=truncateElipsis(a[e].string,50),templateList.appendChild(c)}templateList.style.display="block",templateList.style.top=editingTemplateExpander.getBoundingClientRect().bottom,templateList.style.left=editingTemplateExpander.getBoundingClientRect().left}}}else runCommand("writeBlock",sessionState.focusId,"",[]);else if("search-input"===o.target.id){var t=exactFullTextSearch(o.target.value);if(0<t.length){searchResultList.innerHTML="";for(let e=0;e<Math.min(t.length,10);e++){const r=searchResultTemplate.cloneNode(!0);0===e&&(r.dataset.selected="true"),t[e].title?(r.dataset.title=t[e].title,r.innerText=truncateElipsis(t[e].title,50)):(r.dataset.string=t[e].string,r.dataset.id=t[e].id,r.innerText=truncateElipsis(t[e].string,50)),searchResultList.appendChild(r)}searchResultList.style.display="block",searchResultList.style.top=searchInput.getBoundingClientRect().bottom,searchResultList.style.left=searchInput.getBoundingClientRect().left}else searchResultList.style.display="none"}else"page__title"===o.target.className&&(console.log("edit title"),e=o.target.parentNode.dataset.id,runCommand("writePageTitle",e,o.target.innerText))});const globalHotkeys={"hide top bar":{key:"b",control:!0,fn:()=>{"0px"===topBar.style.marginTop?user.topBar="hidden":user.topBar="visible",saveUser()}},escape:{key:"Escape",fn:()=>{autocompleteList.style.display="none",templateList.style.display="none"}},upload:{key:"d",control:!0,fn:()=>{document.getElementById("upload-input").click()}},download:{key:"s",control:!0,shift:!0,fn:downloadHandler},save:{key:"s",control:!0,fn:debouncedSaveStore},"toggle color theme":{key:"m",control:!0,fn:()=>{"light"===document.body.className?user.theme="dark":user.theme="light",saveUser()}},search:{key:"u",control:!0,fn:()=>{"0px"!==topBar.style.marginTop&&(topBar.style.marginTop="0px"),searchInput.focus()}},open:{key:"o",control:!0,fn:()=>{editingLink&&"page-ref"===editingLink.className&&goto("pageTitle",editingLink.children[1].innerText),editingLink&&"tag"===editingLink.className&&goto("pageTitle",editingLink.innerText.substring(1))}},terminal:{key:"i",control:!0,alt:!0,fn:()=>{"none"===terminalElement.style.display?(terminalElement.style.display="block",terminalElement.focus()):terminalElement.style.display="none"}}};document.addEventListener("keydown",event=>{for(var hotkeyName in updateCursorInfo(),globalHotkeys){const hotkey=globalHotkeys[hotkeyName];if(event.key===hotkey.key&&event.shiftKey===!!hotkey.shift&&event.ctrlKey===!!hotkey.control&&event.altKey===!!hotkey.alt)return hotkey.fn(),void event.preventDefault()}if("none"!==autocompleteList.style.display){"Tab"!==event.key&&"Enter"!==event.key||(autocomplete(),event.preventDefault());const newSelected="ArrowUp"===event.key&&focusSuggestion.previousElementSibling||"ArrowDown"===event.key&&focusSuggestion.nextElementSibling;newSelected&&(newSelected.dataset.selected="true",delete focusSuggestion.dataset.selected,event.preventDefault())}else if("none"!==templateList.style.display){"Tab"!==event.key&&"Enter"!==event.key||(expandTemplate(),event.preventDefault());const newSelected="ArrowUp"===event.key&&focusSuggestion.previousElementSibling||"ArrowDown"===event.key&&focusSuggestion.nextElementSibling;newSelected&&(newSelected.dataset.selected="true",delete focusSuggestion.dataset.selected,event.preventDefault())}else if(sessionState.isFocused){let blocks,newActiveBlock;switch(event.key){case"Enter":if(!event.shiftKey){const parent=blockOrPageFromId(store.blocks[sessionState.focusId].parent);let idx=parent.children.indexOf(sessionState.focusId);event.ctrlKey||(idx+=1),console.log(idx);const newBlockUid=runCommand("createBlock",store.blocks[sessionState.focusId].parent,idx),newBlockElement=renderBlock(focusBlock.parentNode,newBlockUid,idx);newBlockElement.children[1].focus(),event.preventDefault()}break;case"Tab":(event.shiftKey?dedentFocusedBlock:indentFocusedBlock)(),event.preventDefault();break;case"Backspace":0===sessionState.position&&(blocks=Array.from(document.querySelectorAll(".block")),newActiveBlock=blocks[blocks.indexOf(focusBlock)-1],focusBlock.remove(),focusBlockEnd(newActiveBlock),runCommand("deleteBlock",sessionState.focusId),event.preventDefault());break;case"ArrowDown":if(event.altKey&&event.shiftKey){const parentId=store.blocks[sessionState.focusId].parent,parentElement=focusBlock.parentNode,currentIdx=blockOrPageFromId(parentId).children.indexOf(sessionState.focusId);focusBlock.nextElementSibling&&(runCommand("moveBlock",sessionState.focusId,parentId,currentIdx+1),focusBlock.nextElementSibling.nextElementSibling?parentElement.insertBefore(focusBlock,focusBlock.nextElementSibling.nextElementSibling):parentElement.appendChild(focusBlock),getSelection().collapse(focusNode,focusOffset),event.preventDefault())}else event.shiftKey||event.altKey||(blocks=Array.from(document.querySelectorAll(".block")),newActiveBlock=blocks[blocks.indexOf(focusBlock)+1],focusBlockStart(newActiveBlock),event.preventDefault());break;case"ArrowUp":if(event.altKey&&event.shiftKey){const parentId=store.blocks[sessionState.focusId].parent,parentElement=focusBlock.parentNode,currentIdx=blockOrPageFromId(parentId).children.indexOf(sessionState.focusId);focusBlock.previousElementSibling&&(runCommand("moveBlock",sessionState.focusId,parentId,currentIdx-1),parentElement.insertBefore(focusBlock,focusBlock.previousElementSibling),getSelection().collapse(focusNode,focusOffset),event.preventDefault())}else event.shiftKey||event.altKey||(blocks=Array.from(document.querySelectorAll(".block")),newActiveBlock=blocks[blocks.indexOf(focusBlock)-1],focusBlockEnd(newActiveBlock),event.preventDefault());break;case"ArrowLeft":event.shiftKey&&event.altKey?dedentFocusedBlock():0===sessionState.position&&(blocks=Array.from(document.querySelectorAll(".block")),newActiveBlock=blocks[blocks.indexOf(focusBlock)-1],focusBlockEnd(newActiveBlock),event.preventDefault());break;case"ArrowRight":event.shiftKey&&event.altKey?indentFocusedBlock():sessionState.position===focusBlockBody.innerText.length&&(blocks=Array.from(document.querySelectorAll(".block")),newActiveBlock=blocks[blocks.indexOf(focusBlock)+1],newActiveBlock&&focusBlockStart(newActiveBlock),event.preventDefault())}}if(document.activeElement&&"search-input"===document.activeElement.id){if("Enter"===event.key)return goto("pageTitle",event.target.value),void event.preventDefault();if("Tab"===event.key){const selected=searchResultList.querySelector('.search-result[data-selected="true"]');if(selected)return void(selected.dataset.title?goto("pageTitle",selected.dataset.title):goto("block",selected.dataset.id))}}if("none"!==terminalElement.style.display&&"Enter"===event.key&&!event.ctrlKey&&!event.shiftKey&&!event.altKey){const tc=terminalCommands[event.target.innerText];if(tc)tc();else try{eval(event.target.innerText),event.ctrlKey||(terminalElement.style.display="none",terminalElement.innerHTML="")}catch(error){console.log(error),event.preventDefault()}}}),document.addEventListener("click",e=>{var t=e.target.closest(".block__bullet");if("search-result"!==e.target.className){"search-input"!==e.target.id&&(searchResultList.style.display="none");var o=e.target.closest(".breadcrumb-page"),n=e.target.closest(".breadcrumb-block");if("page-ref__body"===e.target.className)goto("pageTitle",e.target.innerText);else if(t)goto("block",t.parentNode.dataset.id);else if("block-ref"===e.target.className)goto("block",e.target.dataset.id);else if("url"===e.target.className){const s=document.createElement("a");s.target="_blank",s.href=e.target.innerText,s.click()}else e.target.closest(".tag")?goto("pageTitle",e.target.closest(".tag").innerText.substring(1)):"download-button"===e.target.id?downloadHandler():"template__suggestion"===e.target.className?(focusSuggestion&&(focusSuggestion.dataset.selected=!1),e.target.dataset.selected=!0,focusSuggestion=e.target,expandTemplate()):"upload-button"===e.target.id?document.getElementById("upload-input").click():"daily-notes-button"===e.target.id?goto("dailyNotes"):"autocomplete__suggestion"===e.target.className?(focusSuggestion&&(focusSuggestion.dataset.selected=!1),e.target.dataset.selected=!0,autocomplete()):"help-button"===e.target.id?goto("pageTitle","Welcome to Micro Roam"):o?goto("pageTitle",o.dataset.title):n&&goto("block",n.dataset.id);updateCursorInfo()}else e.target.dataset.title?goto("pageTitle",e.target.dataset.title):goto("block",e.target.dataset.id)});const commonAncestorNode=(e,t)=>{const o=[];for(;void 0!==e.dataset.id;)aSet.push(e.dataset.id),e=e.parentNode.parentNode;const n=[];for(;void 0===o.indexOf(t.dataset.id);)n.push(t.dataset.id),t=t.parentNode.parentNode;o[o.indexOf(t.dataset.id)-1];return n[-1]},mouseMoveListener=t=>{if(t.target.closest(".block"))for(let e=0;e<t.path.length;e++)t.path};document.addEventListener("mousedown",e=>{updateCursorInfo(),document.addEventListener("mousemove",mouseMoveListener),e.target.closest(".block")&&(dragSelectStartBlock=null)}),document.addEventListener("mouseup",e=>{null!==dragSelectStartBlock&&(document.removeEventListener("mousemove",mouseMoveListener),dragSelectStartBlock=null)}),topBarHiddenHitbox.addEventListener("mouseover",()=>{user.topBar="visible",saveUser()}),document.getElementById("upload-input").addEventListener("change",e=>{const t=e.target.files[0];console.log(t);var{name:o,ext:e}=splitFileName(t.name);console.log(`name ${o} extension ${e}`),"zip"===e?t.arrayBuffer().then(e=>{e=zipToFiles(e);if(console.log(e),1===e.length&&"json"===e[0].ext)store=roamJsonToStore(e[0].name,e[0].text),fetch("./default-store.json").then(e=>e.json().then(e=>{mergeStore(e),theresANewStore()}));else throw notifyText("Markdown import doesn't work yet. Upload a .json file, or a .zip file containing a .json file instead.",12),new Error("md import doesn't work")}):"json"===e?t.text().then(e=>{user.graphName=o,store=roamJsonToStore(o,e),fetch("./default-store.json").then(e=>e.json().then(e=>{mergeStore(e),theresANewStore()}))}):notifyText("Micro Roam only accepts a .json file, a .zip file containing 1 .json file, or a .zip file containing .md files")});

const initialDailyNotes=5,renderSessionState=()=>{switch(searchResultList.style.display="none",pageFrameOuter.removeEventListener("scroll",dailyNotesInfiniteScrollListener),pageFrame.innerHTML="",searchInput.value="",sessionState.pageFrame){case"pageTitle":let e=store.pagesByTitle[sessionState.pageFrameTitle];void 0===e&&(e=runCommand("createPage",sessionState.pageFrameTitle)),renderPage(pageFrame,e);break;case"block":const i=blockFocusFrameTemplate.cloneNode(!0);pageFrame.appendChild(i),renderBreadcrumb(i.children[0],sessionState.pageFrameId),renderBlock(i.children[1],sessionState.pageFrameId);const r=store.blocks[sessionState.pageFrameId].backRefs;if(r){r.sort((e,t)=>store.blocks[t]["edit-time"]-store.blocks[e]["edit-time"]);var s,o=backrefListTemplate.cloneNode(!0);i.children[2].appendChild(o);for(s of r)renderBlock(o.children[1],s)}break;case"dailyNotes":pageFrameOuter.addEventListener("scroll",dailyNotesInfiniteScrollListener),sessionState.oldestDate=new Date(Date.now());let t=0;void 0===store.pagesByTitle[formatDate(sessionState.oldestDate)]&&runCommand("createPage",formatDate(sessionState.oldestDate));for(let e=0;e<1e3;e++){var a=store.pagesByTitle[formatDate(sessionState.oldestDate)];if(a&&(renderPage(pageFrame,a),pageFrame.appendChild(pageBreakTemplate.cloneNode(!0)),t+=1,t>=initialDailyNotes))break;sessionState.oldestDate.setDate(sessionState.oldestDate.getDate()-1)}t<initialDailyNotes&&pageFrame.lastChild.remove()}sessionState.isFocused&&focusIdPosition(),pageFrameOuter.scrollTop=sessionState.scroll||0},gotoNoHistory=(e,...t)=>{switch(e){case"dailyNotes":sessionState.pageFrame="dailyNotes";break;case"pageTitle":sessionState.pageFrame="pageTitle",sessionState.pageFrameTitle=t[0];break;case"block":sessionState.pageFrame="block",sessionState.pageFrameId=t[0]}renderSessionState()},goto=(...e)=>{sessionState.scroll=pageFrameOuter.scrollTop;var t=JSON.parse(JSON.stringify(sessionState));sessionState.isFocused=!1,sessionState.scroll=0,gotoNoHistory(...e),setTimeout(()=>{history.replaceState(t,"Micro Roam"),history.pushState(sessionState,"Micro Roam")},0)},gotoReplaceHistory=(...e)=>{gotoNoHistory(...e),history.replaceState(sessionState,"Micro Roam")};window.addEventListener("popstate",e=>{console.log(e.state),e.state&&(sessionState=e.state,renderSessionState())});const focusIdPosition=()=>{focusBlockBody=document.querySelector(`.block[data-id="${sessionState.focusId}"]>.block__body`);const o=e=>{for(var t of e.childNodes)if("#text"===t.nodeName){if(t.textContent&&sessionState.position>=t.startIdx&&sessionState.position<t.startIdx+t.textContent.length){scanResult=t;try{return getSelection().collapse(t,sessionState.position-t.startIdx),t}catch(e){return t}}}else{var s=o(t);if(s)return s}};o(focusBlockBody)},setFocusedBlockString=e=>{focusBlockBody.innerHTML="";var t=renderBlockBody(focusBlockBody,e);focusIdPosition(),updateCursorInfo(),runCommand("writeBlock",sessionState.focusId,e,t)},updateCursorInfo=()=>{if(focusNode=getSelection().focusNode,focusOffset=getSelection().focusOffset,focusSuggestion=autocompleteList.querySelector('.autocomplete__suggestion[data-selected="true"]')||templateList.querySelector('.template__suggestion[data-selected="true"]'),focusNode)if(focusBlock=focusNode.parentNode.closest(".block"),focusBlock){sessionState.isFocused=!0,sessionState.focusId=focusBlock.dataset.id,"block__body"===focusNode.className?sessionState.position=focusBlock.innerText.length*(0!==focusOffset):(sessionState.position=focusOffset,focusNode.startIdx&&(sessionState.position+=focusNode.startIdx)),focusBlockBody=focusBlock.children[1],editingLink=void 0;var e,t,s,o=focusBlockBody.querySelectorAll(".page-ref");for(e of focusBlockBody.querySelectorAll(".tag"))e.childNodes[0].endIdx>=sessionState.position&&e.childNodes[0].startIdx<sessionState.position&&(editingLink=e);for(t of o)t.children[1].childNodes[0].endIdx>=sessionState.position&&t.children[1].childNodes[0].startIdx<sessionState.position&&(editingLink=t);editingTitle=editingLink&&("tag"===editingLink.className&&editingLink.innerText.substring(1)||"page-ref"===editingLink.className&&editingLink.children[1].innerText),editingTemplateExpander=void 0;for(s of focusBlockBody.querySelectorAll(".template-expander"))s.childNodes[0].endIdx>=sessionState.position&&s.childNodes[0].startIdx<sessionState.position&&(editingTemplateExpander=s)}else sessionState.isFocused=!1;else sessionState.isFocused=!1},parseStackTrace=e=>{const t=[];var s;for(s of e.matchAll(/([^ ]+) \(([^\)]+):([0-9]+):([0-9]+)\)(?:\n|$)/g))t.push({function:s[1],file:s[2],line:s[3],column:s[4]});return t},logError=(e,t,s,o,a)=>{e={line:s,file:t,stack:parseStackTrace(a.stack),message:e,column:o},o=localStorage.getItem("error_log");if(o){const i=JSON.parse(o);i.push(e),localStorage.setItem("error_log",JSON.stringify(i))}else localStorage.setItem("error_log",JSON.stringify([e]));return!1};window.onerror=logError,w?theresANewStore():w=!0;
</script>

  <!--got dailynotes references dailynotesinfinitescrolllistener, so events is before index
  would only save 1ms by loading it later anyway-->

  <!-- now rendering is done, loading interactive scripts-->

  
<script>
const page=e=>{console.log(store.pages[store.pagesByTitle[e]])},log=()=>{user.logging=!0,saveUser()},nolog=()=>{user.logging=!1,saveUser()},test=()=>{const e=document.createElement("script");e.src="test.js",document.body.appendChild(e)},reset=()=>{indexedDB.deleteDatabase("microroam");localStorage.removeItem("user"),window.location.href=window.location.href},blank=()=>{store=blankStore(),user=blankUser,saveUser(),goto("dailyNotes")},pr=()=>{console.log(JSON.stringify(store))},downloadBinary=()=>{var e=storeToBinary(),e=new Blob([e],{type:"application/x-micro-roam"}),e=URL.createObjectURL(e);const o=document.createElement("a");o.setAttribute("href",e),o.setAttribute("download",`${store.graphName}.mrm`),o.click()},terminalCommands={blank:blank,reset:reset,test:test,log:log,page:page,nolog:nolog,pr:pr,downloadBinary:downloadBinary};
</script>

</body>