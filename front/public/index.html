<body>
  <div id="app">
    <div id="top-bar" style="margin-top:0px">
      <a id="report-issue-button" target="_blank" href="mailto:taoroalin@gmail.com?subject=You Made Micro Roam Wrong"
        tabindex="-1">
        Report Issue
      </a>
      <button id="help-button" tabindex="-1">
        Help
      </button>
      <button id="daily-notes-button" tabindex="-1">
        Daily Notes
      </button>
      <input id="search-input" placeholder="search" tabindex="-1">
      <button id="upload-button" tabindex="-1">
        <input style="display:none" type="file" id="upload-input">
        Upload JSON
      </button>
      <a id="download-button" tabindex="-1">
        Download JSON
      </a>
    </div>

    <div id="top-bar-hidden-hitbox" style="position:fixed;height:15px;width:100%"></div>

    <div id="terminal" contenteditable="true" style="display:none"></div>

    <div id="page-frame-outer">
      <div id="page-frame">

      </div>
    </div>

    
<script>
const r=indexedDB.open("microroam",4),blankUser={graphName:"default",theme:window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",topBar:"visible",logging:!1,spellcheck:!1};let user=blankUser;const storedUser=localStorage.getItem("user");storedUser&&(user=JSON.parse(storedUser));const topBar=document.getElementById("top-bar"),topBarHiddenHitbox=document.getElementById("top-bar-hidden-hitbox"),showTopBar=()=>{topBar.style.marginTop="0px",topBarHiddenHitbox.style.display="none"},hideTopBar=()=>{topBar.style.marginTop="-46px",topBarHiddenHitbox.style.display="block"},saveUser=()=>{document.body.className=user.theme,("visible"===user.topBar?showTopBar:hideTopBar)(),localStorage.setItem("user",JSON.stringify(user))};saveUser(),r.onsuccess=e=>{idb=e.target.result,idb.transaction(["stores"],"readonly").objectStore("stores").get(user.graphName).onsuccess=e=>{e.target.result?(store=JSON.parse(e.target.result.store),finishStartupThread()):(console.log("adding default graph"),fetch("./default-store.json").then(e=>e.json().then(e=>{store=e,user.graphName=e.graphName,startCommand=["pageTitle","Welcome to Micro Roam"],finishStartupThread()})))}},r.onupgradeneeded=e=>{const t=r.result,s=Array.from(t.objectStoreNames);s.includes("stores")||t.createObjectStore("stores",{keyPath:"graphName"})},r.onerror=e=>{alert(`In order to save your notes between sessions, Micro Roam needs access to IndexedDB. 
      You can allow access by exiting "private browsing" mode, or by using a newer browser, or by changing browser settings`)};let startupThreads=2;const finishStartupThread=()=>{startupThreads<=1?theresANewStore():startupThreads--},theresANewStore=()=>{user.graphName=store.graphName,saveUser(),gotoNoHistory(...startCommand),debouncedSaveStore()};let store=null,refs=null,titles=null,idb=null,startCommand=["dailyNotes"],commitDebounce=null,editingTemplateExpander=null,editingLink=null,editingTitle=null,focusNode=null,focusOffset=null,focusBlock=null,focusSuggestion=null,sessionState={pageFrame:"dailyNotes",focusId:null,scroll:0,position:null},dragSelectStartBlock=null,dragSelect=null,clipboardData=null;
</script>


    <div id="autocomplete-list" style="display:none"></div>
    <!-- inline styles on this site are all edited directly by js -->
    <div id="search-result-list" style="display:none"></div>
    <div id="template-list" style="display:none"></div>

  </div>

  <title>Micro Roam</title>

  
<style>
/* global styles ----------------------------------------------------------------------------- */
*{
  outline:none;
  scrollbar-width:none;
}

.dark{
  --background:#161616;
  --text: rgb(246, 246, 246);
  --link: #3f84c0;
  --brackets:#A7B6C2;
  --block-ref:rgb(63, 63, 63);
  --bullet:#758897;
  --border:#afbeca;
  --break: #838e97;
  --highlight:rgb(110, 93, 16);
  --click:darkgrey;
  --page-ref:#2bcc5b;
  --shadow:rgb(98, 98, 98);
  --notification:#2e4736;
  --selected:#2d4a66;
}

.light{
  --background:white;
  --text:black;
  --link: rgb(54, 123, 184);
  --brackets:#A7B6C2;
  --block-ref:lightgrey;
  --bullet:#394B59;
  --border:#585e64;
  --shadow:#585e64;
  --break:#a8b4be;
  --highlight:rgb(255, 239, 146);
  --click:rgb(197, 197, 197);
  --page-ref:rgb(73, 197, 91);
  --notification:#a4d1b1;
  --selected:#abcdeb;
}

input, button, a{
  font-family: 'Inter', Verdana;
}

input{
  border:none;
}

button{
  appearance: none;
  border:none;
  box-shadow: none;
  cursor:pointer;
  background-color:inherit;
  color:inherit;
  font-size:inherit;
}

span{
  margin:0;
  padding:0;
}

::-webkit-scrollbar{
  width:0%;
  height:0%;
}

::selection{
  background-color:#85b7e8;
  color:var(--text);
}

body {
    scrollbar-width: 0px;
    font-family: 'Inter', Verdana, Arial;
    font-weight: normal;
    margin: 0;
    color:var(--text);
    background-color: var(--background);
}

a{
  color:var(--link);
}

a:visited { color:var(--link) }

.notification{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  top:-40px; /* transitions to more px */
  margin-top: 0px;
  opacity:1;
  transition: top 0.25s ease-out, opacity 0.2s linear;
  padding:20px;
  background-color:var(--notification);
  border-radius:8px;
}


/* singular element styles --------------------------------------------------------------------------------------- */

#app{
  height:100%;
  width:100%;
  display:flex;
  flex-direction: column;
}

#page-frame-outer{
  width:100%;
  overflow-y:scroll;
}

#page-frame{
  margin: 0 auto 30px;
  max-width: min(900px, 100%);
}

#top-bar{
  width:100%;
  display: flex;
  flex-direction: row;
  align-content: space-between;
  background-color:var(--background);
  transition:margin-top 0.1s;
}

/* these have different paddings, but look the same because weird stuff. todo investigate */
#top-bar a{
  padding: 14px 10px 10px;
  font-size:0.9em;
}
#top-bar button{
  padding: 12px 10px 10px;
  font-size:0.9em;
}


#download-button, #report-issue-button {
  color:var(--text);
  display:block;
  cursor:pointer;
  text-decoration: none;
}

#search-input{
  background-color:var(--background);
  color:var(--text);
  padding:3px 13px;
  margin: 7px 5px 5px;
  display:block;
  font-size:1.2em;
  box-shadow:0 0 2px var(--shadow);
  border-radius:100px;
  flex-grow: 1;
}

#autocomplete-list, #template-list{
  position:absolute;
  display:flex;
  flex-direction: column;
  background-color:var(--background);
  font-size:1.3em;
  border-radius:5px;
  box-shadow: 0 0 8px var(--shadow);
}

.autocomplete__suggestion[data-selected="true"],.template__suggestion[data-selected="true"]{
  background-color:var(--click);
}

.autocomplete__suggestion, .template__suggestion{
  padding:7px;
  cursor:pointer;
  border-radius: 5px;
}


#search-result-list{
  position:absolute;
  display:flex;
  flex-direction: column;
  background-color:var(--background);
  font-size:1.3em;
  border-radius:5px;
  box-shadow: 0 0 8px var(--shadow);
}

.search-result[data-selected="true"]{
  background-color:var(--click);
}

.search-result{
  padding:7px;
  cursor:pointer;
  border-radius: 5px;
}

/* Page styles --------------------------------------------------------------------------------------------------- */

.page{
  margin-right:30px;
  margin-left:30px;
  position:relative;
}

.page__title{
  font-size: 36px;
  margin: 40px 0 20px 0;
}

.page__body, .backref-frame__body{
  margin-left:20px;
}

.backref-list__body{
  margin-left:10px;
}

.backref-list__title{
  font-size: 1.2em;
  font-weight:bold;
  padding: 20px 0 0;
}

.page-break{
  height:0px;
  margin: 60px 25px;
  border:1px solid var(--break);
  border-width: 1px 0 0 0;
}


.block{
  position:relative;
  border-radius:5px;
}

.block[data-selected="true"]{
  background-color:var(--selected);
}

.block__body{
  padding:5px 0;
}

.block__bullet{
  cursor:pointer;
  position:absolute;
  left:-21px;
  top:4px;
}

.block__children{
  margin-left: 25px;
}

.block-focus-frame{
  margin: 60px 0;
}

.breadcrumb-page{
  cursor:pointer;
}

.breadcrumb-block{
  cursor:pointer;
}

.backref-frame__breadcrumb{
  margin:15px 0 5px 0;
  font-size:1.2em;
}

.block-focus-frame__breadcrumb{
  margin:15px 0 5px 0;
  font-size:1.2em;
}

/* Parsed block styles -------------------------------------------------------------------------------------- */

.page-ref{
  position:relative;
}

.page-ref__brackets{
  font-weight: lighter;
  color:var(--brackets);
}

.page-ref__body{
  color:var(--page-ref);
  font-weight: 800;
}

.page-ref:hover{
  cursor:pointer;
}

.page-ref:hover>.page-ref__body{
  text-decoration: underline;
}

.tag{
  color:var(--page-ref);
  font-weight: 800;
  position:relative;
}

.tag:hover{
  text-decoration: underline;
  cursor:pointer;
}

.block-ref{
  background-color:var(--block-ref);
}

.block-ref:hover{
  text-decoration: underline;
  cursor:pointer;
}

.bold{
  font-weight:bold;
}

.italic{
  font-style:italic;
}

.highlight{
  background-color: var(--highlight);
  border-radius:2px;
  padding:1px;
}

.block-focus-frame{
  margin: 35px 0 0 60px;
}

.url{
  color:var(--link);
  text-decoration: underline;
  cursor:pointer;
}

.literal{
  font-family:'Inconsolata';
  font-size:1.15em;
}

.attribute{
  font-weight: bold;
}

.attribute:hover{
  cursor:pointer;
}

#terminal{
  font-family:'Inconsolata';
  width:100%;
  padding:8px;
  background-color: black;
  color:white;
}
</style>


  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata">

  <template id="page">
    <div class="page">
      <h1 class="page__title" contenteditable="true" tabindex="-1" spellcheck="false"></h1>

      <div class="page__body">

      </div>
      <div class="page__backlinks">

      </div>
    </div>
  </template>

  <template id="block">
    <div class="block">
      <svg class="block__bullet" width="20" height="20">
        <circle cx="10" cy="10.5" r="3" fill="var(--bullet)" />
      </svg>
      <div class="block__body" contenteditable="true" tabindex="-1" spellcheck="false">
      </div>
      <div class="block__children">

      </div>
    </div>
  </template>

  <template id="backref-list">
    <div class="backref-list">
      <div class="backref-list__title">Linked References</div>
      <div class="backref-list__body"></div>
    </div>
  </template>

  <template id="page-break">
    <div class="page-break"></div>
  </template>

  <template id="block-focus-frame">
    <div class="block-focus-frame">
      <div class="block-focus-frame__breadcrumb"></div>
      <div class="block-focus-frame__body"></div>
      <div class="block-focus-frame__backlinks"></div>
    </div>
  </template>

  <template id="backref-frame">
    <div class="backref-frame">
      <div class="backref-frame__breadcrumb"></div>
      <div class="backref-frame__body"></div>
    </div>
  </template>

  <template id="page-ref">
    <span class="page-ref"><span class="page-ref__brackets"></span><span class="page-ref__body"></span><span
        class="page-ref__brackets"></span></span>
  </template>

  <template id="tag">
    <span class="tag"></span>
  </template>

  <template id="block-ref">
    <span class="block-ref"></span>
  </template>

  <template id="block-ref">
    <span class="block-ref"></span>
  </template>

  <template id="bold">
    <span class="bold"></span>
  </template>

  <template id="italic">
    <span class="italic"></span>
  </template>

  <template id="highlight">
    <span class="highlight"></span>
  </template>

  <template id="literal">
    <span class="literal"></span>
  </template>

  <!-- this is a bit silly, since this element doesn't show up as anyting, but for consistancy?? -->
  <template id="template-expander">
    <span class="template-expander"></span>
  </template>

  <!--using spans with event handlers as links because they play nice with contenteditable-->
  <template id="url">
    <span class="url"></span>
  </template>

  <template id="attribute">
    <span class="attribute"></span>
  </template>

  <template id="autocomplete__suggestion">
    <div class="autocomplete__suggestion"></div>
  </template>

  <template id="template__suggestion">
    <div class="template__suggestion"></div>
  </template>

  <template id="search-result">
    <div class="search-result"></div>
  </template>

  <template id="breadcrumb-block">
    <span class="breadcrumb-block"><span class="breadcrumb-block__arrow">-></span><span
        class="breadcrumb-block__body"></span></span>
  </template>

  <template id="breadcrumb-page">
    <span class="breadcrumb-page"></span>
  </template>

  <template id="notification">
    <div class="notification"></div>
  </template>

  
<script>
const monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"],getOrdinal=e=>{var t=e%10,r=e%100;return 1==t&&11!=r?e+"st":2==t&&12!=r?e+"nd":3==t&&13!=r?e+"rd":e+"th"},formatDate=e=>`${monthNames[e.getMonth()]} ${getOrdinal(e.getDate())}, ${e.getFullYear()}`,truncateElipsis=(e,t=40)=>e.length>t?e.substring(0,t-3)+"...":e;

const storeToRoamJSON=u=>{const e=[],d=e=>{const r={uid:e},s=u.blocks[e];return Object.assign(r,s),s.children&&(r.children=s.children.map(d)),r[":create/user"]={":user/uid":u.ownerRoamId},r[":edit/user"]={":user/uid":u.ownerRoamId},s[":create/user"]&&(r[":create/user"]={":user/uid":s[":create/user"]}),s[":edit/user"]&&(r[":edit/user"]={":user/uid":s[":edit/user"]}),s.refs&&(r.refs=s.refs.map(e=>({uid:e}))),s[":block/refs"]&&(r[":block/refs"]=s[":block/refs"].map(e=>({":block/uid":e}))),delete r.backRefs,delete r.parent,r};for(var r in u.pages){const s=u.pages[r],i={uid:r};e.push(i),Object.assign(i,s),delete i.backRefs,s.children&&(i.children=s.children.map(d)),i[":create/user"]={":user/uid":u.ownerRoamId},i[":edit/user"]={":user/uid":u.ownerRoamId},s[":create/user"]&&(i[":create/user"]={":user/uid":s[":create/user"]}),s[":edit/user"]&&(i[":edit/user"]={":user/uid":s[":edit/user"]})}return console.log(e),JSON.stringify(e)};

const cpy=e=>JSON.parse(JSON.stringify(e)),getIn=(t,r)=>{let s=store;for(let e=0;e<t.length-r;e++)void 0===s[t[e]]&&(s[t[e]]={}),s=s[t[e]];return s},doEdits=e=>{if(e.subtract)for(var t of e.subtract){const c=getIn(t,2);var r=t[t.length-2];c[r]=c[r].filter(e=>e!=t[t.length-1])}if(e.write)for(var s of e.write){const d=getIn(s,2);d[s[s.length-2]]=cpy(s[s.length-1])}if(e.add)for(var o of e.add){const g=getIn(o,2);g[o[o.length-2]].push(cpy(o[o.length-1]))}if(e.insert)for(var n of e.insert){const p=getIn(n,3);var i=n[n.length-3],a=n[n.length-2],n=n[n.length-1];let e=p[i];if(void 0===e)e=[a],p[i]=e;else{if(e.length<n)throw console.log(e),console.log(i),new Error("tried to insert past end of list");p[i]=e.slice(0,n),p[i].push(cpy(a)),p[i].push(...e.slice(n))}}if(e.delete)for(var l of e.delete){const f=getIn(l,1);delete f[l[l.length-1]]}print(e)},saveStore=()=>{const e=idb.transaction(["stores"],"readwrite"),t=e.objectStore("stores");var r=JSON.stringify(store);const s=t.put({graphName:store.graphName,store:r});s.onsuccess=()=>{console.log("saved")},s.onerror=e=>{console.log("save error"),console.log(error)}};let saveStoreTimeout=null;const debouncedSaveStore=()=>{clearTimeout(saveStoreTimeout),saveStoreTimeout=setTimeout(saveStore,500)},print=e=>{user.logging&&console.log(e)},CHARS_64="-_0123456789abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ",newUid=()=>{var t=new Uint8Array(9);let r;do{crypto.getRandomValues(t),r="";for(let e=0;e<9;e++)r+=CHARS_64[t[e]%64]}while(void 0!==store.pages[r]||void 0!==store.blocks[r]);return r},newUUID=()=>{var t=new Uint8Array(21);crypto.getRandomValues(t);let r="";for(let e=0;e<21;e++)r+=CHARS_64[t[e]%64];return r},blockOrPageFromId=e=>store.blocks[e]||store.pages[e],parentThingey=e=>store.pages[e]?"pages":"blocks",commands={deleteBlock:t=>{var e=store.blocks[t],r=e.parent;const s=e[":block/refs"]||[],o=e.backRefs||[];return{edits:{subtract:[[parentThingey(e.parent),r,"children",t],...s.map(e=>[parentThingey(e),e,"backRefs",t]),...o.map(e=>[parentThingey(e),e,"refs",t])],delete:[["blocks",t]]}}},moveBlock:(e,t,r,s)=>{var o=store.blocks[e].parent;return{edits:{write:[["blocks",e,"parent",t]],insert:[[parentThingey(t),t,"children",e,r]],subtract:[[parentThingey(o),o,"children",e]]},returns:void 0}},writeBlock:(r,e,t,s)=>{var o;const n=store.blocks[r][":block/refs"],i={write:[],subtract:[],add:[],delete:[]},a=t.map(e=>{let t=store.pagesByTitle[e];return void 0!==t?n.includes(t)||i.add.push(["pages",t,"backRefs",r]):(t=newUid(),i.write.push(["pages",t,{title:e,children:[],":create/time":s,backRefs:[r]}]),i.write.push(["pagesByTitle",e,t])),t});if(i.write.push(["blocks",r,"string",e],["blocks",r,"edit-time",s],["blocks",r,":block/refs",a]),n)for(var l of n)a.includes(l)||(o=store.pages[l],"pages"!==parentThingey(l)||void 0!==o.children&&0!==o.children.length||!(void 0===o.backRefs||o.backRefs.length<=1)?i.subtract.push([parentThingey(l),l,"backRefs",r]):(i.delete.push(["pagesByTitle",o.title]),i.delete.push(["pages",l])));return{edits:i}},createBlock:(e,t,r)=>{var s=newUid(),o=store.pages[e]?"pages":"blocks";return{edits:{write:[["blocks",s,{string:"",parent:e,":create/time":r,children:[],backRefs:[],":block/refs":[],refs:store[o].refs}]],insert:[[o,e,"children",s,t]]},returns:s}},createPage:(e,t)=>{var r=newUid();return{edits:{write:[["pages",r,{title:e,":create/time":t}],["pagesByTitle",e,r]]},returns:r}},writePageTitle:(e,t,r)=>{var s=store.pages[e],o=s.title;const n={write:[["pages",e,"title",t],["pages",e,"edit-time",r],["pagesByTitle",t,e]],delete:[["pagesByTitle",o]]};if(s.backRefs)for(var i of s.backRefs){let e=store.blocks[i].string;n.write.push(["blocks",i,"string",e.replaceAll(o,t)])}return{edits:n}},copyBlock:(e,t,r,l)=>{var s=newUid();const c={write:[],insert:[[parentThingey(t),t,"children",s,r]],subtract:[]},d=(e,t,r)=>{var s,o=store.blocks[e];const n={"create-time":l,string:o.string,parent:r};for(s of LIST_PROPS)o[s]&&(n[s]=Array.from(o[s]));if(o.children){n.children=[];for(var i of o.children){var a=newUid();d(i,a,t),n.children.push(a)}}c.write.push(["blocks",t,n])};return d(e,s,t),{edits:c,returns:s}}},runCommand=(...e)=>{print(e);var{edits:t,returns:e}=commands[e[0]](...e.slice(1),Date.now());return doEdits(t),debouncedSaveStore(),e};

const blankStore=()=>({graphName:"default",ownerRoamId:"default",blocks:{},pages:{},pagesByTitle:{}}),LIST_PROPS=["refs",":block/refs","backRefs"],LIST_PROPS_FORWARD=["refs",":block/refs"],LOCAL_FILE_SIGNATURE=67324752,END_CENTRAL_DIR_SIGNATURE=101010256,CENTRAL_FILE_SIGNATURE=33639248,ARCHIVE_EXTRA_RECORD_SIGNATURE=134630224,ZIP64_END_CENTRAL_SIGNATURE=101075792,splitFileName=e=>{var r=e.match(/\.([a-z]+)$/);return{name:e.substring(0,r.index),ext:r[1]}},zipToFiles=e=>{var r=new Uint8Array(e),o=r.length;let t=0;const s=[];for(;t<o;){var a=new ArrayBuffer(4);const d=new Uint8Array(a);for(let e=0;e<4;e++)d[e]=r[t+e];var n=new Uint32Array(a)[0];if(n!==LOCAL_FILE_SIGNATURE){if(n===END_CENTRAL_DIR_SIGNATURE)break;console.log(`got signature ${n}`);break}var l=new Uint16Array(e,8,1)[0];if(0!==l)return console.log(l),void notifyText("Micro Roam can't handle .zip files that are actually compressed. use a .json file or an uncompressed .zip file, like ones exported by Roam Research or Micro Roam",10);{var i=new ArrayBuffer(12);const p=new Uint8Array(i);for(let e=0;e<12;e++)p[e]=r[e+18+t];var c=new Uint32Array(i),f=(c[0],c[1]),a=c[2];if(1441805<=a)break;const g=new TextDecoder;var n=g.decode(new Uint8Array(e,t+30,a)),{name:l,ext:i}=splitFileName(n),c=g.decode(new Uint8Array(e,t+30+a,f));s.push({name:l,ext:i,text:c,fullName:n}),t+=30+a+f}}return s},roamJsonToStore=(e,r)=>{var o,t,s,a=performance.now(),r=JSON.parse(r);const n={},l={},i={};let c=null;r[0][":edit/user"]&&(c=r[0][":edit/user"][":user/uid"]);const f=(r,e)=>{if((l[r.uid]=r).parent=e,r[":create/user"]&&r[":create/user"][":user/uid"]!==c?r[":create/user"]=r[":create/user"][":user/uid"]:delete r[":create/user"],r[":edit/user"]&&r[":edit/user"][":user/uid"]!==c?r[":edit/user"]=r[":edit/user"][":user/uid"]:delete r[":edit/user"],r.children){const s=r.children;r.children=s.map(e=>e.uid),s.forEach(e=>f(e,r.uid))}if(r.refs&&(r.refs=r.refs.map(e=>e.uid)),r[":block/refs"]&&(r[":block/refs"]=r[":block/refs"].map(e=>e[":block/uid"])),delete r.uid,r.backRefs=[],r[":block/props"]&&r[":block/props"][":drawing/lines"])for(var o of r[":block/props"][":drawing/lines"])o[":points"]=o[":points"].map(e=>[Math.round(e[0]),Math.round(e[1])]);if(r.props&&r.props.lines)for(var t of r.props.lines)t.points=t.points.map(e=>[Math.round(e[0]),Math.round(e[1])])};for(o of r){if(i[o.title]=o.uid,n[o.uid]=o,o[":create/user"]&&o[":create/user"][":user/uid"]!==c?o[":create/user"]=o[":create/user"][":user/uid"]:delete o[":create/user"],o[":edit/user"]&&o[":edit/user"][":user/uid"]!==c?o[":edit/user"]=o[":edit/user"][":user/uid"]:delete o[":edit/user"],void 0!==o.children){var d,p=o.children;o.children=[];for(d of p)o.children.push(d.uid),f(d,o.uid)}delete o.uid,o.backRefs=[]}for(t in l){var g=l[t];if(g[":block/refs"])for(var u of g[":block/refs"])void 0!==l[u]?l[u].backRefs.push(t):void 0!==n[u]?n[u].backRefs.push(t):(u=new Error(`bad ref ${u}`),console.log(u),console.log("ERROR"))}for(s in n){var h=n[s];h.children&&0!==h.children.length||0!==h.backRefs.length||(delete i[h.title],delete n[s])}e={graphName:e,pages:n,blocks:l,pagesByTitle:i,ownerRoamId:c};return console.log(`roamJsonToStore took ${performance.now()-a}`),console.log(e),e},mdToStore=e=>{var o=Date.now();store;const t={};store=blankStore();var r,s;for(r of e){var a=r.name;const c=r.text;var n=(s=a,store.pagesByTitle[s]||newUid());const f={"create-time":o,title:a};if(store.pages[n]=f,store.pagesByTitle[a]=n,0<c.length){f.children=[];var l,i=e=>{var r=newUid();t[e]=r;e={"create-time":o,string:e};store.blocks[r]=e,f.children.push(r)},n=(f,c.matchAll(/\n((?:    )*)- /g));let e=2;for(l of n)i(c.substring(e,l.index)),e=l.index+l[0].length;i(c.substring(e))}}console.log(store)},parseMdBlock=e=>{},exampleStore={blocks:{bnslSbnd:{string:"",":block/refs":["steklsne","nslkeDk"]}},pages:{nslkeDk:{title:"I have title",backRefs:["bnslSbnd"]}}},mergeStore=i=>{const r={};var e,o,t,c=e=>r[e]||(void 0!==store.blocks[e]||void 0!==store.pages[e]?newUid():i.pages[e]&&store.pagesByTitle[i.pages[e].title]?(r[e]=store.pagesByTitle[i.pages[e].title],r[e]):e);for(e in i.blocks)c(e);for(o in i.pages)c(o);const f=(e,r,o)=>{var t,s=i.blocks[e];const a={...s};if(store.blocks[r]=a,a.parent=o,s.children){a.children=[];for(var n of s.children){var l=c(n);f(n,l,r),a.children.push(l)}}for(t of LIST_PROPS){let e=s[t];e&&(a[t]=e.map(c))}};for(t in i.pages){var s=c(t),a=i.pages[t];if(void 0===store.pages[s]){const v={...a};if(store.pages[s]=v,store.pagesByTitle[a.title]=s,a.children){v.children=[];for(var n of a.children){var l=c(n);f(n,l,s),v.children.push(l)}}for(var d of LIST_PROPS){let e=a[d];e&&(v[d]=e.map(c))}}else{const k=store.pages[s];if(a.children){void 0===k.children&&(k.children=[]);for(var p of a.children){var g=c(p);f(p,g,s),k.children.push(g)}}for(var u of LIST_PROPS)if(a[u]){void 0===k[u]&&(k[u]=[]);for(var h of a[u])k[u].push(c(h))}}}},gcBlocks=()=>{for(var e of Array.from(store.blocks)){var r=store.blocks[e];void 0===store.pages[r.parent]&&void 0===store.blocks[r.parent]&&delete store.blocks[e]}},escapeRegex=e=>e.replaceAll(/(?<=^|[^`])([\[\]\(\)])/g,"\\$1").replaceAll("`",""),searchRefCountWeight=.05,titleExactFullTextSearch=e=>{var r,o=new RegExp(escapeRegex(e),"i");const t=[];for(r in store.pages){var s=store.pages[r];const n=s.title;var a=n.match(o);a&&t.push({title:n,id:r,idx:a.index-(s.backRefs&&s.backRefs.length)*searchRefCountWeight})}return t.sort((e,r)=>e.idx-r.idx),t.slice(0,10)},exactFullTextSearch=e=>{var r,o,t=new RegExp(escapeRegex(e),"i");const s=[];for(r in store.pages){var a=store.pages[r];const i=a.title;var n=i.match(t);n&&s.push({title:i,id:r,idx:n.index-(a.backRefs&&a.backRefs.length)*searchRefCountWeight})}for(o in store.blocks){const c=store.blocks[o];var l=c.string.match(t);l&&s.push({string:c.string,id:o,idx:l.index+1-(c.backRefs&&c.backRefs.length)*searchRefCountWeight})}return s.sort((e,r)=>e.idx-r.idx).slice(0,10)},searchTemplates=s=>{var e=store.pages[store.pagesByTitle["roam/templates"]];const a=[];if(e){var r=(e,r)=>{const o=store.blocks[e],t=o.string.match(r?/^([^ \r\n]+)\s*$/:/^([^ \r\n]+)\s*(?:(?:#roam\/templates)|(?:\[\[roam\/templates\]\]))$/);console.log(t),t&&t.length>=s.length&&t[1].substring(0,s.length).toLowerCase()===s.toLowerCase()&&a.push({id:e,string:t[1]})};if(e.backRefs)for(var o of e.backRefs)r(o,0);if(e.children)for(var t of e.children)r(t,1)}return a},makePagesByTitle=()=>{var e,r=performance.now();for(e in store.pagesByTitle={},store.pages)store.pagesByTitle[store.pages[e].title]=e;console.log(`makepbt took ${performance.now()-r}`)},storeToFlat=()=>{const e=[],r=[];for(var o in store.pages)e.push(o),r.push(JSON.stringify(store.pages[o]));for(var t in store.blocks)e.push(t),r.push(JSON.stringify(store.blocks[t]));return{keys:e,values:r}},storeToBinary=()=>{var e=performance.now();const r=new TextEncoder;var{keys:o,values:t}=storeToFlat(store);let s=4,a=[];for(let e=0;e<o.length;e++){var n=r.encode(o[e]).length,l=r.encode(t[e]).length;s+=n+l+8,a.push(n,l)}var i=new ArrayBuffer(s);const c=new Uint8Array(i),f=new Uint32Array(i,0,a.length+10);f[0]=Math.floor(a.length/2);for(let e=0;e<a.length;e++)f[e+1]=a[e];let d=4+4*a.length;for(let e=0;e<o.length;e++){var p=o[e],g=t[e],u=a[2*e],h=a[2*e+1];r.encodeInto(p,c.subarray(d)),d+=u,r.encodeInto(g,c.subarray(d)),d+=h}return console.log(`store to binary took ${performance.now()-e}`),i},attemptToUnCorruptStore=()=>{for(var e in store.blocks){const a=store.blocks[e];for(var r of LIST_PROPS)a[r]&&(a[r]=a[r].filter(blockOrPageFromId))}for(var o in store.pages){const n=store.pages[o];for(var t of LIST_PROPS)n[t]&&(n[t]=n[t].filter(blockOrPageFromId))}for(var s in store.pagesByTitle)"undefined"===s&&delete store.pagesByTitle[s]},getRidOfUnusedLists=()=>{for(var e in store.blocks){const s=store.blocks[e];for(var r of LIST_PROPS)s[r]&&0===s[r].length&&delete s[r];s.children&&0===s.children.length&&delete s.children}for(var o in store.pages){const a=store.pages[o];for(var t of LIST_PROPS)a[t]&&(a[t]=a[t].filter(blockOrPageFromId));a.children&&0===a.children.length&&delete a.children}},stripRefs=()=>{for(var e in delete store.pagesByTitle,store.pages){const s=store.pages[e];for(var r of LIST_PROPS)delete s[r]}for(var o in store.blocks){const a=store.blocks[o];for(var t of LIST_PROPS)delete a[t]}},generateRefs=()=>{var e,r,o=performance.now();for(e in refs={},titles={},store.pages){var t=store.pages[e];titles[t.title]=e}for(r in store.blocks){var s=document.createDocumentFragment(),s=renderBlockBody(s,r);if(0<s.length)for(var a of s){var n=titles[a];n?(refs[n]||(refs[n]=[]),refs[n].push(r)):console.log(`no page ${a}`)}}console.log(`gen refs took ${performance.now()-o}`)};

const pageFrame=document.getElementById("page-frame"),pageFrameOuter=document.getElementById("page-frame-outer"),searchInput=document.getElementById("search-input"),downloadButton=document.getElementById("download-button"),terminalElement=document.getElementById("terminal"),searchResultList=document.getElementById("search-result-list"),autocompleteList=document.getElementById("autocomplete-list"),templateList=document.getElementById("template-list"),getTemp=e=>document.getElementById(e).content.firstElementChild,pageTemplate=getTemp("page"),blockTemplate=getTemp("block"),backrefListTemplate=getTemp("backref-list"),blockFocusFrameTemplate=getTemp("block-focus-frame"),pageBreakTemplate=getTemp("page-break"),suggestionTemplate=getTemp("autocomplete__suggestion"),searchResultTemplate=getTemp("search-result"),templateSuggestionTemplate=getTemp("template__suggestion"),breadcrumbBlockTemplate=getTemp("breadcrumb-block"),breadcrumbPageTemplate=getTemp("breadcrumb-page"),backrefFrameTemplate=getTemp("backref-frame"),notificationTemplate=getTemp("notification"),pageRefTemplate=getTemp("page-ref"),tagTemplate=getTemp("tag"),urlTemplate=getTemp("url"),blockRefTemplate=getTemp("block-ref"),boldTemplate=getTemp("bold"),italicTemplate=getTemp("italic"),highlightTemplate=getTemp("highlight"),literalTemplate=getTemp("literal"),templateExpanderTemplate=getTemp("template-expander"),attributeTemplate=getTemp("attribute");

const renderPage=(e,l)=>{const t=store.pages[l],d=pageTemplate.cloneNode(!0),n=d.firstElementChild,a=d.children[1];if(a.dataset.id=l,d.dataset.id=l,void 0===t.title)throw new Error(`error with page id ${l}`);n.innerText=t.title;let i=t.children;i&&0!==i.length||(runCommand("createBlock",l,0),i=t.children);for(var o of i)renderBlock(a,o);if(t.backRefs&&0<t.backRefs.length){const s=backrefListTemplate.cloneNode(!0);d.children[2].appendChild(s),t.backRefs.sort((e,l)=>store.blocks[l]["edit-time"]-store.blocks[e]["edit-time"]);for(var r of t.backRefs){var p=backrefFrameTemplate.cloneNode(!0);renderBreadcrumb(p.children[0],r),renderBlock(p.children[1],r),s.children[1].appendChild(p)}}return e.appendChild(d),d},renderBlock=(e,l,t)=>{const d=blockTemplate.cloneNode(!0),n=d.children[1],a=d.children[2];d.dataset.id=l,a.dataset.id=l,n.dataset.id=l;var i=store.blocks[l].string;i&&renderBlockBody(n,i);l=store.blocks[l].children;if(l)for(var o of l)renderBlock(a,o);return void 0!==t&&e.children.length>=t?e.insertBefore(d,e.children[t]):e.appendChild(d),d},renderBlockBody=(e,l,t=!1)=>{t||" "!==l[l.length-1]&&(l+=" ");const d=[e];t=l.matchAll(/(\[\[)|(\]\])|(#[\/a-zA-Z0-9_-]+)|(\(\([a-zA-Z0-9\-_]{8,50}\)\))|(\*\*)|(\^\^)|(__)|((?:https?\:\/\/)(?:[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6})\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/\/=]*))|`([^`]+)`|(;;(?:[^ \n\r]*))|(^[\/a-zA-Z0-9_-]+)::/g);let n=0,a=e;var i,o=e=>{const l=document.createTextNode(e);return l.startIdx=n,l.endIdx=n+e.length,l};const r=[];for(i of t){if(a.appendChild(o(l.substring(n,i.index))),n=i.index,i[1]){const c=pageRefTemplate.cloneNode(!0);a.appendChild(c),c.children[0].appendChild(o("[[")),d.push(c.children[1]),a=d[d.length-1]}else if(i[2])if("page-ref__body"===a.className)a.parentNode.children[2].appendChild(o("]]")),r.push(a.innerText),d.pop(),a=d[d.length-1];else{const h=document.createElement("span");h.className="page-ref-close-missing-open",h.appendChild(o("]]")),a.appendChild(h)}else if(i[3]){r.push(i[3].substring(1));const m=tagTemplate.cloneNode(!0);m.appendChild(o(i[3])),a.appendChild(m)}else if(i[4]){var p=i[4].substring(2,i[4].length-2),s=store.blocks[p];if(s){const f=blockRefTemplate.cloneNode(!0);f.innerText=s.string,f.dataset.id=p,a.appendChild(f)}else a.appendChild(o(i[0]))}else if(i[5])if("bold"===a.className)a.appendChild(o("**")),d.pop(),a=d[d.length-1];else{const g=boldTemplate.cloneNode(!0);a.appendChild(g),g.appendChild(o("**")),d.push(g),a=g}else if(i[6])if("highlight"===a.className)a.appendChild(o("^^")),d.pop(),a=d[d.length-1];else{const C=highlightTemplate.cloneNode(!0);a.appendChild(C),C.appendChild(o("^^")),d.push(C),a=C}else if(i[7])if("italic"===a.className)a.appendChild(o("__")),d.pop(),a=d[d.length-1];else{const b=italicTemplate.cloneNode(!0);a.appendChild(b),b.appendChild(o("__")),d.push(b),a=b}else if(i[8]){const N=urlTemplate.cloneNode(!0);N.appendChild(o(i[8])),N.href=i[8],a.appendChild(N)}else if(i[9]){const u=literalTemplate.cloneNode(!0);u.appendChild(o(i[0])),a.appendChild(u)}else if(i[10]){const k=templateExpanderTemplate.cloneNode(!0);k.appendChild(o(i[0])),a.appendChild(k)}else if(i[11]){const T=attributeTemplate.cloneNode(!0);T.appendChild(o(i[0])),a.appendChild(T)}n=i.index+i[0].length}for(d[d.length-1].appendChild(o(l.substring(n)));a!==e;)"page-ref"===a.className&&(a.children[0].className=a.children[0].className+"-incomplete"),a.className=a.className+"-incomplete",a=a.parentNode;return r},renderBreadcrumb=(l,e)=>{const t=[];for(;;){if(e=store.blocks[e].parent,void 0===store.blocks[e]){t.push({title:store.pages[e].title,id:e});break}t.push({string:store.blocks[e].string,id:e})}const d=breadcrumbPageTemplate.cloneNode(!0);var n=t[t.length-1].title;renderBlockBody(d,n),d.dataset.title=n,l.appendChild(d);for(let e=t.length-2;0<=e;e--){const d=breadcrumbBlockTemplate.cloneNode(!0);var a=d.children[1];renderBlockBody(a,t[e].string,!0),d.dataset.id=t[e].id,l.appendChild(d)}},notifyText=(e,l)=>{const t=notificationTemplate.cloneNode(!0);t.innerText=e,document.getElementById("app").appendChild(t),setTimeout(()=>t.style.top="60px",50);l=l&&1e3*l||5e3;setTimeout(()=>t.style.opacity="0",l),setTimeout(()=>{t.remove()},l+300)};

const focusBlockEnd=e=>{const t=e.children[1],o=document.createTextNode(" ");t.appendChild(o),getSelection().collapse(o,0),o.remove()},focusBlockStart=e=>{const t=e.children[1],o=document.createTextNode(" ");t.insertBefore(o,t.firstChild),getSelection().collapse(o,0),o.remove()},focusBlockVerticalOffset=(e,t=focusBlock,o=!1)=>{const n=Array.from(document.querySelectorAll(".block"));e=n[n.indexOf(t)+e];e&&(o?focusBlockStart:focusBlockEnd)(e)},getChildren=e=>("block"===e.className?e.children[2]:e.children[1]).children,dailyNotesInfiniteScrollListener=()=>{if(pageFrame.getBoundingClientRect().bottom-innerHeight<700)for(let e=0;e<100;e++){sessionState.oldestDate.setDate(sessionState.oldestDate.getDate()-1);var t=store.pagesByTitle[formatDate(sessionState.oldestDate)];if(t){renderPage(pageFrame,t),pageFrame.appendChild(pageBreakTemplate.cloneNode(!0));break}}},downloadHandler=()=>{console.log("download");var e=storeToRoamJSON(store),e=new Blob([e],{type:"text/json"}),e=URL.createObjectURL(e);downloadButton.setAttribute("href",e),downloadButton.setAttribute("download",`${store.graphName}-micro-roam.json`)},expandTemplate=()=>{var e=focusSuggestion.dataset.id,t=store.blocks[sessionState.focusId];if(void 0===t.children||0===t.children.length){var o=store.blocks[sessionState.focusId].parent,n=store.blocks[e].children,s=blockOrPageFromId(o).children.indexOf(sessionState.focusId);runCommand("deleteBlock",sessionState.focusId);var l=focusBlock.parentNode;focusBlock.remove();for(let e=0;e<n.length;e++){var a=n[e],r=s+e,a=runCommand("copyBlock",a,o,r),r=renderBlock(l,a,r);0===e&&focusBlockEnd(r)}}else notifyText("can't use a template inside a block that has children");templateList.style.display="none"},pasteBlocks=()=>{var o=store.blocks[sessionState.focusId].parent;let n=blockOrPageFromId(o).children.indexOf(sessionState.focusId);var s=focusBlock.parentNode;if(""===focusBlockBody.innerText?(runCommand("deleteBlock",sessionState.focusId),focusBlock.remove()):n+=1,clipboardData.dragSelect.rooted){var e=runCommand("copyBlock",clipboardData.dragSelect.root,o,n),e=renderBlock(s,e,n);focusBlockEnd(e)}else{let t=null;for(let e=0;e<clipboardData.dragSelect.endIdx+1-clipboardData.dragSelect.startIdx;e++){var l=blockOrPageFromId(clipboardData.dragSelect.root).children[e+clipboardData.dragSelect.startIdx],l=runCommand("copyBlock",l,o,e+n),l=renderBlock(s,l,e+n);t=l}focusBlockEnd(t)}},autocomplete=()=>{const e=store.blocks[sessionState.focusId].string;var t,o,n;"tag"===editingLink.className?(o=editingLink.childNodes[0],/[^\/a-zA-Z0-9_-]/.test(focusSuggestion.dataset.title)?(t=e.slice(0,o.startIdx)+"[["+focusSuggestion.dataset.title+"]]"+e.slice(o.endIdx),sessionState.position=o.startIdx+focusSuggestion.dataset.title.length+4,setFocusedBlockString(t)):(n=e.slice(0,o.startIdx)+"#"+focusSuggestion.dataset.title+e.slice(o.endIdx),sessionState.position=o.startIdx+focusSuggestion.dataset.title.length+1,setFocusedBlockString(n))):(o=editingLink.children[1].childNodes[0],n=e.slice(0,o.startIdx)+focusSuggestion.dataset.title+e.slice(o.endIdx),sessionState.position=o.startIdx+focusSuggestion.dataset.title.length+2,setFocusedBlockString(n)),autocompleteList.style.display="none"},indentFocusedBlock=()=>{var e,t,o=sessionState.focusId;const n=focusBlock.previousElementSibling;n&&n.dataset&&n.dataset.id&&(e=n.dataset.id,t=blockOrPageFromId(e).children.length,runCommand("moveBlock",o,e,t),n.children[2].appendChild(focusBlock),getSelection().collapse(focusNode,focusOffset))},dedentFocusedBlock=()=>{var e=sessionState.focusId,t=store.blocks[e].parent,o=store.blocks[t];if(o){o=o.parent;const n=blockOrPageFromId(o);t=n.children.indexOf(t);runCommand("moveBlock",e,o,t+1);t=focusBlock.parentNode.parentNode;const s=t.parentNode;t=t.nextElementSibling;t?s.insertBefore(focusBlock,t):s.appendChild(focusBlock),getSelection().collapse(focusNode,focusOffset)}};document.addEventListener("input",o=>{if(console.log("input"),updateCursorInfo(),autocompleteList.style.display="none",templateList.style.display="none",sessionState.isFocused)if(" "!==focusBlockBody.innerText&&""!==focusBlockBody.innerText){let t=focusBlockBody.innerText;if("["===o.data){var n,s=o.target.querySelectorAll(".page-ref-close-missing-open");let e=!1;for(n of s)if(console.log(n),n.childNodes[0].startIdx>sessionState.position){e=!0;break}e||(t=t.substring(0,sessionState.position)+"]"+t.substring(sessionState.position))}if(store.blocks[sessionState.focusId].string=t,setFocusedBlockString(t),editingTitle){var l=titleExactFullTextSearch(editingTitle);if(0<l.length){autocompleteList.innerHTML="",autocompleteList.style.display="block";s=editingLink.getBoundingClientRect();autocompleteList.style.top=s.bottom,autocompleteList.style.left=s.left;for(let e=0;e<l.length;e++){matchingTitle=l[e];const r=suggestionTemplate.cloneNode(!0);0===e&&(r.dataset.selected="true"),r.dataset.id=matchingTitle.id,matchingTitle.title?(r.dataset.title=matchingTitle.title,r.innerText=truncateElipsis(matchingTitle.title,50)):(r.dataset.string=matchingTitle.string,r.innerText=truncateElipsis(matchingTitle.string,50)),autocompleteList.appendChild(r)}}}if(editingTemplateExpander){console.log("editingTemplateExpander");var e=editingTemplateExpander.innerText.substring(2),a=searchTemplates(e);if(console.log(a),0<a.length){templateList.innerHTML="";for(let e=0;e<Math.min(a.length,10);e++){const i=templateSuggestionTemplate.cloneNode(!0);0===e&&(i.dataset.selected="true"),i.dataset.string=a[e].string,i.dataset.id=a[e].id,i.innerText=truncateElipsis(a[e].string,50),templateList.appendChild(i)}templateList.style.display="block",templateList.style.top=editingTemplateExpander.getBoundingClientRect().bottom,templateList.style.left=editingTemplateExpander.getBoundingClientRect().left}}}else runCommand("writeBlock",sessionState.focusId,"",[]);else if("search-input"===o.target.id){var t=exactFullTextSearch(o.target.value);if(0<t.length){searchResultList.innerHTML="";for(let e=0;e<Math.min(t.length,10);e++){const c=searchResultTemplate.cloneNode(!0);0===e&&(c.dataset.selected="true"),t[e].title?(c.dataset.title=t[e].title,c.innerText=truncateElipsis(t[e].title,50)):(c.dataset.string=t[e].string,c.dataset.id=t[e].id,c.innerText=truncateElipsis(t[e].string,50)),searchResultList.appendChild(c)}searchResultList.style.display="block",searchResultList.style.top=searchInput.getBoundingClientRect().bottom,searchResultList.style.left=searchInput.getBoundingClientRect().left}else searchResultList.style.display="none"}else"page__title"===o.target.className&&(console.log("edit title"),e=o.target.parentNode.dataset.id,runCommand("writePageTitle",e,o.target.innerText))});const globalHotkeys={"hide top bar":{key:"b",control:!0,fn:()=>{"0px"===topBar.style.marginTop?user.topBar="hidden":user.topBar="visible",saveUser()}},escape:{key:"Escape",fn:()=>{autocompleteList.style.display="none",templateList.style.display="none"}},upload:{key:"d",control:!0,fn:()=>{document.getElementById("upload-input").click()}},download:{key:"s",control:!0,shift:!0,fn:downloadHandler},save:{key:"s",control:!0,fn:debouncedSaveStore},"toggle color theme":{key:"m",control:!0,fn:()=>{"light"===document.body.className?user.theme="dark":user.theme="light",saveUser()}},search:{key:"u",control:!0,fn:()=>{"0px"!==topBar.style.marginTop&&(topBar.style.marginTop="0px"),searchInput.focus()}},open:{key:"o",control:!0,fn:()=>{editingLink&&"page-ref"===editingLink.className&&goto("pageTitle",editingLink.children[1].innerText),editingLink&&"tag"===editingLink.className&&goto("pageTitle",editingLink.innerText.substring(1))}},terminal:{key:"i",control:!0,alt:!0,fn:()=>{"none"===terminalElement.style.display?(terminalElement.style.display="block",terminalElement.focus()):terminalElement.style.display="none"}}};document.addEventListener("keydown",event=>{for(var hotkeyName in updateCursorInfo(),globalHotkeys){const hotkey=globalHotkeys[hotkeyName];if(event.key===hotkey.key&&event.shiftKey===!!hotkey.shift&&event.ctrlKey===!!hotkey.control&&event.altKey===!!hotkey.alt)return hotkey.fn(),void event.preventDefault()}if(dragSelect){let did=!1;if("c"!==event.key&&"x"!==event.key||!event.ctrlKey||(console.log("copy blocks"),clipboardData={dragSelect:{root:dragSelect.root.dataset.id,startIdx:dragSelect.startIdx,endIdx:dragSelect.endIdx,rooted:dragSelect.rooted}},did=!0),"Backspace"===event.key||"Delete"===event.key||"x"===event.key&&event.ctrlKey){if(console.log(dragSelect),dragSelect.rooted)focusBlockVerticalOffset(-1,dragSelect.root),runCommand("deleteBlock",dragSelect.root.dataset.id),document.querySelectorAll(`.block[data-id="${dragSelect.root.dataset.id}"]`).forEach(e=>e.remove());else{const childNodes=getChildren(dragSelect.root);focusBlockVerticalOffset(-1,childNodes[dragSelect.startIdx]),console.log(`cnl ${childNodes.length} start ${dragSelect.startIdx} end ${dragSelect.endIdx}`);for(let i=dragSelect.endIdx;i>=dragSelect.startIdx;i--){const node=childNodes[i];runCommand("deleteBlock",node.dataset.id),document.querySelectorAll(`.block[data-id="${node.dataset.id}"]`).forEach(e=>e.remove())}}dragSelect=null,did=!0}did&&event.preventDefault()}else if("none"!==autocompleteList.style.display){"Tab"!==event.key&&"Enter"!==event.key||(autocomplete(),event.preventDefault());const newSelected="ArrowUp"===event.key&&focusSuggestion.previousElementSibling||"ArrowDown"===event.key&&focusSuggestion.nextElementSibling;newSelected&&(newSelected.dataset.selected="true",delete focusSuggestion.dataset.selected,event.preventDefault())}else if("none"!==templateList.style.display){"Tab"!==event.key&&"Enter"!==event.key||(expandTemplate(),event.preventDefault());const newSelected="ArrowUp"===event.key&&focusSuggestion.previousElementSibling||"ArrowDown"===event.key&&focusSuggestion.nextElementSibling;newSelected&&(newSelected.dataset.selected="true",delete focusSuggestion.dataset.selected,event.preventDefault())}else if(sessionState.isFocused){let blocks,newActiveBlock;switch(event.key){case"Enter":if(!event.shiftKey){const parent=blockOrPageFromId(store.blocks[sessionState.focusId].parent);let idx=parent.children.indexOf(sessionState.focusId);event.ctrlKey||(idx+=1),console.log(idx);const newBlockUid=runCommand("createBlock",store.blocks[sessionState.focusId].parent,idx),newBlockElement=renderBlock(focusBlock.parentNode,newBlockUid,idx);newBlockElement.children[1].focus(),event.preventDefault()}break;case"Tab":(event.shiftKey?dedentFocusedBlock:indentFocusedBlock)(),event.preventDefault();break;case"Backspace":0===sessionState.position&&(blocks=Array.from(document.querySelectorAll(".block")),newActiveBlock=blocks[blocks.indexOf(focusBlock)-1],focusBlock.remove(),focusBlockEnd(newActiveBlock),runCommand("deleteBlock",sessionState.focusId),event.preventDefault());break;case"ArrowDown":if(event.altKey&&event.shiftKey){const parentId=store.blocks[sessionState.focusId].parent,parentElement=focusBlock.parentNode,currentIdx=blockOrPageFromId(parentId).children.indexOf(sessionState.focusId);focusBlock.nextElementSibling&&(runCommand("moveBlock",sessionState.focusId,parentId,currentIdx+1),focusBlock.nextElementSibling.nextElementSibling?parentElement.insertBefore(focusBlock,focusBlock.nextElementSibling.nextElementSibling):parentElement.appendChild(focusBlock),getSelection().collapse(focusNode,focusOffset),event.preventDefault())}else event.shiftKey||event.altKey||(focusBlockVerticalOffset(1),event.preventDefault());break;case"ArrowUp":if(event.altKey&&event.shiftKey){const parentId=store.blocks[sessionState.focusId].parent,parentElement=focusBlock.parentNode,currentIdx=blockOrPageFromId(parentId).children.indexOf(sessionState.focusId);focusBlock.previousElementSibling&&(runCommand("moveBlock",sessionState.focusId,parentId,currentIdx-1),parentElement.insertBefore(focusBlock,focusBlock.previousElementSibling),getSelection().collapse(focusNode,focusOffset),event.preventDefault())}else event.shiftKey||event.altKey||(focusBlockVerticalOffset(-1),event.preventDefault());break;case"ArrowLeft":event.shiftKey&&event.altKey?dedentFocusedBlock():0===sessionState.position&&(focusBlockVerticalOffset(-1),event.preventDefault());break;case"ArrowRight":event.shiftKey&&event.altKey?indentFocusedBlock():sessionState.position===focusBlockBody.innerText.length&&(focusBlockVerticalOffset(1,focusBlock,!0),event.preventDefault());break;case"v":event.ctrlKey&&clipboardData&&(pasteBlocks(),event.preventDefault());break;case"c":event.ctrlKey&&(clipboardData=null);break;case"]":console.log(sessionState.position),"]"===focusBlockBody.innerText[sessionState.position]?(event.preventDefault(),sessionState.position+=1,focusIdPosition()):console.log(focusBlockBody.innerText[sessionState.position])}}if(document.activeElement&&"search-input"===document.activeElement.id){if("Enter"===event.key)return goto("pageTitle",event.target.value),void event.preventDefault();if("Tab"===event.key){const selected=searchResultList.querySelector('.search-result[data-selected="true"]');if(selected)return void(selected.dataset.title?goto("pageTitle",selected.dataset.title):goto("block",selected.dataset.id))}}if("none"!==terminalElement.style.display&&"Enter"===event.key&&!event.ctrlKey&&!event.shiftKey&&!event.altKey){const tc=terminalCommands[event.target.innerText];if(tc)tc(),event.preventDefault(),terminalElement.style.display="none",terminalElement.innerHTML="";else try{eval(event.target.innerText),event.ctrlKey||(terminalElement.style.display="none",terminalElement.innerHTML="")}catch(error){console.log(error),event.preventDefault()}}});const getPageTitleOfNode=e=>{const t=e.closest(".tag");if(t)return t.innerText.substring(1);const o=e.closest(".attribute");if(o)return o.innerText.substring(0,o.innerText.length-2);e=e.closest(".page-ref");return e?e.children[1].innerText:void 0};document.addEventListener("click",e=>{var t=getPageTitleOfNode(e.target);if(t)goto("pageTitle",t);else{var o=e.target.closest(".block__bullet");if("search-result"!==e.target.className){"search-input"!==e.target.id&&(searchResultList.style.display="none");var n=e.target.closest(".breadcrumb-page"),t=e.target.closest(".breadcrumb-block");if(o)goto("block",o.parentNode.dataset.id);else if("block-ref"===e.target.className)goto("block",e.target.dataset.id);else if("url"===e.target.className){const s=document.createElement("a");s.target="_blank",s.href=e.target.innerText,s.click()}else"download-button"===e.target.id?downloadHandler():"template__suggestion"===e.target.className?(focusSuggestion&&(focusSuggestion.dataset.selected=!1),e.target.dataset.selected=!0,focusSuggestion=e.target,expandTemplate()):"upload-button"===e.target.id?document.getElementById("upload-input").click():"daily-notes-button"===e.target.id?goto("dailyNotes"):"autocomplete__suggestion"===e.target.className?(focusSuggestion&&(focusSuggestion.dataset.selected=!1),e.target.dataset.selected=!0,autocomplete()):"help-button"===e.target.id?goto("pageTitle","Welcome to Micro Roam"):n?goto("pageTitle",n.dataset.title):t&&goto("block",t.dataset.id);updateCursorInfo()}else e.target.dataset.title?goto("pageTitle",e.target.dataset.title):goto("block",e.target.dataset.id)}});const commonAncestorNode=(e,t)=>{const o=[];for(;void 0!==e.dataset.id;)o.push(e.dataset.id),e=e.parentNode.parentNode;const n=[];for(;void 0!==t.dataset.id;){if(n.push(t.dataset.id),-1!==o.indexOf(t.dataset.id)){var s=o[o.indexOf(t.dataset.id)-1],l=n[n.length-2];const r=blockOrPageFromId(t.dataset.id).children;var a=r?r.indexOf(l):-1,l=r?r.indexOf(s):-1,s=Math.max(l,a);return{root:t,startIdx:Math.max(Math.min(l,a),0),endIdx:-1===s?r.length:s,rooted:-1===a||-1===l}}t=t.parentNode.parentNode}},setDragSelected=t=>{if(dragSelect)if(dragSelect.rooted)dragSelect.root.dataset.selected=t;else{const o=getChildren(dragSelect.root);for(let e=dragSelect.startIdx;e<dragSelect.endIdx+1;e++)o[e].dataset.selected=t}},mouseMoveListener=e=>{setDragSelected(!1);e=e.target.closest(".block");e&&e!==dragSelectStartBlock?(getSelection().empty(),(e=commonAncestorNode(dragSelectStartBlock,e))&&(dragSelect=e,setDragSelected(!0))):dragSelect=null};document.addEventListener("mousedown",e=>{updateCursorInfo(),setDragSelected(!1),dragSelect=null,e.target.closest(".block")&&(document.addEventListener("mousemove",mouseMoveListener),dragSelectStartBlock=e.target.closest(".block"))}),document.addEventListener("mouseup",e=>{null!==dragSelectStartBlock&&(document.removeEventListener("mousemove",mouseMoveListener),dragSelectStartBlock=null)}),topBarHiddenHitbox.addEventListener("mouseover",()=>{user.topBar="visible",saveUser()}),document.getElementById("upload-input").addEventListener("change",e=>{const t=e.target.files[0];console.log(t);var{name:o,ext:e}=splitFileName(t.name);console.log(`name ${o} extension ${e}`),"zip"===e?t.arrayBuffer().then(e=>{e=zipToFiles(e);if(console.log(e),1===e.length&&"json"===e[0].ext)store=roamJsonToStore(e[0].name,e[0].text),preprocessNewStore();else throw notifyText("Markdown import doesn't work yet. Upload a .json file, or a .zip file containing a .json file instead.",12),new Error("md import doesn't work")}):"json"===e?t.text().then(e=>{user.graphName=o,store=roamJsonToStore(o,e),preprocessNewStore()}):notifyText("Micro Roam only accepts a .json file or .zip file containing 1 .json file")});const preprocessNewStore=()=>{attemptToUnCorruptStore(),startCommand=["dailyNotes"],fetch("./default-store.json").then(e=>e.json().then(e=>{mergeStore(e),theresANewStore()}))};

const initialDailyNotes=5,renderSessionState=()=>{switch(searchResultList.style.display="none",pageFrameOuter.removeEventListener("scroll",dailyNotesInfiniteScrollListener),pageFrame.innerHTML="",searchInput.value="",sessionState.pageFrame){case"pageTitle":let e=store.pagesByTitle[sessionState.pageFrameTitle];void 0===e&&(e=runCommand("createPage",sessionState.pageFrameTitle)),renderPage(pageFrame,e);break;case"block":const i=blockFocusFrameTemplate.cloneNode(!0);pageFrame.appendChild(i),renderBreadcrumb(i.children[0],sessionState.pageFrameId),renderBlock(i.children[1],sessionState.pageFrameId);const r=store.blocks[sessionState.pageFrameId].backRefs;if(r){r.sort((e,t)=>store.blocks[t]["edit-time"]-store.blocks[e]["edit-time"]);var s,o=backrefListTemplate.cloneNode(!0);i.children[2].appendChild(o);for(s of r)renderBlock(o.children[1],s)}break;case"dailyNotes":pageFrameOuter.addEventListener("scroll",dailyNotesInfiniteScrollListener),sessionState.oldestDate=new Date(Date.now());let t=0;void 0===store.pagesByTitle[formatDate(sessionState.oldestDate)]&&runCommand("createPage",formatDate(sessionState.oldestDate));for(let e=0;e<1e3;e++){var a=store.pagesByTitle[formatDate(sessionState.oldestDate)];if(a&&(renderPage(pageFrame,a),pageFrame.appendChild(pageBreakTemplate.cloneNode(!0)),t+=1,t>=initialDailyNotes))break;sessionState.oldestDate.setDate(sessionState.oldestDate.getDate()-1)}t<initialDailyNotes&&pageFrame.lastChild.remove()}sessionState.isFocused&&focusIdPosition(),pageFrameOuter.scrollTop=sessionState.scroll||0},gotoNoHistory=(e,...t)=>{switch(e){case"dailyNotes":sessionState.pageFrame="dailyNotes";break;case"pageTitle":sessionState.pageFrame="pageTitle",sessionState.pageFrameTitle=t[0];break;case"block":sessionState.pageFrame="block",sessionState.pageFrameId=t[0]}renderSessionState()},goto=(...e)=>{sessionState.scroll=pageFrameOuter.scrollTop;var t=JSON.parse(JSON.stringify(sessionState));sessionState.isFocused=!1,sessionState.scroll=0,gotoNoHistory(...e),setTimeout(()=>{history.replaceState(t,"Micro Roam"),history.pushState(sessionState,"Micro Roam")},0)},gotoReplaceHistory=(...e)=>{gotoNoHistory(...e),history.replaceState(sessionState,"Micro Roam")};window.addEventListener("popstate",e=>{console.log(e.state),e.state&&(sessionState=e.state,renderSessionState())});const focusIdPosition=()=>{focusBlockBody=document.querySelector(`.block[data-id="${sessionState.focusId}"]>.block__body`);const o=e=>{for(var t of e.childNodes)if("#text"===t.nodeName){if(t.textContent&&sessionState.position>=t.startIdx&&sessionState.position<t.startIdx+t.textContent.length){scanResult=t;try{return getSelection().collapse(t,sessionState.position-t.startIdx),t}catch(e){return t}}}else{var s=o(t);if(s)return s}};o(focusBlockBody)},setFocusedBlockString=e=>{focusBlockBody.innerHTML="";var t=document.createDocumentFragment(),s=renderBlockBody(t,e);focusBlockBody.appendChild(t),focusIdPosition(),updateCursorInfo(),runCommand("writeBlock",sessionState.focusId,e,s)},updateCursorInfo=()=>{if(focusNode=getSelection().focusNode,focusOffset=getSelection().focusOffset,focusSuggestion=autocompleteList.querySelector('.autocomplete__suggestion[data-selected="true"]')||templateList.querySelector('.template__suggestion[data-selected="true"]'),focusNode)if(focusBlock=focusNode.parentNode.closest(".block"),focusBlock){sessionState.isFocused=!0,sessionState.focusId=focusBlock.dataset.id,"block__body"===focusNode.className?sessionState.position=focusBlock.innerText.length*(0!==focusOffset):(sessionState.position=focusOffset,focusNode.startIdx&&(sessionState.position+=focusNode.startIdx)),focusBlockBody=focusBlock.children[1],editingLink=void 0;var e,t,s,o=focusBlockBody.querySelectorAll(".page-ref");for(e of focusBlockBody.querySelectorAll(".tag"))e.childNodes[0].endIdx>=sessionState.position&&e.childNodes[0].startIdx<sessionState.position&&(editingLink=e);for(t of o)t.children[1].childNodes[0].endIdx>=sessionState.position&&t.children[1].childNodes[0].startIdx<sessionState.position&&(editingLink=t);editingTitle=editingLink&&("tag"===editingLink.className&&editingLink.innerText.substring(1)||"page-ref"===editingLink.className&&editingLink.children[1].innerText),editingTemplateExpander=void 0;for(s of focusBlockBody.querySelectorAll(".template-expander"))s.childNodes[0].endIdx>=sessionState.position&&s.childNodes[0].startIdx<sessionState.position&&(editingTemplateExpander=s)}else sessionState.isFocused=!1;else sessionState.isFocused=!1},parseStackTrace=e=>{const t=[];var s;for(s of e.matchAll(/([^ ]+) \(([^\)]+):([0-9]+):([0-9]+)\)(?:\n|$)/g))t.push({function:s[1],file:s[2],line:s[3],column:s[4]});return t},logError=(e,t,s,o,a)=>{e={line:s,file:t,stack:parseStackTrace(a.stack),message:e,column:o},o=localStorage.getItem("error_log");if(o){const i=JSON.parse(o);i.push(e),localStorage.setItem("error_log",JSON.stringify(i))}else localStorage.setItem("error_log",JSON.stringify([e]));return!1};window.onerror=logError,finishStartupThread();
</script>

  <!--got dailynotes references dailynotesinfinitescrolllistener, so events is before index
  would only save 1ms by loading it later anyway-->

  <!-- now rendering is done, loading interactive scripts-->

  
<script>
console.log("test");const testRoundTrip=()=>{var e=storeToRoamJSON(store);store=roamJsonToStore(store.graphName,e);var o=storeToRoamJSON(store);e===o?console.log("Round trip test passed!"):(console.log(e),console.log(o),console.error("round trip failed"))},createPageTest=()=>{var e=store;store=blankStore(),runCommand("createPage","Test Page"),store=e};let testSTime;const renderMulti=(e,o=void 0,r=100,t=!1)=>{t||(testSTime=performance.now()),0<r?e(o)||setTimeout(()=>renderMulti(e,o,r-1,!0),0):console.log(`test func took ${performance.now()-testSTime}`)},benchmarkPageLoad=()=>renderMulti(()=>goto("pageTitle","Welcome to Micro Roam"));let benchmarkRandomWalkSTime=null;const benchmarkRandomWalk=()=>renderMulti(()=>{let e=[];var o,r,t,n=document.querySelectorAll(".page-ref"),a=document.querySelectorAll(".tag"),s=document.querySelectorAll(".breadcrumb-page");for(o of n)e.push(o.children[1].innerText);for(r of a)e.push(r.innerText.substring(1));for(t of s)e.push(t.innerText);e=e.filter(e=>store.pagesByTitle[e]&&store.pages[store.pagesByTitle[e]]&&store.pages[store.pagesByTitle[e]].title);s=e[Math.floor(Math.random()*(e.length-1))];goto("pageTitle",s)}),benchmarkRenderAll=async()=>{var e,o=performance.now();let r=0,t=0;for(e in store.pagesByTitle){var n=performance.now();gotoNoHistory("pageTitle",e),r+=performance.now()-n,t+=1,await new Promise(e=>setTimeout(e,0))}o=performance.now()-o,o=`rendered ${t} pages in ${Math.round(o)}ms, avg ${Math.round(o/t)}ms
  function time avg ${Math.round(r/t)}`;console.log(o),notifyText(o,10)},testAll=()=>{testRoundTrip(),benchmarkPageLoad(),benchmarkRandomWalk(),benchmarkRenderAll()};

const page=e=>{console.log(store.pages[store.pagesByTitle[e]])},log=()=>{user.logging=!0,saveUser()},nolog=()=>{user.logging=!1,saveUser()},flash=benchmarkRenderAll,reset=()=>{indexedDB.deleteDatabase("microroam");localStorage.removeItem("user"),window.location.href=window.location.href},blank=()=>{store=blankStore(),user=blankUser,saveUser(),goto("dailyNotes")},pr=()=>{console.log(JSON.stringify(store))},downloadBinary=()=>{var e=storeToBinary(),e=new Blob([e],{type:"application/x-micro-roam"}),e=URL.createObjectURL(e);const o=document.createElement("a");o.setAttribute("href",e),o.setAttribute("download",`${store.graphName}.mrm`),o.click()},loadGraphminerNotes=()=>{fetch("./graphminer-store.json").then(e=>e.json().then(e=>{store=e,user.graphName=store.graphName,saveUser(),theresANewStore(),debouncedSaveStore()}))},taonotes=loadGraphminerNotes,terminalCommands={blank:blank,reset:reset,flash:flash,log:log,page:page,nolog:nolog,pr:pr,taonotes:taonotes,downloadBinary:downloadBinary};
</script>

</body>