<script>let idb=null,store=null,otherStores={},r;const basicBitchServerUrl="http://localhost:3000";let user,userText=localStorage.getItem("user"),usingLocalStore=!0,startFn=()=>gotoNoHistory("dailyNotes"),dataLoaded=!1,scriptsLoaded=!1;const setDataLoaded=()=>{scriptsLoaded&&start(),dataLoaded=!0},start=()=>{saveUser(),startFn(),user.h&&user.s.commitId!==user.s.syncCommitId&&debouncedSaveStore()},invalidateLocal=()=>{indexedDB.deleteDatabase("microroam");console.error("Local replica invalid. Resetting from server"),user.s.commitId=void 0,user.s.syncCommitId=void 0,localStorage.setItem("user",JSON.stringify(user)),localStorage.removeItem("store"),window.location.href=window.location.href};if(userText){if(user=JSON.parse(userText),user.h){const c=new Headers;c.set("h",user.h),user.s.syncCommitId&&c.set("commitid",user.s.syncCommitId);let e=`${basicBitchServerUrl}/get/${user.s.graphName}`;fetch(e,{method:"POST",headers:c}).then(async s=>{304!==s.status?200===s.status?(console.log(`server on commit ${s.headers.get("commitid")} local on commit ${user.s.syncCommitId}`),usingLocalStore=!1,s.json().then(e=>{console.log("got blox");const o=startFn;startFn=()=>{store=hydrateFromBlox(user.s.graphName,e),user.s.syncCommitId=s.headers.get("commitid"),o()},setDataLoaded()})):console.log("STORE NOT ON SERVER"):console.log("already up to date")})}const b=localStorage.getItem("store");if(b){try{store=JSON.parse(b),setDataLoaded()}catch(e){invalidateLocal()}r=indexedDB.open("microroam",5),r.onsuccess=e=>idb=e.target.result}else r=indexedDB.open("microroam",5),r.onsuccess=e=>{if(console.log("normal success"),idb=e.target.result,!0===usingLocalStore)try{idb.transaction(["stores"],"readonly").objectStore("stores").get(user.graphName).onsuccess=e=>{if(!0===usingLocalStore)if(e.target.result)try{store=JSON.parse(e.target.result.store),setDataLoaded()}catch(e){invalidateLocal()}else console.log("adding default graph")}}catch(e){}}}else user={s:{graphName:"default",theme:window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",topBar:"visible",logging:!1,spellcheck:!1,editingSpotlight:!0}},fetch("./default-store.json").then(e=>{e.json().then(e=>{store=e,startFn=()=>gotoNoHistory("pageTitle","Welcome to Micro Roam"),setDataLoaded()})}),r=indexedDB.open("microroam",5),r.onsuccess=e=>idb=e.target.result;r.onupgradeneeded=o=>{console.log("upgradeneeded");const s=r.result,e=Array.from(s.objectStoreNames);e.includes("stores")?(console.log(o),console.log(s),r.onsuccess=()=>{console.log("new success"),idb=o.target.result;const e=s.transaction(["stores"],"readonly").objectStore("stores");e.get(user.s.graphName).onsuccess=e=>{store=e.target.result.store;e=oldStoreToRoamJSON[s.version](store);roamJsonToStore(user.s.graphName,e),saveStore(),setDataLoaded()}}):s.createObjectStore("stores",{keyPath:"graphName"})},r.onerror=e=>{console.log("error"),console.log(e),alert('In order to save your notes between sessions, Micro Roam needs access to IndexedDB. \nYou can allow access by exiting "private browsing" mode, or by using a newer browser, or by changing browser settings')}</script><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400&display=swap" rel="stylesheet"><style>*{outline:0;scrollbar-width:none}.dark{--background:#000000;--click:rgb(100, 100, 100);--text:#dbdbdb;--link:#3f84c0;--brackets:#a7b6c2;--block-ref:rgb(63, 63, 63);--bullet:#8f9091;--border:#afbeca;--bar:#565d63;--break:#838e97;--highlight:#685000;--page-ref:#3ac263;--shadow:rgb(98, 98, 98);--notification:#183d23;--query-background:#051809;--editing-background:#141414;--selected:#2d4a66}.light{--background:white;--click:rgb(197, 197, 197);--text:black;--link:rgb(54, 123, 184);--brackets:#a7b6c2;--block-ref:lightgrey;--bullet:#394b59;--border:#585e64;--bar:#7c858d;--shadow:#585e64;--break:#a8b4be;--highlight:rgb(255, 247, 128);--page-ref:#1cce37;--notification:#a4d1b1;--query-background:#b0dfbd;--editing-background:#e6e6e6;--selected:#abcdeb}a,button,input{font-family:Inter}input{border:none;background-color:var(--background);color:var(--text)}button{appearance:none;border:none;box-shadow:none;cursor:pointer;background-color:inherit;color:inherit;font-size:inherit}span{margin:0;padding:0}::-webkit-scrollbar{width:0%;height:0%}::selection{background-color:#85b7e8;color:var(--text)}body{scrollbar-width:0;font-family:Inter;font-weight:400;margin:0;color:var(--text);background-color:var(--background)}a{color:var(--link)}a:visited{color:var(--link)}#app{height:100%;width:100%;display:flex;flex-direction:column}#page-frame-outer{width:100%;overflow-y:scroll}#page-frame{margin:0 auto 30px;max-width:min(900px,100%)}#top-bar{width:100%;display:flex;flex-direction:row;align-content:space-between;background-color:var(--background)}#top-bar button{font-size:.9em;color:var(--bullet);padding:10px 10px 8px}.top-bar-transition{transition:margin-top .1s}#top-bar-left,#top-bar-right{display:flex;flex-direction:row}#top-connect,#top-hamburger{padding:7px 6px 2px 4px;cursor:pointer}#options-frame{position:fixed;top:36px;right:5px;display:flex;flex-direction:column}#options-frame button{border-radius:10px;padding:6px;display:block}#create-new-store{border-radius:10px;padding:6px;font-size:1.1em}#search-input{background-color:var(--background);color:var(--text);padding:3px 13px;margin:5px 3px 4px;display:block;font-size:1.1em;box-shadow:0 0 2px var(--bullet);border-radius:100px;flex-grow:1}#search-input::placeholder{color:var(--bullet)}#autocomplete-list,#command-list,#options-frame,#template-list{position:absolute;display:flex;flex-direction:column;background-color:var(--background);font-size:1.3em;border-radius:10px;box-shadow:0 0 6px 0 var(--shadow)}.autocomplete__suggestion[data-selected=true],.command__suggestion[data-selected=true],.template__suggestion[data-selected=true]{background-color:var(--click)}.autocomplete__suggestion,.command__suggestion,.template__suggestion{padding:10px;cursor:pointer;border-radius:5px}#search-result-list{position:absolute;display:flex;flex-direction:column;background-color:var(--background);font-size:1.3em;border-radius:5px;box-shadow:0 0 8px var(--shadow)}.search-result[data-selected=true]{background-color:var(--click)}.search-result{padding:7px;cursor:pointer;border-radius:5px}.page{margin-right:30px;margin-left:30px;position:relative}.page__title{font-size:38px;margin:35px 0 20px 0;font-weight:300}.backref-frame__body,.page__body{margin-left:20px}.backref-list__body{margin-left:10px}.backref-list__title{font-size:1.3em;padding:20px 0 0}.page-break{height:0;margin:50px 25px;border:1px solid var(--break);border-width:1px 0 0 0}.block{position:relative;border-radius:5px}.block[data-selected=true]{background-color:var(--selected)}.block__body{padding:5px 2px;white-space:pre-wrap}[data-editingspotlight=true] .block__body[data-editmode=true]{background-color:var(--editing-background);border-radius:4px}.block__bullet{cursor:pointer;position:absolute;left:-21px;top:4px}.block__children{margin-left:22px;position:relative}.block__children::before{display:block;position:absolute;content:"\200B";top:0;height:100%;width:6px;transform:translateX(-34px);border-left:1px solid var(--bar)}.block-focus-frame{margin:60px 0}.breadcrumb-page{cursor:pointer}.breadcrumb-block{cursor:pointer}.backref-frame__breadcrumb{margin:15px 0 5px 0;font-size:1.2em}.block-focus-frame__breadcrumb{margin:15px 0 5px 0;font-size:1.2em}.page-ref{position:relative}.page-ref__brackets{font-weight:lighter;color:var(--brackets)}.page-ref__graphname{font-weight:lighter;color:var(--page-ref)}.page-ref__body{color:var(--page-ref);font-weight:600}.page-ref:hover{cursor:pointer}.page-ref:hover>.page-ref__body{text-decoration:underline}.tag__body{color:var(--page-ref);position:relative;font-weight:600}.tag__graph-name{color:var(--page-ref);position:relative;font-weight:300}.tag:hover{text-decoration:underline;cursor:pointer}.block-ref{background-color:var(--block-ref)}.block-ref:hover{text-decoration:underline;cursor:pointer}.bold{font-weight:700}.italic{font-style:italic}.highlight{background-color:var(--highlight);border-radius:2px;padding:1px}.block-focus-frame{margin:35px 0 0 60px}.url{color:var(--link);text-decoration:underline;cursor:pointer}.literal{font-family:Inconsolata;font-size:1.15em}.code-block{font-family:Inconsolata;font-size:1.15em}.attribute{font-weight:700}.attribute:hover{cursor:pointer}.image-embed{max-width:100%}.todo-checkbox{transform:translateY(1px);height:14px;width:14px;margin:0 2px}.compute-failed{background-color:var(--query-background);border-radius:4px;padding:5px 2px;margin-left:-2px}#terminal{font-family:Inconsolata;width:100%;padding:8px;background-color:#000;color:#fff}.query-frame{background-color:var(--query-background);border-radius:8px;padding:1px 12px 18px;margin:3px 0}.notification{text-align:center;min-width:300px;position:fixed;left:50%;transform:translateX(-50%);top:-40px;margin-top:0;opacity:1;transition:top .25s ease-out,opacity .2s linear;padding:20px;background-color:var(--notification);border-radius:8px}#login,#signup{position:fixed;top:0;left:0;right:0;bottom:0;background-color:var(--background);text-align:center}#login-form,#signup-form{position:fixed;top:28%;left:50%;transform:translateX(-50%);padding:13px 20px 20px;border-radius:12px;display:flex;flex-direction:column;justify-content:space-between}#login input,#signup input{background-color:var(--background);color:var(--text);font-size:1.4em;border-radius:3px;display:block;padding:4px;margin-bottom:13px}#login button,#signup button{position:fixed;bottom:19%;left:50%;transform:translateX(-50%);display:block;padding:4px;border-radius:3px;background-color:var(--background);color:var(--placeholder)}#login button:focus,#signup button:focus{font-weight:700}#login p,#signup p{left:50%;font-size:1.7em;color:var(--placeholder);padding:4px;margin-bottom:20px;margin-top:65px}#login .exit-to-main,#signup .exit-to-main{bottom:9%}.really-want-to{padding:80px;position:fixed;top:30%;right:50%;transform:translateX(50%);background-color:var(--background);box-shadow:0 0 2px var(--shadow);border-radius:8px;text-align:center;flex-direction:column}.really-want-to button{margin-top:30px;display:block}</style><div id="html"><p style="font-family:Inter">please enable JavaScript</div><script>const elById=e=>document.getElementById(e),getTemp=e=>elById(e).content.firstElementChild,allHtml=`<div id="app">
  <div id="top-bar" style="margin-top:-43px">
    <div id="top-bar-left">
      
    </div>
    <input id="search-input" placeholder="search" tabindex="-1">
    <div id="top-bar-right">
      
    </div>
    
    <svg id="top-connect" width="25" height="25">
      <line x1="12.5" y1="20" x2="21" y2="9" stroke="var(--bullet)" />
      <line x1="12.5" y1="20" x2="4" y2="9" stroke="var(--bullet)" />
      <line x1="12.5" y1="20" x2="12.5" y2="5" stroke="var(--bullet)" />
      
      <circle cx="4" cy="9" r="3.5" stroke="var(--bullet)" />
      <circle cx="12.5" cy="5" r="3.5" stroke="var(--bullet)" />
      <circle cx="21" cy="9" r="3.5" stroke="var(--bullet)" />
      
      <circle cx="12.5" cy="20" r="4.5" stroke="var(--bullet)" />
      <circle cx="12.5" cy="20" r="2.5" fill="var(--bullet)" />
    </svg>
    
    <svg id="top-hamburger" width="25" height="25">
      <circle cx="12.5" cy="5" r="2.5" fill="var(--bullet)" />
      <circle cx="12.5" cy="13" r="2.5" fill="var(--bullet)" />
      <circle cx="12.5" cy="21" r="2.5" fill="var(--bullet)" />
    </svg>
    
  </div>

  <div id="top-bar-hidden-hitbox" style="position:fixed;height:20px;width:100%;display:none;"></div>


  <div id="terminal" contenteditable="true" style="display:none"></div>

  <div id="page-frame-outer">
    <div id="page-frame">

    </div>
  </div>
  
  <div id="options-frame" style="display:none">
  </div>

  <!-- inline styles on this site are all edited directly by js -->
  <div id="autocomplete-list" style="display:none"></div>
  <div id="command-list" style="display:none"></div>
  <div id="search-result-list" style="display:none"></div>
  <div id="template-list" style="display:none"></div>

  <div id="login" style="display:none">
    <p>Login</p>
    <form id="login-form">
      <input type="email" id="login-email" placeholder="email">
      <input type="password" id="login-password" placeholder="password">
      <input type="submit" style="height:0px" tabindex="-1">
    </form>
    <button id="switch-to-signup">Sign up</button>
    <button class="exit-to-main">Back</button>
  </div>

  <div id="signup" style="display:none">
    <p>Sign up</p>
    <form id="signup-form">
      <input type="email" id="signup-email" placeholder="email">
      <input type="text" id="signup-username" placeholder="username">
      <input type="password" id="signup-password" placeholder="password">
      <input type="submit" style="height:0px" tabindex="-1">
    </form>
    <button id="switch-to-login">Login</button>
    <button class="exit-to-main">Back</button>
  </div>

  <div id="really-want-to-leave" class="really-want-to" style="display:none">
    Your data will be lost if you sign out now
    <button>Continue</button>
  </div>
</div>

<title>Micro Roam</title>


<template id="page">
  <div class="page">
    <h1 class="page__title" contenteditable="true" tabindex="-1"></h1>

    <div class="page__body">

    </div>
    <div class="page__backlinks">

    </div>
  </div>
</template>

<template id="block">
  <div class="block">
    <svg class="block__bullet" width="20" height="20">
      <circle cx="10" cy="10.5" r="3" fill="var(--bullet)" />
    </svg>
    <div class="block__body" contenteditable="true" tabindex="-1"></div>
    <div class="block__children">

    </div>
  </div>
</template>

<template id="backref-list">
  <div class="backref-list">
    <div class="backref-list__title">Linked References</div>
    <div class="backref-list__body"></div>
  </div>
</template>

<template id="query-frame">
  <div class="query-frame"></div>
</template>

<template id="block-focus-frame">
  <div class="block-focus-frame">
    <div class="block-focus-frame__breadcrumb"></div>
    <div class="block-focus-frame__body"></div>
    <div class="block-focus-frame__backlinks"></div>
  </div>
</template>

<template id="backref-frame">
  <div class="backref-frame">
    <div class="backref-frame__breadcrumb"></div>
    <div class="backref-frame__body"></div>
  </div>
</template>

<template id="page-ref">
  <span class="page-ref"><span class="page-ref__brackets"></span><span class="page-ref__graphname"></span><span class="page-ref__body"></span><span
      class="page-ref__brackets"></span></span>
</template>

<template id="tag">
  <span class="tag"><span class="tag__graph-name"></span><span class="tag__body"></span></span>
</template>

<template id="image-embed">
  <img class="image-embed">
</template>

<template id="compute-failed">
  <span class="compute-failed"><span class="compute-failed__brackets"></span><span
      class="compute-failed__body"></span><span class="compute-failed__brackets"></span></span>
</template>

<template id="todo-checkbox">
  <input type="checkbox" class="todo-checkbox">
</template>

<template id="video-embed">
  <iframe class="video-embed" width="560" height="315" title="YouTube video player" frameborder="0"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
    allowfullscreen></iframe>
</template>

<template id="breadcrumb-page">
  <span class="breadcrumb-page"></span>
</template>

<template id="notification">
  <div class="notification"></div>
</template>

<template id="breadcrumb-block">
  <span class="breadcrumb-block"><span class="breadcrumb-block__arrow">-></span><span
      class="breadcrumb-block__body"></span></span>
</template>

<template id="autocomplete__suggestion">
  <div class="autocomplete__suggestion"></div>
</template>

<template id="command__suggestion">
  <div class="command__suggestion"></div>
</template>

<template id="template__suggestion">
  <div class="template__suggestion"></div>
</template>

<template id="search-result">
  <div class="search-result"></div>
</template>`,allFrame=elById("html");allFrame.innerHTML=allHtml;const topBarRight=elById("top-bar-right"),topBarLeft=elById("top-bar-left"),optionsFrame=elById("options-frame"),topButtons={};let topButtonNames=["Help","Daily Notes","Report Issue","Sign Up","Sign Out","Login","Upload","Download"];for(let e of topButtonNames)topButtons[e]=document.createElement("button"),topButtons[e].innerText=e,topButtons[e].tabindex=-1;topButtons["Create New Graph"]=document.createElement("input"),topButtons["Create New Graph"].placeholder="Create New Graph",topButtons["Create New Graph"].id="create-new-store",topButtons["Create New Graph"].type="text",topButtons["Create New Graph"].size=15;const disconnectedFileInput=document.createElement("input");disconnectedFileInput.type="file",topButtonNames=Object.keys(topButtons);let toShowOnTopBar=["help","Daily Notes","Report Issue","Sign Up"];const layoutTopBar=()=>{var e,t=Math.round(toShowOnTopBar.length/2);for(let e=0;e<t;e++)topBarLeft.appendChild(topButtons[topButtonNames[e]]);for(let e=t;e<toShowOnTopBar.length;e++)topBarRight.appendChild(topButtons[topButtonNames[e]]);for(e of topButtonNames)toShowOnTopBar.includes(e)||optionsFrame.appendChild(topButtons[e])};layoutTopBar();let sessionState={pageFrame:"dailyNotes",focusId:null,scroll:0,position:null},focusNode=null,focusOffset=null,focusBlock=null,focusBlockBody=null,editingTemplateExpander=null,editingCommandElement=null,editingLink=null,editingTitle=null,focusSuggestion=null,dragSelectStartBlock=null,dragSelect=null,clipboardData=null;const SEARCH_RESULT_LENGTH=12;document.body.className=user.s.theme;const topBar=document.getElementById("top-bar"),topBarHiddenHitbox=document.getElementById("top-bar-hidden-hitbox");"visible"===user.s.topBar&&(topBar.style.marginTop="0px",topBarHiddenHitbox.style.display="none"),setTimeout(()=>topBar.className="top-bar-transition",200);const pageFrame=elById("page-frame"),pageFrameOuter=elById("page-frame-outer"),searchInput=elById("search-input"),terminalElement=elById("terminal"),searchResultList=elById("search-result-list");searchResultList.dataset.templateName="search-result";const autocompleteList=elById("autocomplete-list");autocompleteList.dataset.templateName="autocomplete__suggestion";const inlineCommandList=elById("command-list");inlineCommandList.dataset.templateName="command__suggestion";const templateList=elById("template-list");templateList.dataset.templateName="template__suggestion";const switchToLogin=elById("switch-to-login"),switchToSignup=elById("switch-to-signup"),signupElement=elById("signup"),loginElement=elById("login"),reallyWantToLeaveElement=elById("really-want-to-leave"),appElement=elById("app"),topHamburgerElement=elById("top-hamburger"),connectFrame=elById("connect-frame"),loginForm=elById("login-form"),loginEmailElement=elById("login-email"),loginPasswordElement=elById("login-password"),signupForm=elById("signup-form"),signupUsernameElement=elById("signup-username"),signupEmailElement=elById("signup-email"),signupPasswordElement=elById("signup-password"),pageTemplate=getTemp("page"),blockTemplate=getTemp("block"),backrefListTemplate=getTemp("backref-list"),blockFocusFrameTemplate=getTemp("block-focus-frame"),searchResultTemplate=getTemp("search-result"),breadcrumbBlockTemplate=getTemp("breadcrumb-block"),breadcrumbPageTemplate=getTemp("breadcrumb-page"),backrefFrameTemplate=getTemp("backref-frame"),notificationTemplate=getTemp("notification"),tagTemplate=getTemp("tag"),pageRefTemplate=getTemp("page-ref"),imageEmbedTemplate=getTemp("image-embed"),computeFailedTemplate=getTemp("compute-failed"),todoCheckboxTemplate=getTemp("todo-checkbox"),videoEmbedTemplate=getTemp("video-embed"),queryFrameTemplate=getTemp("query-frame"),textEncoder=new TextEncoder,CHARS_64="-_0123456789abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ",CHARS_16="0123456789abcdef";let newUid;{let o=new Uint8Array(9);newUid=()=>{let t;do{crypto.getRandomValues(o),t="";for(let e=0;e<9;e++)t+=CHARS_64[o[e]%64]}while(void 0!==store.blox[t]);return t}}let newUUID;{let o=new Uint8Array(21);newUUID=()=>{crypto.getRandomValues(o);let t="";for(let e=0;e<21;e++)t+=CHARS_64[o[e]%64];return t}}const applyDif=(e,t)=>{let o=e.length;void 0!==t.s&&(o=t.s);var s=o-(void 0!==t.d&&t.d.length||0);return e.substring(0,s)+(t.i||"")+e.substring(o)},unapplyDif=(e,t)=>{var o=void 0!==t.d&&t.d.length||0,s=void 0!==t.i&&t.i.length||0;if(void 0!==t.s){var a=t.s-o,r=a+s;return e.substring(0,a)+(t.d||"")+e.substring(r)}s=e.length-o-s;return e.substring(0,s)+(t.d||"")},undoEditBlox=(e,t)=>{const[o,s,a,r,i,l]=e;switch(o){case"cr":var n=t[s].p;n&&(t[n].k=t[n].k.filter(e=>e!==s)),delete t[s];break;case"dl":var d=(t[s]=a).p,n=r;d&&(t[d].k||(t[d].k=[]),void 0!==n?t[d].k.splice(n,0,s):t[d].k.push(s));break;case"mv":var d=i,c=l;const p=t[s];t[a].k=t[a].k.filter(e=>e!=s),t[p.p=d].k||(t[d].k=[]),t[d].k.splice(c,0,s);break;case"df":c=a;const m=t[s];m.et=commit.time,m.s=unapplyDif(m.s,c)}},doEditBlox=(e,t,o)=>{const[s,a,r,i,l]=e;switch(s){case"dl":var n=t[a].p;n&&(t[n].k=t[n].k.filter(e=>e!==a)),delete t[a];break;case"cr":t[a]={ct:o,s:""};var n=r,d=i;void 0!==n&&(t[a].p=n,void 0===t[n].k&&(t[n].k=[]),void 0===d?t[n].k.push(a):t[n].k.splice(d,0,a));break;case"mv":var d=r,c=i;const p=t[a];t[l].k=t[l].k.filter(e=>e!=a),t[p.p=d].k||(t[d].k=[]),t[d].k.splice(c,0,a);break;case"df":c=r;const m=t[a];m.et=o,m.s=applyDif(m.s,c)}};let getProcessMemory;try{performance.memory.heapUsed,getProcessMemory=()=>performance.memory&&performance.memory.heapUsed}catch(e){process.memoryUsage().heapUsed,getProcessMemory=()=>process.memoryUsage().heapUsed}class LruCache{constructor(e,t=15e8){this.maxProcessMemory=t,this.fetcher=e,this.map=new Map}async get(e){var t=this.map.get(e);if(void 0!==t)return this.map.delete(e),this.map.set(e,t),t;t=await this.fetcher(e);if(t&&this.map.set(e,t),getProcessMemory()>this.maxProcessMemory)for(const o of this.map){this.map.delete(o[0]);break}return t}}const promisify=s=>(...o)=>new Promise((e,t)=>s(...o,e)),intToBase64=t=>{if(void 0!==t){let e="";for(;0<t;)e=""+CHARS_64[t%64]+e,t=Math.floor(t/64);return e}},base64ToInt=t=>{let o=0;for(let e=0;e<t.length;e++)o+=CHARS_64.indexOf(t[e])*Math.pow(64,t.length-e-1);return o},cpy=e=>{if("object"!=typeof e)return e;if(e instanceof Array)return e.map(cpy);{const o={};for(var t in e)o[t]=cpy(e[t]);return o}},monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"],getOrdinal=e=>{var t=e%10,o=e%100;return 1==t&&11!=o?e+"st":2==t&&12!=o?e+"nd":3==t&&13!=o?e+"rd":e+"th"},formatDate=e=>`${monthNames[e.getMonth()]} ${getOrdinal(e.getDate())}, ${e.getFullYear()}`,formatTime=e=>e.getHours()+":"+e.getMinutes(),unFormatDate=e=>{e=e.match(/([a-zA-Z]+) ([0-9]{1,2})(?:st|nd|rd|th), ([0-9]{4})/);if(e&&monthNames.includes(e[1]))return new Date},formatDateYMD=e=>`${e.getFullYear()}-${formatInt(e.getMonth()+1,2)}-${formatInt(e.getDate(),2)}`,truncateElipsis=(e,t=40)=>e.length>t?e.substring(0,t-3)+"...":e,getTomorrowDateString=()=>formatDate(new Date(Date.now()+864e5)),getYesterdayDateString=()=>formatDate(new Date(Date.now()-864e5)),getLastWeekDateString=()=>{const e=new Date(Date.now());return e.setDate(e.getDate()-7),formatDate(e)},getNextWeekDateString=()=>{const e=new Date(Date.now());return e.setDate(e.getDate()+7),formatDate(e)},formatInt=(e,t)=>{e=e.toString();return"0".repeat(t-e.length)+e},clamp=(e,t,o)=>Math.max(t,Math.min(e,o)),ustime=()=>{var e=Math.floor(1e3*(performance.timing.navigationStart+performance.now()));return console.log(e),e},pushToArrInObj=(e,t,o)=>{void 0===e[t]?e[t]=[o]:e[t].push(o)},canWriteBloc=e=>!0,isSynced=()=>user.s.commitId===user.s.syncCommitId,diff=(e,t)=>({d:t,i:e});let undoCommitList=[],undoCommitSessionStateList=[],undoCommitInProgress=[],masterCommitList=[],masterCommitInProgress=[];const undoEditCacheStuff=e=>{var[t,o,s]=e;switch(console.log(e),t){case"cr":void 0===s&&delete store.titles[s.s];break;case"df":setLinks(store,o);var a,r=store.blox[o];void 0===r.p&&(a=applyDif(r.s,s),delete store.titles[a],store.titles[r.s]=o)}},undo=()=>{var t=undoCommitList.pop();sessionState=undoCommitSessionStateList.pop();for(let e=t.edits.length-1;0<=e;e--){var o=t.edits[e];undoEditBlox(o,store.blox),undoEditCacheStuff(o)}},doEditCacheStuff=(e,t=!1)=>{const[o,s,a]=e;switch(o){case"dl":a.p||delete store.titles[a.s];var r=store.forwardRefs[s];if(r)for(var i of r){const n=store.refs[i];1===n.length?delete store.refs[i]:store.refs[i]=n.filter(e=>e!=s)}store.refs[s];break;case"df":setLinks(store,s,t);var l=store.blox[s];if(void 0===l.p){r=unapplyDif(l.s,a);if(delete store.titles[r],void 0!==store.titles[l.s])return void console.error(`duplicate block title ${l.s}`);store.titles[l.s]=s}}},doEdit=(...e)=>{var t=intToBase64(Date.now());undoCommitInProgress.push(e),masterCommitInProgress.push(e),print(e),doEditBlox(e,store.blox,t),doEditCacheStuff(e)},commit=()=>{var e=newUUID();undoCommitList.push({id:e,t:intToBase64(Date.now()),edits:undoCommitInProgress}),undoCommitSessionStateList.push(cpy(sessionState)),user.s.commitId=e,undoCommitInProgress=[],setTimeout(()=>{debouncedSaveStore(),saveUserJustLocalStorage()},0)},commitEdit=(...e)=>{doEdit(...e),commit()},saveStore=(e=!1)=>{var t,o=store.blox,o=JSON.stringify(o);let s="{";for(t in store)"blox"!==t&&void 0!==store[t]&&(s+='"'+t+'":'+JSON.stringify(store[t])+",");s+='"blox":'+o+"}",saveStoreToBasicBitchServer(o,e),saveStoreStringLocal(s)},saveStoreIncremental=()=>{syncEditsWithBasicBitchServer(),saveStoreStringLocal(JSON.stringify(store))},saveStoreStringLocal=e=>{try{localStorage.setItem("store",e)}catch(e){localStorage.removeItem("store"),console.error(`Local Storage Failure: ${e}`)}const t=idb.transaction(["stores"],"readwrite"),o=t.objectStore("stores"),s=o.put({graphName:store.graphName,store:e});s.onsuccess=()=>{console.log("saved")},s.onerror=e=>{console.log("save error"),console.log(e)}};let saveStoreTimeout=null;const debouncedSaveStore=()=>{user.s.commitId!==user.s.syncCommitId&&(clearTimeout(saveStoreTimeout),saveStoreTimeout=setTimeout(saveStoreIncremental,300))},print=e=>{user.s.logging&&console.log(e)},mergeEdits=t=>{for(let e=0;e<t.length;e++)t[e]},macros={};macros.nocommit={copyBlock:(e,t,o)=>{const i=(e,t,o)=>{var s=newUid(),a=store.blox[e];if(doEdit("cr",s,t,o),doEdit("df",s,diff(a.s,"")),a.k)for(let e=0;e<a.k.length;e++){var r=a.k[e];i(r,s,e)}return s};return i(e,t,o)},delete:e=>{var t=store.blox[e];let o=void 0;t.p&&(o=store.blox[t.p].k.indexOf(e)),doEdit("dl",e,cpy(t),o)},write:(e,t)=>{doEdit("df",e,diff(t,store.blox[e].s))},writePageTitle:(e,t)=>{var o,s=store.blox[e].s;doEdit("df",e,diff(t,s));for(o of store.refs[e]||[]){const i=store.blox[o];var a=i.s,r=i.s.replaceAll(s,t);console.log(a),console.log(r),doEdit("df",o,diff(r,a))}},createPage:e=>{if(!store.titles[e]){console.log(`making page ${e}`);var t=newUid();return doEdit("cr",t),doEdit("df",t,diff(e,"")),t}console.error(`tried to create page that already exists ${e}`)},create:(e,t)=>{var o=newUid();return doEdit("cr",o,e,t),o},move:(e,t,o)=>{var s=store.blox[e];void 0===o&&(o=store.blox[t].k.length),doEdit("mv",e,t,o,s.p,store.blox[s.p].k.indexOf(e))}};for(let t in macros.nocommit)macros[t]=(...e)=>{e=macros.nocommit[t](...e);return commit(),e};const blankStore=()=>({blox:{},titles:{},refs:{},forwardRefs:{},innerRefs:{},outerRefs:{},roamProps:{},ownerRoamId:void 0,graphName:void 0}),bloxProps=["s","p","ct","k","et","cu","eu"],gcPage=(e,t)=>{isPageEmpty(e,t)&&macros.nocommit.delete(t)},isPageEmpty=(e,t)=>{var o=e.blox[t];if(void 0!==e.refs[t]&&0<e.refs[t].length)return!1;if(o.k){if(1<o.k.length)return!1;if(0===o.k.length)return!0;o=o.k[0];return isBlockEmpty(e,o)}return!0},isBlockEmpty=(e,t)=>{t=e.blox[t];return""===t.s&&(void 0===t.k||0===t.k.length)},fixParents=()=>{for(var e in store.blox)delete store.blox[e].p;for(var t in store.blox){var o;for(o of store.blox[t].k||[])store.blox[o].p=t}},fixDuplicatePages=()=>{var e,t,o={};for(e in store.blox)store.blox[e].p||pushToArrInObj(o,store.blox[e].s,e);for(t in o){var s=o[t];for(let e=1;e<s.length;e++){for(var a of store.blox[s[e]].k||[])macros.move(a,s[0]);macros.delete(s[e])}}},parseRegexJustLinks=/(\[\[)|(\]\])|#([\/a-zA-Z0-9_-]+)|\(\(([a-zA-Z0-9\-_]+)\)\)|(^[\/a-zA-Z0-9_-]+)::|`([^`]+)`|```/g,setLinks=(o,t,e=!1,s=!1)=>{for(var a of o.forwardRefs[t]||[])o.refs[a]=o.refs[a].filter(e=>e!==t),s||gcPage(o,a);const r=[];o.forwardRefs[t]=r;let i;i=e?e=>{e in o.refs?o.refs[e].push(t):o.refs[e]=[t],r.push(e)}:e=>{e in o.refs?o.refs[e].push(t):o.refs[e]=[t],r.push(e)};var l,n=e=>{let t=o.titles[e];void 0===t&&(t=macros.nocommit.createPage(e)),i(t)};const d=o.blox[t].s;let c=0,p=void 0,m=[];for(l of d.matchAll(parseRegexJustLinks)){if(0===m.length||"cb"===p.t)l[1]?(m.push({t:"pr",s:""}),p=m[m.length-1]):l[3]?n(l[3]):l[5]?n(l[5]):l[4]?void 0!==o.blox[l[4]]&&i(l[4]):l[7]&&(p&&"cb"===p.t?m.pop():(m.push({t:"cb",s:""}),p=m[m.length-1]));else if(p.s=p.s+d.substring(c,l.index),c=l.index,l[1]){var u={t:"pr",s:""};p.s=p.s+"[[",m.push(u),p=m[m.length-1]}else if(l[2]){let e="]]";"pr"===p.t&&(e=p.s+"]]",n([p.s]),m.pop(),p=m[m.length-1]),void 0!==p&&(p.s=p.s+e)}else l[3]?(n(l[3]),p.s=p.s+l[0]):l[5]?(p.s=p.s+l[0],n(l[5])):l[4]?(void 0!==o.blox[l[4]]&&i(l[4]),p.s=p.s+l[0]):l[7]?p&&"cb"===p.t?m.pop():(m.push({t:"cb",s:""}),p=m[m.length-1]):p.s=p.s+l[0];c=l.index+l[0].length}0===r.length&&delete o.forwardRefs[t]},generateRefs=e=>{var t,o=performance.now();for(t in e.refs={},e.forwardRefs={},e.blox)setLinks(e,t);console.log(`gen refs took ${performance.now()-o}`)},mergeLists=(e,t)=>{for(var o of t)e.includes(o)||e.push(o)},arrSetDiff=(e,t)=>{let o=[],s=[];for(var a of e)t.includes(a)||o.push(a);for(var r of t)e.includes(r)||s.push(r);return{added:o,deleted:s}},propagateRefs=(t,e,o)=>{const{added:s}=arrSetDiff(e,o);t=store.blox[t];if(t.p){let e=t.p;for(;e;){var a=store.blox[e];const l=store.forwardRefs[e];for(let e=0;e<s.length;e++){var r=s[e];l.includes(r)?(s[e]=s.pop(),--e):l.push(r)}e=a.p}}let i=t;do{i=store.blox[i.p];for(let e=0;e<s.length;e++);}while(i.p)},generateInnerRefs=()=>{performance.now();for(var t in store.innerRefs={},store.forwardRefs){var o=store.forwardRefs[t];let e=t;for(;e;)store.innerRefs[e]||(store.innerRefs[e]=[]),mergeLists(store.innerRefs[e],o),e=store.blox[e].p}},generateOuterRefs=()=>{performance.now();for(var e in store.outerRefs={},store.forwardRefs){const o=store.forwardRefs[e],s=e=>{store.outerRefs[e]||(store.outerRefs[e]=[]),mergeLists(store.outerRefs[e],o);for(var t of store.blox[e].k||[])s(t)};s(e)}},generateInnerOuterRefs=()=>{generateInnerRefs(),generateOuterRefs()},mergeStore=i=>{const l={};for(var e in i.blox){var t=i.blox[e];store.titles[t.s]?store.blox[e]&&(l[e]=newUid()):l[e]=store.titles[t.s]}const n=(e,t)=>{var o=l[e]||e,e=i.blox[e];const s={...e};if(store.blox[o]=s,s.p=t,e.k){s.k=[];for(var a of e.k){var r=l[a]||a;n(a,o),s.k.push(r)}}};for(var o in i.titles){var s=i.titles[o],o=i.blox[s];if(void 0===store.titles[o.s]){var a=l(s)||s;const u={...o};if(store.blox[a]=u,store.titles[o.s]=a,o.k){u.k=[];for(var r of kids){var d=getNewId(r);n(r,a),u.k.push(d)}}}else if(o.k){var c,p=store.titles[o.s];const f=store.blox[p];f.k||(f.k=[]);for(c of o.k){var m=l[c]||c;n(c,p),f.k.push(m)}}}},escapeRegex=e=>e.replaceAll(/([\[\]\(\)])/g,"\\$1").replaceAll("\\\\",""),newSearchRegex=e=>new RegExp(escapeRegex(e),"i"),searchRefCountWeight=.05,pageOverBlockWeight=1;let titleExactFullTextSearchCache=[];const titleExactFullTextSearch=e=>{var t,o=newSearchRegex(e);for(t in titleExactFullTextSearchCache=[],store.titles){var s=store.titles[t],a=(store.blox[s],t.match(o));a&&titleExactFullTextSearchCache.push({title:t,id:s,idx:a.index-(store.refs[s]?store.refs[s].length:0)*searchRefCountWeight})}return titleExactFullTextSearchCache.sort((e,t)=>e.idx-t.idx),titleExactFullTextSearchCache};let exactFullTextSearchCache=[];const exactFullTextSearch=e=>{var t,o=newSearchRegex(e);for(t in exactFullTextSearchCache=[],store.blox){var s=store.blox[t];const e=s.s;var a=e.match(o);if(a){const r={id:t,idx:a.index-(store.refs[t]?store.refs[t].length:0)*searchRefCountWeight-(void 0===s.p)*pageOverBlockWeight};s.p?r.string=s.s:r.title=s.s,exactFullTextSearchCache.push(r)}}return exactFullTextSearchCache.sort((e,t)=>e.idx-t.idx),exactFullTextSearchCache};let templateSearchCache=[];const searchTemplates=e=>{var t=store.titles["roam/templates"],o=store.blox[t];templateSearchCache=[];let s;try{s=newSearchRegex(e)}catch{return templateSearchCache}if(o){var a=e=>{const t=store.blox[e];console.log(t.s);var o=t.s.match(s);console.log(o),o&&templateSearchCache.push({id:e,string:t.s,idx:o.idx})};if(store.refs[t])for(var r of store.refs[t])a(r);if(store.blox[t].k)for(var i of store.blox[t].k)a(i);console.log(templateSearchCache),templateSearchCache=templateSearchCache.sort((e,t)=>t.idx-e.idx),console.log(templateSearchCache)}return templateSearchCache},generateTitles=e=>{for(var t in e.titles={},e.blox){var o=e.blox[t];void 0===o.p&&(e.titles[o.s]=t)}},hydrateFromBlox=(e,t)=>{console.log("hydratefromblox");let o=blankStore();return o.blox=t,o.graphName=e,generateTitles(o),generateRefs(o),o},sortByLastEdited=e=>{e.sort((e,t)=>store.blox[e].et>store.blox[t].et?-1:1)},createAndSwitchToNewStore=async e=>{store=blankStore(),store.graphName=e,user.s.graphName=e,user.s.commitId="MYVERYFIRSTCOMMITEVER",saveUser(),await addGraph(),saveStore(),window.location.href=window.location.href},prepFocusIdForCursor=()=>{if(focusBlock&&focusBlock.isConnected&&focusBlock.dataset.id!==sessionState.focusId&&(focusBlockBody.textContent="",renderBlockBody(focusBlockBody,store.blox[focusBlock.dataset.id].s)),focusBlock=document.querySelector(`.block[data-id="${sessionState.focusId}"]`),focusBlockBody=focusBlock.children[1],void 0===focusBlock)throw new Error(`tried to focus block that doesn't exist: ${sessionState.focusId}`);sessionState.isFocused=!0;var e=store.blox[sessionState.focusId].s;focusBlockBody.innerText="",renderBlockBody(focusBlockBody,e,!0)},focusIdPosition=()=>{prepFocusIdForCursor();const s=e=>{for(var t of e.childNodes)if("#text"===t.nodeName){if(sessionState.position>=(t.startIdx||0)&&sessionState.position<=(t.startIdx||0)+t.textContent.length){scanResult=t;var o=sessionState.position-t.startIdx;return getSelection().collapse(t,o),t}}else{t=s(t);if(t)return t}};s(focusBlockBody),updateCursorSpanInfo()},selectIdWholeNode=e=>{prepFocusIdForCursor(),updateCursorSpanInfo()},setFocusedBlockString=(e,t)=>{let o=e;void 0===o&&(o=store.blox[sessionState.focusId].s),void 0!==t?commitEdit("df",sessionState.focusId,t):macros.write(sessionState.focusId,o),focusIdPosition()},getEditingSimpleSpan=e=>{var t;for(t of focusBlockBody.querySelectorAll("."+e))if(t.childNodes[0].endIdx>=sessionState.position&&t.childNodes[0].startIdx<sessionState.position)return t},updateCursorPosition=()=>{focusNode=getSelection().focusNode,focusOffset=getSelection().focusOffset;var e=focusNode.parentNode.closest(".block");sessionState.focusId=e.dataset.id,sessionState.position=(focusNode.startIdx||0)+focusOffset},updateCursorSpanInfo=()=>{var e,t;editingLink=void 0;for(e of focusBlockBody.querySelectorAll(".tag"))e.children[1].firstChild.endIdx>=sessionState.position&&e.children[0].firstChild.startIdx<sessionState.position&&(editingLink=e);for(t of focusBlockBody.querySelectorAll(".page-ref"))t.children[2].firstChild.endIdx>=sessionState.position&&t.children[1].firstChild.startIdx<sessionState.position&&(editingLink=t);editingTitle=editingLink&&editingLink.title,editingTemplateExpander=getEditingSimpleSpan("template-expander"),editingUrlElement=getEditingSimpleSpan("url"),editingCommandElement=getEditingSimpleSpan("command"),void 0===editingCommandElement&&(inlineCommandList.style.display="none"),void 0===editingTemplateExpander&&(templateList.style.display="none"),void 0===editingLink&&(autocompleteList.style.display="none")},focusBlockEnd=e=>{sessionState.focusId=e.dataset.id,sessionState.position=store.blox[sessionState.focusId].s.length,focusIdPosition()},focusBlockStart=e=>{sessionState.focusId=e.dataset.id,sessionState.position=0,focusIdPosition()},focusBlockVerticalOffset=(e,t=focusBlock,o=!1)=>{const s=Array.from(document.querySelectorAll(".block")),a=s[s.indexOf(t)+e];a&&(a.scrollIntoView({block:"nearest",inline:"nearest"}),(o?focusBlockStart:focusBlockEnd)(a))},getChildren=e=>("block"===e.className?e.children[2]:e.children[1]).children,getClosestPageLink=e=>e.closest(".tag")||e.closest(".attribute")||e.closest(".page-ref"),getPageTitleOfNode=e=>{e=getClosestPageLink(e);return e&&e.title},renderPage=(e,t,o=!0)=>{var s,a,r=store.blox[t];const i=pageTemplate.cloneNode(!0),l=i.firstElementChild,n=i.children[1];if(n.dataset.id=t,i.dataset.id=t,void 0===r.s)throw new Error(`error with page id ${t}`);l.innerText=r.s;let d=r.k;d&&0!==d.length||(s=newUid(),commitEdit("cr",s,t,0),d=r.k);for(a of d)renderBlock(n,a);t=store.refs[t];return o&&t&&0<t.length&&(o=backrefListTemplate.cloneNode(!0),i.children[2].appendChild(o),renderBackrefs(o.children[1],t)),e.appendChild(i),i},renderBackrefs=(e,t)=>{sortByLastEdited(t);for(var o of t){var s=backrefFrameTemplate.cloneNode(!0);renderBreadcrumb(s.children[0],o),renderBlock(s.children[1],o),e.appendChild(s)}},renderBlock=(e,t,o)=>{const s=blockTemplate.cloneNode(!0),a=s.children[1],r=s.children[2];s.dataset.id=t,r.dataset.id=t,a.dataset.id=t;var i,l=store.blox[t].s;renderBlockBody(a,l);for(i of store.blox[t].k||[])renderBlock(r,i);return void 0!==o&&e.children.length>=o?e.insertBefore(s,e.children[o]):e.appendChild(s),s},renderBreadcrumb=(t,e)=>{e=store.blox[e].p;const o=[];for(;void 0!==e;){var s=store.blox[e];void 0!==s.p?o.push({string:s.s,id:e}):o.push({title:s.s,id:e}),e=s.p}if(0<o.length){const i=breadcrumbPageTemplate.cloneNode(!0);var a=o[o.length-1].title;renderBlockBody(i,a),i.dataset.title=a,t.appendChild(i);for(let e=o.length-2;0<=e;e--){const l=breadcrumbBlockTemplate.cloneNode(!0);var r=l.children[1];renderBlockBody(r,o[e].string),l.dataset.id=o[e].id,t.appendChild(l)}}},renderResultSet=(e,t,o,s=0)=>{if(0===t.length)return o.style.display="none",void(focusSuggestion=null);const a=getTemp(o.dataset.templateName);o.innerHTML="",o.style.display="block";e=e.getBoundingClientRect();o.style.top=e.bottom,o.style.left=e.left,o.dataset.resultStartIdx=s;var r=Math.min(t.length,s+SEARCH_RESULT_LENGTH);for(let e=s;e<r;e++){matchingTitle=t[e];const i=a.cloneNode(!0);e==s&&(focusSuggestion=i,i.dataset.selected="true"),i.dataset.id=matchingTitle.id,matchingTitle.title?(i.dataset.title=matchingTitle.title,i.innerText=truncateElipsis(matchingTitle.title,50)):(i.dataset.string=matchingTitle.string,i.innerText=truncateElipsis(matchingTitle.string,50)),o.appendChild(i)}},notifyText=(e,t)=>{const o=notificationTemplate.cloneNode(!0);o.innerText=e,appElement.appendChild(o),setTimeout(()=>o.style.top="60px",50);t=t&&1e3*t||5e3;setTimeout(()=>o.style.opacity="0",t),setTimeout(()=>{o.remove()},t+300)},parseRegex=/(\[\[(?:[a-zA-Z0-9\-]+:)?)|(\]\])|(or)|\(\(([a-zA-Z0-9\-_]+)\)\)|(\*\*)|(\^\^)|(__)|((?:https?\:\/\/)(?:[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6})\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/\/=]*))|`([^`]+)`|;;([^ \n\r]+)|(and)|(```)|(\/[ a-zA-Z]*)|!\[([^\]]*)\]\(((?:https?\:\/\/)(?:[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6})\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/\/=]*))\)|({{)|(}})|#([a-zA-Z0-9\-]+:)?([\/a-zA-Z0-9_-]+)|^([a-zA-Z0-9\-]+:)?([ \/a-zA-Z0-9_-]+)::/g,renderBlockBody=(e,t,o=!1)=>{e.dataset.editmode=o;const s=[e];var a=t.matchAll(parseRegex);let r=0,i=e,l=null;var n,d=e=>(l=document.createTextNode(e),l.startIdx=r,l.endIdx=r+e.length,l);for(n of a){if(i.appendChild(d(t.substring(r,n.index))),r=n.index,void 0!==n[1]){const m=pageRefTemplate.cloneNode(!0);m.startIdx=r+2,i.appendChild(m),i.graphName=n[1],o&&m.children[0].appendChild(d("[[")),m.startIdx=r;const u=document.createTextNode(n[0].substring(2));u.startIdx=r+2,u.endIdx=r+n[0].length,m.children[1].appendChild(u),s.push(m.children[2]),i=s[s.length-1]}else if(void 0!==n[2])if("page-ref__body"===i.className)i.parentNode.endIdx=r,i.parentNode.title=i.innerText,i.parentNode.endIdx=r+2,o&&i.parentNode.children[3].appendChild(d("]]")),s.pop(),i=s[s.length-1],l.endIdx+=2;else{const f=document.createElement("span");o&&(f.className="page-ref-close-missing-open"),f.appendChild(d("]]")),i.appendChild(f)}else if(void 0!==n[3]){const g=document.createElement("span");g.className="compute-or",g.appendChild(d("or")),i.appendChild(g)}else if(void 0!==n[4])if(o){const h=document.createElement("span");h.className="block-ref-editing",h.appendChild(d(n[0])),i.appendChild(h)}else{var c=n[4],p=store.blox[c];if(p){const v=document.createElement("span");v.className="block-ref",v.innerText=p.s,v.dataset.id=c,i.appendChild(v)}else i.appendChild(d(n[0]))}else if(void 0!==n[5])if("bold"===i.className)o&&i.appendChild(d("**")),s.pop(),i=s[s.length-1],l.endIdx+=2;else{const b=document.createElement("span");b.className="bold",i.appendChild(b),o&&b.appendChild(d("**")),s.push(b),i=b}else if(void 0!==n[6])if("highlight"===i.className)o&&i.appendChild(d("^^")),s.pop(),i=s[s.length-1],l.endIdx+=2;else{const y=document.createElement("span");y.className="highlight",i.appendChild(y),o&&y.appendChild(d("^^")),s.push(y),i=y}else if(void 0!==n[7])if("italic"===i.className)o&&i.appendChild(d("__")),s.pop(),i=s[s.length-1],l.endIdx+=2;else{const S=document.createElement("span");S.className="italic",o&&S.appendChild(d("__")),i.appendChild(S),s.push(S),i=S}else if(void 0!==n[8]){const x=document.createElement("span");x.className="url",x.appendChild(d(n[0])),x.href=n[8],i.appendChild(x)}else if(void 0!==n[9]){const k=document.createElement("span");k.className="literal",o?k.appendChild(d(n[0])):k.appendChild(d(n[9])),i.appendChild(k)}else if(void 0!==n[10]){const B=document.createElement("span");B.className="template-expander",B.appendChild(d(n[0])),i.appendChild(B)}else if(void 0!==n[11]){const w=document.createElement("span");w.className="compute-and",w.appendChild(d("and")),i.appendChild(w)}else if(void 0!==n[12])if("code-block"===i.className)o&&i.appendChild(d("```")),s.pop(),i=s[s.length-1];else{const C=document.createElement("div");C.className="code-block",i.appendChild(C),s.push(C),i=C,o&&i.appendChild(d("```"))}else if(void 0!==n[13]){const T=document.createElement("span");T.className="command",T.appendChild(d(n[0])),i.appendChild(T)}else if(void 0!==n[14]&&void 0!==n[15])if(o){const I=document.createElement("span");I.className="image-full-text",I.appendChild(d(n[0])),i.appendChild(I)}else{const N=imageEmbedTemplate.cloneNode(!0);N.alt=n[14],N.src=n[15],i.appendChild(N)}else if(void 0!==n[16]){const E=computeFailedTemplate.cloneNode(!0);E.startIdx=r+2,i.appendChild(E),E.children[0].appendChild(d("{{")),s.push(E.children[1]),i=s[s.length-1]}else if(void 0!==n[17])if("compute-failed__body"===i.className){const _=i.parentNode;_.endIdx=r,_.text=t.substring(_.startIdx,_.endIdx),_.children[2].appendChild(d("}}")),transformComputeElement(_,o),s.pop(),i=s[s.length-1],l.endIdx+=2}else{const L=document.createElement("span");L.appendChild(d("}}")),i.appendChild(L)}else if(void 0!==n[19]){const R=tagTemplate.cloneNode(!0);n[18]=n[18]||"",R.children[0].appendChild(d("#"+n[18])),R.graphName=n[18],R.title=n[19];const D=document.createTextNode(n[19]);D.startIdx=r+n[18].length+1,D.endIdx=r+n[0].length,R.startIdx=r,R.endIdx=r+n[0].length,R.children[1].appendChild(D),i.appendChild(R)}else if(void 0!==n[21]){const F=document.createElement("span");F.className="attribute",F.graphName=n[20],F.title=n[21],F.appendChild(d(n[0])),i.appendChild(F)}r=n.index+n[0].length}for(s[s.length-1].appendChild(d(t.substring(r)));i!==e;)"page-ref"===i.className&&(i.children[0].className=i.children[0].className+"-incomplete"),i.className=i.className+"-incomplete",i=i.parentNode},queryOperationOrder={root:0,"compute-or":1,"compute-and":2,page:3},transformComputeElement=(o,e)=>{var s=o.children[1].children;if(0!==s.length){var a=s[0],a=getPageTitleOfNode(a);if(a){switch(a){case"TODO":if(e)return;o.textContent="";var r=todoCheckboxTemplate.cloneNode(!0);o.appendChild(r);break;case"DONE":if(e)return;{o.textContent="";const f=todoCheckboxTemplate.cloneNode(!0);f.checked=!0,o.appendChild(f)}break;case"video":if(e||user.s.noVideo)return;if(2!==s.length)return;if("url"===s[1].className){const g=videoEmbedTemplate.cloneNode(!0);g.src=youtubeLinkToEmbed(s[1].innerText),o.textContent="",o.appendChild(g)}break;case"query":let t=r={op:"root"};for(let e=1;e<s.length;e++){const h={},o=s[e];var i=getPageTitleOfNode(o);if(i){if(h.title=i,h.op="page",void 0===t.l)t.l=h;else{if(void 0!==t.r)return void console.error("page ref with no operator");t.r=h}h.p=t,t=h}else{var l=queryOperationOrder[o.className];if(void 0!==l){h.op=o.className;let e=void 0;for(;queryOperationOrder[t.op]>l;)e=t,t=t.p;h.l=e,void 0!==e&&(e.p=h),t.l===e?t.l=h:t.r=h,h.p=t,t=h}}}var n,d,r=r.l;performance.now();const c={};for(n of store.refs[store.titles.query])c[n]=1;const p=[];for(d in queryAstObjectSetStrategy(r))void 0===c[d]&&void 0!==store.blox[d]&&p.push(d);r=queryFrameTemplate.cloneNode(!0);renderBackrefs(r,p);const m=o.closest(".block"),u=m.querySelector(".query-frame");return u&&u.remove(),void m.appendChild(r);default:return}o.className="compute"}}},queryAstArrayStrategy=e=>{if(void 0===e)return[];var t=queryAstArrayStrategy(e.r);let o=queryAstArrayStrategy(e.l);switch(e.op){case"compute-and":const r=[];for(var s of t)o.includes(s)&&r.push(s);return r;case"compute-or":for(var a of t)o.push(a);return o;case"page":return[...store.refs[store.titles[e.title]]||[]]}},queryAstObjectSetStrategy=e=>{if(void 0===e)return{};var t,o=queryAstObjectSetStrategy(e.r);let s=queryAstObjectSetStrategy(e.l),a={};switch(e.op){case"compute-and":for(var r in o)1===s[r]&&(a[r]=1);return a;case"compute-or":for(var i in o)s[i]=1;return s;case"page":for(t of store.refs[store.titles[e.title]])a[t]=1;return a}},idOfYoutubeURL=e=>{e=e.match(/^https:\/\/www\.youtube.com\/watch\?v=([a-zA-Z0-9]+)(&t=.+)?$/);if(e)return e[1]},embedLinkOfYoutubeId=e=>`https://www.youtube.com/embed/${e}`,youtubeLinkToEmbed=e=>embedLinkOfYoutubeId(idOfYoutubeURL(e)),reset=()=>{localStorage.clear();indexedDB.deleteDatabase("microroam");window.location.href=window.location.href},syncEditsWithBasicBitchServer=async()=>{if(0!==masterCommitInProgress.length){const s=new Headers;s.set("h",user.h);var e=newUUID(),t={id:e,t:intToBase64(Date.now()),edits:masterCommitInProgress};masterCommitInProgress=[],s.set("body",JSON.stringify(t)),s.set("synccommitid",user.s.syncCommitId);var o=await fetch(`${basicBitchServerUrl}/edit/${store.graphName}`,{headers:s});200===o.status?(user.s.syncCommitId=e,masterCommitList.push(t)):409===o.status?(console.log("conflicting edit"),invalidateLocal()):masterCommitInProgress=[...t.edits,...masterCommitInProgress]}},saveStoreToBasicBitchServer=async(e,t=!1)=>{var o=performance.now();const s=new Headers;s.set("h",user.h);var a=user.s.commitId;s.set("commitid",a),s.set("synccommitid",user.s.syncCommitId),t&&s.set("force","true");e=await fetch(`${basicBitchServerUrl}/put/${store.graphName}`,{method:"POST",body:e,headers:s});200===e.status||304===e.status?(user.s.syncCommitId=a,console.log(`save confirmed in ${performance.now()-o}`)):console.warn("failed to save to server")},getBloxFromBasicBitchServer=async e=>{var t=performance.now();const o=await fetch(`${basicBitchServerUrl}/get/${e}`,{headers:{passwordHash:user.h}});if(200===reponse.status){e=await o.json();return console.log(`got in ${performance.now()-t}`),e}console.warn("failed to get store")},addOtherStore=async e=>{var t=await getBloxFromBasicBitchServer(e),t=hydrateFromBlox(t);otherStores[e]=t},saveSettingsToBasicBitchServer=async()=>{const e=new Headers;e.set("h",user.h),e.set("body",JSON.stringify(user.s)),200!==(await fetch(`${basicBitchServerUrl}/settings`,{headers:e})).status&&console.log("failed to save settings")},middlePepper="76pCgT0lW6ES9yjt01MeH",beginPepper="CeoPPOv9rIq6O7YiYlSFX",endPepper="Rzw1dagomQGpoo2s7iGE3lYL2yruaJDGrUk6bFCvz",hashPassword=async(e,t)=>{var t=`${beginPepper}${e}${middlePepper}${t}${endPepper}`,t=textEncoder.encode(t),t=await crypto.subtle.digest("SHA-512",t),o=new Uint8Array(t);let s="";for(let e=0;e<o.length;e++)s+=String.fromCharCode(o[e]);return s=btoa(s),s=s.replaceAll("/","-").replaceAll("+","_").replaceAll("=",""),s};loginForm.addEventListener("submit",async e=>{e.preventDefault();var t=loginEmailElement.value;loginEmailElement.value="";e=loginPasswordElement.value;loginPasswordElement.value="";t=await hashPassword(e,t);const o=await fetch(`${basicBitchServerUrl}/auth`,{method:"POST",headers:{h:t}});200===o.status?(user=await o.json(),saveUser(),invalidateLocal(),console.log(user)):notifyText("Don't know that username + password.")}),signupForm.addEventListener("submit",async e=>{e.preventDefault();var t=signupEmailElement.value;signupEmailElement.value="";var o=signupUsernameElement.value;signupUsernameElement.value="";e=signupPasswordElement.value;signupPasswordElement.value="";e=await hashPassword(e,t),t=JSON.stringify({h:e,u:o,e:t,s:user.s});console.log(t);const s=new Headers;s.set("body",t);const a=await fetch(`${basicBitchServerUrl}/signup`,{method:"POST",headers:s});200===a.status?(console.log(a),user=await a.json(),saveUser(),invalidateLocal(),console.log("signed up")):(t=await a.json(),notifyText(t))});const addGraph=async()=>{const e=new Headers;e.set("h",user.h),e.set("commitid",user.s.commitId);var t=user.s.commitId;(await fetch(`${basicBitchServerUrl}/creategraph/${store.graphName}`,{headers:e,method:"POST",body:JSON.stringify(store.blox)})).ok?user.s.syncCommitId=t:notifyText("failed to add graph")},initialDailyNotes=5,renderSessionState=()=>{switch(searchResultList.style.display="none",pageFrameOuter.removeEventListener("scroll",dailyNotesInfiniteScrollListener),pageFrame.innerHTML="",searchInput.value="",sessionState.pageFrame){case"pageTitle":let e=store.titles[sessionState.page];void 0===e&&(e=macros.createPage(sessionState.page)),renderPage(pageFrame,e);break;case"block":const i=blockFocusFrameTemplate.cloneNode(!0);pageFrame.appendChild(i),renderBreadcrumb(i.children[0],sessionState.block),renderBlock(i.children[1],sessionState.block);const l=store.refs[sessionState.block];if(l){l.sort((e,t)=>store.blox[t].et-store.blox[e].et);var s,a=backrefListTemplate.cloneNode(!0);i.children[2].appendChild(a);for(s of l)renderBlock(a.children[1],s)}break;case"dailyNotes":pageFrameOuter.addEventListener("scroll",dailyNotesInfiniteScrollListener),sessionState.oldestDate=new Date(Date.now());let t=0;console.log(store.titles);let o=formatDate(sessionState.oldestDate);generateTitles(store),store.titles[o]||(console.log(`creating page ${o}`),macros.createPage(o));for(let e=0;e<1e3;e++){var r=store.titles[o];if(r){renderPage(pageFrame,r);const n=document.createElement("div");if(n.className="page-break",pageFrame.appendChild(n),t+=1,t>=initialDailyNotes)break}sessionState.oldestDate.setDate(sessionState.oldestDate.getDate()-1),o=formatDate(sessionState.oldestDate)}t<initialDailyNotes&&pageFrame.lastChild.remove()}var e;sessionState.isFocused&&pageFrame.querySelector(`.block[data-id="${sessionState.focusId}"]`)?console.log(`SESSION STATE ALREADY FOCUSED ON ${sessionState.focusId}`):(e=pageFrame.querySelector(".block"),sessionState.position=0,sessionState.focusId=e.dataset.id),focusIdPosition(),pageFrameOuter.scrollTop=sessionState.scroll||0},gotoNoHistory=(e,...t)=>{switch(e){case"dailyNotes":sessionState.pageFrame="dailyNotes";break;case"pageTitle":sessionState.pageFrame="pageTitle",sessionState.page=t[0];break;case"block":sessionState.pageFrame="block",sessionState.block=t[0]}renderSessionState()},goto=(...e)=>{sessionState.scroll=pageFrameOuter.scrollTop;const t=JSON.parse(JSON.stringify(sessionState));sessionState.isFocused=!1,sessionState.scroll=0,gotoNoHistory(...e),setTimeout(()=>{history.replaceState(t,"Micro Roam"),history.pushState(sessionState,"Micro Roam")},0)},gotoReplaceHistory=(...e)=>{gotoNoHistory(...e),history.replaceState(sessionState,"Micro Roam")};window.addEventListener("popstate",e=>{console.log(e.state),e.state&&(sessionState=e.state,renderSessionState())});const dailyNotesInfiniteScrollListener=()=>{if(pageFrame.getBoundingClientRect().bottom-innerHeight<700)for(let e=0;e<100;e++){sessionState.oldestDate.setDate(sessionState.oldestDate.getDate()-1);var t=store.titles[formatDate(sessionState.oldestDate)];if(t){renderPage(pageFrame,t);const o=document.createElement("div");o.className="page-break",pageFrame.appendChild(o);break}}},parseStackTrace=e=>{const t=[];var o;for(o of e.matchAll(/([^ ]+) \(([^\)]+):([0-9]+):([0-9]+)\)(?:\n|$)/g))t.push({function:o[1],file:o[2],line:o[3],column:o[4]});return t},logError=(e,t,o,s,a)=>{e={line:o,file:t,stack:parseStackTrace(a.stack),message:e,column:s},s=localStorage.getItem("error_log");if(s){const r=JSON.parse(s);r.push(e),localStorage.setItem("error_log",JSON.stringify(r))}else localStorage.setItem("error_log",JSON.stringify([e]));return!1};window.onerror=logError;const showTopBar=()=>{topBar.style.marginTop="0px",topBarHiddenHitbox.style.display="none"},hideTopBar=()=>{topBar.style.marginTop="-36px",topBarHiddenHitbox.style.display="block"},saveUser=()=>{document.body.className=user.s.theme,("visible"===user.s.topBar?showTopBar:hideTopBar)(),document.body.spellcheck=user.s.spellcheck,document.body.dataset.editingspotlight=user.s.editingSpotlight,user.h?(topButtons["Sign Out"].style.display="block",topButtons["Sign Up"].style.display="none",topButtons.Login.style.display="none"):(topButtons["Sign Out"].style.display="none",topButtons["Sign Up"].style.display="block",topButtons.Login.style.display="block"),saveUserJustLocalStorage(),saveSettingsToBasicBitchServer()},saveUserJustLocalStorage=()=>{localStorage.setItem("user",JSON.stringify(user))};dataLoaded&&start(),scriptsLoaded=!0;const ptest=()=>{var e=performance.now();for(let e=0;e<100;e++)generateInnerOuterRefs();e=performance.now()-e;console.log(`thing took ${e}`)}</script><script async>const downloadHandler=()=>{console.log("download");var e=storeToRoamJSON(store),e=new Blob([e],{type:"text/json"}),e=URL.createObjectURL(e);const t=document.createElement("a");t.setAttribute("href",e),t.setAttribute("download",`${store.graphName}-${formatDateYMD(new Date(Date.now()))}.json`),t.click()},downloadMd=()=>{console.log("download md");var e=storeToMdZip(),e=URL.createObjectURL(e);const t=document.createElement("a");t.setAttribute("href",e),t.setAttribute("download",`${store.graphName}-md-${formatDateYMD(new Date(Date.now()))}.zip`),t.click()},expandTemplate=()=>{var e=focusSuggestion.dataset.id,t=store.blox[sessionState.focusId];if(void 0===t.k||0===t.k.length){var o=store.blox[sessionState.focusId].p,n=store.blox[e].k,s=store.blox[o].k.indexOf(sessionState.focusId);macros.nocommit.delete(sessionState.focusId,!1);var r=focusBlock.parentNode;focusBlock.remove();for(let e=0;e<n.length;e++){var a=n[e],l=s+e,a=macros.nocommit.copyBlock(a,o,l),l=renderBlock(r,a,l);0===e&&focusBlockEnd(l)}commit()}else notifyText("can't use a template inside a block that has children");templateList.style.display="none"},pasteBlocks=()=>{var o=store.blox[sessionState.focusId].p;let n=store.blox[o].k.indexOf(sessionState.focusId);var s=focusBlock.parentNode;if(""===focusBlockBody.innerText?(macros.nocommit.delete(sessionState.focusId),focusBlock.remove()):n+=1,clipboardData.dragSelect.rooted){var e=macros.nocommit.copyBlock(clipboardData.dragSelect.root,o,n),e=renderBlock(s,e,n);focusBlockEnd(e)}else{let t=null;for(let e=0;e<clipboardData.dragSelect.endIdx+1-clipboardData.dragSelect.startIdx;e++){var r=store.blox[clipboardData.dragSelect.root].k[e+clipboardData.dragSelect.startIdx],r=macros.nocommit.copyBlock(r,o,e+n),r=renderBlock(s,r,e+n);t=r}focusBlockEnd(t)}commit()},autocomplete=()=>{const e=store.blox[sessionState.focusId].s;var t,o;"tag"===editingLink.className?(editingLink.childNodes[0],focusSuggestion.dataset.title.match(/^[a-zA-Z0-9\-_]+$/)?(t=e.slice(0,editingLink.startIdx)+"#"+focusSuggestion.dataset.title+e.slice(editingLink.endIdx),sessionState.position=editingLink.startIdx+focusSuggestion.dataset.title.length+1,setFocusedBlockString(t)):(o=e.slice(0,editingLink.startIdx)+"[["+focusSuggestion.dataset.title+"]]"+e.slice(editingLink.endIdx),console.log(o),sessionState.position=editingLink.startIdx+focusSuggestion.dataset.title.length+4,setFocusedBlockString(o))):(o=e.slice(0,editingLink.startIdx)+"[["+focusSuggestion.dataset.title+"]]"+e.slice(editingLink.endIdx),console.log(o),sessionState.position=editingLink.startIdx+focusSuggestion.dataset.title.length+4,setFocusedBlockString(o)),autocompleteList.style.display="none"},indentFocusedBlock=()=>{var e,t,o=sessionState.focusId;const n=focusBlock.previousElementSibling;n&&n.dataset&&n.dataset.id&&(e=n.dataset.id,console.log(e),t=store.blox[e].k&&store.blox[e].k.length||0,macros.move(o,e,t),n.children[2].appendChild(focusBlock),getSelection().collapse(focusNode,focusOffset))},dedentFocusedBlock=()=>{var e=sessionState.focusId,t=store.blox[e].p,o=store.blox[t];if(o){o=o.p,t=store.blox[o].k.indexOf(t);macros.move(e,o,t+1);t=focusBlock.parentNode.parentNode;const n=t.parentNode;t=t.nextElementSibling;t?n.insertBefore(focusBlock,t):n.appendChild(focusBlock),getSelection().collapse(focusNode,focusOffset)}};document.addEventListener("input",n=>{var e,s;if(sessionState.isFocused)if(updateCursorPosition()," "!==focusBlockBody.innerText&&""!==focusBlockBody.innerText){let t=focusBlockBody.innerText,o=null!==n.data&&1===n.data.length&&"insertText"===n.inputType;if(null!==n.data)if("["===n.data){var r,a=n.target.querySelectorAll(".page-ref-close-missing-open");let e=!1;for(r of a)if(console.log(r),r.childNodes[0].startIdx>sessionState.position){e=!0;break}e||(t=t.substring(0,sessionState.position)+"]"+t.substring(sessionState.position),o=!1)}else"]"===n.data&&"]"===t[sessionState.position]&&(t=t.substring(0,sessionState.position-1)+t.substring(sessionState.position),o=!1);let e={d:store.blox[sessionState.focusId].s,i:t};o&&(e=sessionState.position===t.length?{i:n.data}:{i:n.data,s:sessionState.position-1}),setFocusedBlockString(t,e),editingCommandElement&&(a=matchInlineCommand(editingCommandElement.innerText.substring(1)),renderResultSet(editingCommandElement,a,inlineCommandList,0)),editingTitle&&(s=titleExactFullTextSearch(editingTitle),renderResultSet(editingLink,s,autocompleteList,0)),editingTemplateExpander&&(s=editingTemplateExpander.innerText.substring(2),s=searchTemplates(s),renderResultSet(editingTemplateExpander,s,templateList,0))}else macros.write(sessionState.focusId,"");else"search-input"===n.target.id?(e=exactFullTextSearch(n.target.value),renderResultSet(searchInput,e,searchResultList,0)):"page__title"===n.target.className&&(console.log("edit title"),e=n.target.parentNode.dataset.id,macros.writePageTitle(e,n.target.innerText))});const globalHotkeys={"hide top bar":{key:"b",control:!0,fn:()=>{"0px"===topBar.style.marginTop?user.s.topBar="hidden":user.s.topBar="visible",saveUser()}},escape:{key:"Escape",fn:()=>{autocompleteList.style.display="none",templateList.style.display="none"}},upload:{key:"d",control:!0,fn:()=>{topButtons.Upload.click()}},download:{key:"s",control:!0,shift:!0,fn:downloadHandler},save:{key:"s",control:!0,fn:debouncedSaveStore},"toggle color theme":{key:"m",control:!0,fn:()=>{"light"===document.body.className?user.s.theme="dark":user.s.theme="light",saveUser()}},search:{key:"u",control:!0,fn:()=>{"0px"!==topBar.style.marginTop&&(topBar.style.marginTop="0px"),searchInput.focus()}},open:{key:"o",control:!0,fn:e=>{editingTitle?goto("pageTitle",editingTitle):editingUrlElement&&editingUrlElement.click()}},"daily notes":{key:"d",alt:!0,fn:()=>{goto("dailyNotes")}},undo:{key:"z",control:!0,fn:()=>{0<undoCommitList.length&&(undo(),renderSessionState())}},"delete block":{key:"k",control:!0,shift:!0,fn:()=>{var e=store.blox[sessionState.focusId];if(void 0===e.k||0===e.k.length){const t=focusBlock;e=sessionState.focusId;focusBlockVerticalOffset(-1),t.remove(),macros.delete(e)}else notifyText('no "delete block" for blocks with children (at least right now)')}},terminal:{key:"i",control:!0,alt:!0,fn:()=>{"none"===terminalElement.style.display?(terminalElement.style.display="block",terminalElement.focus()):terminalElement.style.display="none"}},p:{key:"p",control:!0,fn:()=>{console.log("at least it wasn't print")}}};document.addEventListener("keydown",event=>{for(var hotkeyName in globalHotkeys){const hotkey=globalHotkeys[hotkeyName];if(event.key.toLowerCase()===hotkey.key&&event.shiftKey===!!hotkey.shift&&event.ctrlKey===!!hotkey.control&&event.altKey===!!hotkey.alt)return hotkey.fn(event),void event.preventDefault()}if(dragSelect){let did=!1;if(("c"===event.key||"x"===event.key)&&event.ctrlKey){let text="";console.log("copy blocks");const id=dragSelect.root.dataset.id;if(dragSelect.rooted)text=blocToMd(id);else{const kids=store.blox[id].k;for(let i=dragSelect.startIdx;i<dragSelect.endIdx+1;i++)text+=blocToMd(kids[i])}clipboardData={dragSelect:{root:id,startIdx:dragSelect.startIdx,endIdx:dragSelect.endIdx,rooted:dragSelect.rooted},text:text},console.log(clipboardData),navigator.clipboard.writeText(text),did=!0}if("Backspace"===event.key||"Delete"===event.key||"x"===event.key&&event.ctrlKey){if(console.log(dragSelect),dragSelect.rooted)focusBlockVerticalOffset(-1,dragSelect.root),macros.nocommit.delete(dragSelect.root.dataset.id),document.querySelectorAll(`.block[data-id="${dragSelect.root.dataset.id}"]`).forEach(e=>e.remove());else{const childNodes=getChildren(dragSelect.root);focusBlockVerticalOffset(-1,childNodes[dragSelect.startIdx]),console.log(`cnl ${childNodes.length} start ${dragSelect.startIdx} end ${dragSelect.endIdx}`);for(let i=dragSelect.endIdx;i>=dragSelect.startIdx;i--){const node=childNodes[i];macros.nocommit.delete(node.dataset.id),document.querySelectorAll(`.block[data-id="${node.dataset.id}"]`).forEach(e=>e.remove())}commit()}dragSelect=null,did=!0}did&&event.preventDefault()}else if("none"!==autocompleteList.style.display)"Enter"===event.key&&(autocomplete(),event.preventDefault()),updownythingey(editingLink,autocompleteList,titleExactFullTextSearchCache,focusSuggestion)&&event.preventDefault();else if("none"!==templateList.style.display)"Tab"!==event.key&&"Enter"!==event.key||(expandTemplate(),event.preventDefault()),updownythingey(editingTemplateExpander,templateList,templateSearchCache,focusSuggestion)&&event.preventDefault();else if("none"!==inlineCommandList.style.display)"Tab"!==event.key&&"Enter"!==event.key||(execInlineCommand(),event.preventDefault()),updownythingey(editingCommandElement,inlineCommandList,commandSearchCache,focusSuggestion)&&event.preventDefault();else if(sessionState.isFocused){let blocks,newActiveBlock;switch(event.key){case"Enter":if(!event.shiftKey){let idx=store.blox[store.blox[sessionState.focusId].p].k.indexOf(sessionState.focusId);event.ctrlKey||(idx+=1),console.log(idx);const newBlockUid=newUid();commitEdit("cr",newBlockUid,store.blox[sessionState.focusId].p,idx);const newBlockElement=renderBlock(focusBlock.parentNode,newBlockUid,idx);newBlockElement.children[1].focus(),event.preventDefault()}break;case"Tab":(event.shiftKey?dedentFocusedBlock:indentFocusedBlock)(),event.preventDefault();break;case"Backspace":if(0===sessionState.position){const parent=store.blox[store.blox[sessionState.focusId].p];if(void 0!==parent.p||1!==parent.k.length){const currentFocusBlock=focusBlock;focusBlockVerticalOffset(-1),macros.delete(currentFocusBlock.dataset.id),currentFocusBlock.remove(),event.preventDefault()}}break;case"ArrowDown":if(event.altKey&&event.shiftKey){const parentId=store.blox[sessionState.focusId].p,parentElement=focusBlock.parentNode,currentIdx=store.blox[parentId].k.indexOf(sessionState.focusId);focusBlock.nextElementSibling&&(macros.move(sessionState.focusId,parentId,currentIdx+1),focusBlock.nextElementSibling.nextElementSibling?parentElement.insertBefore(focusBlock,focusBlock.nextElementSibling.nextElementSibling):parentElement.appendChild(focusBlock),getSelection().collapse(focusNode,focusOffset),event.preventDefault())}else event.shiftKey||event.altKey||(focusBlockVerticalOffset(1),event.preventDefault());break;case"ArrowUp":if(event.altKey&&event.shiftKey){const parentId=store.blox[sessionState.focusId].p,parentElement=focusBlock.parentNode,currentIdx=store.blox[parentId].k.indexOf(sessionState.focusId);focusBlock.previousElementSibling&&(macros.move(sessionState.focusId,parentId,currentIdx-1),parentElement.insertBefore(focusBlock,focusBlock.previousElementSibling),getSelection().collapse(focusNode,focusOffset),event.preventDefault())}else event.shiftKey||event.altKey||(focusBlockVerticalOffset(-1),event.preventDefault());break;case"ArrowLeft":event.shiftKey&&event.altKey?dedentFocusedBlock():0===sessionState.position?(focusBlockVerticalOffset(-1),event.preventDefault()):--sessionState.position;break;case"ArrowRight":event.shiftKey&&event.altKey?indentFocusedBlock():sessionState.position===focusBlockBody.innerText.length?(focusBlockVerticalOffset(1,focusBlock,!0),event.preventDefault()):sessionState.position+=1;break;case"c":event.ctrlKey&&(clipboardData=null)}}if(document.activeElement&&"search-input"===document.activeElement.id){if("Enter"===event.key)return!event.ctrlKey&&focusSuggestion?focusSuggestion.dataset.title?goto("pageTitle",focusSuggestion.dataset.title):goto("block",focusSuggestion.dataset.id):goto("pageTitle",event.target.value),void event.preventDefault();const didUpDowny=updownythingey(searchInput,searchResultList,exactFullTextSearchCache,focusSuggestion);didUpDowny&&event.preventDefault()}if("none"!==terminalElement.style.display&&"Enter"===event.key&&!event.ctrlKey&&!event.shiftKey&&!event.altKey){const string=event.target.innerText,first=string.match(/^[a-z]+/);if(first&&terminalCommands[first[0]]){const fn=terminalCommands[first[0]];fn(string.substring(first[0].length)),event.preventDefault(),terminalElement.style.display="none",terminalElement.innerHTML=""}else try{eval(string),event.ctrlKey||(terminalElement.style.display="none",terminalElement.innerHTML="")}catch(error){console.log(error),event.preventDefault()}}print(sessionState)}),document.addEventListener("paste",e=>{if(console.log(e),clipboardData){const t=e.clipboardData.getData("text");t.replaceAll(/\r/g,"")==clipboardData.text?(pasteBlocks(),e.preventDefault()):clipboardData=void 0}});const updownythingey=(e,t,o,n)=>{var s="ArrowUp"===event.key||"Tab"===event.key&&event.shiftKey?-1:("ArrowDown"===event.key||"Tab"===event.key)&&1;if(s){const r=-1===s?n.previousElementSibling:n.nextElementSibling;return r?(r.dataset.selected="true",focusSuggestion=r,delete n.dataset.selected):(n=parseInt(t.dataset.resultStartIdx),n=clamp(n+s*SEARCH_RESULT_LENGTH,0,o.length-SEARCH_RESULT_LENGTH),renderResultSet(e,o,t,n),-1===s&&(delete t.firstElementChild.dataset.selected,t.lastElementChild.dataset.selected=!0)),!0}};document.addEventListener("mousedown",t=>{var o=getClosestPageLink(t.target);if(o)goto("pageTitle",o.title,o.graphName);else{var n=t.target.closest(".block__bullet");if("search-result"!==t.target.className){"search-input"!==t.target.id&&(searchResultList.style.display="none");var s=t.target.closest(".breadcrumb-page"),o=t.target.closest(".breadcrumb-block");if(n)goto("block",n.parentNode.dataset.id);else if("block-ref"===t.target.className)goto("block",t.target.dataset.id);else if("url"===t.target.className){const e=document.createElement("a");e.target="_blank",e.href=t.target.innerText,e.click()}else if(t.target===topButtons.Download)downloadHandler();else if("template__suggestion"===t.target.className)focusSuggestion&&(focusSuggestion.dataset.selected=!1),t.target.dataset.selected=!0,focusSuggestion=t.target,expandTemplate();else if(t.target===topButtons.Upload)disconnectedFileInput.click();else if(t.target===topButtons["Daily Notes"])goto("dailyNotes");else if("autocomplete__suggestion"===t.target.className)focusSuggestion&&(focusSuggestion.dataset.selected=!1),t.target.dataset.selected=!0,autocomplete();else if(t.target===topButtons.Help)goto("pageTitle","Welcome to Micro Roam");else if(s)goto("pageTitle",s.dataset.title);else if(o)goto("block",o.dataset.id);else if("exit-to-main"==t.target.className)signupElement.style.display="none",loginElement.style.display="none";else if("command__suggestion"===t.target.className)execInlineCommand();else if("image-embed"===t.target.className)focusBlockStart(t.target.closest(".block")),t.preventDefault();else if("todo-checkbox"===t.target.className){n=t.target.checked?"TODO":"DONE",s=t.target.closest(".block").dataset.id,o=t.target.closest(".compute");let e=store.blox[s].s;e=e.substring(0,o.startIdx)+"[["+n+"]]"+e.substring(o.endIdx),macros.write(s,e);const r=t.target.closest(".block__body");r.textContent="",renderBlockBody(r,e),t.preventDefault()}else if("top-connect"===t.target.id)if("none"===connectFrame.style.display)connectFrame.style.display="block",otherStores;else connectFrame.style.display="none"}else t.target.dataset.title?goto("pageTitle",t.target.dataset.title):goto("block",t.target.dataset.id)}});const commonAncestorNode=(e,t)=>{const o=[];for(;void 0!==e.dataset.id;)o.push(e.dataset.id),e=e.parentNode.parentNode;const n=[];for(;void 0!==t.dataset.id;){if(n.push(t.dataset.id),-1!==o.indexOf(t.dataset.id)){var s=o[o.indexOf(t.dataset.id)-1],r=n[n.length-2];const l=store.blox[t.dataset.id].k;var a=l?l.indexOf(r):-1,r=l?l.indexOf(s):-1,s=Math.max(r,a);return{root:t,startIdx:Math.max(Math.min(r,a),0),endIdx:-1===s?l.length:s,rooted:-1===a||-1===r}}t=t.parentNode.parentNode}},setDragSelected=t=>{if(dragSelect)if(dragSelect.rooted)dragSelect.root.dataset.selected=t;else{const o=getChildren(dragSelect.root);for(let e=dragSelect.startIdx;e<dragSelect.endIdx+1;e++)o[e].dataset.selected=t}},mouseMoveListener=e=>{setDragSelected(!1);e=e.target.closest(".block");e&&e!==dragSelectStartBlock?(getSelection().empty(),(e=commonAncestorNode(dragSelectStartBlock,e))&&(dragSelect=e,setDragSelected(!0))):dragSelect=null};document.addEventListener("mousedown",e=>{setDragSelected(!1),dragSelect=null,e.target.closest(".block")&&(document.addEventListener("mousemove",mouseMoveListener),dragSelectStartBlock=e.target.closest(".block"))}),document.addEventListener("mouseup",e=>{null!==dragSelectStartBlock&&(document.removeEventListener("mousemove",mouseMoveListener),dragSelectStartBlock=null)}),document.addEventListener("selectionchange",e=>{if(focusNode=getSelection().focusNode,focusOffset=getSelection().focusOffset,focusNode){var t=focusNode.parentNode.closest(".block");if(t&&canWriteBloc(t.dataset.id))return sessionState.isFocused=!0,sessionState.position=(focusNode.startIdx||0)+focusOffset,void(t.dataset.id!==sessionState.focusId&&(sessionState.focusId=t.dataset.id,focusIdPosition()))}sessionState.isFocused=!1});const showTopBarFn=()=>{user.s.topBar="visible",saveUser()};let showTopBarTimeout=null;topBarHiddenHitbox.addEventListener("mouseover",()=>{clearTimeout(showTopBarTimeout),showTopBarTimeout=setTimeout(showTopBarFn,400)}),topBarHiddenHitbox.addEventListener("mouseout",()=>{clearTimeout(showTopBarTimeout),showTopBarTimeout=null}),disconnectedFileInput.addEventListener("change",e=>{const t=e.target.files[0];console.log(t);const{name:o,ext:n}=splitFileName(t.name);console.log(`name ${o} extension ${n}`),"zip"===n?t.arrayBuffer().then(e=>{e=zipToFiles(e);if(console.log(e),1===e.length&&"json"===e[0].ext)store=roamJsonToStore(e[0].name,e[0].text),preprocessImportedStore();else throw notifyText("Markdown import doesn't work yet. Upload a .json file, or a .zip file containing a .json file instead.",12),new Error("md import doesn't work")}):"json"===n?t.text().then(e=>{user.s.graphName=o,store=roamJsonToStore(o,e),preprocessImportedStore()}):notifyText("Micro Roam only accepts a .json file or .zip file containing 1 .json file")});const preprocessImportedStore=async()=>{startFn=()=>gotoNoHistory("dailyNotes"),await addGraph(),start()};topButtons["Sign Up"].addEventListener("click",e=>{focusSignup(),e.stopPropagation(),e.preventDefault()});const focusSignup=()=>{signupElement.style.display="block",loginElement.style.display="none",signupEmailElement.focus()},focusLogin=()=>{loginElement.style.display="block",signupElement.style.display="none",loginEmailElement.focus()};switchToSignup.addEventListener("click",focusSignup),switchToLogin.addEventListener("click",focusLogin);const rwlClickOutListener=e=>{console.log("rwlclick"),null===e.target.closest(".really-want-to")&&(reallyWantToLeaveElement.style.display="none",document.removeEventListener("click",rwlClickOutListener))};topButtons["Sign Out"].addEventListener("click",()=>{isSynced()?reset():(reallyWantToLeaveElement.style.display="flex",document.addEventListener("click",e=>rwlClickOutListener(e)),event.stopPropagation())}),reallyWantToLeaveElement.children[0].addEventListener("click",reset),topHamburgerElement.addEventListener("click",()=>{"block"==optionsFrame.style.display?optionsFrame.style.display="none":optionsFrame.style.display="block"}),topButtons["Create New Graph"].addEventListener("keydown",e=>{"Enter"===e.key&&createAndSwitchToNewStore(e.target.value)});const inlineCommandReplaceString=(e,t=0)=>{sessionState.position=editingCommandElement.firstChild.startIdx+e.length+t,editingCommandElement.innerText=e,setFocusedBlockString(focusBlockBody.innerText)},inlineCommands={TODO:()=>{var e=editingCommandElement.firstChild.startIdx+9;editingCommandElement.remove();var t="{{#TODO}}"+(t=focusBlockBody.innerText);sessionState.position=e,setFocusedBlockString(t)},"page link":()=>{inlineCommandReplaceString("[[]]",-2)},today:()=>{inlineCommandReplaceString("[["+formatDate(new Date(Date.now()))+"]]")},video:()=>{inlineCommandReplaceString("{{#video: }}",-2)},query:()=>{inlineCommandReplaceString("{{#query: }}",-2)},"current time":()=>{var e=new Date(Date.now());inlineCommandReplaceString(formatTime(e))},tomorrow:()=>{inlineCommandReplaceString("[["+getTomorrowDateString()+"]]")},yesterday:()=>{inlineCommandReplaceString("[["+getYesterdayDateString()+"]]")},"next week":()=>{inlineCommandReplaceString("[["+getNextWeekDateString()+"]]")},"last week":()=>{inlineCommandReplaceString("[["+getLastWeekDateString()+"]]")},bold:()=>{inlineCommandReplaceString("****",-2)},italic:()=>{inlineCommandReplaceString("____",-2)},highlight:()=>{inlineCommandReplaceString("^^^^",-2)}};let commandSearchCache=[];const matchInlineCommand=e=>{commandSearchCache=[];let t;try{t=newSearchRegex(e)}catch(e){return commandSearchCache}for(var o in inlineCommands)o.match(t)&&commandSearchCache.push({string:o});return commandSearchCache},execInlineCommand=()=>{inlineCommandList.style.display="none",inlineCommands[focusSuggestion.dataset.string]()},roamBloxProps={children:"k",string:"s",title:"s","create-time":"ct","edit-time":"et",":create/user":"cu",":edit/user":"eu",uid:"uid",refs:"",":block/refs":""},roamJsonToStore=(e,t)=>{console.log("roamJsontostore");var o=performance.now();const r=intToBase64(Date.now());var n,t=JSON.parse(t);store=blankStore(),store.graphName=e,t[0][":edit/user"]&&(store.ownerRoamId=t[0][":edit/user"][":user/uid"]),ownerRoamId=store.ownerRoamId;const a=(t,e)=>{var o,n=intToBase64(t["create-time"])||r;const s={s:t.string,p:e,ct:n,et:intToBase64(t["edit-time"])||n};for(o in store.blox[t.uid]=s,t[":create/user"]&&t[":create/user"][":user/uid"]!==ownerRoamId?s.cu=t[":create/user"][":user/uid"]:delete s.cu,t[":edit/user"]&&t[":edit/user"][":user/uid"]!==ownerRoamId?s.eu=t[":edit/user"][":user/uid"]:delete s.eu,t.children&&(s.k=t.children.map(e=>e.uid),t.children.forEach(e=>a(e,t.uid))),t)o in roamBloxProps||(store.roamProps[t.uid]||(store.roamProps[t.uid]={}),store.roamProps[t.uid][o]=t[o])};for(n of t){store.titles[n.title]=n.uid;var s,l=intToBase64(n["create-time"])||r;const c={s:n.title,ct:l,et:intToBase64(n["edit-time"])||l};for(s in store.blox[n.uid]=c,n)s in roamBloxProps||(store.roamProps[n.uid]||(store.roamProps[n.uid]={}),store.roamProps[n.uid][s]=n[s]);if(n[":create/user"]&&n[":create/user"][":user/uid"]!==ownerRoamId?c.cu=n[":create/user"][":user/uid"]:delete c.cu,n[":edit/user"]&&n[":edit/user"][":user/uid"]!==ownerRoamId?c.eu=n[":edit/user"][":user/uid"]:delete c.eu,void 0!==n.children){const d=[];c.k=d;for(let e=0;e<n.children.length;e++){var i=n.children[e];d.push(i.uid),a(i,n.uid)}}}return generateRefs(store),user.s.commitId="MYVERYFIRSTCOMMITEVER",console.log(`roamJsonToStore took ${performance.now()-o}`),console.log(store),store},storeToRoamJSON=n=>{const e=[],s=e=>{const t=n.blox[e],o={uid:e,string:t.s};t.ct&&(o["create-time"]=base64ToInt(t.ct)),t.et&&(o["edit-time"]=base64ToInt(t.et));e=n.roamProps[e];return e&&Object.assign(o,e),t.k&&(o.children=t.k.map(s)),o[":create/user"]={":user/uid":n.ownerRoamId},o[":edit/user"]={":user/uid":n.ownerRoamId},t.cu&&(o[":create/user"]={":user/uid":t.cu}),t.eu&&(o[":edit/user"]={":user/uid":t.eu}),o};for(var t in n.titles){var o=n.titles[t];const r=n.blox[o];t=n.roamProps[o];const a={uid:o,title:r.s};r.ct&&(a["create-time"]=base64ToInt(r.ct)),r.et&&(a["edit-time"]=base64ToInt(r.et)),e.push(a),Object.assign(a,t),r.k&&(a.children=r.k.map(s)),a[":create/user"]={":user/uid":n.ownerRoamId},a[":edit/user"]={":user/uid":n.ownerRoamId},r[":create/user"]&&(a[":create/user"]={":user/uid":r[":create/user"]}),r[":edit/user"]&&(a[":edit/user"]={":user/uid":r[":edit/user"]})}return console.log(e),JSON.stringify(e)},oldStoreToRoamJSON={4:n=>{const e=[],s=e=>{const t={uid:e},o=n.blocks[e];return Object.assign(t,o),o.children&&(t.children=o.children.map(s)),t[":create/user"]={":user/uid":n.ownerRoamId},t[":edit/user"]={":user/uid":n.ownerRoamId},o[":create/user"]&&(t[":create/user"]={":user/uid":o[":create/user"]}),o[":edit/user"]&&(t[":edit/user"]={":user/uid":o[":edit/user"]}),o.refs&&(t.refs=o.refs.map(e=>({uid:e}))),o[":block/refs"]&&(t[":block/refs"]=o[":block/refs"].map(e=>({":block/uid":e}))),delete t.backRefs,delete t.parent,t};for(var t in n.pages){const o=n.pages[t],r={uid:t};e.push(r),Object.assign(r,o),delete r.backRefs,o.children&&(r.children=o.children.map(s)),r[":create/user"]={":user/uid":n.ownerRoamId},r[":edit/user"]={":user/uid":n.ownerRoamId},o[":create/user"]&&(r[":create/user"]={":user/uid":o[":create/user"]}),o[":edit/user"]&&(r[":edit/user"]={":user/uid":o[":edit/user"]})}return console.log(e),JSON.stringify(e)}},mdToStore=e=>{const o=intToBase64(Date.now());store;const n={};store=blankStore();var t,s;for(t of e){var r=t.name;const c=t.text;var a=(s=r,store.pagesByTitle[s]||newUid());const d={"create-time":o,title:r};if(store.pages[a]=d,store.pagesByTitle[r]=a,0<c.length){d.children=[];var l,i=e=>{var t=newUid();n[e]=t;e={"create-time":o,string:e};store.blocks[t]=e,d.children.push(t)},a=(d,c.matchAll(/\n((?:    )*)- /g));let e=2;for(l of a)i(c.substring(e,l.index)),e=l.index+l[0].length;i(c.substring(e))}}console.log(store)},parseMdBlock=e=>{},blocToMd=e=>{let s="";const r=(e,t)=>{const o=store.blox[e];void 0===o&&console.log(e);for(let e=0;e<t;e++)s+="    ";s+="- "+o.s.replaceAll(/\(\(([a-zA-Z0-9\-_]+)\)\)/g,(e,t)=>{return store.blox[t]?'"'+store.blox[t].s+'"':e})+"\n";for(var n of o.k||[])r(n,t+1)};return r(e,0),s},storeToMdObjects=()=>{const t=[];for(var o in store.titles){var n,s=store.blox[store.titles[o]];let e="";for(n of s.k||[])e+=blocToMd(n);t.push({fullName:o+".md",text:e})}return t},storeToMdZip=()=>filesToZip(storeToMdObjects()),LOCAL_FILE_SIGNATURE=67324752,LOCAL_FILE_HEADER_LENGTH=30,END_CENTRAL_DIR_SIGNATURE=101010256,END_CENTRAL_DIR_HEADER_LENGTH=46,CENTRAL_FILE_SIGNATURE=33639248,ARCHIVE_EXTRA_RECORD_SIGNATURE=134630224,CRC_32_MAGIC=2869187666,splitFileName=e=>{var t=e.match(/\.([a-z]+)$/);return{name:e.substring(0,t.index),ext:t[1]}},zipToFiles=e=>{var t=new Uint8Array(e);let o=0;const n=[];for(;o<t.length;){var s=new ArrayBuffer(4);const d=new Uint8Array(s);for(let e=0;e<4;e++)d[e]=t[o+e];var r=new Uint32Array(s)[0];if(r!==LOCAL_FILE_SIGNATURE){if(r===END_CENTRAL_DIR_SIGNATURE){console.log("got end central dir signature");break}console.log(`got signature ${r}`);break}var a=new Uint16Array(e,8,1)[0];if(0!==a)return console.log(a),void notifyText("Micro Roam can't handle .zip files that are actually compressed. use a .json file or an uncompressed .zip file, like ones exported by Roam Research or Micro Roam",10);{var l=new ArrayBuffer(12);const u=new Uint8Array(l);for(let e=0;e<12;e++)u[e]=t[e+18+o];var i=new Uint32Array(l),c=(i[0],i[1]),s=i[2];if(1441805<=s)break;const m=new TextDecoder;var r=m.decode(new Uint8Array(e,o+30,s)),{name:a,ext:l}=splitFileName(r),i=m.decode(new Uint8Array(e,o+30+s,c));n.push({name:a,ext:l,text:i,fullName:r}),o+=30+s+c}}return n};let crcTable=null;const makeCRCTable=()=>{let t;crcTable=[];for(let e=0;e<256;e++){t=e;for(let e=0;e<8;e++)t=1&t?3736805603^t>>>1:t>>>1;crcTable[e]=t}};function crc32(t,o,n){null===crcTable&&makeCRCTable();let s=-1;for(let e=o;e<n;e++)s=s>>>8^crcTable[255&(s^t[e])];return(-1^s)>>>0}const dateUnixToMsDosFormat=e=>{const t=new Date(e);let o=t.getDate()+(t.getMonth()+1<<5)+(t.getFullYear()-1980<<9);return console.log(o),console.log(o.toString(2)),o},writeU16ToU8Array=(e,t,o)=>{e[t]=o<<24>>>24,e[t+1]=o<<16>>>24},writeIntToU8Array=(e,t,o)=>{e[t]=o<<24>>>24,e[t+1]=o<<16>>>24,e[t+2]=o<<8>>>24,e[t+3]=o>>>24},ZIP_VERSION=10,blankLocalHeader=new Uint8Array(30);writeIntToU8Array(blankLocalHeader,0,LOCAL_FILE_SIGNATURE),writeIntToU8Array(blankLocalHeader,14,CRC_32_MAGIC),writeU16ToU8Array(blankLocalHeader,4,ZIP_VERSION);const blankCentralHeader=new Uint8Array(46);writeIntToU8Array(blankCentralHeader,0,CENTRAL_FILE_SIGNATURE),writeU16ToU8Array(blankCentralHeader,4,16),writeU16ToU8Array(blankCentralHeader,6,ZIP_VERSION);const copyBuffer=(t,o,n,s,r)=>{for(let e=0;e<r;e++)n[s+e]=t[o+e]},filesToZip=e=>{var t,o=Date.now(),n=dateUnixToMsDosFormat(o),s=performance.now();let r="",a=0;for(t of e)r+=t.fullName+t.text,a+=30+t.fullName.length+t.text.length;o=textEncoder.encode(r).length+LOCAL_FILE_HEADER_LENGTH*e.length+END_CENTRAL_DIR_HEADER_LENGTH;console.log(r.length-a),console.log(`mstime ${performance.now()-s}`);var l,o=new ArrayBuffer(o);let i=new Uint8Array(o),c=0;for(l of e){var d=c;copyBuffer(blankLocalHeader,0,i,c,blankLocalHeader.length),writeU16ToU8Array(i,d+10,n),writeU16ToU8Array(i,d+12,n),c+=blankLocalHeader.length;var u=i.subarray(c),{read:m}=textEncoder.encodeInto(l.fullName,u);c+=m;var g=i.subarray(c),{read:u}=textEncoder.encodeInto(l.text,g),g=crc32(i,c,c+u);writeIntToU8Array(i,d+14,g),c+=u,writeIntToU8Array(i,d+18,u),writeIntToU8Array(i,d+22,u),writeU16ToU8Array(i,d+26,m)}o=new Blob([o]);return console.log(`filestozip ${performance.now()-s}`),o},testRoundTrip=()=>{var e=storeToRoamJSON(store);store=roamJsonToStore(store.graphName,e);var t=storeToRoamJSON(store);e===t?console.log("Round trip test passed!"):(console.log(e),console.log(t),console.error("round trip failed"))},createPageTest=()=>{var e=store;store=blankStore(),macros.createPage("Test Page"),store=e};let testSTime;const renderMulti=(e,t=void 0,o=100,n=!1)=>{n||(testSTime=performance.now()),0<o?e(t)||setTimeout(()=>renderMulti(e,t,o-1,!0),0):console.log(`test func took ${performance.now()-testSTime}`)},benchmarkPageLoad=()=>renderMulti(()=>goto("pageTitle","Welcome to Micro Roam"));let benchmarkRandomWalkSTime=null;const benchmarkRandomWalk=()=>renderMulti(()=>{let e=[];var t,o,n,s=document.querySelectorAll(".page-ref"),r=document.querySelectorAll(".tag"),a=document.querySelectorAll(".breadcrumb-page");for(t of s)e.push(t.children[2].innerText);for(o of r)e.push(o.innerText.substring(1));for(n of a)e.push(n.innerText);e=e.filter(e=>store.titles[e]&&store.blox[store.titles[e]]);a=e[Math.floor(Math.random()*(e.length-1))];goto("pageTitle",a)}),benchmarkRenderAll=async()=>{var e,t=performance.now();let o=0,n=0;for(e in store.titles){var s=performance.now();gotoNoHistory("pageTitle",e),o+=performance.now()-s,n+=1,await new Promise(e=>setTimeout(e,0))}t=performance.now()-t,t=`rendered ${n} pages in ${Math.round(t)}ms, avg ${Math.round(t/n)}ms \nfunction time avg ${Math.round(o/n)}`;console.log(t),notifyText(t,10)},testAll=()=>{testRoundTrip(),benchmarkPageLoad(),benchmarkRandomWalk(),benchmarkRenderAll()},benchmarkGen=()=>{var e=performance.now();for(let e=0;e<100;e++)generateInnerRefs();console.log(`gen took ${performance.now()-e}`)},log=()=>{user.s.logging=!0,saveUser()},nolog=()=>{user.s.logging=!1,saveUser()},flash=benchmarkRenderAll,blank=(e="default")=>{store=blankStore(),store.graphName=e,user={s:{graphName:"default",theme:window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",topBar:"visible",logging:!1,spellcheck:!1,editingSpotlight:!0}},user.s.graphName=e,saveUser(),debouncedSaveStore(),goto("dailyNotes")},pr=()=>{console.log(JSON.stringify(store))},downloadBinary=()=>{var e=storeToBinary(),e=new Blob([e],{type:"application/x-micro-roam"}),e=URL.createObjectURL(e);const t=document.createElement("a");t.setAttribute("href",e),t.setAttribute("download",`${store.graphName}.mrm`),t.click()},monitor=string=>{const js=`setInterval(()=>console.log(${string}), 500)`;eval(js)},terminalCommands={blank:blank,reset:reset,flash:flash,log:log,page:page,nolog:nolog,pr:pr,downloadBinary:downloadBinary,monitor:monitor}</script>