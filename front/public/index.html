<body>
  <div id="app">
    <div id="top-bar" style="margin-top:0px">

      <a id="report-issue-button" target="_blank" href="mailto:taoroalin@gmail.com?subject=You Made Micro Roam Wrong"
        tabindex="-1">
        Report Issue
      </a>
      <button id="help-button" tabindex="-1">
        Help
      </button>
      <button id="daily-notes-button" tabindex="-1">
        Daily Notes
      </button>
      <input id="search-input" placeholder="search" tabindex="-1">
      <button id="upload-button" tabindex="-1">
        <input style="display:none" type="file" id="upload-input">
        Upload JSON
      </button>
      <a id="download-button" tabindex="-1">
        Download JSON
      </a>
    </div>

    <div id="top-bar-hidden-hitbox" style="position:fixed;height:15px;width:100%"></div>

    <div id="terminal" contenteditable="true" style="display:none"></div>

    <div id="page-frame-outer">
      <div id="page-frame">

      </div>
    </div>

    
<script>
const r=indexedDB.open("microroam",4),blankUser={graphName:"default",theme:"light",topBar:"visible",logging:!1,spellcheck:!1};let user=blankUser;const storedUser=localStorage.getItem("user");storedUser&&(user=JSON.parse(storedUser));let w=!1,store=null,idb=null;const theresANewStore=()=>{user.graphName=store.graphName,saveUser(),gotoNoHistory("dailyNotes"),setTimeout(()=>saveWorker.postMessage(["save",store]),0)};r.onsuccess=e=>{idb=e.target.result,idb.transaction(["stores"],"readonly").objectStore("stores").get(user.graphName).onsuccess=e=>{e.target.result?(store=JSON.parse(e.target.result.store),w?theresANewStore():w=!0):(console.log("adding default graph"),fetch("./default-store.json").then(e=>e.json().then(e=>{store=e,user.graphName=e.graphName,w?theresANewStore():w=!0})))}},r.onupgradeneeded=e=>{const s=r.result,t=Array.from(s.objectStoreNames);t.includes("stores")||s.createObjectStore("stores",{keyPath:"graphName"})},r.onerror=e=>{alert(`In order to save your notes between sessions, Micro Roam needs access to IndexedDB. 
      You can allow access by exiting "private browsing" mode, or by using a newer browser, or by changing browser settings`)};let commitDebounce=null,editingTemplateExpander=null,editingLink=null,editingTitle=null,focusNode=null,focusOffset=null,focusBlock=null,focusSuggestion=null,sessionState={pageFrame:"dailyNotes",focusId:null,scroll:0,position:null};const topBar=document.getElementById("top-bar"),topBarHiddenHitbox=document.getElementById("top-bar-hidden-hitbox"),showTopBar=()=>{topBar.style.marginTop="0px",topBarHiddenHitbox.style.display="none"},hideTopBar=()=>{topBar.style.marginTop="-46px",topBarHiddenHitbox.style.display="block"},saveUser=()=>{document.body.className=user.theme,("visible"===user.topBar?showTopBar:hideTopBar)(),localStorage.setItem("user",JSON.stringify(user))};saveUser();
</script>


    <div id="autocomplete-list" style="display:none"></div>
    <!-- inline styles on this site are all edited directly by js -->
    <div id="search-result-list" style="display:none"></div>
    <div id="template-list" style="display:none"></div>

  </div>

  <title>Micro Roam</title>

  
<style>
/* global styles ----------------------------------------------------------------------------- */
*{
  outline:none;
  scrollbar-width:none;
}

.dark{
  --background:#161616;
  --text: white;
  --link: #3f84c0;
  --brackets:#A7B6C2;
  --block-ref:rgb(63, 63, 63);
  --bullet:#758897;
  --border:#afbeca;
  --break: #838e97;
  --highlight:rgb(110, 93, 16);
  --click:darkgrey;
  --page-ref:#2bcc5b;
  --shadow:rgb(98, 98, 98);
  --notification:#2e4736;
}

.light{
  --background:white;
  --text:black;
  --link: rgb(54, 123, 184);
  --brackets:#A7B6C2;
  --block-ref:lightgrey;
  --bullet:#394B59;
  --border:#585e64;
  --shadow:#585e64;
  --break:#a8b4be;
  --highlight:rgb(255, 239, 146);
  --click:rgb(197, 197, 197);
  --page-ref:rgb(73, 197, 91);
  --notification:#a4d1b1;
}

input, button, a{
  font-family: 'Inter', Verdana;
}

input{
  border:none;
}

button{
  appearance: none;
  border:none;
  box-shadow: none;
  cursor:pointer;
  background-color:inherit;
  color:inherit;
  font-size:inherit;
}

span{
  margin:0;
  padding:0;
}

::-webkit-scrollbar{
  width:0%;
  height:0%;
}

::selection{
  background-color:#85b7e8;
  color:var(--text);
}

body {
    scrollbar-width: 0px;
    font-family: 'Inter', Verdana, Arial;
    font-weight: normal;
    margin: 0;
    color:var(--text);
    background-color: var(--background);
}

a{
  color:var(--link);
}

a:visited { color:var(--link) }

.notification{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  top:-40px; /* transitions to more px */
  margin-top: 0px;
  opacity:1;
  transition: top 0.25s ease-out, opacity 0.2s linear;
  padding:20px;
  background-color:var(--notification);
  border-radius:8px;
}


/* singular element styles --------------------------------------------------------------------------------------- */

#app{
  height:100%;
  width:100%;
  display:flex;
  flex-direction: column;
}

#page-frame-outer{
  width:100%;
  overflow-y:scroll;
}

#page-frame{
  margin: 0 auto 30px;
  max-width: min(900px, 100%);
}

#top-bar{
  width:100%;
  display: flex;
  flex-direction: row;
  align-content: space-between;
  background-color:var(--background);
  transition:margin-top 0.1s;
}

/* these have different paddings, but look the same because weird stuff. todo investigate */
#top-bar a{
  padding: 14px 10px 10px;
  font-size:0.9em;
}
#top-bar button{
  padding: 12px 10px 10px;
  font-size:0.9em;
}


#download-button, #report-issue-button {
  color:var(--text);
  display:block;
  cursor:pointer;
  text-decoration: none;
}

#search-input{
  background-color:var(--background);
  color:var(--text);
  padding:3px 13px;
  margin: 7px 5px 5px;
  display:block;
  font-size:1.2em;
  box-shadow:0 0 2px var(--shadow);
  border-radius:100px;
  flex-grow: 1;
}

#autocomplete-list, #template-list{
  position:absolute;
  display:flex;
  flex-direction: column;
  background-color:var(--background);
  font-size:1.3em;
  border-radius:5px;
  box-shadow: 0 0 8px var(--shadow);
}

.autocomplete__suggestion[data-selected="true"],.template__suggestion[data-selected="true"]{
  background-color:var(--click);
}

.autocomplete__suggestion, .template__suggestion{
  padding:7px;
  cursor:pointer;
  border-radius: 5px;
}


#search-result-list{
  position:absolute;
  display:flex;
  flex-direction: column;
  background-color:var(--background);
  font-size:1.3em;
  border-radius:5px;
  box-shadow: 0 0 8px var(--shadow);
}

.search-result[data-selected="true"]{
  background-color:var(--click);
}

.search-result{
  padding:7px;
  cursor:pointer;
  border-radius: 5px;
}

/* Page styles --------------------------------------------------------------------------------------------------- */

.page{
  margin-right:30px;
  margin-left:30px;
  position:relative;
}

.page__title{
  font-size: 36px;
  margin: 40px 0 20px 0;
}

.page__body, .backref-frame__body{
  margin-left:20px;
}

.backref-list__body{
  margin-left:10px;
}

.backref-list__title{
  font-size: 1.2em;
  font-weight:bold;
  padding: 20px 0 0;
}

.page-break{
  height:0px;
  margin: 60px 25px;
  border:1px solid var(--break);
  border-width: 1px 0 0 0;
}


.block{
  position:relative;
}

.block__body{
  padding:5px 0;
}

.block__bullet{
  cursor:pointer;
  position:absolute;
  left:-21px;
  top:4px;
}

.block__children{
  margin-left: 25px;
}

.block-focus-frame{
  margin: 60px 0;
}

.breadcrumb-page{
  cursor:pointer;
}

.breadcrumb-block{
  cursor:pointer;
}

.backref-frame__breadcrumb{
  margin:15px 0 5px 0;
  font-size:1.2em;
}

.block-focus-frame__breadcrumb{
  margin:15px 0 5px 0;
  font-size:1.2em;
}

/* Parsed block styles -------------------------------------------------------------------------------------- */

.page-ref{
  position:relative;
}

.page-ref__brackets{
  font-weight: lighter;
  color:var(--brackets);
}

.page-ref__body{
  color:var(--page-ref);
  font-weight: 800;
}

.page-ref__body:hover{
  text-decoration: underline;
  cursor:pointer;
}

.tag{
  color:var(--page-ref);
  font-weight: 800;
  position:relative;
}

.tag:hover{
  text-decoration: underline;
  cursor:pointer;
}

.block-ref{
  background-color:var(--block-ref);
}

.block-ref:hover{
  text-decoration: underline;
  cursor:pointer;
}

.bold{
  font-weight:bold;
}

.italic{
  font-style:italic;
}

.highlight{
  background-color: var(--highlight);
  border-radius:2px;
  padding:1px;
}

.block-focus-frame{
  margin: 35px 0 0 60px;
}

.url{
  color:var(--link);
  text-decoration: underline;
  cursor:pointer;
}

.literal{
  font-family:'Inconsolata';
  font-size:1.15em;
}

#terminal{
  font-family:'Inconsolata';
  width:100%;
  padding:8px;
  background-color: black;
  color:white;
}
</style>


  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata">

  <template id="page">
    <div class="page">
      <h1 class="page__title" contenteditable="true" tabindex="-1"></h1>

      <div class="page__body">

      </div>
      <div class="page__backlinks">

      </div>
    </div>
  </template>

  <template id="block">
    <div class="block">
      <svg class="block__bullet" width="20" height="20">
        <circle cx="10" cy="10.5" r="3" fill="var(--bullet)" />
      </svg>
      <div class="block__body" contenteditable="true" tabindex="-1">
      </div>
      <div class="block__children">

      </div>
    </div>
  </template>

  <template id="backref-list">
    <div class="backref-list">
      <div class="backref-list__title">Linked References</div>
      <div class="backref-list__body"></div>
    </div>
  </template>

  <template id="page-break">
    <div class="page-break"></div>
  </template>

  <template id="block-focus-frame">
    <div class="block-focus-frame">
      <div class="block-focus-frame__breadcrumb"></div>
      <div class="block-focus-frame__body"></div>
      <div class="block-focus-frame__backlinks"></div>
    </div>
  </template>

  <template id="backref-frame">
    <div class="backref-frame">
      <div class="backref-frame__breadcrumb"></div>
      <div class="backref-frame__body"></div>
    </div>
  </template>

  <template id="page-ref">
    <span class="page-ref"><span class="page-ref__brackets"></span><span class="page-ref__body"></span><span
        class="page-ref__brackets"></span></span>
  </template>

  <template id="tag">
    <span class="tag"></span>
  </template>

  <template id="block-ref">
    <span class="block-ref"></span>
  </template>

  <template id="block-ref">
    <span class="block-ref"></span>
  </template>

  <template id="bold">
    <span class="bold"></span>
  </template>

  <template id="italic">
    <span class="italic"></span>
  </template>

  <template id="highlight">
    <span class="highlight"></span>
  </template>

  <template id="literal">
    <span class="literal"></span>
  </template>

  <!-- this is a bit silly, since this element doesn't show up as anyting, but for consistancy?? -->
  <template id="template-expander">
    <span class="template-expander"></span>
  </template>

  <!--using spans with event handlers as links because they play nice with contenteditable-->
  <template id="url">
    <span class="url"></span>
  </template>

  <template id="autocomplete__suggestion">
    <div class="autocomplete__suggestion"></div>
  </template>

  <template id="template__suggestion">
    <div class="template__suggestion"></div>
  </template>

  <template id="search-result">
    <div class="search-result"></div>
  </template>

  <template id="breadcrumb-block">
    <span class="breadcrumb-block"><span class="breadcrumb-block__arrow">-></span><span
        class="breadcrumb-block__body"></span></span>
  </template>

  <template id="breadcrumb-page">
    <span class="breadcrumb-page"></span>
  </template>

  <template id="notification">
    <div class="notification"></div>
  </template>

  
<script>
const monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"],getOrdinal=e=>{var t=e%10,r=e%100;return 1==t&&11!=r?e+"st":2==t&&12!=r?e+"nd":3==t&&13!=r?e+"rd":e+"th"},formatDate=e=>`${monthNames[e.getMonth()]} ${getOrdinal(e.getDate())}, ${e.getFullYear()}`,truncateElipsis=(e,t=40)=>e.length>t?e.substring(0,t-3)+"...":e;

const storeToRoamJSON=u=>{const e=[],d=e=>{const r={uid:e},s=u.blocks[e];return Object.assign(r,s),s.children&&(r.children=s.children.map(d)),r[":create/user"]={":user/uid":u.ownerRoamId},r[":edit/user"]={":user/uid":u.ownerRoamId},s[":create/user"]&&(r[":create/user"]={":user/uid":s[":create/user"]}),s[":edit/user"]&&(r[":edit/user"]={":user/uid":s[":edit/user"]}),s.refs&&(r.refs=s.refs.map(e=>({uid:e}))),s[":block/refs"]&&(r[":block/refs"]=s[":block/refs"].map(e=>({":block/uid":e}))),delete r.backRefs,delete r.parent,r};for(var r in u.pages){const s=u.pages[r],i={uid:r};e.push(i),Object.assign(i,s),delete i.backRefs,s.children&&(i.children=s.children.map(d)),i[":create/user"]={":user/uid":u.ownerRoamId},i[":edit/user"]={":user/uid":u.ownerRoamId},s[":create/user"]&&(i[":create/user"]={":user/uid":s[":create/user"]}),s[":edit/user"]&&(i[":edit/user"]={":user/uid":s[":edit/user"]})}return console.log(e),JSON.stringify(e)};

const getIn=(t,n)=>{let o=store;for(let e=0;e<t.length-n;e++)void 0===o[t[e]]&&(o[t[e]]={}),o=o[t[e]];return o},doEdits=e=>{if(e.subtract)for(var t of e.subtract){const f=getIn(t,2);var n=t[t.length-2];f[n]=f[n].filter(e=>e!=t[t.length-1])}if(e.write)for(var o of e.write){const h=getIn(o,2);h[o[o.length-2]]=o[o.length-1]}if(e.add)for(var r of e.add){const c=getIn(r,2);c[r[r.length-2]].push(r[r.length-1])}if(e.insert)for(var l of e.insert){const d=getIn(l,3);var s=l[l.length-3],g=l[l.length-2],l=l[l.length-1];let e=d[s];if(void 0===e)e=[g],d[s]=e;else{if(e.length<l)throw console.log(e),console.log(s),new Error("tried to insert past end of list");d[s]=e.slice(0,l),d[s].push(g),d[s].push(...e.slice(l))}}if(e.delete)for(var i of e.delete){const a=getIn(i,1);delete a[i[i.length-1]]}},print=e=>{user.logging&&console.log(e)};

const CHARS_64="-_0123456789abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ",newUid=()=>{let r;do{r="";for(let e=0;e<9;e++)r+=CHARS_64[Math.floor(64*Math.random())]}while(void 0!==store.pages[r]||void 0!==store.blocks[r]);return r},blockOrPageFromId=e=>store.blocks[e]||store.pages[e],parentThingey=e=>store.pages[e]?"pages":"blocks",commands={deleteBlock:r=>{var e=store.blocks[r],t=e.parent;const s=e[":block/refs"],i=e.backRefs;return{edits:{subtract:[[parentThingey(e.parent),t,"children",r],...s.map(e=>[parentThingey(e),e,"backRefs",r]),...i.map(e=>[parentThingey(e),e,"refs",r])],delete:[["blocks",r]]}}},moveBlock:(e,r,t,s)=>{var i=store.blocks[e].parent;return{edits:{write:[["blocks",e,"parent",r]],insert:[[parentThingey(r),r,"children",e,t]],subtract:[[parentThingey(i),i,"children",e]]},returns:void 0}},writeBlock:(t,e,r,s)=>{var i;const a=store.blocks[t][":block/refs"],n={write:[],subtract:[],add:[],delete:[]},o=r.map(e=>{let r=store.pagesByTitle[e];return void 0!==r?a.includes(r)||n.add.push(["pages",r,"backRefs",t]):(r=newUid(),n.write.push(["pages",r,{title:e,children:[],":create/time":s,backRefs:[t]}]),n.write.push(["pagesByTitle",e,r])),r});if(n.write.push(["blocks",t,"string",e],["blocks",t,"edit-time",s],["blocks",t,":block/refs",o]),a)for(var c of a)o.includes(c)||(i=store.pages[c],"pages"!==parentThingey(c)||void 0!==i.children&&0!==i.children.length||!(void 0===i.backRefs||i.backRefs.length<=1)?n.subtract.push([parentThingey(c),c,"backRefs",t]):(n.delete.push(["pagesByTitle",i.title]),n.delete.push(["pages",c])));return{edits:n}},createBlock:(e,r,t)=>{var s=newUid(),i=store.pages[e]?"pages":"blocks";return{edits:{write:[["blocks",s,{string:"",parent:e,":create/time":t,children:[],backRefs:[],":block/refs":[],refs:store[i].refs}]],insert:[[i,e,"children",s,r]]},returns:s}},createPage:(e,r)=>{var t=newUid();return{edits:{write:[["pages",t,{title:e,children:[],":create/time":r,backRefs:[]}],["pagesByTitle",e,t]]},returns:t}},writePageTitle:(e,r,t)=>{var s=store.pages[e],i=s.title;const a={write:[["pages",e,"title",r],["pages",e,"edit-time",t],["pagesByTitle",r,e]],delete:[["pagesByTitle",i]]};if(s.backRefs)for(var n of s.backRefs){let e=store.blocks[n].string;a.write.push(["blocks",n,"string",e.replaceAll(i,r)])}return{edits:a}},copyBlock:(e,r,t,c)=>{var s=newUid();const l={write:[],insert:[[parentThingey(r),r,"children",s,t]],subtract:[]},d=(e,r,t)=>{var s,i=store.blocks[e];const a={"create-time":c,string:i.string,parent:t};for(s of LIST_PROPS)i[s]&&(a[s]=Array.from(i[s]));if(i.children){a.children=[];for(var n of i.children){var o=newUid();d(n,o,r),a.children.push(o)}}l.write.push(["blocks",r,a])};return d(e,s,r),{edits:l,returns:s}}},runCommand=(...e)=>{var{edits:r,returns:e}=commands[e[0]](...e.slice(1),Date.now());return doEdits(r),saveWorker.postMessage(["edits",r]),e};

const blankStore=()=>({graphName:"default",ownerRoamId:"default",blocks:{},pages:{},pagesByTitle:{}}),LIST_PROPS=["refs",":block/refs","backRefs"],LOCAL_FILE_SIGNATURE=67324752,END_CENTRAL_DIR_SIGNATURE=101010256,CENTRAL_FILE_SIGNATURE=33639248,ARCHIVE_EXTRA_RECORD_SIGNATURE=134630224,ZIP64_END_CENTRAL_SIGNATURE=101075792,zipToFiles=s=>{var t=new Uint8Array(s),e=t.length;let o=0;const a=[];for(;o<e;){var i=new ArrayBuffer(4);const r=new Uint8Array(i);for(let e=0;e<4;e++)r[e]=t[o+e];var n=new Uint32Array(i)[0];if(n!==LOCAL_FILE_SIGNATURE){if(n===END_CENTRAL_DIR_SIGNATURE)break;console.log(`got signature ${n}`);break}var l=new Uint16Array(s,8,1)[0];if(0!==l)return console.log(l),void notifyText("Micro Roam can't handle .zip files that are actually compressed. use a .json file or an uncompressed .zip file, like ones exported by Roam Research or Micro Roam",10);{var c=new ArrayBuffer(12);const d=new Uint8Array(c);for(let e=0;e<12;e++)d[e]=t[e+18+o];i=new Uint32Array(c),n=(i[0],i[1]),l=i[2];if(1441805<=l)break;const f=new TextDecoder,u=f.decode(new Uint8Array(s,o+30,l));c=u.match(/\.([a-z]+)$/),i=f.decode(new Uint8Array(s,o+30+l,n));let e,r;c&&(e=c[1],r=u.substring(0,c.index)),a.push({name:r,ext:e,text:i,fullName:u}),o+=30+l+n}}return a},roamJsonToStore=(e,r)=>{var s,t,o,a=performance.now(),r=JSON.parse(r);const i={},n={},l={};let c=null;r[0][":edit/user"]&&(c=r[0][":edit/user"][":user/uid"]);const d=(r,e)=>{if((n[r.uid]=r).parent=e,r[":create/user"]&&r[":create/user"][":user/uid"]!==c?r[":create/user"]=r[":create/user"][":user/uid"]:delete r[":create/user"],r[":edit/user"]&&r[":edit/user"][":user/uid"]!==c?r[":edit/user"]=r[":edit/user"][":user/uid"]:delete r[":edit/user"],r.children){const o=r.children;r.children=o.map(e=>e.uid),o.forEach(e=>d(e,r.uid))}if(r.refs&&(r.refs=r.refs.map(e=>e.uid)),r[":block/refs"]&&(r[":block/refs"]=r[":block/refs"].map(e=>e[":block/uid"])),delete r.uid,r.backRefs=[],r[":block/props"]&&r[":block/props"][":drawing/lines"])for(var s of r[":block/props"][":drawing/lines"])s[":points"]=s[":points"].map(e=>[Math.round(e[0]),Math.round(e[1])]);if(r.props&&r.props.lines)for(var t of r.props.lines)t.points=t.points.map(e=>[Math.round(e[0]),Math.round(e[1])])};for(s of r){if(l[s.title]=s.uid,i[s.uid]=s,s[":create/user"]&&s[":create/user"][":user/uid"]!==c?s[":create/user"]=s[":create/user"][":user/uid"]:delete s[":create/user"],s[":edit/user"]&&s[":edit/user"][":user/uid"]!==c?s[":edit/user"]=s[":edit/user"][":user/uid"]:delete s[":edit/user"],void 0!==s.children){var f,u=s.children;s.children=[];for(f of u)s.children.push(f.uid),d(f,s.uid)}delete s.uid,s.backRefs=[]}for(t in n){const h=n[t];h[":block/refs"]&&h[":block/refs"].forEach(e=>{void 0!==n[e]?n[e].backRefs.push(t):void 0!==i[e]&&i[e].backRefs.push(t)})}for(o in i){var p=i[o];p.children&&0!==p.children.length||0!==p.backRefs.length||(delete l[p.title],delete i[o])}e={graphName:e,pages:i,blocks:n,pagesByTitle:l,ownerRoamId:c};return console.log(`roamJsonToStore took ${performance.now()-a}`),console.log(e),e},mdToStore=e=>{var s=Date.now();store;const t={};store=blankStore();var r,o;for(r of e){var a=r.name;const c=r.text;var i=(o=a,store.pagesByTitle[o]||newUid());const d={"create-time":s,title:a};if(store.pages[i]=d,store.pagesByTitle[a]=i,0<c.length){d.children=[];var n,l=e=>{var r=newUid();t[e]=r;e={"create-time":s,string:e};store.blocks[r]=e,d.children.push(r)},i=(d,c.matchAll(/\n((?:    )*)- /g));let e=2;for(n of i)l(c.substring(e,n.index)),e=n.index+n[0].length;l(c.substring(e))}}console.log(store)},parseMdBlock=e=>{},mergeStore=l=>{var e,r,s,t={},c=e=>void 0!==store.blocks[e]||void 0!==store.pages[e]?t[e]||newUid():e;for(e in l.blocks)c(e);for(r in l.pages)c(r);const d=(e,r,s)=>{const t=l.blocks[e],o={...t};if(store.blocks[r]=o,t.parent=s,t.children){o.children=[];for(var a of t.children){var i=c(a);d(a,i,r),o.children.push(i)}}for(var n of LIST_PROPS){let e=t[n];e&&(o[n]=e.map(c))}};for(s in l.pages){var o=l.pages[s],a=store.pagesByTitle[o.title];if(void 0===a){var i,n=c(s);const R={...o};if(store.pages[n]=R,store.pagesByTitle[o.title]=n,o.children){R.children=[];for(var f of o.children){var u=c(f);d(f,u,s),R.children.push(u)}}for(i of LIST_PROPS){let e=o[i];e&&(R[i]=e.map(c))}}else{const b=store.pages[a];if(o.children){void 0===b.children&&(b.children=[]);for(var p of o.children){var h=c(p);d(p,h,a),b.children.push(h)}}for(var g of LIST_PROPS)if(o[g]){void 0===b[g]&&(b[g]=[]);for(var v of o[g])b[g].push(c(v))}}}},gcBlocks=()=>{for(var e of Array.from(store.blocks)){var r=store.blocks[e];void 0===store.pages[r.parent]&&void 0===store.blocks[r.parent]&&delete store.blocks[e]}},escapeRegex=e=>e.replaceAll(/(?<=^|[^`])([\[\]\(\)])/g,"\\$1").replaceAll("`",""),searchRefCountWeight=.05,titleExactFullTextSearch=e=>{var r,s=new RegExp(escapeRegex(e),"i");const t=[];for(r in store.pages){var o=store.pages[r];const i=o.title;var a=i.match(s);a&&t.push({title:i,id:r,idx:a.index-o.backRefs.length*searchRefCountWeight})}return t.sort((e,r)=>e.idx-r.idx),t.slice(0,10)},exactFullTextSearch=e=>{var r,s,t=new RegExp(escapeRegex(e),"i");const o=[];for(r in store.pages){var a=store.pages[r];const l=a.title;var i=l.match(t);i&&o.push({title:l,id:r,idx:i.index-a.backRefs.length*searchRefCountWeight})}for(s in store.blocks){const c=store.blocks[s];var n=c.string.match(t);n&&o.push({string:c.string,id:s,idx:n.index+1-c.backRefs.length*searchRefCountWeight})}return o.sort((e,r)=>e.idx-r.idx).slice(0,10)},searchTemplates=o=>{var e=store.pages[store.pagesByTitle["roam/templates"]];const a=[];if(e){var r=(e,r)=>{const s=store.blocks[e],t=s.string.match(r?/^([^ \r\n]+)\s*$/:/^([^ \r\n]+)\s*(?:(?:#roam\/templates)|(?:\[\[roam\/templates\]\]))$/);console.log(t),t&&t.length>=o.length&&t[1].substring(0,o.length).toLowerCase()===o.toLowerCase()&&a.push({id:e,string:t[1]})};if(e.backRefs)for(var s of e.backRefs)r(s,0);if(e.children)for(var t of e.children)r(t,1)}return a};

const getTemp=e=>document.getElementById(e).content.firstElementChild,pageTemplate=getTemp("page"),blockTemplate=getTemp("block"),backrefListTemplate=getTemp("backref-list"),blockFocusFrameTemplate=getTemp("block-focus-frame"),pageBreakTemplate=getTemp("page-break"),suggestionTemplate=getTemp("autocomplete__suggestion"),searchResultTemplate=getTemp("search-result"),templateSuggestionTemplate=getTemp("template__suggestion"),breadcrumbBlockTemplate=getTemp("breadcrumb-block"),breadcrumbPageTemplate=getTemp("breadcrumb-page"),backrefFrameTemplate=getTemp("backref-frame"),notificationTemplate=getTemp("notification"),pageRefTemplate=getTemp("page-ref"),tagTemplate=getTemp("tag"),urlTemplate=getTemp("url"),blockRefTemplate=getTemp("block-ref"),boldTemplate=getTemp("bold"),italicTemplate=getTemp("italic"),highlightTemplate=getTemp("highlight"),literalTemplate=getTemp("literal"),templateExpanderTemplate=getTemp("template-expander"),pageFrame=document.getElementById("page-frame"),pageFrameOuter=document.getElementById("page-frame-outer"),searchInput=document.getElementById("search-input"),downloadButton=document.getElementById("download-button"),terminalElement=document.getElementById("terminal"),searchResultList=document.getElementById("search-result-list"),autocompleteList=document.getElementById("autocomplete-list"),templateList=document.getElementById("template-list");

const renderPage=(e,l)=>{const d=store.pages[l],t=pageTemplate.cloneNode(!0),n=t.firstElementChild,a=t.children[1];a.dataset.id=l,t.dataset.id=l,n.innerText=d.title;let i=d.children;i&&0!==i.length||(runCommand("createBlock",l,0),i=d.children);for(var o of i)renderBlock(a,o);if(0<d.backRefs.length){const s=backrefListTemplate.cloneNode(!0);t.children[2].appendChild(s),d.backRefs.sort((e,l)=>store.blocks[l]["edit-time"]-store.blocks[e]["edit-time"]);for(var r of d.backRefs){var p=backrefFrameTemplate.cloneNode(!0);renderBreadcrumb(p.children[0],r),renderBlock(p.children[1],r),s.children[1].appendChild(p)}}return e.appendChild(t),t},renderBlock=(e,l,d)=>{const t=blockTemplate.cloneNode(!0),n=t.children[1],a=t.children[2];t.dataset.id=l,a.dataset.id=l,n.dataset.id=l;var i=store.blocks[l].string;i&&renderBlockBody(n,i);l=store.blocks[l].children;if(l)for(var o of l)renderBlock(a,o);return void 0!==d&&e.children.length>=d?e.insertBefore(t,e.children[d]):e.appendChild(t),t},renderBlockBody=(e,l)=>{" "!==l[l.length-1]&&(l+=" ");const d=[e];var t=l.matchAll(/(\[\[)|(\]\])|(#[\/a-zA-Z0-9_-]+)|(\(\([a-zA-Z0-9\-_]{8,50}\)\))|(\*\*)|(\^\^)|(__)|((?:https?\:\/\/)(?:[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6})\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/\/=]*))|`([^`]+)`|(;;(?:[^ \n\r]*))/g);let n=0,a=e;var i,o=e=>{const l=document.createTextNode(e);return l.startIdx=n,l.endIdx=n+e.length,l};const r=[];for(i of t){if(a.appendChild(o(l.substring(n,i.index))),n=i.index,i[1]){const c=pageRefTemplate.cloneNode(!0);a.appendChild(c),c.children[0].appendChild(o("[[")),d.push(c.children[1]),a=d[d.length-1]}else if(i[2])"page-ref__body"===a.className?(a.parentNode.children[2].appendChild(o("]]")),r.push(a.innerText),d.pop(),a=d[d.length-1]):a.appendChild(o("]]"));else if(i[3]){r.push(i[3].substring(1));const h=tagTemplate.cloneNode(!0);h.appendChild(o(i[3])),a.appendChild(h)}else if(i[4]){var p=i[4].substring(2,i[4].length-2),s=store.blocks[p];if(s){const f=blockRefTemplate.cloneNode(!0);f.innerText=s.string,f.dataset.id=p,a.appendChild(f)}else a.appendChild(o(i[0]))}else if(i[5])if("bold"===a.className)a.appendChild(o("**")),d.pop(),a=d[d.length-1];else{const m=boldTemplate.cloneNode(!0);a.appendChild(m),m.appendChild(o("**")),d.push(m),a=m}else if(i[6])if("highlight"===a.className)a.appendChild(o("^^")),d.pop(),a=d[d.length-1];else{const g=highlightTemplate.cloneNode(!0);a.appendChild(g),g.appendChild(o("^^")),d.push(g),a=g}else if(i[7])if("italic"===a.className)a.appendChild(o("__")),d.pop(),a=d[d.length-1];else{const C=italicTemplate.cloneNode(!0);a.appendChild(C),C.appendChild(o("__")),d.push(C),a=C}else if(i[8]){const b=urlTemplate.cloneNode(!0);b.appendChild(o(i[8])),b.href=i[8],a.appendChild(b)}else if(i[9]){const u=literalTemplate.cloneNode(!0);u.appendChild(o(i[0])),a.appendChild(u)}else if(i[10]){const k=templateExpanderTemplate.cloneNode(!0);k.appendChild(o(i[0])),a.appendChild(k)}n=i.index+i[0].length}for(d[d.length-1].appendChild(o(l.substring(n)));a!==e;)"page-ref"===a.className&&(a.children[0].className=""),a.className="",a=a.parentNode;return r},renderBreadcrumb=(l,e)=>{const d=[];for(;;){if(e=store.blocks[e].parent,void 0===store.blocks[e]){d.push({title:store.pages[e].title,id:e});break}d.push({string:store.blocks[e].string,id:e})}const t=breadcrumbPageTemplate.cloneNode(!0);var n=d[d.length-1].title;renderBlockBody(t,n),t.dataset.title=n,l.appendChild(t);for(let e=d.length-2;0<=e;e--){const t=breadcrumbBlockTemplate.cloneNode(!0);var a=t.children[1];renderBlockBody(a,d[e].string),t.dataset.id=d[e].id,l.appendChild(t)}},notifyText=(e,l)=>{const d=notificationTemplate.cloneNode(!0);d.innerText=e,document.getElementById("app").appendChild(d),setTimeout(()=>d.style.top="60px",50);l=l&&1e3*l||5e3;setTimeout(()=>d.style.opacity="0",l),setTimeout(()=>{d.remove()},l+300)};

const dailyNotesInfiniteScrollListener=()=>{if(pageFrame.getBoundingClientRect().bottom-innerHeight<700)for(let e=0;e<100;e++){sessionState.oldestDate.setDate(sessionState.oldestDate.getDate()-1);var t=store.pagesByTitle[formatDate(sessionState.oldestDate)];if(t){renderPage(pageFrame,t),pageFrame.appendChild(pageBreakTemplate.cloneNode(!0));break}}},downloadHandler=()=>{console.log("download");var e=storeToRoamJSON(store),e=new Blob([e],{type:"text/json"}),e=URL.createObjectURL(e);downloadButton.setAttribute("href",e),downloadButton.setAttribute("download",`${store.graphName}-micro-roam.json`)},expandTemplate=()=>{var e=focusSuggestion.dataset.id,t=store.blocks[sessionState.focusId];if(void 0===t.children||0===t.children.length){var o=store.blocks[sessionState.focusId].parent,s=store.blocks[e].children,n=blockOrPageFromId(o).children.indexOf(sessionState.focusId);runCommand("deleteBlock",sessionState.focusId);var l=focusBlock.parentNode;focusBlock.remove();for(let e=0;e<s.length;e++){var a=s[e],i=n+e,a=runCommand("copyBlock",a,o,i),i=renderBlock(l,a,i);0===e&&focusBlockEnd(i)}}else notifyText("can't use a template inside a block that has children");templateList.style.display="none"},autocomplete=()=>{const e=store.blocks[sessionState.focusId].string;var t,o,s;"tag"===editingLink.className?(o=editingLink.childNodes[0],/[^\/a-zA-Z0-9_-]/.test(focusSuggestion.dataset.title)?(t=e.slice(0,o.startIdx)+"[["+focusSuggestion.dataset.title+"]]"+e.slice(o.endIdx),sessionState.position=o.startIdx+focusSuggestion.dataset.title.length+4,setFocusedBlockString(t)):(s=e.slice(0,o.startIdx)+"#"+focusSuggestion.dataset.title+e.slice(o.endIdx),sessionState.position=o.startIdx+focusSuggestion.dataset.title.length+1,setFocusedBlockString(s))):(o=editingLink.children[1].childNodes[0],s=e.slice(0,o.startIdx)+focusSuggestion.dataset.title+e.slice(o.endIdx),sessionState.position=o.startIdx+focusSuggestion.dataset.title.length+2,setFocusedBlockString(s)),autocompleteList.style.display="none"},indentFocusedBlock=()=>{var e,t,o=sessionState.focusId;const s=focusBlock.previousSibling;s&&s.dataset&&s.dataset.id&&(e=s.dataset.id,t=blockOrPageFromId(e).children.length,runCommand("moveBlock",o,e,t),s.children[2].appendChild(focusBlock),getSelection().collapse(focusNode,focusOffset))},dedentFocusedBlock=()=>{var e=sessionState.focusId,t=focusBlock.parentNode.parentNode;if(t){const s=t.parentNode;var o=t.parentNode.parentNode.dataset.id,t=t.nextSibling;o&&(t?s.insertBefore(focusBlock,t):s.appendChild(focusBlock),t=blockOrPageFromId(o).children.indexOf(e),runCommand("moveBlock",e,o,t+1),getSelection().collapse(focusNode,focusOffset))}};document.addEventListener("input",e=>{if(updateCursorInfo(),autocompleteList.style.display="none",templateList.style.display="none",sessionState.isFocused)if(" "!==focusBlockBody.innerText&&""!==focusBlockBody.innerText){var t=focusBlockBody.innerText;if(store.blocks[sessionState.focusId].string=t,setFocusedBlockString(t),editingTitle){var o=titleExactFullTextSearch(editingTitle);if(0<o.length){autocompleteList.innerHTML="",autocompleteList.style.display="block";t=editingLink.getBoundingClientRect();autocompleteList.style.top=t.bottom,autocompleteList.style.left=t.left;for(let e=0;e<o.length;e++){matchingTitle=o[e];const a=suggestionTemplate.cloneNode(!0);0===e&&(a.dataset.selected="true"),a.dataset.id=matchingTitle.id,matchingTitle.title?(a.dataset.title=matchingTitle.title,a.innerText=truncateElipsis(matchingTitle.title,50)):(a.dataset.string=matchingTitle.string,a.innerText=truncateElipsis(matchingTitle.string,50)),autocompleteList.appendChild(a)}}}if(editingTemplateExpander){console.log("editingTemplateExpander");var s=editingTemplateExpander.innerText.substring(2),n=searchTemplates(s);if(console.log(n),0<n.length){templateList.innerHTML="";for(let e=0;e<Math.min(n.length,10);e++){const i=templateSuggestionTemplate.cloneNode(!0);0===e&&(i.dataset.selected="true"),i.dataset.string=n[e].string,i.dataset.id=n[e].id,i.innerText=truncateElipsis(n[e].string,50),templateList.appendChild(i)}templateList.style.display="block",templateList.style.top=editingTemplateExpander.getBoundingClientRect().bottom,templateList.style.left=editingTemplateExpander.getBoundingClientRect().left}}}else runCommand("writeBlock",sessionState.focusId,"",[]);else if("search-input"===e.target.id){var l=exactFullTextSearch(e.target.value);if(0<l.length){searchResultList.innerHTML="";for(let e=0;e<Math.min(l.length,10);e++){const c=searchResultTemplate.cloneNode(!0);0===e&&(c.dataset.selected="true"),l[e].title?(c.dataset.title=l[e].title,c.innerText=truncateElipsis(l[e].title,50)):(c.dataset.string=l[e].string,c.dataset.id=l[e].id,c.innerText=truncateElipsis(l[e].string,50)),searchResultList.appendChild(c)}searchResultList.style.display="block",searchResultList.style.top=searchInput.getBoundingClientRect().bottom,searchResultList.style.left=searchInput.getBoundingClientRect().left}else searchResultList.style.display="none"}else"page__title"===e.target.className&&(console.log("edit title"),s=e.target.parentNode.dataset.id,runCommand("writePageTitle",s,e.target.innerText))});const focusBlockEnd=e=>{const t=e.children[1],o=document.createTextNode(" ");t.appendChild(o),getSelection().collapse(o,0),o.remove()},focusBlockStart=e=>{const t=e.children[1],o=document.createTextNode(" ");t.insertBefore(o,t.firstChild),getSelection().collapse(o,0),o.remove()},globalHotkeys={"hide top bar":{key:"b",control:!0,fn:()=>{"0px"===topBar.style.marginTop?user.topBar="hidden":user.topBar="visible",saveUser()}},escape:{key:"Escape",fn:()=>{autocompleteList.style.display="none",templateList.style.display="none"}},upload:{key:"d",control:!0,fn:()=>{document.getElementById("upload-input").click()}},download:{key:"s",control:!0,shift:!0,fn:downloadHandler},save:{key:"s",control:!0,fn:()=>{saveWorker.postMessage(["save",store])}},"toggle color theme":{key:"m",control:!0,fn:()=>{"light"===document.body.className?user.theme="dark":user.theme="light",saveUser()}},search:{key:"u",control:!0,fn:()=>{"0px"!==topBar.style.marginTop&&(topBar.style.marginTop="0px"),searchInput.focus()}},open:{key:"o",control:!0,fn:()=>{editingLink&&"page-ref"===editingLink.className&&goto("pageTitle",editingLink.children[1].innerText),editingLink&&"tag"===editingLink.className&&goto("pageTitle",editingLink.innerText.substring(1))}},terminal:{key:"i",control:!0,alt:!0,fn:()=>{"none"===terminalElement.style.display?(terminalElement.style.display="block",terminalElement.focus()):terminalElement.style.display="none"}}};document.addEventListener("keydown",event=>{for(var hotkeyName in updateCursorInfo(),globalHotkeys){const hotkey=globalHotkeys[hotkeyName];if(event.key===hotkey.key&&event.shiftKey===!!hotkey.shift&&event.ctrlKey===!!hotkey.control&&event.altKey===!!hotkey.alt)return hotkey.fn(),void event.preventDefault()}if("none"!==autocompleteList.style.display){"Tab"!==event.key&&"Enter"!==event.key||(autocomplete(),event.preventDefault());const newSelected="ArrowUp"===event.key&&focusSuggestion.previousSibling||"ArrowDown"===event.key&&focusSuggestion.nextSibling;newSelected&&(newSelected.dataset.selected="true",delete focusSuggestion.dataset.selected,event.preventDefault())}else if("none"!==templateList.style.display){"Tab"!==event.key&&"Enter"!==event.key||(expandTemplate(),event.preventDefault());const newSelected="ArrowUp"===event.key&&focusSuggestion.previousSibling||"ArrowDown"===event.key&&focusSuggestion.nextSibling;newSelected&&(newSelected.dataset.selected="true",delete focusSuggestion.dataset.selected,event.preventDefault())}else if(sessionState.isFocused){let blocks,newActiveBlock;switch(event.key){case"Enter":if(!event.shiftKey){const parent=blockOrPageFromId(store.blocks[sessionState.focusId].parent);let idx=parent.children.indexOf(sessionState.focusId);event.ctrlKey||(idx+=1),console.log(idx);const newBlockUid=runCommand("createBlock",store.blocks[sessionState.focusId].parent,idx),newBlockElement=renderBlock(focusBlock.parentNode,newBlockUid,idx);newBlockElement.children[1].focus(),event.preventDefault()}break;case"Tab":(event.shiftKey?dedentFocusedBlock:indentFocusedBlock)(),event.preventDefault();break;case"Backspace":0===sessionState.position&&(blocks=Array.from(document.querySelectorAll(".block")),newActiveBlock=blocks[blocks.indexOf(focusBlock)-1],focusBlock.remove(),focusBlockEnd(newActiveBlock),runCommand("deleteBlock",sessionState.focusId),event.preventDefault());break;case"ArrowDown":if(event.altKey&&event.shiftKey){const parentId=store.blocks[sessionState.focusId].parent,parentElement=focusBlock.parentNode,currentIdx=blockOrPageFromId(parentId).children.indexOf(sessionState.focusId);focusBlock.nextSibling&&(runCommand("moveBlock",sessionState.focusId,parentId,currentIdx+1),focusBlock.nextSibling.nextSibling?parentElement.insertBefore(focusBlock,focusBlock.nextSibling.nextSibling):parentElement.appendChild(focusBlock),getSelection().collapse(focusNode,focusOffset),event.preventDefault())}else event.shiftKey||event.altKey||(blocks=Array.from(document.querySelectorAll(".block")),newActiveBlock=blocks[blocks.indexOf(focusBlock)+1],focusBlockStart(newActiveBlock),event.preventDefault());break;case"ArrowUp":if(event.altKey&&event.shiftKey){const parentId=store.blocks[sessionState.focusId].parent,parentElement=focusBlock.parentNode,currentIdx=blockOrPageFromId(parentId).children.indexOf(sessionState.focusId);focusBlock.previousSibling&&(runCommand("moveBlock",sessionState.focusId,parentId,currentIdx-1),parentElement.insertBefore(focusBlock,focusBlock.previousSibling),getSelection().collapse(focusNode,focusOffset),event.preventDefault())}else event.shiftKey||event.altKey||(blocks=Array.from(document.querySelectorAll(".block")),newActiveBlock=blocks[blocks.indexOf(focusBlock)-1],focusBlockEnd(newActiveBlock),event.preventDefault());break;case"ArrowLeft":event.shiftKey&&event.altKey?dedentFocusedBlock():0===sessionState.position&&(blocks=Array.from(document.querySelectorAll(".block")),newActiveBlock=blocks[blocks.indexOf(focusBlock)-1],focusBlockEnd(newActiveBlock),event.preventDefault());break;case"ArrowRight":event.shiftKey&&event.altKey?indentFocusedBlock():sessionState.position===focusBlockBody.innerText.length&&(blocks=Array.from(document.querySelectorAll(".block")),newActiveBlock=blocks[blocks.indexOf(focusBlock)+1],newActiveBlock&&focusBlockStart(newActiveBlock),event.preventDefault())}}if(document.activeElement&&"search-input"===document.activeElement.id){if("Enter"===event.key)return goto("pageTitle",event.target.value),void event.preventDefault();if("Tab"===event.key){const selected=searchResultList.querySelector('.search-result[data-selected="true"]');if(selected)return void(selected.dataset.title?goto("pageTitle",selected.dataset.title):goto("block",selected.dataset.id))}}if("none"!==terminalElement.style.display&&"Enter"===event.key&&!event.ctrlKey&&!event.shiftKey&&!event.altKey){const tc=terminalCommands[event.target.innerText];tc?tc():eval(event.target.innerText),event.ctrlKey||(terminalElement.style.display="none",terminalElement.innerHTML="")}}),document.addEventListener("click",e=>{var t=e.target.closest(".block__bullet");if("search-result"!==e.target.className){"search-input"!==e.target.id&&(searchResultList.style.display="none");var o=e.target.closest(".breadcrumb-page"),s=e.target.closest(".breadcrumb-block");if("template__suggestion"===e.target.className)focusSuggestion&&(focusSuggestion.dataset.selected=!1),e.target.dataset.selected=!0,focusSuggestion=e.target,expandTemplate();else if("page-ref__body"===e.target.className)goto("pageTitle",e.target.innerText);else if(t)goto("block",t.parentNode.dataset.id);else if("block-ref"===e.target.className)goto("block",e.target.dataset.id);else if(e.target.closest(".tag"))goto("pageTitle",e.target.closest(".tag").innerText.substring(1));else if("download-button"===e.target.id)downloadHandler();else if("upload-button"===e.target.id)document.getElementById("upload-input").click();else if("daily-notes-button"===e.target.id)goto("dailyNotes");else if("autocomplete__suggestion"===e.target.className)focusSuggestion&&(focusSuggestion.dataset.selected=!1),e.target.dataset.selected=!0,autocomplete();else if("url"===e.target.className){const n=document.createElement("a");n.target="_blank",n.href=e.target.innerText,n.click()}else"help-button"===e.target.id?goto("pageTitle","Welcome to Micro Roam"):o?goto("pageTitle",o.dataset.title):s&&goto("block",s.dataset.id);updateCursorInfo()}else e.target.dataset.title?goto("pageTitle",e.target.dataset.title):goto("block",e.target.dataset.id)}),topBarHiddenHitbox.addEventListener("mouseover",()=>{user.topBar="visible",saveUser()}),document.getElementById("upload-input").addEventListener("change",e=>{const t=e.target.files[0];console.log(t);var[o,e]=t.name.split(".");console.log(`name ${o} extension ${e}`),"zip"===e?t.arrayBuffer().then(e=>{e=zipToFiles(e);if(console.log(e),1===e.length&&"json"===e[0].ext)store=roamJsonToStore(e[0].name,e[0].text),fetch("./default-store.json").then(e=>e.json().then(e=>{mergeStore(e),theresANewStore()}));else{const o=[];for(var t of e)"md"===t.ext?o.push(t):console.log(`That zip file contained ${t.fullName}, but Micro Roam expected a .json file or multiple .md files`);console.log("parsing markdown"),mdToStore(o)}}):"json"===e?t.text().then(e=>{store=roamJsonToStore(o,e),fetch("./default-store.json").then(e=>e.json().then(e=>{mergeStore(e),theresANewStore()}))}):notifyText("Micro Roam only accepts a .json file, a .zip file containing 1 .json file, or a .zip file containing .md files")});

const initialDailyNotes=5,renderSessionState=()=>{switch(searchResultList.style.display="none",pageFrameOuter.removeEventListener("scroll",dailyNotesInfiniteScrollListener),pageFrame.innerHTML="",searchInput.value="",sessionState.pageFrame){case"pageTitle":let e=store.pagesByTitle[sessionState.pageFrameTitle];void 0===e&&(e=runCommand("createPage",sessionState.pageFrameTitle)),renderPage(pageFrame,e);break;case"block":const i=blockFocusFrameTemplate.cloneNode(!0);pageFrame.appendChild(i),renderBreadcrumb(i.children[0],sessionState.pageFrameId),renderBlock(i.children[1],sessionState.pageFrameId);const r=store.blocks[sessionState.pageFrameId].backRefs;if(r){r.sort((e,t)=>store.blocks[t]["edit-time"]-store.blocks[e]["edit-time"]);var s,o=backrefListTemplate.cloneNode(!0);i.children[2].appendChild(o);for(s of r)renderBlock(o.children[1],s)}break;case"dailyNotes":pageFrameOuter.addEventListener("scroll",dailyNotesInfiniteScrollListener),sessionState.oldestDate=new Date(Date.now());let t=0;void 0===store.pagesByTitle[formatDate(sessionState.oldestDate)]&&runCommand("createPage",formatDate(sessionState.oldestDate));for(let e=0;e<1e3;e++){var a=store.pagesByTitle[formatDate(sessionState.oldestDate)];if(a&&(renderPage(pageFrame,a),pageFrame.appendChild(pageBreakTemplate.cloneNode(!0)),t+=1,t>=initialDailyNotes))break;sessionState.oldestDate.setDate(sessionState.oldestDate.getDate()-1)}t<initialDailyNotes&&pageFrame.lastChild.remove()}sessionState.isFocused&&focusIdPosition(),pageFrameOuter.scrollTop=sessionState.scroll||0},gotoNoHistory=(e,...t)=>{switch(e){case"dailyNotes":sessionState.pageFrame="dailyNotes";break;case"pageTitle":sessionState.pageFrame="pageTitle",sessionState.pageFrameTitle=t[0];break;case"block":sessionState.pageFrame="block",sessionState.pageFrameId=t[0]}renderSessionState()},goto=(...e)=>{sessionState.scroll=pageFrameOuter.scrollTop;var t=JSON.parse(JSON.stringify(sessionState));sessionState.scroll=0,gotoNoHistory(...e),setTimeout(()=>{history.replaceState(t,"Micro Roam"),history.pushState(sessionState,"Micro Roam")},0)},gotoReplaceHistory=(...e)=>{gotoNoHistory(...e),history.replaceState(sessionState,"Micro Roam")};window.addEventListener("popstate",e=>{console.log(e.state),e.state&&(sessionState=e.state,renderSessionState())});const focusIdPosition=()=>{focusBlockBody=document.querySelector(`.block[data-id="${sessionState.focusId}"]>.block__body`);const o=e=>{for(var t of e.childNodes)if("#text"===t.nodeName){if(t.textContent&&sessionState.position>=t.startIdx&&sessionState.position<t.startIdx+t.textContent.length){scanResult=t;try{return getSelection().collapse(t,sessionState.position-t.startIdx),t}catch(e){return t}}}else{var s=o(t);if(s)return s}};o(focusBlockBody)},setFocusedBlockString=e=>{focusBlockBody.innerHTML="";var t=renderBlockBody(focusBlockBody,e);focusIdPosition(),updateCursorInfo(),runCommand("writeBlock",sessionState.focusId,e,t)},updateCursorInfo=()=>{if(console.log("update cursor info"),sessionState.scroll=pageFrameOuter.scrollTop,focusNode=getSelection().focusNode,focusOffset=getSelection().focusOffset,focusSuggestion=autocompleteList.querySelector('.autocomplete__suggestion[data-selected="true"]')||templateList.querySelector('.template__suggestion[data-selected="true"]'),focusNode)if(focusBlock=focusNode.parentNode.closest(".block"),focusBlock){sessionState.isFocused=!0,sessionState.focusId=focusBlock.dataset.id,"block__body"===focusNode.className?sessionState.position=focusBlock.innerText.length*(0!==focusOffset):(sessionState.position=focusOffset,focusNode.startIdx&&(sessionState.position+=focusNode.startIdx)),focusBlockBody=focusBlock.children[1],editingLink=void 0;var e,t,s,o=focusBlockBody.querySelectorAll(".page-ref");for(e of focusBlockBody.querySelectorAll(".tag"))e.childNodes[0].endIdx>=sessionState.position&&e.childNodes[0].startIdx<sessionState.position&&(editingLink=e);for(t of o)t.children[1].childNodes[0].endIdx>=sessionState.position&&t.children[1].childNodes[0].startIdx<sessionState.position&&(editingLink=t);editingTitle=editingLink&&("tag"===editingLink.className&&editingLink.innerText.substring(1)||"page-ref"===editingLink.className&&editingLink.children[1].innerText),editingTemplateExpander=void 0;for(s of focusBlockBody.querySelectorAll(".template-expander"))s.childNodes[0].endIdx>=sessionState.position&&s.childNodes[0].startIdx<sessionState.position&&(editingTemplateExpander=s)}else sessionState.isFocused=!1;else sessionState.isFocused=!1},saveWorker=new Worker("/worker.js");saveWorker.postMessage(["user",user]),saveWorker.onmessage=e=>{e.data[1];"ping"===e.data[0]&&console.log(`ping took ${performance.now()-pingstime}`)},w?theresANewStore():w=!0;

const page=e=>{console.log(store.pages[store.pagesByTitle[e]])},log=()=>{user.logging=!0,saveUser(),saveWorker.postMessage(["user",user])},nolog=()=>{user.logging=!1,saveUser(),saveWorker.postMessage(["user",user])},test=()=>{const e=document.createElement("script");e.src="test.js",document.body.appendChild(e)},reset=()=>{indexedDB.deleteDatabase("microroam");localStorage.removeItem("user"),window.location.href=window.location.href},blank=()=>{store=blankStore(),user=blankUser,saveUser(),goto("dailyNotes")},pr=()=>{console.log(JSON.stringify(store))};let pingstime;const ping=()=>{pingstime=performance.now(),saveWorker.postMessage(["ping",{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:{hello:"hello"}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}])},terminalCommands={blank:blank,reset:reset,test:test,log:log,page:page,nolog:nolog,ping:ping,pr:pr};
</script>

</body>