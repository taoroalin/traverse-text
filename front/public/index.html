<script>let idb=null,store=null,otherStores={},r;const basicBitchServerUrl="http://localhost:3000";let user,userText=localStorage.getItem("user"),usingLocalStore=!0,startFn=()=>gotoNoHistory("dailyNotes"),dataLoaded=!1,scriptsLoaded=!1;const setDataLoaded=()=>{scriptsLoaded&&start(),dataLoaded=!0},start=()=>{saveUser(),startFn(),user.h&&user.s.commitId!==user.s.syncCommitId&&debouncedSaveStore()},invalidateLocal=()=>{indexedDB.deleteDatabase("microroam");console.error("Local replica invalid. Resetting from server"),user.s.commitId=void 0,user.s.syncCommitId=void 0,localStorage.setItem("user",JSON.stringify(user)),localStorage.removeItem("store"),window.location.href=window.location.href};if(userText){if(user=JSON.parse(userText),user.h){const c=new Headers;c.set("h",user.h),user.s.syncCommitId&&c.set("commitid",user.s.syncCommitId);let e=`${basicBitchServerUrl}/get/${user.s.graphName}`;fetch(e,{method:"POST",headers:c}).then(async s=>{304!==s.status?200===s.status?(console.log(`server on commit ${s.headers.get("commitid")} local on commit ${user.s.syncCommitId}`),usingLocalStore=!1,s.json().then(e=>{console.log("got blox");const o=startFn;startFn=()=>{store=hydrateFromBlox(user.s.graphName,e),user.s.syncCommitId=s.headers.get("commitid"),o()},setDataLoaded()})):console.log("STORE NOT ON SERVER"):console.log("already up to date")})}const b=localStorage.getItem("store");if(b){try{store=JSON.parse(b),setDataLoaded()}catch(e){invalidateLocal()}r=indexedDB.open("microroam",5),r.onsuccess=e=>idb=e.target.result}else r=indexedDB.open("microroam",5),r.onsuccess=e=>{if(console.log("normal success"),idb=e.target.result,!0===usingLocalStore)try{idb.transaction(["stores"],"readonly").objectStore("stores").get(user.graphName).onsuccess=e=>{if(!0===usingLocalStore)if(e.target.result)try{store=JSON.parse(e.target.result.store),setDataLoaded()}catch(e){invalidateLocal()}else console.log("adding default graph")}}catch(e){}}}else user={s:{graphName:"default",theme:window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",topBar:"visible",logging:!1,spellcheck:!1,editingSpotlight:!0}},fetch("./default-store.json").then(e=>{e.json().then(e=>{store=e,startFn=()=>gotoNoHistory("pageTitle","Welcome to Micro Roam"),setDataLoaded()})}),r=indexedDB.open("microroam",5),r.onsuccess=e=>idb=e.target.result;r.onupgradeneeded=o=>{console.log("upgradeneeded");const s=r.result,e=Array.from(s.objectStoreNames);e.includes("stores")?(console.log(o),console.log(s),r.onsuccess=()=>{console.log("new success"),idb=o.target.result;const e=s.transaction(["stores"],"readonly").objectStore("stores");e.get(user.s.graphName).onsuccess=e=>{store=e.target.result.store;const o=oldStoreToRoamJSON[s.version](store);roamJsonToStore(user.s.graphName,o),saveStore(),setDataLoaded()}}):s.createObjectStore("stores",{keyPath:"graphName"})},r.onerror=e=>{console.log("error"),console.log(e),alert('In order to save your notes between sessions, Micro Roam needs access to IndexedDB. \nYou can allow access by exiting "private browsing" mode, or by using a newer browser, or by changing browser settings')}</script><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet"><style>*{outline:0;scrollbar-width:none}.dark{--background:#000000;--click:rgb(100, 100, 100);--text:#dbdbdb;--link:#3f84c0;--brackets:#a7b6c2;--block-ref:rgb(63, 63, 63);--bullet:#8f9091;--border:#afbeca;--bar:#565d63;--break:#838e97;--highlight:#685000;--page-ref:#3ac263;--shadow:rgb(98, 98, 98);--notification:#183d23;--query-background:#051809;--editing-background:#111111;--selected:#2d4a66}.light{--background:white;--click:rgb(197, 197, 197);--text:black;--link:rgb(54, 123, 184);--brackets:#a7b6c2;--block-ref:lightgrey;--bullet:#394b59;--border:#585e64;--bar:#7c858d;--shadow:#585e64;--break:#a8b4be;--highlight:rgb(255, 247, 128);--page-ref:#1cce37;--notification:#a4d1b1;--query-background:#b0dfbd;--editing-background:#e6e6e6;--selected:#abcdeb}a,button,input{font-family:Inter}input{border:none;background-color:var(--background);color:var(--text)}button{appearance:none;border:none;box-shadow:none;cursor:pointer;background-color:inherit;color:inherit;font-size:inherit}span{margin:0;padding:0}::-webkit-scrollbar{width:0%;height:0%}::selection{background-color:#85b7e8;color:var(--text)}body{scrollbar-width:0;font-family:Inter;font-weight:400;margin:0;color:var(--text);background-color:var(--background)}a{color:var(--link)}a:visited{color:var(--link)}#app{height:100%;width:100%;display:flex;flex-direction:column}#page-frame-outer{width:100%;overflow-y:scroll}#page-frame{margin:0 auto 30px;max-width:min(900px,100%)}#top-bar{width:100%;display:flex;flex-direction:row;align-content:space-between;background-color:var(--background)}#top-bar button{font-size:.9em;color:var(--bullet);padding:10px 10px 8px}.top-bar-transition{transition:margin-top .1s}#top-bar-left,#top-bar-right{display:flex;flex-direction:row}#top-connect,#top-hamburger{padding:7px 6px 2px 4px;cursor:pointer}#options-frame{position:fixed;top:36px;right:5px;display:flex;flex-direction:column}#options-frame button{border-radius:10px;padding:6px;display:block}#create-new-store{border-radius:10px;padding:6px;font-size:1.1em}#search-input{background-color:var(--background);color:var(--text);padding:3px 13px;margin:5px 3px 4px;display:block;font-size:1.1em;box-shadow:0 0 2px var(--bullet);border-radius:100px;flex-grow:1}#search-input::placeholder{color:var(--bullet)}#autocomplete-list,#command-list,#options-frame,#template-list{position:absolute;display:flex;flex-direction:column;background-color:var(--background);font-size:1.3em;border-radius:10px;box-shadow:0 0 6px 0 var(--shadow)}.autocomplete__suggestion[data-selected=true],.command__suggestion[data-selected=true],.template__suggestion[data-selected=true]{background-color:var(--click)}.autocomplete__suggestion,.command__suggestion,.template__suggestion{padding:10px;cursor:pointer;border-radius:5px}#search-result-list{position:absolute;display:flex;flex-direction:column;background-color:var(--background);font-size:1.3em;border-radius:5px;box-shadow:0 0 8px var(--shadow)}.search-result[data-selected=true]{background-color:var(--click)}.search-result{padding:7px;cursor:pointer;border-radius:5px}.page{margin-right:30px;margin-left:30px;position:relative}.page__title{font-size:38px;margin:35px 0 20px 0;font-weight:300}.backref-frame__body,.page__body{margin-left:20px}.backref-list__body{margin-left:10px}.backref-list__title{font-size:1.3em;padding:20px 0 0}.page-break{height:0;margin:50px 25px;border:1px solid var(--break);border-width:1px 0 0 0}.block{position:relative;border-radius:5px}.block[data-selected=true]{background-color:var(--selected)}.block__body{padding:5px 2px;white-space:pre-wrap}[data-editingspotlight=true] .block__body[data-editmode=true]{background-color:var(--editing-background);border-radius:4px}.block__bullet{cursor:pointer;position:absolute;left:-21px;top:4px}.block__children{margin-left:22px;position:relative}.block__children::before{display:block;position:absolute;content:"\200B";top:0;height:100%;width:6px;transform:translateX(-34px);border-left:1px solid var(--bar)}.block-focus-frame{margin:60px 0}.breadcrumb-page{cursor:pointer}.breadcrumb-block{cursor:pointer}.backref-frame__breadcrumb{margin:15px 0 5px 0;font-size:1.2em}.block-focus-frame__breadcrumb{margin:15px 0 5px 0;font-size:1.2em}.page-ref{position:relative}.page-ref__brackets{font-weight:lighter;color:var(--brackets)}.page-ref__body{color:var(--page-ref);font-weight:600}.page-ref:hover{cursor:pointer}.page-ref:hover>.page-ref__body{text-decoration:underline}.tag{color:var(--page-ref);position:relative;font-weight:600}.tag:hover{text-decoration:underline;cursor:pointer}.block-ref{background-color:var(--block-ref)}.block-ref:hover{text-decoration:underline;cursor:pointer}.bold{font-weight:700}.italic{font-style:italic}.highlight{background-color:var(--highlight);border-radius:2px;padding:1px}.block-focus-frame{margin:35px 0 0 60px}.url{color:var(--link);text-decoration:underline;cursor:pointer}.literal{font-family:Inconsolata;font-size:1.15em}.code-block{font-family:Inconsolata;font-size:1.15em}.attribute{font-weight:700}.attribute:hover{cursor:pointer}.image-embed{max-width:100%}.todo-checkbox{transform:translateY(1px);height:14px;width:14px;margin:0 2px}.compute-failed{background-color:var(--query-background);border-radius:4px;padding:5px 2px;margin-left:-2px}#terminal{font-family:Inconsolata;width:100%;padding:8px;background-color:#000;color:#fff}.query-frame{background-color:var(--query-background);border-radius:8px;padding:1px 12px 18px;margin:3px 0}.notification{text-align:center;min-width:300px;position:fixed;left:50%;transform:translateX(-50%);top:-40px;margin-top:0;opacity:1;transition:top .25s ease-out,opacity .2s linear;padding:20px;background-color:var(--notification);border-radius:8px}#login,#signup{position:fixed;top:0;left:0;right:0;bottom:0;background-color:var(--background);text-align:center}#login-form,#signup-form{position:fixed;top:28%;left:50%;transform:translateX(-50%);padding:13px 20px 20px;border-radius:12px;display:flex;flex-direction:column;justify-content:space-between}#login input,#signup input{background-color:var(--background);color:var(--text);font-size:1.4em;border-radius:3px;display:block;padding:4px;margin-bottom:13px}#login button,#signup button{position:fixed;bottom:19%;left:50%;transform:translateX(-50%);display:block;padding:4px;border-radius:3px;background-color:var(--background);color:var(--placeholder)}#login button:focus,#signup button:focus{font-weight:700}#login p,#signup p{left:50%;font-size:1.7em;color:var(--placeholder);padding:4px;margin-bottom:20px;margin-top:65px}#login .exit-to-main,#signup .exit-to-main{bottom:9%}.really-want-to{padding:80px;position:fixed;top:30%;right:50%;transform:translateX(50%);background-color:var(--background);box-shadow:0 0 2px var(--shadow);border-radius:8px;text-align:center;flex-direction:column}.really-want-to button{margin-top:30px;display:block}</style><div id="html"><p style="font-family:Inter">please enable JavaScript</div><script>const elById=e=>document.getElementById(e),getTemp=e=>elById(e).content.firstElementChild,allHtml=`<div id="app">
  <div id="top-bar" style="margin-top:-43px">
    <div id="top-bar-left">
      
    </div>
    <input id="search-input" placeholder="search" tabindex="-1">
    <div id="top-bar-right">
      
    </div>
    
    <svg id="top-connect" width="25" height="25">
      <line x1="12.5" y1="20" x2="21" y2="9" stroke="var(--bullet)" />
      <line x1="12.5" y1="20" x2="4" y2="9" stroke="var(--bullet)" />
      <line x1="12.5" y1="20" x2="12.5" y2="5" stroke="var(--bullet)" />
      
      <circle cx="4" cy="9" r="3.5" stroke="var(--bullet)" />
      <circle cx="12.5" cy="5" r="3.5" stroke="var(--bullet)" />
      <circle cx="21" cy="9" r="3.5" stroke="var(--bullet)" />
      
      <circle cx="12.5" cy="20" r="4.5" stroke="var(--bullet)" />
      <circle cx="12.5" cy="20" r="2.5" fill="var(--bullet)" />
    </svg>
    
    <svg id="top-hamburger" width="25" height="25">
      <circle cx="12.5" cy="5" r="2.5" fill="var(--bullet)" />
      <circle cx="12.5" cy="13" r="2.5" fill="var(--bullet)" />
      <circle cx="12.5" cy="21" r="2.5" fill="var(--bullet)" />
    </svg>
    
  </div>

  <div id="top-bar-hidden-hitbox" style="position:fixed;height:20px;width:100%;display:none;"></div>


  <div id="terminal" contenteditable="true" style="display:none"></div>

  <div id="page-frame-outer">
    <div id="page-frame">

    </div>
  </div>
  
  <div id="options-frame" style="display:none">
  </div>

  <div id="connect-frame" style="display:none">
  <input id="find-graph-input">
  <div id="connected-list"></div>
  </div>

  <!-- inline styles on this site are all edited directly by js -->
  <div id="autocomplete-list" style="display:none"></div>
  <div id="command-list" style="display:none"></div>
  <div id="search-result-list" style="display:none"></div>
  <div id="template-list" style="display:none"></div>

  <div id="login" style="display:none">
    <p>Login</p>
    <form id="login-form">
      <input type="email" id="login-email" placeholder="email">
      <input type="password" id="login-password" placeholder="password">
      <input type="submit" style="height:0px" tabindex="-1">
    </form>
    <button id="switch-to-signup">Sign up</button>
    <button class="exit-to-main">Back</button>
  </div>

  <div id="signup" style="display:none">
    <p>Sign up</p>
    <form id="signup-form">
      <input type="email" id="signup-email" placeholder="email">
      <input type="text" id="signup-username" placeholder="username">
      <input type="password" id="signup-password" placeholder="password">
      <input type="submit" style="height:0px" tabindex="-1">
    </form>
    <button id="switch-to-login">Login</button>
    <button class="exit-to-main">Back</button>
  </div>

  <div id="really-want-to-leave" class="really-want-to" style="display:none">
    Your data will be lost if you sign out now
    <button>Continue</button>
  </div>
</div>

<title>Micro Roam</title>


<template id="page">
  <div class="page">
    <h1 class="page__title" contenteditable="true" tabindex="-1"></h1>

    <div class="page__body">

    </div>
    <div class="page__backlinks">

    </div>
  </div>
</template>

<template id="block">
  <div class="block">
    <svg class="block__bullet" width="20" height="20">
      <circle cx="10" cy="10.5" r="3" fill="var(--bullet)" />
    </svg>
    <div class="block__body" contenteditable="true" tabindex="-1"></div>
    <div class="block__children">

    </div>
  </div>
</template>

<template id="backref-list">
  <div class="backref-list">
    <div class="backref-list__title">Linked References</div>
    <div class="backref-list__body"></div>
  </div>
</template>

<template id="query-frame">
  <div class="query-frame"></div>
</template>

<template id="block-focus-frame">
  <div class="block-focus-frame">
    <div class="block-focus-frame__breadcrumb"></div>
    <div class="block-focus-frame__body"></div>
    <div class="block-focus-frame__backlinks"></div>
  </div>
</template>

<template id="backref-frame">
  <div class="backref-frame">
    <div class="backref-frame__breadcrumb"></div>
    <div class="backref-frame__body"></div>
  </div>
</template>

<template id="page-ref">
  <span class="page-ref"><span class="page-ref__brackets"></span><span class="page-ref__body"></span><span
      class="page-ref__brackets"></span></span>
</template>

<template id="image-embed">
  <img class="image-embed">
</template>

<template id="compute-failed">
  <span class="compute-failed"><span class="compute-failed__brackets"></span><span
      class="compute-failed__body"></span><span class="compute-failed__brackets"></span></span>
</template>

<template id="todo-checkbox">
  <input type="checkbox" class="todo-checkbox">
</template>

<template id="video-embed">
  <iframe class="video-embed" width="560" height="315" title="YouTube video player" frameborder="0"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
    allowfullscreen></iframe>
</template>

<template id="breadcrumb-page">
  <span class="breadcrumb-page"></span>
</template>

<template id="notification">
  <div class="notification"></div>
</template>

<template id="breadcrumb-block">
  <span class="breadcrumb-block"><span class="breadcrumb-block__arrow">-></span><span
      class="breadcrumb-block__body"></span></span>
</template>

<template id="autocomplete__suggestion">
  <div class="autocomplete__suggestion"></div>
</template>

<template id="command__suggestion">
  <div class="command__suggestion"></div>
</template>

<template id="template__suggestion">
  <div class="template__suggestion"></div>
</template>

<template id="search-result">
  <div class="search-result"></div>
</template>`,allFrame=elById("html");allFrame.innerHTML=allHtml;const topBarRight=elById("top-bar-right"),topBarLeft=elById("top-bar-left"),optionsFrame=elById("options-frame"),topButtons={};let topButtonNames=["Help","Daily Notes","Report Issue","Sign Up","Sign Out","Login","Upload","Download"];for(let e of topButtonNames)topButtons[e]=document.createElement("button"),topButtons[e].innerText=e,topButtons[e].tabindex=-1;topButtons["Create New Graph"]=document.createElement("input"),topButtons["Create New Graph"].placeholder="Create New Graph",topButtons["Create New Graph"].id="create-new-store",topButtons["Create New Graph"].type="text",topButtons["Create New Graph"].size=15;const disconnectedFileInput=document.createElement("input");disconnectedFileInput.type="file",topButtonNames=Object.keys(topButtons);let toShowOnTopBar=["help","Daily Notes","Report Issue","Sign Up"];const layoutTopBar=()=>{const t=Math.round(toShowOnTopBar.length/2);for(let e=0;e<t;e++)topBarLeft.appendChild(topButtons[topButtonNames[e]]);for(let e=t;e<toShowOnTopBar.length;e++)topBarRight.appendChild(topButtons[topButtonNames[e]]);for(let e of topButtonNames)toShowOnTopBar.includes(e)||optionsFrame.appendChild(topButtons[e])};layoutTopBar();let sessionState={pageFrame:"dailyNotes",focusId:null,scroll:0,position:null},focusNode=null,focusOffset=null,focusBlock=null,focusBlockBody=null,editingTemplateExpander=null,editingCommandElement=null,editingLink=null,editingTitle=null,focusSuggestion=null,dragSelectStartBlock=null,dragSelect=null,clipboardData=null;const SEARCH_RESULT_LENGTH=12;document.body.className=user.s.theme;const topBar=document.getElementById("top-bar"),topBarHiddenHitbox=document.getElementById("top-bar-hidden-hitbox");"visible"===user.s.topBar&&(topBar.style.marginTop="0px",topBarHiddenHitbox.style.display="none"),setTimeout(()=>topBar.className="top-bar-transition",200);const pageFrame=elById("page-frame"),pageFrameOuter=elById("page-frame-outer"),searchInput=elById("search-input"),terminalElement=elById("terminal"),searchResultList=elById("search-result-list");searchResultList.dataset.templateName="search-result";const autocompleteList=elById("autocomplete-list");autocompleteList.dataset.templateName="autocomplete__suggestion";const inlineCommandList=elById("command-list");inlineCommandList.dataset.templateName="command__suggestion";const templateList=elById("template-list");templateList.dataset.templateName="template__suggestion";const switchToLogin=elById("switch-to-login"),switchToSignup=elById("switch-to-signup"),signupElement=elById("signup"),loginElement=elById("login"),reallyWantToLeaveElement=elById("really-want-to-leave"),appElement=elById("app"),topHamburgerElement=elById("top-hamburger"),connectFrame=elById("connect-frame"),loginForm=elById("login-form"),loginEmailElement=elById("login-email"),loginPasswordElement=elById("login-password"),signupForm=elById("signup-form"),signupUsernameElement=elById("signup-username"),signupEmailElement=elById("signup-email"),signupPasswordElement=elById("signup-password"),pageTemplate=getTemp("page"),blockTemplate=getTemp("block"),backrefListTemplate=getTemp("backref-list"),blockFocusFrameTemplate=getTemp("block-focus-frame"),searchResultTemplate=getTemp("search-result"),breadcrumbBlockTemplate=getTemp("breadcrumb-block"),breadcrumbPageTemplate=getTemp("breadcrumb-page"),backrefFrameTemplate=getTemp("backref-frame"),notificationTemplate=getTemp("notification"),pageRefTemplate=getTemp("page-ref"),imageEmbedTemplate=getTemp("image-embed"),computeFailedTemplate=getTemp("compute-failed"),todoCheckboxTemplate=getTemp("todo-checkbox"),videoEmbedTemplate=getTemp("video-embed"),queryFrameTemplate=getTemp("query-frame"),textEncoder=new TextEncoder,CHARS_64="-_0123456789abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ",CHARS_16="0123456789abcdef";let newUid;{let o=new Uint8Array(9);newUid=()=>{let t;do{crypto.getRandomValues(o),t="";for(let e=0;e<9;e++)t+=CHARS_64[o[e]%64]}while(void 0!==store.blox[t]);return t}}let newUUID;{let o=new Uint8Array(21);newUUID=()=>{crypto.getRandomValues(o);let t="";for(let e=0;e<21;e++)t+=CHARS_64[o[e]%64];return t}}const applyDif=(e,t)=>{let o=e.length;void 0!==t.s&&(o=t.s);const s=o-(void 0!==t.d&&t.d.length||0);return e.substring(0,s)+(t.i||"")+e.substring(o)},unapplyDif=(e,t)=>{const o=void 0!==t.d&&t.d.length||0,s=void 0!==t.i&&t.i.length||0;if(void 0!==t.s){const a=t.s-o,r=a+s;return e.substring(0,a)+(t.d||"")+e.substring(r)}{const i=e.length-o-s;return e.substring(0,i)+(t.d||"")}},undoEditBlox=(e,t)=>{const[o,s,a,r,i,n]=e;switch(o){case"cr":const l=t[s].p;l&&(t[l].k=t[l].k.filter(e=>e!==s)),delete t[s];break;case"dl":const c=(t[s]=a).p,d=r;c&&(t[c].k||(t[c].k=[]),void 0!==d?t[c].k.splice(d,0,s):t[c].k.push(s));break;case"mv":const p=a,m=i,u=n,f=t[s];t[p].k=t[p].k.filter(e=>e!=s),t[f.p=m].k||(t[m].k=[]),t[m].k.splice(u,0,s);break;case"df":const g=a,h=t[s];h.et=commit.time,h.s=unapplyDif(h.s,g)}},doEditBlox=(e,t,o)=>{const[s,a,r,i,n]=e;switch(s){case"dl":const l=t[a].p;l&&(t[l].k=t[l].k.filter(e=>e!==a)),delete t[a];break;case"cr":t[a]={ct:o,s:""};const c=r,d=i;void 0!==c&&(t[a].p=c,void 0===t[c].k&&(t[c].k=[]),void 0===d?t[c].k.push(a):t[c].k.splice(d,0,a));break;case"mv":const p=r,m=i,u=n,f=t[a];t[u].k=t[u].k.filter(e=>e!=a),t[f.p=p].k||(t[p].k=[]),t[p].k.splice(m,0,a);break;case"df":const g=r,h=t[a];h.et=o,h.s=applyDif(h.s,g)}};let getProcessMemory;try{performance.memory.heapUsed,getProcessMemory=()=>performance.memory&&performance.memory.heapUsed}catch(e){process.memoryUsage().heapUsed,getProcessMemory=()=>process.memoryUsage().heapUsed}class LruCache{constructor(e,t=15e8){this.maxProcessMemory=t,this.fetcher=e,this.map=new Map}async get(e){const t=this.map.get(e);if(void 0!==t)return this.map.delete(e),this.map.set(e,t),t;{const o=await this.fetcher(e);if(o&&this.map.set(e,o),getProcessMemory()>this.maxProcessMemory)for(const s of this.map){this.map.delete(s[0]);break}return o}}}const promisify=s=>(...o)=>new Promise((e,t)=>s(...o,e)),intToBase64=t=>{if(void 0!==t){let e="";for(;0<t;)e=""+CHARS_64[t%64]+e,t=Math.floor(t/64);return e}},base64ToInt=t=>{let o=0;for(let e=0;e<t.length;e++)o+=CHARS_64.indexOf(t[e])*Math.pow(64,t.length-e-1);return o};try{exports.applyDif=applyDif,exports.unapplyDif=unapplyDif,exports.doEditBlox=doEditBlox,exports.undoEditBlox=undoEditBlox,exports.promisify=promisify,exports.LruCache=LruCache,exports.newUid=newUid,exports.newUUID=newUUID,exports.base64ToInt=base64ToInt,exports.intToBase64=intToBase64}catch(e){}const cpy=t=>{if("object"!=typeof t)return t;if(t instanceof Array)return t.map(cpy);{const o={};for(let e in t)o[e]=cpy(t[e]);return o}},monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"],getOrdinal=e=>{const t=e%10,o=e%100;return 1==t&&11!=o?e+"st":2==t&&12!=o?e+"nd":3==t&&13!=o?e+"rd":e+"th"},formatDate=e=>`${monthNames[e.getMonth()]} ${getOrdinal(e.getDate())}, ${e.getFullYear()}`,formatTime=e=>e.getHours()+":"+e.getMinutes(),unFormatDate=e=>{const t=e.match(/([a-zA-Z]+) ([0-9]{1,2})(?:st|nd|rd|th), ([0-9]{4})/);if(t&&monthNames.includes(t[1]))return new Date},formatDateYMD=e=>`${e.getFullYear()}-${formatInt(e.getMonth()+1,2)}-${formatInt(e.getDate(),2)}`,truncateElipsis=(e,t=40)=>e.length>t?e.substring(0,t-3)+"...":e,getTomorrowDateString=()=>formatDate(new Date(Date.now()+864e5)),getYesterdayDateString=()=>formatDate(new Date(Date.now()-864e5)),getLastWeekDateString=()=>{const e=new Date(Date.now());return e.setDate(e.getDate()-7),formatDate(e)},getNextWeekDateString=()=>{const e=new Date(Date.now());return e.setDate(e.getDate()+7),formatDate(e)},formatInt=(e,t)=>{const o=e.toString();return"0".repeat(t-o.length)+o},clamp=(e,t,o)=>Math.max(t,Math.min(e,o)),ustime=()=>{const e=Math.floor(1e3*(performance.timing.navigationStart+performance.now()));return console.log(e),e},pushToArrInObj=(e,t,o)=>{void 0===e[t]?e[t]=[o]:e[t].push(o)},canWriteBloc=e=>!0,isSynced=()=>user.s.commitId===user.s.syncCommitId,diff=(e,t)=>({d:t,i:e});let undoCommitList=[],undoCommitSessionStateList=[],undoCommitInProgress=[],masterCommitList=[],masterCommitInProgress=[];const undoEditCacheStuff=e=>{const[t,o,s]=e;switch(console.log(e),t){case"cr":void 0===s&&delete store.titles[s.s];break;case"df":setLinks(store,o);const a=store.blox[o];if(void 0===a.p){const r=applyDif(a.s,s);delete store.titles[r],store.titles[a.s]=o}}},undo=()=>{const t=undoCommitList.pop();sessionState=undoCommitSessionStateList.pop();for(let e=t.edits.length-1;0<=e;e--){const o=t.edits[e];undoEditBlox(o,store.blox),undoEditCacheStuff(o)}},doEditCacheStuff=(e,t=!1)=>{const[o,s,a]=e;switch(o){case"dl":a.p||delete store.titles[a.s];const r=store.forwardRefs[s];if(r)for(let e of r){const n=store.refs[e];1===n.length?delete store.refs[e]:store.refs[e]=n.filter(e=>e!=s)}store.refs[s];break;case"df":setLinks(store,s,t);const i=store.blox[s];if(void 0===i.p){const l=unapplyDif(i.s,a);if(delete store.titles[l],void 0!==store.titles[i.s])return void console.error(`duplicate block title ${i.s}`);store.titles[i.s]=s}}},doEdit=(...e)=>{const t=intToBase64(Date.now());undoCommitInProgress.push(e),masterCommitInProgress.push(e),print(e),doEditBlox(e,store.blox,t),doEditCacheStuff(e)},commit=()=>{const e=newUUID();undoCommitList.push({id:e,t:intToBase64(Date.now()),edits:undoCommitInProgress}),undoCommitSessionStateList.push(cpy(sessionState)),user.s.commitId=e,undoCommitInProgress=[],setTimeout(()=>{debouncedSaveStore(),saveUserJustLocalStorage()},0)},commitEdit=(...e)=>{doEdit(...e),commit()},saveStore=(e=!1)=>{const t=store.blox,o=JSON.stringify(t);let s="{";for(let e in store)"blox"!==e&&void 0!==store[e]&&(s+='"'+e+'":'+JSON.stringify(store[e])+",");s+='"blox":'+o+"}",saveStoreToBasicBitchServer(o,e),saveStoreStringLocal(s)},saveStoreIncremental=()=>{syncEditsWithBasicBitchServer(),saveStoreStringLocal(JSON.stringify(store))},saveStoreStringLocal=e=>{try{localStorage.setItem("store",e)}catch(e){localStorage.removeItem("store"),console.error(`Local Storage Failure: ${e}`)}const t=idb.transaction(["stores"],"readwrite"),o=t.objectStore("stores"),s=o.put({graphName:store.graphName,store:e});s.onsuccess=()=>{console.log("saved")},s.onerror=e=>{console.log("save error"),console.log(e)}};let saveStoreTimeout=null;const debouncedSaveStore=()=>{user.s.commitId!==user.s.syncCommitId&&(clearTimeout(saveStoreTimeout),saveStoreTimeout=setTimeout(saveStoreIncremental,300))},print=e=>{user.s.logging&&console.log(e)},mergeEdits=t=>{for(let e=0;e<t.length;e++)t[e]},macros={};macros.nocommit={copyBlock:(e,t,o)=>{const i=(e,t,o)=>{const s=newUid(),a=store.blox[e];if(doEdit("cr",s,t,o),doEdit("df",s,diff(a.s,"")),a.k)for(let e=0;e<a.k.length;e++){const r=a.k[e];i(r,s,e)}return s};return i(e,t,o)},delete:e=>{const t=store.blox[e];let o=void 0;t.p&&(o=store.blox[t.p].k.indexOf(e)),doEdit("dl",e,cpy(t),o)},write:(e,t)=>{doEdit("df",e,diff(t,store.blox[e].s))},writePageTitle:(t,o)=>{const s=store.blox[t].s;doEdit("df",t,diff(o,s));for(let e of store.refs[t]||[]){const a=store.blox[e],r=a.s,i=a.s.replaceAll(s,o);console.log(r),console.log(i),doEdit("df",e,diff(i,r))}},createPage:e=>{if(!store.titles[e]){console.log(`making page ${e}`);const t=newUid();return doEdit("cr",t),doEdit("df",t,diff(e,"")),t}console.error(`tried to create page that already exists ${e}`)},create:(e,t)=>{const o=newUid();return doEdit("cr",o,e,t),o},move:(e,t,o)=>{const s=store.blox[e];void 0===o&&(o=store.blox[t].k.length),doEdit("mv",e,t,o,s.p,store.blox[s.p].k.indexOf(e))}};for(let o in macros.nocommit)macros[o]=(...e)=>{const t=macros.nocommit[o](...e);return commit(),t};const blankStore=()=>({blox:{},titles:{},refs:{},forwardRefs:{},innerRefs:{},outerRefs:{},roamProps:{},ownerRoamId:void 0,graphName:void 0}),bloxProps=["s","p","ct","k","et","cu","eu"],gcPage=(e,t)=>{isPageEmpty(e,t)&&macros.nocommit.delete(t)},isPageEmpty=(e,t)=>{const o=e.blox[t];if(void 0!==e.refs[t]&&0<e.refs[t].length)return!1;if(o.k){if(1<o.k.length)return!1;if(0===o.k.length)return!0;const s=o.k[0];return isBlockEmpty(e,s)}return!0},isBlockEmpty=(e,t)=>{const o=e.blox[t];return""===o.s&&(void 0===o.k||0===o.k.length)},fixParents=()=>{for(let e in store.blox)delete store.blox[e].p;for(let t in store.blox){const o=store.blox[t];for(let e of o.k||[])store.blox[e].p=t}},fixDuplicatePages=()=>{const t={};for(let e in store.blox){const o=store.blox[e];o.p||pushToArrInObj(t,store.blox[e].s,e)}for(let e in t){const s=t[e];for(let t=1;t<s.length;t++){for(let e of store.blox[s[t]].k||[])macros.move(e,s[0]);macros.delete(s[t])}}},parseRegexJustLinks=/(\[\[)|(\]\])|#([\/a-zA-Z0-9_-]+)|\(\(([a-zA-Z0-9\-_]+)\)\)|(^[\/a-zA-Z0-9_-]+)::|`([^`]+)`|```/g,setLinks=(o,t,e=!1,s=!1)=>{for(let e of o.forwardRefs[t]||[])o.refs[e]=o.refs[e].filter(e=>e!==t),s||gcPage(o,e);const a=[];o.forwardRefs[t]=a;let r;r=e?e=>{e in o.refs?o.refs[e].push(t):o.refs[e]=[t],a.push(e)}:e=>{e in o.refs?o.refs[e].push(t):o.refs[e]=[t],a.push(e)};const i=e=>{let t=o.titles[e];void 0===t&&(t=macros.nocommit.createPage(e)),r(t)},n=o.blox[t],l=n.s,c=l.matchAll(parseRegexJustLinks);let d=0,p=void 0,m=[];for(let e of c){if(0===m.length||"cb"===p.t){if(e[1]){const u={t:"pr",s:""};m.push(u),p=m[m.length-1]}else if(e[3])i(e[3]);else if(e[5])i(e[5]);else if(e[4])void 0!==o.blox[e[4]]&&r(e[4]);else if(e[7])if(p&&"cb"===p.t)m.pop();else{const f={t:"cb",s:""};m.push(f),p=m[m.length-1]}}else if(p.s=p.s+l.substring(d,e.index),d=e.index,e[1]){const g={t:"pr",s:""};p.s=p.s+"[[",m.push(g),p=m[m.length-1]}else if(e[2]){let e="]]";"pr"===p.t&&(e=p.s+"]]",i([p.s]),m.pop(),p=m[m.length-1]),void 0!==p&&(p.s=p.s+e)}else if(e[3])i(e[3]),p.s=p.s+e[0];else if(e[5])p.s=p.s+e[0],i(e[5]);else if(e[4])void 0!==o.blox[e[4]]&&r(e[4]),p.s=p.s+e[0];else if(e[7])if(p&&"cb"===p.t)m.pop();else{const h={t:"cb",s:""};m.push(h),p=m[m.length-1]}else p.s=p.s+e[0];d=e.index+e[0].length}0===a.length&&delete o.forwardRefs[t]},generateRefs=t=>{const e=performance.now();t.refs={},t.forwardRefs={};for(let e in t.blox)setLinks(t,e);console.log(`gen refs took ${performance.now()-e}`)},mergeLists=(t,o)=>{for(let e of o)t.includes(e)||t.push(e)},arrSetDiff=(t,o)=>{let s=[],a=[];for(let e of t)o.includes(e)||s.push(e);for(let e of o)t.includes(e)||a.push(e);return{added:s,deleted:a}},propagateRefs=(e,t,o)=>{const{added:s}=arrSetDiff(t,o),a=store.blox[e];if(a.p){let e=a.p;for(;e;){const i=store.blox[e],n=store.forwardRefs[e];for(let e=0;e<s.length;e++){const l=s[e];n.includes(l)?(s[e]=s.pop(),--e):n.push(l)}e=i.p}}let r=a;do{r=store.blox[r.p];for(let e=0;e<s.length;e++);}while(r.p)},generateInnerRefs=()=>{performance.now();store.innerRefs={};for(let t in store.forwardRefs){const o=store.forwardRefs[t];let e=t;for(;e;)store.innerRefs[e]||(store.innerRefs[e]=[]),mergeLists(store.innerRefs[e],o),e=store.blox[e].p}},generateOuterRefs=()=>{performance.now();store.outerRefs={};for(let e in store.forwardRefs){const o=store.forwardRefs[e],s=t=>{store.outerRefs[t]||(store.outerRefs[t]=[]),mergeLists(store.outerRefs[t],o);for(let e of store.blox[t].k||[])s(e)};s(e)}},generateInnerOuterRefs=()=>{generateInnerRefs(),generateOuterRefs()},mergeStore=r=>{const i={};for(let e in r.blox){const t=r.blox[e];store.titles[t.s]?store.blox[e]&&(i[e]=newUid()):i[e]=store.titles[t.s]}const n=(e,t)=>{const o=i[e]||e,s=r.blox[e],a={...s};if(store.blox[o]=a,a.p=t,s.k){a.k=[];for(let t of s.k){let e=i[t]||t;n(t,o),a.k.push(e)}}};for(let e in r.titles){const o=r.titles[e],s=r.blox[o];if(void 0===store.titles[s.s]){const a=i(o)||o,l={...s};if(store.blox[a]=l,store.titles[s.s]=a,s.k){l.k=[];for(let e of kids){const c=getNewId(e);n(e,a),l.k.push(c)}}}else if(s.k){const d=store.titles[s.s],p=store.blox[d];p.k||(p.k=[]);for(let e of s.k){const m=i[e]||e;n(e,d),p.k.push(m)}}}},escapeRegex=e=>e.replaceAll(/([\[\]\(\)])/g,"\\$1").replaceAll("\\\\",""),newSearchRegex=e=>new RegExp(escapeRegex(e),"i"),searchRefCountWeight=.05,pageOverBlockWeight=1;let titleExactFullTextSearchCache=[];const titleExactFullTextSearch=e=>{const t=newSearchRegex(e);titleExactFullTextSearchCache=[];for(let e in store.titles){const o=store.titles[e],s=(store.blox[o],e.match(t));s&&titleExactFullTextSearchCache.push({title:e,id:o,idx:s.index-(store.refs[o]?store.refs[o].length:0)*searchRefCountWeight})}return titleExactFullTextSearchCache.sort((e,t)=>e.idx-t.idx),titleExactFullTextSearchCache};let exactFullTextSearchCache=[];const exactFullTextSearch=t=>{const o=newSearchRegex(t);exactFullTextSearchCache=[];for(let e in store.blox){const s=store.blox[e],t=s.s,a=t.match(o);if(a){const r={id:e,idx:a.index-(store.refs[e]?store.refs[e].length:0)*searchRefCountWeight-(void 0===s.p)*pageOverBlockWeight};s.p?r.string=s.s:r.title=s.s,exactFullTextSearchCache.push(r)}}return exactFullTextSearchCache.sort((e,t)=>e.idx-t.idx),exactFullTextSearchCache};let templateSearchCache=[];const searchTemplates=e=>{const t=store.titles["roam/templates"],o=store.blox[t];templateSearchCache=[];let s;try{s=newSearchRegex(e)}catch{return templateSearchCache}if(o){const a=e=>{const t=store.blox[e];console.log(t.s);const o=t.s.match(s);console.log(o),o&&templateSearchCache.push({id:e,string:t.s,idx:o.idx})};if(store.refs[t])for(let e of store.refs[t])a(e);if(store.blox[t].k)for(let e of store.blox[t].k)a(e);console.log(templateSearchCache),templateSearchCache=templateSearchCache.sort((e,t)=>t.idx-e.idx),console.log(templateSearchCache)}return templateSearchCache},generateTitles=t=>{t.titles={};for(let e in t.blox){const o=t.blox[e];void 0===o.p&&(t.titles[o.s]=e)}},hydrateFromBlox=(e,t)=>{console.log("hydratefromblox");let o=blankStore();return o.blox=t,o.graphName=e,generateTitles(o),generateRefs(o),o},sortByLastEdited=e=>{e.sort((e,t)=>store.blox[e].et>store.blox[t].et?-1:1)},createAndSwitchToNewStore=async e=>{store=blankStore(),store.graphName=e,user.s.graphName=e,user.s.commitId="MYVERYFIRSTCOMMITEVER",saveUser(),await addGraph(),saveStore(),window.location.href=window.location.href},prepFocusIdForCursor=()=>{if(focusBlock&&focusBlock.isConnected&&focusBlock.dataset.id!==sessionState.focusId&&(focusBlockBody.textContent="",renderBlockBody(focusBlockBody,store.blox[focusBlock.dataset.id].s)),focusBlock=document.querySelector(`.block[data-id="${sessionState.focusId}"]`),focusBlockBody=focusBlock.children[1],void 0===focusBlock)throw new Error(`tried to focus block that doesn't exist: ${sessionState.focusId}`);sessionState.isFocused=!0;const e=store.blox[sessionState.focusId].s;focusBlockBody.innerText="",renderBlockBody(focusBlockBody,e,!0)},focusIdPosition=()=>{prepFocusIdForCursor();const a=t=>{for(let e of t.childNodes)if("#text"===e.nodeName){if(sessionState.position>=(e.startIdx||0)&&sessionState.position<=(e.startIdx||0)+e.textContent.length){scanResult=e;const o=sessionState.position-e.startIdx;return getSelection().collapse(e,o),e}}else{const s=a(e);if(s)return s}};a(focusBlockBody),updateCursorSpanInfo()},selectIdWholeNode=e=>{prepFocusIdForCursor(),updateCursorSpanInfo()},setFocusedBlockString=(e,t)=>{let o=e;void 0===o&&(o=store.blox[sessionState.focusId].s),void 0!==t?commitEdit("df",sessionState.focusId,t):macros.write(sessionState.focusId,o),focusIdPosition()},getEditingSimpleSpan=e=>{const t=focusBlockBody.querySelectorAll("."+e);for(let e of t)if(e.childNodes[0].endIdx>=sessionState.position&&e.childNodes[0].startIdx<sessionState.position)return e},updateCursorPosition=()=>{focusNode=getSelection().focusNode,focusOffset=getSelection().focusOffset;const e=focusNode.parentNode.closest(".block");sessionState.focusId=e.dataset.id,sessionState.position=(focusNode.startIdx||0)+focusOffset},updateCursorSpanInfo=()=>{editingLink=void 0;const t=focusBlockBody.querySelectorAll(".page-ref"),o=focusBlockBody.querySelectorAll(".tag");for(let e of o)e.childNodes[0].endIdx>=sessionState.position&&e.childNodes[0].startIdx<sessionState.position&&(editingLink=e);for(let e of t)e.children[1].childNodes[0].endIdx>=sessionState.position&&e.children[1].childNodes[0].startIdx<sessionState.position&&(editingLink=e);editingTitle=editingLink&&("tag"===editingLink.className&&editingLink.innerText.substring(1)||"page-ref"===editingLink.className&&editingLink.children[1].innerText),editingTemplateExpander=getEditingSimpleSpan("template-expander"),editingUrlElement=getEditingSimpleSpan("url"),editingCommandElement=getEditingSimpleSpan("command"),void 0===editingCommandElement&&(inlineCommandList.style.display="none"),void 0===editingTemplateExpander&&(templateList.style.display="none"),void 0===editingLink&&(autocompleteList.style.display="none")},focusBlockEnd=e=>{sessionState.focusId=e.dataset.id,sessionState.position=store.blox[sessionState.focusId].s.length,focusIdPosition()},focusBlockStart=e=>{sessionState.focusId=e.dataset.id,sessionState.position=0,focusIdPosition()},focusBlockVerticalOffset=(e,t=focusBlock,o=!1)=>{const s=Array.from(document.querySelectorAll(".block")),a=s[s.indexOf(t)+e];a&&(a.scrollIntoView(!1),(o?focusBlockStart:focusBlockEnd)(a))},getChildren=e=>("block"===e.className?e.children[2]:e.children[1]).children,getPageTitleOfNode=e=>{const t=e.closest(".tag");if(t)return t.title;const o=e.closest(".attribute");if(o)return o.title;const s=e.closest(".page-ref");return s?s.children[1].innerText:void 0},renderPage=(e,t,o=!0)=>{const s=store.blox[t],a=pageTemplate.cloneNode(!0),r=a.firstElementChild,i=a.children[1];if(i.dataset.id=t,a.dataset.id=t,void 0===s.s)throw new Error(`error with page id ${t}`);r.innerText=s.s;let n=s.k;if(!n||0===n.length){const c=newUid();commitEdit("cr",c,t,0),n=s.k}for(let e of n)renderBlock(i,e);const l=store.refs[t];if(o&&l&&0<l.length){const d=backrefListTemplate.cloneNode(!0);a.children[2].appendChild(d),renderBackrefs(d.children[1],l)}return e.appendChild(a),a},renderBackrefs=(t,o)=>{sortByLastEdited(o);for(let e of o){const s=backrefFrameTemplate.cloneNode(!0);renderBreadcrumb(s.children[0],e),renderBlock(s.children[1],e),t.appendChild(s)}},renderBlock=(e,t,o)=>{const s=blockTemplate.cloneNode(!0),a=s.children[1],r=s.children[2];s.dataset.id=t,r.dataset.id=t,a.dataset.id=t;const i=store.blox[t].s;renderBlockBody(a,i);const n=store.blox[t].k;for(let e of n||[])renderBlock(r,e);return void 0!==o&&e.children.length>=o?e.insertBefore(s,e.children[o]):e.appendChild(s),s},renderBreadcrumb=(t,e)=>{e=store.blox[e].p;const o=[];for(;void 0!==e;){const s=store.blox[e];void 0!==s.p?o.push({string:s.s,id:e}):o.push({title:s.s,id:e}),e=s.p}if(0<o.length){const a=breadcrumbPageTemplate.cloneNode(!0),r=o[o.length-1].title;renderBlockBody(a,r),a.dataset.title=r,t.appendChild(a);for(let e=o.length-2;0<=e;e--){const i=breadcrumbBlockTemplate.cloneNode(!0),n=i.children[1];renderBlockBody(n,o[e].string),i.dataset.id=o[e].id,t.appendChild(i)}}},renderResultSet=(e,t,o,s=0)=>{if(0===t.length)return o.style.display="none",void(focusSuggestion=null);const a=getTemp(o.dataset.templateName);o.innerHTML="",o.style.display="block";const r=e.getBoundingClientRect();o.style.top=r.bottom,o.style.left=r.left,o.dataset.resultStartIdx=s;const i=Math.min(t.length,s+SEARCH_RESULT_LENGTH);for(let e=s;e<i;e++){matchingTitle=t[e];const n=a.cloneNode(!0);e==s&&(focusSuggestion=n,n.dataset.selected="true"),n.dataset.id=matchingTitle.id,matchingTitle.title?(n.dataset.title=matchingTitle.title,n.innerText=truncateElipsis(matchingTitle.title,50)):(n.dataset.string=matchingTitle.string,n.innerText=truncateElipsis(matchingTitle.string,50)),o.appendChild(n)}},notifyText=(e,t)=>{const o=notificationTemplate.cloneNode(!0);o.innerText=e,appElement.appendChild(o),setTimeout(()=>o.style.top="60px",50);const s=t&&1e3*t||5e3;setTimeout(()=>o.style.opacity="0",s),setTimeout(()=>{o.remove()},s+300)},parseRegex=/(\[\[(?:[a-z]+:)?)|(\]\])|(or)|\(\(([a-zA-Z0-9\-_]+)\)\)|(\*\*)|(\^\^)|(__)|((?:https?\:\/\/)(?:[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6})\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/\/=]*))|`([^`]+)`|;;([^ \n\r]+)|(and)|(```)|(\/[ a-zA-Z]*)|!\[([^\]]*)\]\(((?:https?\:\/\/)(?:[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6})\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/\/=]*))\)|({{)|(}})|#([a-z]+:)?([\/a-zA-Z0-9_-]+)|^([a-z]+:)?([ \/a-zA-Z0-9_-]+)::/g,renderBlockBody=(e,t,o=!1)=>{e.dataset.editmode=o;const s=[e],a=t.matchAll(parseRegex);let r=0,i=e,n=null;const l=e=>(n=document.createTextNode(e),n.startIdx=r,n.endIdx=r+e.length,n);for(let e of a){if(i.appendChild(l(t.substring(r,e.index))),r=e.index,void 0!==e[1]){const c=pageRefTemplate.cloneNode(!0);c.startIdx=r+2,i.appendChild(c),i.graphName=e[1],o&&c.children[0].appendChild(l(e[0])),s.push(c.children[1]),i=s[s.length-1]}else if(void 0!==e[2])if("page-ref__body"===i.className)i.parentNode.endIdx=r,o&&i.parentNode.children[2].appendChild(l("]]")),s.pop(),i=s[s.length-1],n.endIdx+=2;else{const d=document.createElement("span");o&&(d.className="page-ref-close-missing-open"),d.appendChild(l("]]")),i.appendChild(d)}else if(void 0!==e[3]){const p=document.createElement("span");p.className="compute-or",p.appendChild(l("or")),i.appendChild(p)}else if(void 0!==e[4])if(o){const m=document.createElement("span");m.className="block-ref-editing",m.appendChild(l(e[0])),i.appendChild(m)}else{const u=e[4],f=store.blox[u];if(f){const g=document.createElement("span");g.className="block-ref",g.innerText=f.s,g.dataset.id=u,i.appendChild(g)}else i.appendChild(l(e[0]))}else if(void 0!==e[5])if("bold"===i.className)o&&i.appendChild(l("**")),s.pop(),i=s[s.length-1],n.endIdx+=2;else{const h=document.createElement("span");h.className="bold",i.appendChild(h),o&&h.appendChild(l("**")),s.push(h),i=h}else if(void 0!==e[6])if("highlight"===i.className)o&&i.appendChild(l("^^")),s.pop(),i=s[s.length-1],n.endIdx+=2;else{const b=document.createElement("span");b.className="highlight",i.appendChild(b),o&&b.appendChild(l("^^")),s.push(b),i=b}else if(void 0!==e[7])if("italic"===i.className)o&&i.appendChild(l("__")),s.pop(),i=s[s.length-1],n.endIdx+=2;else{const y=document.createElement("span");y.className="italic",o&&y.appendChild(l("__")),i.appendChild(y),s.push(y),i=y}else if(void 0!==e[8]){const v=document.createElement("span");v.className="url",v.appendChild(l(e[0])),v.href=e[8],i.appendChild(v)}else if(void 0!==e[9]){const S=document.createElement("span");S.className="literal",o?S.appendChild(l(e[0])):S.appendChild(l(e[9])),i.appendChild(S)}else if(void 0!==e[10]){const x=document.createElement("span");x.className="template-expander",x.appendChild(l(e[0])),i.appendChild(x)}else if(void 0!==e[11]){const k=document.createElement("span");k.className="compute-and",k.appendChild(l("and")),i.appendChild(k)}else if(void 0!==e[12])if("code-block"===i.className)o&&i.appendChild(l("```")),s.pop(),i=s[s.length-1];else{const B=document.createElement("div");B.className="code-block",i.appendChild(B),s.push(B),i=B,o&&i.appendChild(l("```"))}else if(void 0!==e[13]){const w=document.createElement("span");w.className="command",w.appendChild(l(e[0])),i.appendChild(w)}else if(void 0!==e[14]&&void 0!==e[15])if(o){const C=document.createElement("span");C.className="image-full-text",C.appendChild(l(e[0])),i.appendChild(C)}else{const T=imageEmbedTemplate.cloneNode(!0);T.alt=e[14],T.src=e[15],i.appendChild(T)}else if(void 0!==e[16]){const I=computeFailedTemplate.cloneNode(!0);I.startIdx=r+2,i.appendChild(I),I.children[0].appendChild(l("{{")),s.push(I.children[1]),i=s[s.length-1]}else if(void 0!==e[17])if("compute-failed__body"===i.className){const E=i.parentNode;E.endIdx=r,E.text=t.substring(E.startIdx,E.endIdx),E.children[2].appendChild(l("}}")),transformComputeElement(E,o),s.pop(),i=s[s.length-1],n.endIdx+=2}else{const N=document.createElement("span");N.appendChild(l("}}")),i.appendChild(N)}else if(void 0!==e[19]){const _=document.createElement("span");_.className="tag",_.graphName=e[18],_.title=e[19],_.appendChild(l(e[0])),i.appendChild(_)}else if(void 0!==e[21]){const L=document.createElement("span");L.className="attribute",L.graphName=e[20],L.title=e[21],L.appendChild(l(e[0])),i.appendChild(L)}r=e.index+e[0].length}for(s[s.length-1].appendChild(l(t.substring(r)));i!==e;)"page-ref"===i.className&&(i.children[0].className=i.children[0].className+"-incomplete"),i.className=i.className+"-incomplete",i=i.parentNode},queryOperationOrder={root:0,"compute-or":1,"compute-and":2,page:3},transformComputeElement=(s,e)=>{const a=s.children[1].children;if(0!==a.length){const t=a[0],r=getPageTitleOfNode(t);if(void 0!==r){switch(r){case"TODO":if(e)return;{s.textContent="";const p=todoCheckboxTemplate.cloneNode(!0);s.appendChild(p)}break;case"DONE":if(e)return;{s.textContent="";const m=todoCheckboxTemplate.cloneNode(!0);m.checked=!0,s.appendChild(m)}break;case"video":if(e||user.s.noVideo)return;if(2!==a.length)return;if("url"===a[1].className){const u=videoEmbedTemplate.cloneNode(!0);u.src=youtubeLinkToEmbed(a[1].innerText),s.textContent="",s.appendChild(u)}break;case"query":let t={op:"root"},o=t;for(let e=1;e<a.length;e++){const f={},s=a[e],g=getPageTitleOfNode(s);if(g){if(f.title=g,f.op="page",void 0===o.l)o.l=f;else{if(void 0!==o.r)return void console.error("page ref with no operator");o.r=f}f.p=o,o=f}else{const h=queryOperationOrder[s.className];if(void 0!==h){f.op=s.className;let e=void 0;for(;queryOperationOrder[o.op]>h;)e=o,o=o.p;f.l=e,void 0!==e&&(e.p=f),o.l===e?o.l=f:o.r=f,f.p=o,o=f}}}t=t.l;performance.now();const i={};for(let e of store.refs[store.titles.query])i[e]=1;const n=[];for(let e in queryAstObjectSetStrategy(t))void 0===i[e]&&void 0!==store.blox[e]&&n.push(e);const l=queryFrameTemplate.cloneNode(!0);renderBackrefs(l,n);const c=s.closest(".block"),d=c.querySelector(".query-frame");return d&&d.remove(),void c.appendChild(l);default:return}s.className="compute"}}},queryAstArrayStrategy=e=>{if(void 0===e)return[];let t=queryAstArrayStrategy(e.r),o=queryAstArrayStrategy(e.l);switch(e.op){case"compute-and":const s=[];for(let e of t)o.includes(e)&&s.push(e);return s;case"compute-or":for(let e of t)o.push(e);return o;case"page":return[...store.refs[store.titles[e.title]]||[]]}},queryAstObjectSetStrategy=e=>{if(void 0===e)return{};let t=queryAstObjectSetStrategy(e.r),o=queryAstObjectSetStrategy(e.l),s={};switch(e.op){case"compute-and":for(let e in t)1===o[e]&&(s[e]=1);return s;case"compute-or":for(let e in t)o[e]=1;return o;case"page":const a=store.refs[store.titles[e.title]];for(let e of a)s[e]=1;return s}},idOfYoutubeURL=e=>{const t=e.match(/^https:\/\/www\.youtube.com\/watch\?v=([a-zA-Z0-9]+)(&t=.+)?$/);if(t)return t[1]},embedLinkOfYoutubeId=e=>`https://www.youtube.com/embed/${e}`,youtubeLinkToEmbed=e=>embedLinkOfYoutubeId(idOfYoutubeURL(e)),reset=()=>{localStorage.clear();indexedDB.deleteDatabase("microroam");window.location.href=window.location.href},syncEditsWithBasicBitchServer=async()=>{if(0!==masterCommitInProgress.length){const e=new Headers;e.set("h",user.h);const t=newUUID(),o={id:t,t:intToBase64(Date.now()),edits:masterCommitInProgress};masterCommitInProgress=[],e.set("body",JSON.stringify(o)),e.set("synccommitid",user.s.syncCommitId);const s=await fetch(`${basicBitchServerUrl}/edit/${store.graphName}`,{headers:e});200===s.status?(user.s.syncCommitId=t,masterCommitList.push(o)):409===s.status?(console.log("conflicting edit"),invalidateLocal()):masterCommitInProgress=[...o.edits,...masterCommitInProgress]}},saveStoreToBasicBitchServer=async(e,t=!1)=>{const o=performance.now(),s=new Headers;s.set("h",user.h);const a=user.s.commitId;s.set("commitid",a),s.set("synccommitid",user.s.syncCommitId),t&&s.set("force","true");const r=await fetch(`${basicBitchServerUrl}/put/${store.graphName}`,{method:"POST",body:e,headers:s});200===r.status||304===r.status?(user.s.syncCommitId=a,console.log(`save confirmed in ${performance.now()-o}`)):console.warn("failed to save to server")},getBloxFromBasicBitchServer=async e=>{const t=performance.now(),o=await fetch(`${basicBitchServerUrl}/get/${e}`,{headers:{passwordHash:user.h}});if(200===reponse.status){const s=await o.json();return console.log(`got in ${performance.now()-t}`),s}console.warn("failed to get store")},addOtherStore=async e=>{const t=await getBloxFromBasicBitchServer(e),o=hydrateFromBlox(t);otherStores[e]=o},saveSettingsToBasicBitchServer=async()=>{const e=new Headers;e.set("h",user.h),e.set("body",JSON.stringify(user.s));const t=await fetch(`${basicBitchServerUrl}/settings`,{headers:e});200!==t.status&&console.log("failed to save settings")},middlePepper="76pCgT0lW6ES9yjt01MeH",beginPepper="CeoPPOv9rIq6O7YiYlSFX",endPepper="Rzw1dagomQGpoo2s7iGE3lYL2yruaJDGrUk6bFCvz",hashPassword=async(e,t)=>{const o=`${beginPepper}${e}${middlePepper}${t}${endPepper}`,s=textEncoder.encode(o),a=await crypto.subtle.digest("SHA-512",s),r=new Uint8Array(a);let i="";for(let e=0;e<r.length;e++)i+=String.fromCharCode(r[e]);return i=btoa(i),i=i.replaceAll("/","-").replaceAll("+","_").replaceAll("=",""),i};loginForm.addEventListener("submit",async e=>{e.preventDefault();const t=loginEmailElement.value;loginEmailElement.value="";const o=loginPasswordElement.value;loginPasswordElement.value="";const s=await hashPassword(o,t),a=await fetch(`${basicBitchServerUrl}/auth`,{method:"POST",headers:{h:s}});200===a.status?(user=await a.json(),saveUser(),invalidateLocal(),console.log(user)):notifyText("Don't know that username + password.")}),signupForm.addEventListener("submit",async e=>{e.preventDefault();const t=signupEmailElement.value;signupEmailElement.value="";const o=signupUsernameElement.value;signupUsernameElement.value="";const s=signupPasswordElement.value;signupPasswordElement.value="";const a=await hashPassword(s,t),r=JSON.stringify({h:a,u:o,e:t,s:user.s});console.log(r);const i=new Headers;i.set("body",r);const n=await fetch(`${basicBitchServerUrl}/signup`,{method:"POST",headers:i});if(200===n.status)console.log(n),user=await n.json(),saveUser(),invalidateLocal(),console.log("signed up");else{const l=await n.json();notifyText(l)}});const addGraph=async()=>{const e=new Headers;e.set("h",user.h),e.set("commitid",user.s.commitId);const t=user.s.commitId,o=await fetch(`${basicBitchServerUrl}/creategraph/${store.graphName}`,{headers:e,method:"POST",body:JSON.stringify(store.blox)});o.ok?user.s.syncCommitId=t:notifyText("failed to add graph")},initialDailyNotes=5,renderSessionState=()=>{switch(searchResultList.style.display="none",pageFrameOuter.removeEventListener("scroll",dailyNotesInfiniteScrollListener),pageFrame.innerHTML="",searchInput.value="",sessionState.pageFrame){case"pageTitle":let e=store.titles[sessionState.page];void 0===e&&(e=macros.createPage(sessionState.page)),renderPage(pageFrame,e);break;case"block":const s=blockFocusFrameTemplate.cloneNode(!0);pageFrame.appendChild(s),renderBreadcrumb(s.children[0],sessionState.block),renderBlock(s.children[1],sessionState.block);const a=store.refs[sessionState.block];if(a){a.sort((e,t)=>store.blox[t].et-store.blox[e].et);const r=backrefListTemplate.cloneNode(!0);s.children[2].appendChild(r);for(let e of a)renderBlock(r.children[1],e)}break;case"dailyNotes":pageFrameOuter.addEventListener("scroll",dailyNotesInfiniteScrollListener),sessionState.oldestDate=new Date(Date.now());let t=0;console.log(store.titles);let o=formatDate(sessionState.oldestDate);generateTitles(store),store.titles[o]||(console.log(`creating page ${o}`),macros.createPage(o));for(let e=0;e<1e3;e++){const i=store.titles[o];if(i){renderPage(pageFrame,i);const n=document.createElement("div");if(n.className="page-break",pageFrame.appendChild(n),t+=1,t>=initialDailyNotes)break}sessionState.oldestDate.setDate(sessionState.oldestDate.getDate()-1),o=formatDate(sessionState.oldestDate)}t<initialDailyNotes&&pageFrame.lastChild.remove()}if(sessionState.isFocused&&pageFrame.querySelector(`.block[data-id="${sessionState.focusId}"]`))console.log(`SESSION STATE ALREADY FOCUSED ON ${sessionState.focusId}`);else{const e=pageFrame.querySelector(".block");sessionState.position=0,sessionState.focusId=e.dataset.id}focusIdPosition(),pageFrameOuter.scrollTop=sessionState.scroll||0},gotoNoHistory=(e,...t)=>{switch(e){case"dailyNotes":sessionState.pageFrame="dailyNotes";break;case"pageTitle":sessionState.pageFrame="pageTitle",sessionState.page=t[0];break;case"block":sessionState.pageFrame="block",sessionState.block=t[0]}renderSessionState()},goto=(...e)=>{sessionState.scroll=pageFrameOuter.scrollTop;const t=JSON.parse(JSON.stringify(sessionState));sessionState.isFocused=!1,sessionState.scroll=0,gotoNoHistory(...e),setTimeout(()=>{history.replaceState(t,"Micro Roam"),history.pushState(sessionState,"Micro Roam")},0)},gotoReplaceHistory=(...e)=>{gotoNoHistory(...e),history.replaceState(sessionState,"Micro Roam")};window.addEventListener("popstate",e=>{console.log(e.state),e.state&&(sessionState=e.state,renderSessionState())});const dailyNotesInfiniteScrollListener=()=>{const e=pageFrame.getBoundingClientRect().bottom-innerHeight;if(e<700)for(let e=0;e<100;e++){sessionState.oldestDate.setDate(sessionState.oldestDate.getDate()-1);const t=store.titles[formatDate(sessionState.oldestDate)];if(t){renderPage(pageFrame,t);const o=document.createElement("div");o.className="page-break",pageFrame.appendChild(o);break}}},parseStackTrace=e=>{const t=[],o=e.matchAll(/([^ ]+) \(([^\)]+):([0-9]+):([0-9]+)\)(?:\n|$)/g);for(let e of o)t.push({function:e[1],file:e[2],line:e[3],column:e[4]});return t},logError=(e,t,o,s,a)=>{const r={line:o,file:t,stack:parseStackTrace(a.stack),message:e,column:s},i=localStorage.getItem("error_log");if(i){const n=JSON.parse(i);n.push(r),localStorage.setItem("error_log",JSON.stringify(n))}else localStorage.setItem("error_log",JSON.stringify([r]));return!1};window.onerror=logError;const showTopBar=()=>{topBar.style.marginTop="0px",topBarHiddenHitbox.style.display="none"},hideTopBar=()=>{topBar.style.marginTop="-36px",topBarHiddenHitbox.style.display="block"},saveUser=()=>{document.body.className=user.s.theme,("visible"===user.s.topBar?showTopBar:hideTopBar)(),document.body.spellcheck=user.s.spellcheck,document.body.dataset.editingspotlight=user.s.editingSpotlight,user.h?(topButtons["Sign Out"].style.display="block",topButtons["Sign Up"].style.display="none",topButtons.Login.style.display="none"):(topButtons["Sign Out"].style.display="none",topButtons["Sign Up"].style.display="block",topButtons.Login.style.display="block"),saveUserJustLocalStorage(),saveSettingsToBasicBitchServer()},saveUserJustLocalStorage=()=>{localStorage.setItem("user",JSON.stringify(user))};dataLoaded&&start(),scriptsLoaded=!0;const ptest=()=>{const e=performance.now();for(let e=0;e<100;e++)generateInnerOuterRefs();const t=performance.now()-e;console.log(`thing took ${t}`)}</script><script async>const downloadHandler=()=>{console.log("download");const e=storeToRoamJSON(store),t=new Blob([e],{type:"text/json"}),o=URL.createObjectURL(t),n=document.createElement("a");n.setAttribute("href",o),n.setAttribute("download",`${store.graphName}-${formatDateYMD(new Date(Date.now()))}.json`),n.click()},downloadMd=()=>{console.log("download md");const e=storeToMdZip(),t=URL.createObjectURL(e),o=document.createElement("a");o.setAttribute("href",t),o.setAttribute("download",`${store.graphName}-md-${formatDateYMD(new Date(Date.now()))}.zip`),o.click()},expandTemplate=()=>{const e=focusSuggestion.dataset.id,t=store.blox[sessionState.focusId];if(void 0===t.k||0===t.k.length){const o=store.blox[sessionState.focusId].p,n=store.blox[e].k,s=store.blox[o].k.indexOf(sessionState.focusId);macros.nocommit.delete(sessionState.focusId,!1);const r=focusBlock.parentNode;focusBlock.remove();for(let e=0;e<n.length;e++){const a=n[e],l=s+e,i=macros.nocommit.copyBlock(a,o,l),c=renderBlock(r,i,l);0===e&&focusBlockEnd(c)}commit()}else notifyText("can't use a template inside a block that has children");templateList.style.display="none"},pasteBlocks=()=>{const e=store.blox[sessionState.focusId],o=e.p;let n=store.blox[o].k.indexOf(sessionState.focusId);const s=focusBlock.parentNode;if(""===focusBlockBody.innerText?(macros.nocommit.delete(sessionState.focusId),focusBlock.remove()):n+=1,clipboardData.dragSelect.rooted){const t=macros.nocommit.copyBlock(clipboardData.dragSelect.root,o,n),r=renderBlock(s,t,n);focusBlockEnd(r)}else{let t=null;for(let e=0;e<clipboardData.dragSelect.endIdx+1-clipboardData.dragSelect.startIdx;e++){const a=store.blox[clipboardData.dragSelect.root].k[e+clipboardData.dragSelect.startIdx],l=macros.nocommit.copyBlock(a,o,e+n),i=renderBlock(s,l,e+n);t=i}focusBlockEnd(t)}commit()},autocomplete=()=>{const e=store.blox[sessionState.focusId].s;if("tag"===editingLink.className){const t=editingLink.childNodes[0];if(/[^\/a-zA-Z0-9_-]/.test(focusSuggestion.dataset.title)){const o=e.slice(0,t.startIdx)+"[["+focusSuggestion.dataset.title+"]]"+e.slice(t.endIdx);sessionState.position=t.startIdx+focusSuggestion.dataset.title.length+4,setFocusedBlockString(o)}else{const n=e.slice(0,t.startIdx)+"#"+focusSuggestion.dataset.title+e.slice(t.endIdx);sessionState.position=t.startIdx+focusSuggestion.dataset.title.length+1,setFocusedBlockString(n)}}else{const s=editingLink.children[1].childNodes[0],r=e.slice(0,s.startIdx)+focusSuggestion.dataset.title+e.slice(s.endIdx);console.log(r),sessionState.position=s.startIdx+focusSuggestion.dataset.title.length+2,setFocusedBlockString(r)}autocompleteList.style.display="none"},indentFocusedBlock=()=>{const e=sessionState.focusId,t=focusBlock.previousElementSibling;if(t&&t.dataset&&t.dataset.id){const o=t.dataset.id;console.log(o);const n=store.blox[o].k&&store.blox[o].k.length||0;macros.move(e,o,n),t.children[2].appendChild(focusBlock),getSelection().collapse(focusNode,focusOffset)}},dedentFocusedBlock=()=>{const e=sessionState.focusId,t=store.blox[e].p,o=store.blox[t];if(o){const n=o.p,s=store.blox[n].k.indexOf(t);macros.move(e,n,s+1);const r=focusBlock.parentNode.parentNode,a=r.parentNode,l=r.nextElementSibling;l?a.insertBefore(focusBlock,l):a.appendChild(focusBlock),getSelection().collapse(focusNode,focusOffset)}};document.addEventListener("input",n=>{if(sessionState.isFocused)if(updateCursorPosition()," "!==focusBlockBody.innerText&&""!==focusBlockBody.innerText){let e=focusBlockBody.innerText,o=null!==n.data&&1===n.data.length&&"insertText"===n.inputType;if(null!==n.data)if("["===n.data){const s=n.target.querySelectorAll(".page-ref-close-missing-open");let t=!1;for(let e of s)if(console.log(e),e.childNodes[0].startIdx>sessionState.position){t=!0;break}t||(e=e.substring(0,sessionState.position)+"]"+e.substring(sessionState.position),o=!1)}else"]"===n.data&&"]"===e[sessionState.position]&&(e=e.substring(0,sessionState.position-1)+e.substring(sessionState.position),o=!1);let t={d:store.blox[sessionState.focusId].s,i:e};if(o&&(t=sessionState.position===e.length?{i:n.data}:{i:n.data,s:sessionState.position-1}),setFocusedBlockString(e,t),editingCommandElement){const r=matchInlineCommand(editingCommandElement.innerText.substring(1));renderResultSet(editingCommandElement,r,inlineCommandList,0)}if(editingTitle){const a=titleExactFullTextSearch(editingTitle);renderResultSet(editingLink,a,autocompleteList,0)}if(editingTemplateExpander){const l=editingTemplateExpander.innerText.substring(2),i=searchTemplates(l);renderResultSet(editingTemplateExpander,i,templateList,0)}}else macros.write(sessionState.focusId,"");else if("search-input"===n.target.id){const e=exactFullTextSearch(n.target.value);renderResultSet(searchInput,e,searchResultList,0)}else if("page__title"===n.target.className){console.log("edit title");const t=n.target.parentNode.dataset.id;macros.writePageTitle(t,n.target.innerText)}});const globalHotkeys={"hide top bar":{key:"b",control:!0,fn:()=>{"0px"===topBar.style.marginTop?user.s.topBar="hidden":user.s.topBar="visible",saveUser()}},escape:{key:"Escape",fn:()=>{autocompleteList.style.display="none",templateList.style.display="none"}},upload:{key:"d",control:!0,fn:()=>{topButtons.Upload.click()}},download:{key:"s",control:!0,shift:!0,fn:downloadHandler},save:{key:"s",control:!0,fn:debouncedSaveStore},"toggle color theme":{key:"m",control:!0,fn:()=>{"light"===document.body.className?user.s.theme="dark":user.s.theme="light",saveUser()}},search:{key:"u",control:!0,fn:()=>{"0px"!==topBar.style.marginTop&&(topBar.style.marginTop="0px"),searchInput.focus()}},open:{key:"o",control:!0,fn:e=>{editingTitle?goto("pageTitle",editingTitle):editingUrlElement&&editingUrlElement.click()}},"daily notes":{key:"d",alt:!0,fn:()=>{goto("dailyNotes")}},undo:{key:"z",control:!0,fn:()=>{0<undoCommitList.length&&(undo(),renderSessionState())}},"delete block":{key:"k",control:!0,shift:!0,fn:()=>{const e=store.blox[sessionState.focusId];void 0===e.k||0===e.k.length?(focusBlock.remove(),focusBlockVerticalOffset(-1),macros.delete(sessionState.focusId)):notifyText('no "delete block" for blocks with children (at least right now)')}},terminal:{key:"i",control:!0,alt:!0,fn:()=>{"none"===terminalElement.style.display?(terminalElement.style.display="block",terminalElement.focus()):terminalElement.style.display="none"}},p:{key:"p",control:!0,fn:()=>{console.log("at least it wasn't print")}}};document.addEventListener("keydown",event=>{for(let hotkeyName in globalHotkeys){const hotkey=globalHotkeys[hotkeyName];if(event.key.toLowerCase()===hotkey.key&&event.shiftKey===!!hotkey.shift&&event.ctrlKey===!!hotkey.control&&event.altKey===!!hotkey.alt)return hotkey.fn(event),void event.preventDefault()}if(dragSelect){let did=!1;if(("c"===event.key||"x"===event.key)&&event.ctrlKey){let text="";console.log("copy blocks");const id=dragSelect.root.dataset.id;if(dragSelect.rooted)text=blocToMd(id);else{const kids=store.blox[id].k;for(let i=dragSelect.startIdx;i<dragSelect.endIdx+1;i++)text+=blocToMd(kids[i])}clipboardData={dragSelect:{root:id,startIdx:dragSelect.startIdx,endIdx:dragSelect.endIdx,rooted:dragSelect.rooted},text:text},console.log(clipboardData),navigator.clipboard.writeText(text),did=!0}if("Backspace"===event.key||"Delete"===event.key||"x"===event.key&&event.ctrlKey){if(console.log(dragSelect),dragSelect.rooted)focusBlockVerticalOffset(-1,dragSelect.root),macros.nocommit.delete(dragSelect.root.dataset.id),document.querySelectorAll(`.block[data-id="${dragSelect.root.dataset.id}"]`).forEach(e=>e.remove());else{const childNodes=getChildren(dragSelect.root);focusBlockVerticalOffset(-1,childNodes[dragSelect.startIdx]),console.log(`cnl ${childNodes.length} start ${dragSelect.startIdx} end ${dragSelect.endIdx}`);for(let i=dragSelect.endIdx;i>=dragSelect.startIdx;i--){const node=childNodes[i];macros.nocommit.delete(node.dataset.id),document.querySelectorAll(`.block[data-id="${node.dataset.id}"]`).forEach(e=>e.remove())}commit()}dragSelect=null,did=!0}did&&event.preventDefault()}else if("none"!==autocompleteList.style.display)"Enter"===event.key&&(autocomplete(),event.preventDefault()),updownythingey(editingLink,autocompleteList,titleExactFullTextSearchCache,focusSuggestion)&&event.preventDefault();else if("none"!==templateList.style.display)"Tab"!==event.key&&"Enter"!==event.key||(expandTemplate(),event.preventDefault()),updownythingey(editingTemplateExpander,templateList,templateSearchCache,focusSuggestion)&&event.preventDefault();else if("none"!==inlineCommandList.style.display)"Tab"!==event.key&&"Enter"!==event.key||(execInlineCommand(),event.preventDefault()),updownythingey(editingCommandElement,inlineCommandList,commandSearchCache,focusSuggestion)&&event.preventDefault();else if(sessionState.isFocused){let blocks,newActiveBlock;switch(event.key){case"Enter":if(!event.shiftKey){let idx=store.blox[store.blox[sessionState.focusId].p].k.indexOf(sessionState.focusId);event.ctrlKey||(idx+=1),console.log(idx);const newBlockUid=newUid();commitEdit("cr",newBlockUid,store.blox[sessionState.focusId].p,idx);const newBlockElement=renderBlock(focusBlock.parentNode,newBlockUid,idx);newBlockElement.children[1].focus(),event.preventDefault()}break;case"Tab":(event.shiftKey?dedentFocusedBlock:indentFocusedBlock)(),event.preventDefault();break;case"Backspace":if(0===sessionState.position){const parent=store.blox[store.blox[sessionState.focusId].p];if(void 0!==parent.p||1!==parent.k.length){const currentFocusBlock=focusBlock;focusBlockVerticalOffset(-1),macros.delete(currentFocusBlock.dataset.id),currentFocusBlock.remove(),event.preventDefault()}}break;case"ArrowDown":if(event.altKey&&event.shiftKey){const parentId=store.blox[sessionState.focusId].p,parentElement=focusBlock.parentNode,currentIdx=store.blox[parentId].k.indexOf(sessionState.focusId);focusBlock.nextElementSibling&&(macros.move(sessionState.focusId,parentId,currentIdx+1),focusBlock.nextElementSibling.nextElementSibling?parentElement.insertBefore(focusBlock,focusBlock.nextElementSibling.nextElementSibling):parentElement.appendChild(focusBlock),getSelection().collapse(focusNode,focusOffset),event.preventDefault())}else event.shiftKey||event.altKey||(focusBlockVerticalOffset(1),event.preventDefault());break;case"ArrowUp":if(event.altKey&&event.shiftKey){const parentId=store.blox[sessionState.focusId].p,parentElement=focusBlock.parentNode,currentIdx=store.blox[parentId].k.indexOf(sessionState.focusId);focusBlock.previousElementSibling&&(macros.move(sessionState.focusId,parentId,currentIdx-1),parentElement.insertBefore(focusBlock,focusBlock.previousElementSibling),getSelection().collapse(focusNode,focusOffset),event.preventDefault())}else event.shiftKey||event.altKey||(focusBlockVerticalOffset(-1),event.preventDefault());break;case"ArrowLeft":event.shiftKey&&event.altKey?dedentFocusedBlock():0===sessionState.position?(focusBlockVerticalOffset(-1),event.preventDefault()):--sessionState.position;break;case"ArrowRight":event.shiftKey&&event.altKey?indentFocusedBlock():sessionState.position===focusBlockBody.innerText.length?(focusBlockVerticalOffset(1,focusBlock,!0),event.preventDefault()):sessionState.position+=1;break;case"c":event.ctrlKey&&(clipboardData=null)}}if(document.activeElement&&"search-input"===document.activeElement.id){if("Enter"===event.key)return!event.ctrlKey&&focusSuggestion?focusSuggestion.dataset.title?goto("pageTitle",focusSuggestion.dataset.title):goto("block",focusSuggestion.dataset.id):goto("pageTitle",event.target.value),void event.preventDefault();const didUpDowny=updownythingey(searchInput,searchResultList,exactFullTextSearchCache,focusSuggestion);didUpDowny&&event.preventDefault()}if("none"!==terminalElement.style.display&&"Enter"===event.key&&!event.ctrlKey&&!event.shiftKey&&!event.altKey){const string=event.target.innerText,first=string.match(/^[a-z]+/);if(first&&terminalCommands[first[0]]){const fn=terminalCommands[first[0]];fn(string.substring(first[0].length)),event.preventDefault(),terminalElement.style.display="none",terminalElement.innerHTML=""}else try{eval(string),event.ctrlKey||(terminalElement.style.display="none",terminalElement.innerHTML="")}catch(error){console.log(error),event.preventDefault()}}print(sessionState)}),document.addEventListener("paste",e=>{if(console.log(e),clipboardData){const t=e.clipboardData.getData("text");t.replaceAll(/\r/g,"")==clipboardData.text?(pasteBlocks(),e.preventDefault()):clipboardData=void 0}});const updownythingey=(e,t,o,n)=>{const s="ArrowUp"===event.key||"Tab"===event.key&&event.shiftKey?-1:("ArrowDown"===event.key||"Tab"===event.key)&&1;if(s){const r=-1===s?n.previousElementSibling:n.nextElementSibling;if(r)r.dataset.selected="true",focusSuggestion=r,delete n.dataset.selected;else{const a=parseInt(t.dataset.resultStartIdx),l=clamp(a+s*SEARCH_RESULT_LENGTH,0,o.length-SEARCH_RESULT_LENGTH);renderResultSet(e,o,t,l),-1===s&&(delete t.firstElementChild.dataset.selected,t.lastElementChild.dataset.selected=!0)}return!0}};document.addEventListener("mousedown",t=>{const e=getPageTitleOfNode(t.target);if(e)goto("pageTitle",e);else{const o=t.target.closest(".block__bullet");if("search-result"!==t.target.className){"search-input"!==t.target.id&&(searchResultList.style.display="none");const n=t.target.closest(".breadcrumb-page"),s=t.target.closest(".breadcrumb-block");if(o)goto("block",o.parentNode.dataset.id);else if("block-ref"===t.target.className)goto("block",t.target.dataset.id);else if("url"===t.target.className){const r=document.createElement("a");r.target="_blank",r.href=t.target.innerText,r.click()}else if(t.target===topButtons.Download)downloadHandler();else if("template__suggestion"===t.target.className)focusSuggestion&&(focusSuggestion.dataset.selected=!1),t.target.dataset.selected=!0,focusSuggestion=t.target,expandTemplate();else if(t.target===topButtons.Upload)disconnectedFileInput.click();else if(t.target===topButtons["Daily Notes"])goto("dailyNotes");else if("autocomplete__suggestion"===t.target.className)focusSuggestion&&(focusSuggestion.dataset.selected=!1),t.target.dataset.selected=!0,autocomplete();else if(t.target===topButtons.Help)goto("pageTitle","Welcome to Micro Roam");else if(n)goto("pageTitle",n.dataset.title);else if(s)goto("block",s.dataset.id);else if("exit-to-main"==t.target.className)signupElement.style.display="none",loginElement.style.display="none";else if("command__suggestion"===t.target.className)execInlineCommand();else if("image-embed"===t.target.className)focusBlockStart(t.target.closest(".block")),t.preventDefault();else if("todo-checkbox"===t.target.className){const a=t.target.checked,l=a?"TODO":"DONE",i=t.target.closest(".block"),c=i.dataset.id,d=t.target.closest(".compute");let e=store.blox[c].s;e=e.substring(0,d.startIdx)+"[["+l+"]]"+e.substring(d.endIdx),macros.write(c,e);const u=t.target.closest(".block__body");u.textContent="",renderBlockBody(u,e),t.preventDefault()}else if(t.target.id="top-connect","none"===connectFrame.style.display){connectFrame.style.display="block";for(let e of otherStores);}else connectFrame.style.display="none"}else t.target.dataset.title?goto("pageTitle",t.target.dataset.title):goto("block",t.target.dataset.id)}});const commonAncestorNode=(e,t)=>{const o=[];for(;void 0!==e.dataset.id;)o.push(e.dataset.id),e=e.parentNode.parentNode;const n=[];for(;void 0!==t.dataset.id;){if(n.push(t.dataset.id),-1!==o.indexOf(t.dataset.id)){const s=o[o.indexOf(t.dataset.id)-1],r=n[n.length-2],a=store.blox[t.dataset.id].k,l=a?a.indexOf(r):-1,i=a?a.indexOf(s):-1,c=Math.max(i,l);return{root:t,startIdx:Math.max(Math.min(i,l),0),endIdx:-1===c?a.length:c,rooted:-1===l||-1===i}}t=t.parentNode.parentNode}},setDragSelected=t=>{if(dragSelect)if(dragSelect.rooted)dragSelect.root.dataset.selected=t;else{const o=getChildren(dragSelect.root);for(let e=dragSelect.startIdx;e<dragSelect.endIdx+1;e++)o[e].dataset.selected=t}},mouseMoveListener=e=>{setDragSelected(!1);const t=e.target.closest(".block");if(t&&t!==dragSelectStartBlock){getSelection().empty();const o=commonAncestorNode(dragSelectStartBlock,t);o&&(dragSelect=o,setDragSelected(!0))}else dragSelect=null};document.addEventListener("mousedown",e=>{setDragSelected(!1),dragSelect=null,e.target.closest(".block")&&(document.addEventListener("mousemove",mouseMoveListener),dragSelectStartBlock=e.target.closest(".block"))}),document.addEventListener("mouseup",e=>{null!==dragSelectStartBlock&&(document.removeEventListener("mousemove",mouseMoveListener),dragSelectStartBlock=null)}),document.addEventListener("selectionchange",e=>{if(focusNode=getSelection().focusNode,focusOffset=getSelection().focusOffset,focusNode){const t=focusNode.parentNode.closest(".block");if(t&&canWriteBloc(t.dataset.id))return sessionState.isFocused=!0,sessionState.position=(focusNode.startIdx||0)+focusOffset,void(t.dataset.id!==sessionState.focusId&&(sessionState.focusId=t.dataset.id,focusIdPosition()))}sessionState.isFocused=!1});const showTopBarFn=()=>{user.s.topBar="visible",saveUser()};let showTopBarTimeout=null;topBarHiddenHitbox.addEventListener("mouseover",()=>{clearTimeout(showTopBarTimeout),showTopBarTimeout=setTimeout(showTopBarFn,400)}),topBarHiddenHitbox.addEventListener("mouseout",()=>{clearTimeout(showTopBarTimeout),showTopBarTimeout=null}),disconnectedFileInput.addEventListener("change",e=>{const t=e.target.files[0];console.log(t);const{name:o,ext:n}=splitFileName(t.name);console.log(`name ${o} extension ${n}`),"zip"===n?t.arrayBuffer().then(e=>{const t=zipToFiles(e);if(console.log(t),1===t.length&&"json"===t[0].ext)store=roamJsonToStore(t[0].name,t[0].text),preprocessImportedStore();else throw notifyText("Markdown import doesn't work yet. Upload a .json file, or a .zip file containing a .json file instead.",12),new Error("md import doesn't work")}):"json"===n?t.text().then(e=>{user.s.graphName=o,store=roamJsonToStore(o,e),preprocessImportedStore()}):notifyText("Micro Roam only accepts a .json file or .zip file containing 1 .json file")});const preprocessImportedStore=async()=>{startFn=()=>gotoNoHistory("dailyNotes"),await addGraph(),start()};topButtons["Sign Up"].addEventListener("click",e=>{focusSignup(),e.stopPropagation(),e.preventDefault()});const focusSignup=()=>{signupElement.style.display="block",loginElement.style.display="none",signupEmailElement.focus()},focusLogin=()=>{loginElement.style.display="block",signupElement.style.display="none",loginEmailElement.focus()};switchToSignup.addEventListener("click",focusSignup),switchToLogin.addEventListener("click",focusLogin);const rwlClickOutListener=e=>{console.log("rwlclick"),null===e.target.closest(".really-want-to")&&(reallyWantToLeaveElement.style.display="none",document.removeEventListener("click",rwlClickOutListener))};topButtons["Sign Out"].addEventListener("click",()=>{isSynced()?reset():(reallyWantToLeaveElement.style.display="flex",document.addEventListener("click",e=>rwlClickOutListener(e)),event.stopPropagation())}),reallyWantToLeaveElement.children[0].addEventListener("click",reset),topHamburgerElement.addEventListener("click",()=>{"block"==optionsFrame.style.display?optionsFrame.style.display="none":optionsFrame.style.display="block"}),topButtons["Create New Graph"].addEventListener("keydown",e=>{"Enter"===e.key&&createAndSwitchToNewStore(e.target.value)});const inlineCommandReplaceString=(e,t=0)=>{sessionState.position=editingCommandElement.firstChild.startIdx+e.length+t,editingCommandElement.innerText=e,setFocusedBlockString(focusBlockBody.innerText)},inlineCommands={TODO:()=>{const e=editingCommandElement.firstChild.startIdx+9;editingCommandElement.remove();let t=focusBlockBody.innerText;t="{{#TODO}}"+t,sessionState.position=e,setFocusedBlockString(t)},"page link":()=>{inlineCommandReplaceString("[[]]",-2)},today:()=>{inlineCommandReplaceString("[["+formatDate(new Date(Date.now()))+"]]")},video:()=>{inlineCommandReplaceString("{{#video: }}",-2)},query:()=>{inlineCommandReplaceString("{{#query: }}",-2)},"current time":()=>{const e=new Date(Date.now());inlineCommandReplaceString(formatTime(e))},tomorrow:()=>{inlineCommandReplaceString("[["+getTomorrowDateString()+"]]")},yesterday:()=>{inlineCommandReplaceString("[["+getYesterdayDateString()+"]]")},"next week":()=>{inlineCommandReplaceString("[["+getNextWeekDateString()+"]]")},"last week":()=>{inlineCommandReplaceString("[["+getLastWeekDateString()+"]]")},bold:()=>{inlineCommandReplaceString("****",-2)},italic:()=>{inlineCommandReplaceString("____",-2)},highlight:()=>{inlineCommandReplaceString("^^^^",-2)}};let commandSearchCache=[];const matchInlineCommand=e=>{commandSearchCache=[];let t;try{t=newSearchRegex(e)}catch(e){return commandSearchCache}for(let e in inlineCommands)e.match(t)&&commandSearchCache.push({string:e});return commandSearchCache},execInlineCommand=()=>{inlineCommandList.style.display="none",inlineCommands[focusSuggestion.dataset.string]()},roamBloxProps={children:"k",string:"s",title:"s","create-time":"ct","edit-time":"et",":create/user":"cu",":edit/user":"eu",uid:"uid",refs:"",":block/refs":""},roamJsonToStore=(e,t)=>{console.log("roamJsontostore");const o=performance.now(),s=intToBase64(Date.now()),n=JSON.parse(t);store=blankStore(),store.graphName=e,n[0][":edit/user"]&&(store.ownerRoamId=n[0][":edit/user"][":user/uid"]),ownerRoamId=store.ownerRoamId;const r=(t,e)=>{const o=intToBase64(t["create-time"])||s,n={s:t.string,p:e,ct:o,et:intToBase64(t["edit-time"])||o};store.blox[t.uid]=n,t[":create/user"]&&t[":create/user"][":user/uid"]!==ownerRoamId?n.cu=t[":create/user"][":user/uid"]:delete n.cu,t[":edit/user"]&&t[":edit/user"][":user/uid"]!==ownerRoamId?n.eu=t[":edit/user"][":user/uid"]:delete n.eu,t.children&&(n.k=t.children.map(e=>e.uid),t.children.forEach(e=>r(e,t.uid)));for(let e in t)e in roamBloxProps||(store.roamProps[t.uid]||(store.roamProps[t.uid]={}),store.roamProps[t.uid][e]=t[e])};for(let t of n){store.titles[t.title]=t.uid;const a=intToBase64(t["create-time"])||s,l={s:t.title,ct:a,et:intToBase64(t["edit-time"])||a};store.blox[t.uid]=l;for(let e in t)e in roamBloxProps||(store.roamProps[t.uid]||(store.roamProps[t.uid]={}),store.roamProps[t.uid][e]=t[e]);if(t[":create/user"]&&t[":create/user"][":user/uid"]!==ownerRoamId?l.cu=t[":create/user"][":user/uid"]:delete l.cu,t[":edit/user"]&&t[":edit/user"][":user/uid"]!==ownerRoamId?l.eu=t[":edit/user"][":user/uid"]:delete l.eu,void 0!==t.children){const i=[];l.k=i;for(let e=0;e<t.children.length;e++){const c=t.children[e];i.push(c.uid),r(c,t.uid)}}}return generateRefs(store),user.s.commitId="MYVERYFIRSTCOMMITEVER",console.log(`roamJsonToStore took ${performance.now()-o}`),console.log(store),store},storeToRoamJSON=s=>{const t=[],r=e=>{const t=s.blox[e],o={uid:e,string:t.s};t.ct&&(o["create-time"]=base64ToInt(t.ct)),t.et&&(o["edit-time"]=base64ToInt(t.et));const n=s.roamProps[e];return n&&Object.assign(o,n),t.k&&(o.children=t.k.map(r)),o[":create/user"]={":user/uid":s.ownerRoamId},o[":edit/user"]={":user/uid":s.ownerRoamId},t.cu&&(o[":create/user"]={":user/uid":t.cu}),t.eu&&(o[":edit/user"]={":user/uid":t.eu}),o};for(let e in s.titles){const o=s.titles[e],n=s.blox[o],a=s.roamProps[o],l={uid:o,title:n.s};n.ct&&(l["create-time"]=base64ToInt(n.ct)),n.et&&(l["edit-time"]=base64ToInt(n.et)),t.push(l),Object.assign(l,a),n.k&&(l.children=n.k.map(r)),l[":create/user"]={":user/uid":s.ownerRoamId},l[":edit/user"]={":user/uid":s.ownerRoamId},n[":create/user"]&&(l[":create/user"]={":user/uid":n[":create/user"]}),n[":edit/user"]&&(l[":edit/user"]={":user/uid":n[":edit/user"]})}return console.log(t),JSON.stringify(t)},oldStoreToRoamJSON={4:n=>{const t=[],s=e=>{const t={uid:e},o=n.blocks[e];return Object.assign(t,o),o.children&&(t.children=o.children.map(s)),t[":create/user"]={":user/uid":n.ownerRoamId},t[":edit/user"]={":user/uid":n.ownerRoamId},o[":create/user"]&&(t[":create/user"]={":user/uid":o[":create/user"]}),o[":edit/user"]&&(t[":edit/user"]={":user/uid":o[":edit/user"]}),o.refs&&(t.refs=o.refs.map(e=>({uid:e}))),o[":block/refs"]&&(t[":block/refs"]=o[":block/refs"].map(e=>({":block/uid":e}))),delete t.backRefs,delete t.parent,t};for(let e in n.pages){const o=n.pages[e],r={uid:e};t.push(r),Object.assign(r,o),delete r.backRefs,o.children&&(r.children=o.children.map(s)),r[":create/user"]={":user/uid":n.ownerRoamId},r[":edit/user"]={":user/uid":n.ownerRoamId},o[":create/user"]&&(r[":create/user"]={":user/uid":o[":create/user"]}),o[":edit/user"]&&(r[":edit/user"]={":user/uid":o[":edit/user"]})}return console.log(t),JSON.stringify(t)}},mdToStore=t=>{const n=intToBase64(Date.now()),s=(store,{});store=blankStore();for(let e of t){const r=e.name,a=e.text,l=(o=r,store.pagesByTitle[o]||newUid()),i={"create-time":n,title:r};if(store.pages[l]=i,store.pagesByTitle[r]=l,0<a.length){i.children=[];const c=e=>{const t=newUid();s[e]=t;const o={"create-time":n,string:e};store.blocks[t]=o,i.children.push(t)},d=(i,a.matchAll(/\n((?:    )*)- /g));let t=2;for(let e of d)c(a.substring(t,e.index)),t=e.index+e[0].length;c(a.substring(t))}}var o;console.log(store)},parseMdBlock=e=>{},blocToMd=e=>{let n="";const s=(e,t)=>{const o=store.blox[e];void 0===o&&console.log(e);for(let e=0;e<t;e++)n+="    ";n+="- "+o.s.replaceAll(/\(\(([a-zA-Z0-9\-_]+)\)\)/g,(e,t)=>{const o=store.blox[t];return o?'"'+store.blox[t].s+'"':e})+"\n";for(let e of o.k||[])s(e,t+1)};return s(e,0),n},storeToMdObjects=()=>{const o=[];for(let e in store.titles){const n=store.blox[store.titles[e]];let t="";for(let e of n.k||[])t+=blocToMd(e);o.push({fullName:e+".md",text:t})}return o},storeToMdZip=()=>filesToZip(storeToMdObjects()),LOCAL_FILE_SIGNATURE=67324752,LOCAL_FILE_HEADER_LENGTH=30,END_CENTRAL_DIR_SIGNATURE=101010256,END_CENTRAL_DIR_HEADER_LENGTH=46,CENTRAL_FILE_SIGNATURE=33639248,ARCHIVE_EXTRA_RECORD_SIGNATURE=134630224,CRC_32_MAGIC=2869187666,splitFileName=e=>{const t=e.match(/\.([a-z]+)$/);return{name:e.substring(0,t.index),ext:t[1]}},zipToFiles=e=>{const t=new Uint8Array(e);let o=0;const n=[];for(;o<t.length;){const s=new ArrayBuffer(4),r=new Uint8Array(s);for(let e=0;e<4;e++)r[e]=t[o+e];const a=new Uint32Array(s)[0];if(a!==LOCAL_FILE_SIGNATURE){if(a===END_CENTRAL_DIR_SIGNATURE){console.log("got end central dir signature");break}console.log(`got signature ${a}`);break}{const l=new Uint16Array(e,8,1)[0];if(0!==l)return console.log(l),void notifyText("Micro Roam can't handle .zip files that are actually compressed. use a .json file or an uncompressed .zip file, like ones exported by Roam Research or Micro Roam",10);{const i=new ArrayBuffer(12),c=new Uint8Array(i);for(let e=0;e<12;e++)c[e]=t[e+18+o];const d=new Uint32Array(i),u=(d[0],d[1]),m=d[2];if(1441805<=m)break;const g=new TextDecoder,f=g.decode(new Uint8Array(e,o+30,m)),{name:p,ext:k}=splitFileName(f),S=g.decode(new Uint8Array(e,o+30+m,u));n.push({name:p,ext:k,text:S,fullName:f}),o+=30+m+u}}}return n};let crcTable=null;const makeCRCTable=()=>{let t;crcTable=[];for(let e=0;e<256;e++){t=e;for(let e=0;e<8;e++)t=1&t?3736805603^t>>>1:t>>>1;crcTable[e]=t}};function crc32(t,o,n){null===crcTable&&makeCRCTable();let s=-1;for(let e=o;e<n;e++)s=s>>>8^crcTable[255&(s^t[e])];return(-1^s)>>>0}const dateUnixToMsDosFormat=e=>{const t=new Date(e),o=t.getDate(),n=t.getMonth()+1,s=t.getFullYear()-1980;let r=o+(n<<5)+(s<<9);return console.log(r),console.log(r.toString(2)),r},writeU16ToU8Array=(e,t,o)=>{e[t]=o<<24>>>24,e[t+1]=o<<16>>>24},writeIntToU8Array=(e,t,o)=>{e[t]=o<<24>>>24,e[t+1]=o<<16>>>24,e[t+2]=o<<8>>>24,e[t+3]=o>>>24},ZIP_VERSION=10,blankLocalHeader=new Uint8Array(30);writeIntToU8Array(blankLocalHeader,0,LOCAL_FILE_SIGNATURE),writeIntToU8Array(blankLocalHeader,14,CRC_32_MAGIC),writeU16ToU8Array(blankLocalHeader,4,ZIP_VERSION);const blankCentralHeader=new Uint8Array(46);writeIntToU8Array(blankCentralHeader,0,CENTRAL_FILE_SIGNATURE),writeU16ToU8Array(blankCentralHeader,4,16),writeU16ToU8Array(blankCentralHeader,6,ZIP_VERSION);const copyBuffer=(t,o,n,s,r)=>{for(let e=0;e<r;e++)n[s+e]=t[o+e]},filesToZip=t=>{const e=Date.now(),o=dateUnixToMsDosFormat(e),n=performance.now();let s="",r=0;for(let e of t)s+=e.fullName+e.text,r+=30+e.fullName.length+e.text.length;let a=textEncoder.encode(s).length+LOCAL_FILE_HEADER_LENGTH*t.length+END_CENTRAL_DIR_HEADER_LENGTH;console.log(s.length-r),console.log(`mstime ${performance.now()-n}`);let l=new ArrayBuffer(a),i=new Uint8Array(l),c=0;for(let e of t){const u=c;copyBuffer(blankLocalHeader,0,i,c,blankLocalHeader.length),writeU16ToU8Array(i,u+10,o),writeU16ToU8Array(i,u+12,o),c+=blankLocalHeader.length;const m=i.subarray(c),{read:g}=textEncoder.encodeInto(e.fullName,m);c+=g;const f=i.subarray(c),{read:p}=textEncoder.encodeInto(e.text,f),k=crc32(i,c,c+p);writeIntToU8Array(i,u+14,k),c+=p,writeIntToU8Array(i,u+18,p),writeIntToU8Array(i,u+22,p),writeU16ToU8Array(i,u+26,g)}const d=new Blob([l]);return console.log(`filestozip ${performance.now()-n}`),d},testRoundTrip=()=>{const e=storeToRoamJSON(store);store=roamJsonToStore(store.graphName,e);const t=storeToRoamJSON(store),o=e===t;o?console.log("Round trip test passed!"):(console.log(e),console.log(t),console.error("round trip failed"))},createPageTest=()=>{const e=store;store=blankStore(),macros.createPage("Test Page"),store=e};let testSTime;const renderMulti=(e,t=void 0,o=100,n=!1)=>{if(n||(testSTime=performance.now()),0<o){const s=e(t);s||setTimeout(()=>renderMulti(e,t,o-1,!0),0)}else console.log(`test func took ${performance.now()-testSTime}`)},benchmarkPageLoad=()=>renderMulti(()=>goto("pageTitle","Welcome to Micro Roam"));let benchmarkRandomWalkSTime=null;const benchmarkRandomWalk=()=>renderMulti(()=>{let t=[];const o=document.querySelectorAll(".page-ref"),n=document.querySelectorAll(".tag"),s=document.querySelectorAll(".breadcrumb-page");for(let e of o)t.push(e.children[1].innerText);for(let e of n)t.push(e.innerText.substring(1));for(let e of s)t.push(e.innerText);t=t.filter(e=>store.titles[e]&&store.blox[store.titles[e]]);const e=t[Math.floor(Math.random()*(t.length-1))];goto("pageTitle",e)}),benchmarkRenderAll=async()=>{const e=performance.now();let t=0,o=0;for(let e in store.titles){const r=performance.now();gotoNoHistory("pageTitle",e),t+=performance.now()-r,o+=1,await new Promise(e=>setTimeout(e,0))}const n=performance.now()-e,s=`rendered ${o} pages in ${Math.round(n)}ms, avg ${Math.round(n/o)}ms \nfunction time avg ${Math.round(t/o)}`;console.log(s),notifyText(s,10)},testAll=()=>{testRoundTrip(),benchmarkPageLoad(),benchmarkRandomWalk(),benchmarkRenderAll()},benchmarkGen=()=>{const e=performance.now();for(let e=0;e<100;e++)generateInnerRefs();console.log(`gen took ${performance.now()-e}`)},log=()=>{user.s.logging=!0,saveUser()},nolog=()=>{user.s.logging=!1,saveUser()},flash=benchmarkRenderAll,blank=(e="default")=>{store=blankStore(),store.graphName=e,user={s:{graphName:"default",theme:window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",topBar:"visible",logging:!1,spellcheck:!1,editingSpotlight:!0}},user.s.graphName=e,saveUser(),debouncedSaveStore(),goto("dailyNotes")},pr=()=>{console.log(JSON.stringify(store))},downloadBinary=()=>{const e=storeToBinary(),t=new Blob([e],{type:"application/x-micro-roam"}),o=URL.createObjectURL(t),n=document.createElement("a");n.setAttribute("href",o),n.setAttribute("download",`${store.graphName}.mrm`),n.click()},monitor=string=>{const js=`setInterval(()=>console.log(${string}), 500)`;eval(js)},terminalCommands={blank:blank,reset:reset,flash:flash,log:log,page:page,nolog:nolog,pr:pr,downloadBinary:downloadBinary,monitor:monitor}</script>