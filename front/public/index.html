<script>let idb=null,store=null,r;const basicBitchServerUrl="http://localhost:3000";let user,userText=localStorage.getItem("user"),usingLocalStore=!0,startFn=()=>gotoNoHistory("dailyNotes"),dataLoaded=!1,scriptsLoaded=!1;const setDataLoaded=()=>{scriptsLoaded&&start(),dataLoaded=!0},start=()=>{saveUser(),startFn(),user.h&&user.s.commitId!==user.s.syncCommitId&&debouncedSaveStore()},invalidateLocal=()=>{indexedDB.deleteDatabase("microroam");console.error("Local replica invalid. Resetting from server"),user.s.commitId=void 0,user.s.syncCommitId=void 0,localStorage.setItem("user",JSON.stringify(user)),localStorage.removeItem("store"),window.location.href=window.location.href};if(userText){if(user=JSON.parse(userText),user.h){const c=new Headers;c.set("h",user.h),user.s.syncCommitId&&c.set("commitid",user.s.syncCommitId);let e=`${basicBitchServerUrl}/get/${user.s.graphName}`;fetch(e,{method:"POST",headers:c}).then(async e=>{304!==e.status?200===e.status?(usingLocalStore=!1,user.s.syncCommitId=e.headers.get("commitid"),e.json().then(e=>{console.log("got blox");const o=startFn;startFn=()=>{hydrateFromBlox(user.s.graphName,e),o()},setDataLoaded()})):console.log("STORE NOT ON SERVER"):console.log("already up to date")})}const b=localStorage.getItem("store");if(b){try{store=JSON.parse(b),setDataLoaded()}catch(e){invalidateLocal()}r=indexedDB.open("microroam",5),r.onsuccess=e=>idb=e.target.result}else r=indexedDB.open("microroam",5),r.onsuccess=e=>{if(console.log("normal success"),idb=e.target.result,!0===usingLocalStore)try{idb.transaction(["stores"],"readonly").objectStore("stores").get(user.graphName).onsuccess=e=>{if(!0===usingLocalStore)if(e.target.result)try{store=JSON.parse(e.target.result.store),setDataLoaded()}catch(e){invalidateLocal()}else console.log("adding default graph")}}catch(e){}}}else user={s:{graphName:"default",theme:window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",topBar:"visible",logging:!1,spellcheck:!1}},fetch("./default-store.json").then(e=>{e.json().then(e=>{store=e,startFn=()=>gotoNoHistory("pageTitle","Welcome to Micro Roam"),setDataLoaded()})}),r=indexedDB.open("microroam",5),r.onsuccess=e=>idb=e.target.result;r.onupgradeneeded=o=>{console.log("upgradeneeded");const s=r.result,e=Array.from(s.objectStoreNames);e.includes("stores")?(console.log(o),console.log(s),r.onsuccess=()=>{console.log("new success"),idb=o.target.result;const e=s.transaction(["stores"],"readonly").objectStore("stores");e.get(user.s.graphName).onsuccess=e=>{store=e.target.result.store;e=oldStoreToRoamJSON[s.version](store);roamJsonToStore(user.s.graphName,e),saveStore(),setDataLoaded()}}):s.createObjectStore("stores",{keyPath:"graphName"})},r.onerror=e=>{console.log("error"),console.log(e),alert(`In order to save your notes between sessions, Micro Roam needs access to IndexedDB. 
You can allow access by exiting "private browsing" mode, or by using a newer browser, or by changing browser settings`)}</script><body class="dark"><div id="app"><div id="top-bar" style="margin-top:-43px"><a id="report-issue-button" target="_blank" href="mailto:taoroalin@gmail.com?subject=You Made Micro Roam Wrong" tabindex="-1">Report Issue </a><button id="help-button" tabindex="-1">Help</button> <button id="daily-notes-button" tabindex="-1">Daily Notes</button> <input id="search-input" placeholder="search" tabindex="-1"> <button id="upload-button" tabindex="-1"><input style="display:none" type="file" id="upload-input"> Upload</button> <a id="download-button" tabindex="-1">Download </a><button id="signup-button" tabindex="-1">Sign up</button> <button id="signout-button" tabindex="-1" style="display:none">Sign Out</button></div><div id="top-bar-hidden-hitbox" style="position:fixed;height:20px;width:100%;display:none"></div><script>document.body.className=user.s.theme;const topBar=document.getElementById("top-bar"),topBarHiddenHitbox=document.getElementById("top-bar-hidden-hitbox");"visible"===user.s.topBar&&(topBar.style.marginTop="0px",topBarHiddenHitbox.style.display="none"),setTimeout(()=>topBar.className="top-bar-transition",200)</script><div id="terminal" contenteditable="true" style="display:none"></div><div id="page-frame-outer"><div id="page-frame"></div></div><div id="autocomplete-list" style="display:none"></div><div id="command-list" style="display:none"></div><div id="search-result-list" style="display:none"></div><div id="template-list" style="display:none"></div><div id="login" style="display:none"><p>Login<form id="login-form"><input type="email" id="login-email" placeholder="email"> <input type="password" id="login-password" placeholder="password"> <input type="submit" style="height:0" tabindex="-1"></form><button id="switch-to-signup">Sign up</button> <button class="exit-to-main">Back</button></div><div id="signup" style="display:none"><p>Sign up<form id="signup-form"><input type="email" id="signup-email" placeholder="email"> <input id="signup-username" placeholder="username"> <input type="password" id="signup-password" placeholder="password"> <input type="submit" style="height:0" tabindex="-1"></form><button id="switch-to-login">Login</button> <button class="exit-to-main">Back</button></div><div id="really-want-to-leave" class="really-want-to" style="display:none">Your data will be lost if you sign out now <button>Continue</button></div></div><title>Micro Roam</title><style>*{outline:0;scrollbar-width:none}.dark{--background:#1b1b1b;--click:rgb(100, 100, 100);--text:rgb(246, 246, 246);--link:#3f84c0;--brackets:#a7b6c2;--block-ref:rgb(63, 63, 63);--bullet:#758897;--border:#afbeca;--bar:#565d63;--break:#838e97;--highlight:rgb(110, 93, 16);--page-ref:#2bcc5b;--shadow:rgb(98, 98, 98);--notification:#2e4736;--query-background:#26352a;--editing-background:#040404;--selected:#2d4a66}.light{--background:white;--click:rgb(197, 197, 197);--text:black;--link:rgb(54, 123, 184);--brackets:#a7b6c2;--block-ref:lightgrey;--bullet:#394b59;--border:#585e64;--bar:#7c858d;--shadow:#585e64;--break:#a8b4be;--highlight:rgb(255, 239, 146);--page-ref:rgb(73, 197, 91);--notification:#a4d1b1;--query-background:#b0dfbd;--editing-background:#e6e6e6;--selected:#abcdeb}a,button,input{font-family:Inter,Verdana}input{border:none}button{appearance:none;border:none;box-shadow:none;cursor:pointer;background-color:inherit;color:inherit;font-size:inherit}span{margin:0;padding:0}::-webkit-scrollbar{width:0%;height:0%}::selection{background-color:#85b7e8;color:var(--text)}body{scrollbar-width:0;font-family:Inter,Verdana,Arial;font-weight:400;margin:0;color:var(--text);background-color:var(--background)}a{color:var(--link)}a:visited{color:var(--link)}#app{height:100%;width:100%;display:flex;flex-direction:column}#page-frame-outer{width:100%;overflow-y:scroll}#page-frame{margin:0 auto 30px;max-width:min(900px,100%)}#top-bar{width:100%;display:flex;flex-direction:row;align-content:space-between;background-color:var(--background)}.top-bar-transition{transition:margin-top .1s}#top-hamburger{padding:10px 10px 5px;cursor:pointer}#top-bar a{padding:14px 10px 10px;font-size:.9em;color:var(--text);display:block;cursor:pointer;text-decoration:none}#top-bar button{padding:14px 10px 10px;font-size:.9em}#search-input{background-color:var(--background);color:var(--text);padding:3px 13px;margin:7px 5px 5px;display:block;font-size:1.2em;box-shadow:0 0 2px var(--shadow);border-radius:100px;flex-grow:1}#autocomplete-list,#command-list,#template-list{position:absolute;display:flex;flex-direction:column;background-color:var(--background);font-size:1.3em;border-radius:5px;box-shadow:0 0 8px var(--shadow)}.autocomplete__suggestion[data-selected=true],.command__suggestion[data-selected=true],.template__suggestion[data-selected=true]{background-color:var(--click)}.autocomplete__suggestion,.command__suggestion,.template__suggestion{padding:7px;cursor:pointer;border-radius:5px}#search-result-list{position:absolute;display:flex;flex-direction:column;background-color:var(--background);font-size:1.3em;border-radius:5px;box-shadow:0 0 8px var(--shadow)}.search-result[data-selected=true]{background-color:var(--click)}.search-result{padding:7px;cursor:pointer;border-radius:5px}.page{margin-right:30px;margin-left:30px;position:relative}.page__title{font-size:32px;margin:35px 0 20px 0}.backref-frame__body,.page__body{margin-left:20px}.backref-list__body{margin-left:10px}.backref-list__title{font-size:1.3em;font-weight:700;padding:20px 0 0}.page-break{height:0;margin:50px 25px;border:1px solid var(--break);border-width:1px 0 0 0}.block{position:relative;border-radius:5px}.block[data-selected=true]{background-color:var(--selected)}.block__body{padding:5px 2px;white-space:pre-wrap}.block__body[data-editmode=true]{background-color:var(--editing-background);border-radius:4px}.block__bullet{cursor:pointer;position:absolute;left:-21px;top:4px}.block__children{margin-left:22px;position:relative}.block__children::before{display:block;position:absolute;content:"\200B";top:0;height:100%;width:6px;transform:translateX(-34px);border-left:1px solid var(--bar)}.block-focus-frame{margin:60px 0}.breadcrumb-page{cursor:pointer}.breadcrumb-block{cursor:pointer}.backref-frame__breadcrumb{margin:15px 0 5px 0;font-size:1.2em}.block-focus-frame__breadcrumb{margin:15px 0 5px 0;font-size:1.2em}.page-ref{position:relative}.page-ref__brackets{font-weight:lighter;color:var(--brackets)}.page-ref__body{color:var(--page-ref);font-weight:800}.page-ref:hover{cursor:pointer}.page-ref:hover>.page-ref__body{text-decoration:underline}.tag{color:var(--page-ref);font-weight:800;position:relative}.tag:hover{text-decoration:underline;cursor:pointer}.block-ref{background-color:var(--block-ref)}.block-ref:hover{text-decoration:underline;cursor:pointer}.bold{font-weight:700}.italic{font-style:italic}.highlight{background-color:var(--highlight);border-radius:2px;padding:1px}.block-focus-frame{margin:35px 0 0 60px}.url{color:var(--link);text-decoration:underline;cursor:pointer}.literal{font-family:Inconsolata;font-size:1.15em}.code-block{font-family:Inconsolata;font-size:1.15em}.attribute{font-weight:700}.attribute:hover{cursor:pointer}.image-embed{max-width:100%}#terminal{font-family:Inconsolata;width:100%;padding:8px;background-color:#000;color:#fff}.query-frame{background-color:var(--query-background);border-radius:8px;padding:1px 12px 18px;margin:3px 0}.notification{text-align:center;min-width:300px;position:fixed;left:50%;transform:translateX(-50%);top:-40px;margin-top:0;opacity:1;transition:top .25s ease-out,opacity .2s linear;padding:20px;background-color:var(--notification);border-radius:8px}#login,#signup{position:fixed;top:0;left:0;right:0;bottom:0;background-color:var(--background);text-align:center}#login-form,#signup-form{position:fixed;top:28%;left:50%;transform:translateX(-50%);padding:13px 20px 20px;border-radius:12px;display:flex;flex-direction:column;justify-content:space-between}#login input,#signup input{background-color:var(--background);color:var(--text);font-size:1.4em;border-radius:3px;display:block;padding:4px;margin-bottom:13px}#login button,#signup button{position:fixed;bottom:19%;left:50%;transform:translateX(-50%);display:block;padding:4px;border-radius:3px;background-color:var(--background);color:var(--placeholder)}#login button:focus,#signup button:focus{font-weight:700}#login p,#signup p{left:50%;font-size:1.7em;color:var(--placeholder);padding:4px;margin-bottom:20px;margin-top:65px}#login .exit-to-main,#signup .exit-to-main{bottom:9%}.really-want-to{padding:80px;position:fixed;top:30%;right:50%;transform:translateX(50%);background-color:var(--background);box-shadow:0 0 2px var(--shadow);border-radius:8px;text-align:center;flex-direction:column}.really-want-to button{margin-top:30px;display:block}</style><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata"><template id="page"><div class="page"><h1 class="page__title" contenteditable="true" tabindex="-1" spellcheck="false"></h1><div class="page__body"></div><div class="page__backlinks"></div></div></template><template id="block"><div class="block"><svg class="block__bullet" width="20" height="20"><circle cx="10" cy="10.5" r="3" fill="var(--bullet)"/></svg><div class="block__body" contenteditable="true" tabindex="-1" spellcheck="false"></div><div class="block__children"></div></div></template><template id="backref-list"><div class="backref-list"><div class="backref-list__title">Linked References</div><div class="backref-list__body"></div></div></template><template id="query-frame"><div class="query-frame"></div></template><template id="block-focus-frame"><div class="block-focus-frame"><div class="block-focus-frame__breadcrumb"></div><div class="block-focus-frame__body"></div><div class="block-focus-frame__backlinks"></div></div></template><template id="backref-frame"><div class="backref-frame"><div class="backref-frame__breadcrumb"></div><div class="backref-frame__body"></div></div></template><template id="page-ref"><span class="page-ref"><span class="page-ref__brackets"></span><span class="page-ref__body"></span><span class="page-ref__brackets"></span></span></template><template id="image-embed"><img class="image-embed"></template><template id="compute-failed"><span class="compute-failed"><span class="compute-failed__brackets"></span><span class="compute-failed__body"></span><span class="compute-failed__brackets"></span></span></template><template id="todo-checkbox"><input type="checkbox" class="todo-checkbox"></template><template id="video-embed"><iframe class="video-embed" width="560" height="315" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></template><template id="breadcrumb-page"><span class="breadcrumb-page"></span></template><template id="notification"><div class="notification"></div></template><template id="breadcrumb-block"><span class="breadcrumb-block"><span class="breadcrumb-block__arrow">-></span><span class="breadcrumb-block__body"></span></span></template><template id="autocomplete__suggestion"><div class="autocomplete__suggestion"></div></template><template id="command__suggestion"><div class="command__suggestion"></div></template><template id="template__suggestion"><div class="template__suggestion"></div></template><template id="search-result"><div class="search-result"></div></template><script>let sessionState={pageFrame:"dailyNotes",focusId:null,scroll:0,position:null},focusNode=null,focusOffset=null,focusBlock=null,focusBlockBody=null,editingTemplateExpander=null,editingCommandElement=null,editingLink=null,editingTitle=null,focusSuggestion=null,dragSelectStartBlock=null,dragSelect=null,clipboardData=null;const SEARCH_RESULT_LENGTH=12,elById=e=>document.getElementById(e),getTemp=e=>elById(e).content.firstElementChild,pageFrame=elById("page-frame"),pageFrameOuter=elById("page-frame-outer"),searchInput=elById("search-input"),downloadButton=elById("download-button"),terminalElement=elById("terminal"),searchResultList=elById("search-result-list");searchResultList.dataset.templateName="search-result";const autocompleteList=elById("autocomplete-list");autocompleteList.dataset.templateName="autocomplete__suggestion";const inlineCommandList=elById("command-list");inlineCommandList.dataset.templateName="command__suggestion";const templateList=elById("template-list");templateList.dataset.templateName="template__suggestion";const switchToLogin=elById("switch-to-login"),switchToSignup=elById("switch-to-signup"),signupElement=elById("signup"),signupButton=elById("signup-button"),loginElement=elById("login"),signOutButton=elById("signout-button"),reallyWantToLeaveElement=elById("really-want-to-leave"),uploadInput=elById("upload-input"),appElement=elById("app"),pageTemplate=getTemp("page"),blockTemplate=getTemp("block"),backrefListTemplate=getTemp("backref-list"),blockFocusFrameTemplate=getTemp("block-focus-frame"),searchResultTemplate=getTemp("search-result"),breadcrumbBlockTemplate=getTemp("breadcrumb-block"),breadcrumbPageTemplate=getTemp("breadcrumb-page"),backrefFrameTemplate=getTemp("backref-frame"),notificationTemplate=getTemp("notification"),pageRefTemplate=getTemp("page-ref"),imageEmbedTemplate=getTemp("image-embed"),computeFailedTemplate=getTemp("compute-failed"),todoCheckboxTemplate=getTemp("todo-checkbox"),videoEmbedTemplate=getTemp("video-embed"),queryFrameTemplate=getTemp("query-frame"),loginForm=elById("login-form"),loginEmailElement=elById("login-email"),loginPasswordElement=elById("login-password"),signupForm=elById("signup-form"),signupUsernameElement=elById("signup-username"),signupEmailElement=elById("signup-email"),signupPasswordElement=elById("signup-password"),textEncoder=new TextEncoder,applyDif=(e,t)=>{let o=e.length;void 0!==t.s&&(o=t.s);var s=o-(void 0!==t.d&&t.d.length||0);return e.substring(0,s)+(t.i||"")+e.substring(o)},unapplyDif=(e,t)=>{var o=void 0!==t.d&&t.d.length||0,s=void 0!==t.i&&t.i.length||0;if(void 0!==t.s){var a=t.s-o,n=a+s;return e.substring(0,a)+(t.d||"")+e.substring(n)}s=e.length-o-s;return e.substring(0,s)+(t.d||"")},undoEditBlox=(e,t)=>{const[o,s,a,n,r,i]=e;switch(o){case"cr":var l=t[s].p;l&&(t[l].k=t[l].k.filter(e=>e!==s)),delete t[s];break;case"dl":var c=(t[s]=a).p,l=n;c&&(t[c].k||(t[c].k=[]),l?t[c].k.splice(l,0,s):t[c].k.push(s));break;case"mv":var c=r,d=i;const p=t[s];t[a].k=t[a].k.filter(e=>e!=s),t[p.p=c].k||(t[c].k=[]),t[c].k.splice(d,0,s);break;case"df":d=a;const m=t[s];m.et=commit.time,m.s=unapplyDif(m.s,d)}},doEditBlox=(e,t,o)=>{const[s,a,n,r,i]=e;switch(s){case"dl":var l=t[a].p;l&&(t[l].k=t[l].k.filter(e=>e!==a)),delete t[a];break;case"cr":t[a]={ct:o,s:""};var c=n,l=r;c&&(t[a].p=c,t[c].k||(t[c].k=[]),l?t[c].k.splice(l,0,a):t[c].k.push(a));break;case"mv":var c=n,d=r;const p=t[a];t[i].k=t[i].k.filter(e=>e!=a),t[p.p=c].k||(t[c].k=[]),t[c].k.splice(d,0,a);break;case"df":d=n;const m=t[a];m.et=o,m.s=applyDif(m.s,d)}};let getProcessMemory;try{performance.memory.heapUsed,getProcessMemory=()=>performance.memory&&performance.memory.heapUsed}catch(e){process.memoryUsage().heapUsed,getProcessMemory=()=>process.memoryUsage().heapUsed}class LruCache{constructor(e,t=15e8){this.maxProcessMemory=t,this.fetcher=e,this.map=new Map}async get(e){var t=this.map.get(e);if(void 0!==t)return this.map.delete(e),this.map.set(e,t),t;t=await this.fetcher(e);if(t&&this.map.set(e,t),getProcessMemory()>this.maxProcessMemory)for(const o of this.map){this.map.delete(o[0]);break}return t}}const promisify=s=>(...o)=>new Promise((e,t)=>s(...o,e));try{exports.applyDif=applyDif,exports.unapplyDif=unapplyDif,exports.doEditBlox=doEditBlox,exports.undoEditBlox=undoEditBlox,exports.promisify=promisify,exports.LruCache=LruCache}catch(e){}const CHARS_64="-_0123456789abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ",CHARS_16="0123456789ABCDEF",cpy=e=>{if("object"!=typeof e)return e;if(e instanceof Array)return e.map(cpy);{const o={};for(var t in e)o[t]=cpy(e[t]);return o}},monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"],getOrdinal=e=>{var t=e%10,o=e%100;return 1==t&&11!=o?e+"st":2==t&&12!=o?e+"nd":3==t&&13!=o?e+"rd":e+"th"},formatDate=e=>`${monthNames[e.getMonth()]} ${getOrdinal(e.getDate())}, ${e.getFullYear()}`,formatTime=e=>e.getHours()+":"+e.getMinutes(),unFormatDate=e=>{e=e.match(/([a-zA-Z]+) ([0-9]{1,2})(?:st|nd|rd|th), ([0-9]{4})/);if(e&&monthNames.includes(e[1]))return new Date},formatDateYMD=e=>`${e.getFullYear()}-${formatInt(e.getMonth()+1,2)}-${formatInt(e.getDate(),2)}`,truncateElipsis=(e,t=40)=>e.length>t?e.substring(0,t-3)+"...":e,getTomorrowDateString=()=>formatDate(new Date(Date.now()+864e5)),getYesterdayDateString=()=>formatDate(new Date(Date.now()-864e5)),getLastWeekDateString=()=>{const e=new Date(Date.now());return e.setDate(e.getDate()-7),formatDate(e)},getNextWeekDateString=()=>{const e=new Date(Date.now());return e.setDate(e.getDate()+7),formatDate(e)},formatInt=(e,t)=>{e=e.toString();return"0".repeat(t-e.length)+e},clamp=(e,t,o)=>Math.max(t,Math.min(e,o)),intToBase64=t=>{if(void 0!==t){let e="";for(;0<t;)e=""+CHARS_64[t%64]+e,t=Math.floor(t/64);return e}},base64ToInt=t=>{let o=0;for(let e=0;e<t.length;e++)o+=CHARS_64.indexOf(t[e])*Math.pow(64,t.length-e-1);return o},ustime=()=>{var e=Math.floor(1e3*(performance.timing.navigationStart+performance.now()));return console.log(e),e},inlineCommandReplaceString=(e,t=0)=>{sessionState.position=editingCommandElement.firstChild.startIdx+e.length+t,editingCommandElement.innerText=e,setFocusedBlockString(focusBlockBody.innerText)},inlineCommands={todo:()=>{var e=editingCommandElement.firstChild.startIdx+9;editingCommandElement.remove();var t="{{#TODO}}"+(t=focusBlockBody.innerText);sessionState.position=e,setFocusedBlockString(t)},"page link":()=>{inlineCommandReplaceString("[[]]",-2)},today:()=>{inlineCommandReplaceString("[["+formatDate(new Date(Date.now()))+"]]")},video:()=>{inlineCommandReplaceString("{{#video: }}",-2)},query:()=>{inlineCommandReplaceString("{{#query: }}",-2)},"current time":()=>{var e=new Date(Date.now());inlineCommandReplaceString(formatTime(e))},tomorrow:()=>{inlineCommandReplaceString("[["+getTomorrowDateString()+"]]")},yesterday:()=>{inlineCommandReplaceString("[["+getYesterdayDateString()+"]]")},"next week":()=>{inlineCommandReplaceString("[["+getNextWeekDateString()+"]]")},"last week":()=>{inlineCommandReplaceString("[["+getLastWeekDateString()+"]]")},bold:()=>{inlineCommandReplaceString("****",-2)},italic:()=>{inlineCommandReplaceString("____",-2)},highlight:()=>{inlineCommandReplaceString("^^^^",-2)}};let commandSearchCache=[];const matchInlineCommand=e=>{commandSearchCache=[];let t;try{t=newSearchRegex(e)}catch(e){return commandSearchCache}for(var o in inlineCommands)o.match(t)&&commandSearchCache.push({string:o});return commandSearchCache},execInlineCommand=()=>{inlineCommandList.style.display="none",inlineCommands[focusSuggestion.dataset.string]()},canWriteBloc=e=>!0,isSynced=()=>user.s.commitId===user.s.syncCommitId,diff=(e,t)=>({d:t,i:e});let undoCommitList=[],undoCommitSessionStateList=[],undoCommitInProgress=[],masterCommitList=[],masterCommitInProgress=[];const undoEditCacheStuff=e=>{var[t,o,s]=e;switch(console.log(e),t){case"cr":void 0===s&&delete store.titles[s.s];break;case"df":setLinks(o);var a,n=store.blox[o];void 0===n.p&&(a=applyDif(n.s,s),delete store.titles[a],store.titles[n.s]=o)}},undo=()=>{var t=undoCommitList.pop();sessionState=undoCommitSessionStateList.pop();for(let e=t.edits.length-1;0<=e;e--){var o=t.edits[e];undoEditBlox(o,store.blox),undoEditCacheStuff(o)}},doEditCacheStuff=(e,t=!1)=>{const[o,s,a]=e;switch(o){case"dl":a.p||delete store.titles[a.s];var n=store.forwardRefs[s];if(n)for(var r of n){const l=store.refs[r];1===l.length?delete store.refs[r]:store.refs[r]=l.filter(e=>e!=s)}store.refs[s];break;case"df":setLinks(s,t);var i=store.blox[s];void 0===i.p&&(n=unapplyDif(i.s,a),delete store.titles[n],store.titles[i.s]=s)}},doEdit=(...e)=>{var t=intToBase64(Date.now());undoCommitInProgress.push(e),masterCommitInProgress.push(e),print(e),doEditBlox(e,store.blox,t),doEditCacheStuff(e)},commit=()=>{var e=newUUID();undoCommitList.push({id:e,t:intToBase64(Date.now()),edits:undoCommitInProgress}),undoCommitSessionStateList.push(cpy(sessionState)),store.commitId=e,user.s.commitId=e,undoCommitInProgress=[],setTimeout(()=>{debouncedSaveStore(),saveUserJustLocalStorage()},0)},commitEdit=(...e)=>{doEdit(...e),commit()},saveStore=()=>{var e,t=store.blox,t=JSON.stringify(t);let o="{";for(e in store)"blox"!==e&&void 0!==store[e]&&(o+='"'+e+'":'+JSON.stringify(store[e])+",");o+='"blox":'+t+"}",saveStoreToBasicBitchServer(t),saveStoreStringLocal(o)},saveStoreIncremental=()=>{syncEditsWithBasicBitchServer(),saveStoreStringLocal(JSON.stringify(store))},saveStoreStringLocal=e=>{try{localStorage.setItem("store",e)}catch(e){localStorage.removeItem("store"),console.error(`Local Storage Failure: ${e}`)}const t=idb.transaction(["stores"],"readwrite"),o=t.objectStore("stores"),s=o.put({graphName:store.graphName,store:e});s.onsuccess=()=>{console.log("saved")},s.onerror=e=>{console.log("save error"),console.log(e)}};let saveStoreTimeout=null;const debouncedSaveStore=()=>{user.s.commitId!==user.s.syncCommitId&&(clearTimeout(saveStoreTimeout),saveStoreTimeout=setTimeout(saveStoreIncremental,300))},print=e=>{user.s.logging&&console.log(e)};let newUid;{let UidRandomContainer=new Uint8Array(9);newUid=()=>{let t;do{crypto.getRandomValues(UidRandomContainer),t="";for(let e=0;e<9;e++)t+=CHARS_64[UidRandomContainer[e]%64]}while(void 0!==store.blox[t]);return t}}let newUUID;{let UuidRandomContainer=new Uint8Array(21);newUUID=()=>{crypto.getRandomValues(UuidRandomContainer);let t="";for(let e=0;e<21;e++)t+=CHARS_64[UuidRandomContainer[e]%64];return t}}const macros={};macros.nocommit={copyBlock:(e,t,o)=>{const r=(e,t,o)=>{var s=newUid(),a=store.blox[e];if(doEdit("cr",s,t,o),doEdit("df",s,diff(a.s,"")),a.k)for(let e=0;e<a.k.length;e++){var n=a.k[e];r(n,s,e)}return s};return r(e,t,o)},delete:e=>{var t=store.blox[e];let o=void 0;t.p&&(o=store.blox[t.p].k.indexOf(e)),doEdit("dl",e,cpy(t),o)},write:(e,t)=>{doEdit("df",e,diff(t,store.blox[e].s))},writePageTitle:(e,t)=>{var o,s=store.blox[e].s;doEdit("df",e,diff(t,s));for(o of store.refs[e]||[]){const r=store.blox[o];var a=r.s,n=r.s.replaceAll(s,t);console.log(a),console.log(n),doEdit("df",o,diff(n,a))}},createPage:e=>{var t=newUid();return doEdit("cr",t),doEdit("df",t,diff(e,"")),t},move:(e,t,o)=>{var s=store.blox[e];doEdit("mv",e,t,o,s.p,store.blox[s.p].k.indexOf(e))}};for(let k in macros.nocommit)macros[k]=(...e)=>{e=macros.nocommit[k](...e);return commit(),e};const blankStore=()=>({blox:{},titles:{},refs:{},innerRefs:{},outerRefs:{},roamProps:{},ownerRoamId:void 0,graphName:void 0}),bloxProps=["s","p","i","ct","et","cu","eu"],gcPage=e=>{var t=store.blox[e],o=store.refs[e];void 0!==t.k&&0!==t.k.length||void 0!==o&&0!==o.length||macros.nocommit.delete(e)},parseRegexJustLinks=/(\[\[)|(\]\])|#([\/a-zA-Z0-9_-]+)|\(\(([a-zA-Z0-9\-_]+)\)\)|(^[\/a-zA-Z0-9_-]+)::|`([^`]+)`|```/g,setLinks=(t,e=!1)=>{for(var o of store.forwardRefs[t]||[])store.refs[o]=store.refs[o].filter(e=>e!==t),gcPage(o);const s=[];store.forwardRefs[t]=s;let a;a=e?e=>{e in store.refs?store.refs[e].push(t):store.refs[e]=[t],s.push(e)}:e=>{e in store.refs?store.refs[e].push(t):store.refs[e]=[t],s.push(e)};var n,r=e=>{let t=store.titles[e];void 0===t&&(t=macros.nocommit.createPage(e)),a(t)};const i=store.blox[t].s;let l=0,c=void 0,d=[];for(n of i.matchAll(parseRegexJustLinks)){if(0===d.length||"cb"===c.t)n[1]?(d.push({t:"pr",s:""}),c=d[d.length-1]):n[3]?r(n[3]):n[5]?r(n[5]):n[4]?a(n[4]):n[7]&&(c&&"cb"===c.t?d.pop():(d.push({t:"cb",s:""}),c=d[d.length-1]));else if(c.s=c.s+i.substring(l,n.index),l=n.index,n[1]){var p={t:"pr",s:""};c.s=c.s+"[[",d.push(p),c=d[d.length-1]}else if(n[2]){let e="]]";"pr"===c.t&&(e=c.s+"]]",r([c.s]),d.pop(),c=d[d.length-1]),void 0!==c&&(c.s=c.s+e)}else n[3]?(r(n[3]),c.s=c.s+n[0]):n[5]?(c.s=c.s+n[0],store.titles[n[5]],r(n[5])):n[4]?(a(n[4]),c.s=c.s+n[0]):n[7]?c&&"cb"===c.t?d.pop():(d.push({t:"cb",s:""}),c=d[d.length-1]):c.s=c.s+n[0];l=n.index+n[0].length}0===s.length&&delete store.forwardRefs[t]},generateRefs=()=>{var e,t=performance.now();for(e in void 0===store.refs&&(store.refs={}),void 0===store.forwardRefs&&(store.forwardRefs={}),store.blox)setLinks(e);return console.log(`gen refs took ${performance.now()-t}`),store},mergeLists=(e,t)=>{for(var o of t)e.includes(o)||e.push(o)},arrSetDiff=(e,t)=>{let o=[],s=[];for(var a of e)t.includes(a)||o.push(a);for(var n of t)e.includes(n)||s.push(n);return{added:o,deleted:s}},propagateRefs=(t,e,o)=>{const{added:s}=arrSetDiff(e,o);t=store.blox[t];if(t.p){let e=t.p;for(;e;){var a=store.blox[e];const i=store.forwardRefs[e];for(let e=0;e<s.length;e++){var n=s[e];i.includes(n)?(s[e]=s.pop(),--e):i.push(n)}e=a.p}}let r=t;do{r=store.blox[r.p];for(let e=0;e<s.length;e++);}while(r.p)},generateInnerRefs=()=>{performance.now();for(var t in store.innerRefs={},store.forwardRefs){var o=store.forwardRefs[t];let e=t;for(;e;)store.innerRefs[e]||(store.innerRefs[e]=[]),mergeLists(store.innerRefs[e],o),e=store.blox[e].p}},generateOuterRefs=()=>{performance.now();for(var e in store.outerRefs={},store.forwardRefs){const o=store.forwardRefs[e],s=e=>{store.outerRefs[e]||(store.outerRefs[e]=[]),mergeLists(store.outerRefs[e],o);for(var t of store.blox[e].k||[])s(t)};s(e)}},generateInnerOuterRefs=()=>{generateInnerRefs(),generateOuterRefs()},mergeStore=r=>{const i={};for(var e in r.blox){var t=r.blox[e];store.titles[t.s]?store.blox[e]&&(i[e]=newUid()):i[e]=store.titles[t.s]}const l=(e,t)=>{var o=i[e]||e,e=r.blox[e];const s={...e};if(store.blox[o]=s,s.p=t,e.k){s.k=[];for(var a of e.k){var n=i[a]||a;l(a,o),s.k.push(n)}}};for(var o in r.titles){var s=r.titles[o],o=r.blox[s];if(void 0===store.titles[o.s]){var a=i(s)||s;const u={...o};if(store.blox[a]=u,store.titles[o.s]=a,o.k){u.k=[];for(var n of kids){var c=getNewId(n);l(n,a),u.k.push(c)}}}else if(o.k){var d,p=store.titles[o.s];const f=store.blox[p];f.k||(f.k=[]);for(d of o.k){var m=i[d]||d;l(d,p),f.k.push(m)}}}},escapeRegex=e=>e.replaceAll(/([\[\]\(\)])/g,"\\$1").replaceAll("\\\\",""),newSearchRegex=e=>new RegExp(escapeRegex(e),"i"),searchRefCountWeight=.05,pageOverBlockWeight=1;let titleExactFullTextSearchCache=[];const titleExactFullTextSearch=e=>{var t,o=newSearchRegex(e);for(t in titleExactFullTextSearchCache=[],store.titles){var s=store.titles[t],a=(store.blox[s],t.match(o));a&&titleExactFullTextSearchCache.push({title:t,id:s,idx:a.index-(store.refs[s]?store.refs[s].length:0)*searchRefCountWeight})}return titleExactFullTextSearchCache.sort((e,t)=>e.idx-t.idx),titleExactFullTextSearchCache};let exactFullTextSearchCache=[];const exactFullTextSearch=e=>{var t,o=newSearchRegex(e);for(t in exactFullTextSearchCache=[],store.blox){var s=store.blox[t];const e=s.s;var a=e.match(o);if(a){const n={id:t,idx:a.index-(store.refs[t]?store.refs[t].length:0)*searchRefCountWeight-(void 0===s.p)*pageOverBlockWeight};s.p?n.string=s.s:n.title=s.s,exactFullTextSearchCache.push(n)}}return exactFullTextSearchCache.sort((e,t)=>e.idx-t.idx),exactFullTextSearchCache};let templateSearchCache=[];const searchTemplates=e=>{var t=store.titles["roam/templates"],o=store.blox[t];templateSearchCache=[];let s;try{s=newSearchRegex(e)}catch{return templateSearchCache}if(o){var a=e=>{const t=store.blox[e];console.log(t.s);var o=t.s.match(s);console.log(o),o&&templateSearchCache.push({id:e,string:t.s,idx:o.idx})};if(store.refs[t])for(var n of store.refs[t])a(n);if(store.blox[t].k)for(var r of store.blox[t].k)a(r);console.log(templateSearchCache),templateSearchCache=templateSearchCache.sort((e,t)=>t.idx-e.idx),console.log(templateSearchCache)}return templateSearchCache},hydrateFromBlox=(e,t)=>{for(var o in store=blankStore(),store.blox=t,store.graphName=e,t){var s=t[o];void 0===s.p&&(store.titles[s.s]=o)}generateRefs()},sortByLastEdited=e=>{e.sort((e,t)=>store.blox[e].et>store.blox[t].et?-1:1)},prepFocusIdForCursor=()=>{if(focusBlock&&focusBlock.isConnected&&focusBlock.dataset.id!==sessionState.focusId&&(focusBlockBody.textContent="",renderBlockBody(focusBlockBody,store.blox[focusBlock.dataset.id].s)),focusBlock=document.querySelector(`.block[data-id="${sessionState.focusId}"]`),focusBlockBody=focusBlock.children[1],void 0===focusBlock)throw new Error(`tried to focus block that doesn't exist: ${sessionState.focusId}`);sessionState.isFocused=!0;var e=store.blox[sessionState.focusId].s;focusBlockBody.innerText="",renderBlockBody(focusBlockBody,e,!0)},focusIdPosition=()=>{prepFocusIdForCursor();const s=e=>{for(var t of e.childNodes)if("#text"===t.nodeName){if(sessionState.position>=(t.startIdx||0)&&sessionState.position<=(t.startIdx||0)+t.textContent.length){scanResult=t;var o=sessionState.position-t.startIdx;return getSelection().collapse(t,o),t}}else{t=s(t);if(t)return t}};s(focusBlockBody),updateCursorSpanInfo()},selectIdWholeNode=e=>{prepFocusIdForCursor(),updateCursorSpanInfo()},setFocusedBlockString=(e,t)=>{let o=e;void 0===o&&(o=store.blox[sessionState.focusId].s),void 0!==t?commitEdit("df",sessionState.focusId,t):macros.write(sessionState.focusId,o),focusIdPosition()},getEditingSimpleSpan=e=>{var t;for(t of focusBlockBody.querySelectorAll("."+e))if(t.childNodes[0].endIdx>=sessionState.position&&t.childNodes[0].startIdx<sessionState.position)return t},updateCursorPosition=()=>{focusNode=getSelection().focusNode,focusOffset=getSelection().focusOffset;var e=focusNode.parentNode.closest(".block");sessionState.focusId=e.dataset.id,sessionState.position=(focusNode.startIdx||0)+focusOffset},updateCursorSpanInfo=()=>{editingLink=void 0;var e,t,o=focusBlockBody.querySelectorAll(".page-ref");for(e of focusBlockBody.querySelectorAll(".tag"))e.childNodes[0].endIdx>=sessionState.position&&e.childNodes[0].startIdx<sessionState.position&&(editingLink=e);for(t of o)t.children[1].childNodes[0].endIdx>=sessionState.position&&t.children[1].childNodes[0].startIdx<sessionState.position&&(editingLink=t);editingTitle=editingLink&&("tag"===editingLink.className&&editingLink.innerText.substring(1)||"page-ref"===editingLink.className&&editingLink.children[1].innerText),editingTemplateExpander=getEditingSimpleSpan("template-expander"),editingUrlElement=getEditingSimpleSpan("url"),editingCommandElement=getEditingSimpleSpan("command"),void 0===editingCommandElement&&(inlineCommandList.style.display="none"),void 0===editingTemplateExpander&&(templateList.style.display="none"),void 0===editingLink&&(autocompleteList.style.display="none")},renderPage=(e,t,o=!0)=>{var s,a,n=store.blox[t];const r=pageTemplate.cloneNode(!0),i=r.firstElementChild,l=r.children[1];if(l.dataset.id=t,r.dataset.id=t,void 0===n.s)throw new Error(`error with page id ${t}`);i.innerText=n.s;let c=n.k;c&&0!==c.length||(s=newUid(),commitEdit("cr",s,t,0),c=n.k);for(a of c)renderBlock(l,a);t=store.refs[t];return o&&t&&0<t.length&&(o=backrefListTemplate.cloneNode(!0),r.children[2].appendChild(o),renderBackrefs(o.children[1],t)),e.appendChild(r),r},renderBackrefs=(e,t)=>{sortByLastEdited(t);for(var o of t){var s=backrefFrameTemplate.cloneNode(!0);renderBreadcrumb(s.children[0],o),renderBlock(s.children[1],o),e.appendChild(s)}},renderBlock=(e,t,o)=>{const s=blockTemplate.cloneNode(!0),a=s.children[1],n=s.children[2];s.dataset.id=t,n.dataset.id=t,a.dataset.id=t;var r,i=store.blox[t].s;renderBlockBody(a,i);for(r of store.blox[t].k||[])renderBlock(n,r);return void 0!==o&&e.children.length>=o?e.insertBefore(s,e.children[o]):e.appendChild(s),s},renderBreadcrumb=(t,e)=>{const o=[];if(store.blox[e].p){for(;;){if(e=store.blox[e].p,!store.blox[e].p){o.push({title:store.blox[e].s,id:e});break}o.push({string:store.blox[e].s,id:e})}const n=breadcrumbPageTemplate.cloneNode(!0);var s=o[o.length-1].title;renderBlockBody(n,s),n.dataset.title=s,t.appendChild(n);for(let e=o.length-2;0<=e;e--){const r=breadcrumbBlockTemplate.cloneNode(!0);var a=r.children[1];renderBlockBody(a,o[e].string),r.dataset.id=o[e].id,t.appendChild(r)}}},renderResultSet=(e,t,o,s=0)=>{if(0===t.length)return o.style.display="none",void(focusSuggestion=null);const a=getTemp(o.dataset.templateName);o.innerHTML="",o.style.display="block";e=e.getBoundingClientRect();o.style.top=e.bottom,o.style.left=e.left,o.dataset.resultStartIdx=s;var n=Math.min(t.length,s+SEARCH_RESULT_LENGTH);for(let e=s;e<n;e++){matchingTitle=t[e];const r=a.cloneNode(!0);e==s&&(focusSuggestion=r,r.dataset.selected="true"),r.dataset.id=matchingTitle.id,matchingTitle.title?(r.dataset.title=matchingTitle.title,r.innerText=truncateElipsis(matchingTitle.title,50)):(r.dataset.string=matchingTitle.string,r.innerText=truncateElipsis(matchingTitle.string,50)),o.appendChild(r)}},notifyText=(e,t)=>{const o=notificationTemplate.cloneNode(!0);o.innerText=e,appElement.appendChild(o),setTimeout(()=>o.style.top="60px",50);t=t&&1e3*t||5e3;setTimeout(()=>o.style.opacity="0",t),setTimeout(()=>{o.remove()},t+300)},parseRegex=/(\[\[)|(\]\])|#([\/a-zA-Z0-9_-]+)|\(\(([a-zA-Z0-9\-_]+)\)\)|(\*\*)|(\^\^)|(__)|((?:https?\:\/\/)(?:[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6})\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/\/=]*))|`([^`]+)`|;;([^ \n\r]+)|(^[ \/a-zA-Z0-9_-]+)::|(```)|\\(.*)|!\[([^\]]*)\]\(((?:https?\:\/\/)(?:[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6})\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/\/=]*))\)|({{)|(}})|(and)|(or)/g,renderBlockBody=(e,t,o=!1)=>{e.dataset.editmode=o;const s=[e];var a=t.matchAll(parseRegex);let n=0,r=e,i=null;var l,c=e=>(i=document.createTextNode(e),i.startIdx=n,i.endIdx=n+e.length,i);for(l of a){if(r.appendChild(c(t.substring(n,l.index))),n=l.index,l[1]){const m=pageRefTemplate.cloneNode(!0);m.startIdx=n+2,r.appendChild(m),o&&m.children[0].appendChild(c("[[")),s.push(m.children[1]),r=s[s.length-1]}else if(l[2])if("page-ref__body"===r.className)r.parentNode.endIdx=n,o&&r.parentNode.children[2].appendChild(c("]]")),s.pop(),r=s[s.length-1],i.endIdx+=2;else{const u=document.createElement("span");o&&(u.className="page-ref-close-missing-open"),u.appendChild(c("]]")),r.appendChild(u)}else if(l[3]){const f=document.createElement("span");f.className="tag",f.appendChild(c(l[0])),r.appendChild(f)}else if(l[4])if(o){const g=document.createElement("span");g.className="block-ref-editing",g.appendChild(c(l[0])),r.appendChild(g)}else{var d=l[4],p=store.blox[d];if(p){const h=document.createElement("span");h.className="block-ref",h.innerText=p.s,h.dataset.id=d,r.appendChild(h)}else r.appendChild(c(l[0]))}else if(l[5])if("bold"===r.className)o&&r.appendChild(c("**")),s.pop(),r=s[s.length-1],i.endIdx+=2;else{const S=document.createElement("span");S.className="bold",r.appendChild(S),o&&S.appendChild(c("**")),s.push(S),r=S}else if(l[6])if("highlight"===r.className)o&&r.appendChild(c("^^")),s.pop(),r=s[s.length-1],i.endIdx+=2;else{const v=document.createElement("span");v.className="highlight",r.appendChild(v),o&&v.appendChild(c("^^")),s.push(v),r=v}else if(l[7])if("italic"===r.className)o&&r.appendChild(c("__")),s.pop(),r=s[s.length-1],i.endIdx+=2;else{const y=document.createElement("span");y.className="italic",o&&y.appendChild(c("__")),r.appendChild(y),s.push(y),r=y}else if(l[8]){const k=document.createElement("span");k.className="url",k.appendChild(c(l[0])),k.href=l[8],r.appendChild(k)}else if(l[9]){const b=document.createElement("span");b.className="literal",b.appendChild(c(l[9])),r.appendChild(b)}else if(l[10]){const x=document.createElement("span");x.className="template-expander",x.appendChild(c(l[0])),r.appendChild(x)}else if(l[11]){const B=document.createElement("span");B.className="attribute",B.appendChild(c(l[0])),r.appendChild(B)}else if(l[12])if("code-block"===r.className)s.pop(),r=s[s.length-1];else{const E=document.createElement("div");E.className="code-block",r.appendChild(E),s.push(E),r=E}else if(l[13]){const T=document.createElement("span");T.className="command",T.appendChild(c(l[0])),r.appendChild(T)}else if(void 0!==l[14]&&void 0!==l[15])if(o){const w=document.createElement("span");w.className="image-full-text",w.appendChild(c(l[0])),r.appendChild(w)}else{const C=imageEmbedTemplate.cloneNode(!0);C.alt=l[14],C.src=l[15],r.appendChild(C)}else if(l[16]){const I=computeFailedTemplate.cloneNode(!0);I.startIdx=n+2,r.appendChild(I),I.children[0].appendChild(c("{{")),s.push(I.children[1]),r=s[s.length-1]}else if(l[17])if("compute-failed__body"===r.className){const N=r.parentNode;N.endIdx=n,N.text=t.substring(N.startIdx,N.endIdx),N.children[2].appendChild(c("}}")),transformComputeElement(N,o),s.pop(),r=s[s.length-1],i.endIdx+=2}else{const L=document.createElement("span");L.appendChild(c("}}")),r.appendChild(L)}else if(l[18]){const D=document.createElement("span");D.className="compute-and",D.appendChild(c("and")),r.appendChild(D)}else if(l[19]){const R=document.createElement("span");R.className="compute-or",R.appendChild(c("or")),r.appendChild(R)}n=l.index+l[0].length}for(s[s.length-1].appendChild(c(t.substring(n)));r!==e;)"page-ref"===r.className&&(r.children[0].className=r.children[0].className+"-incomplete"),r.className=r.className+"-incomplete",r=r.parentNode},queryOperationOrder={root:0,"compute-or":1,"compute-and":2,page:3},transformComputeElement=(o,e=!1)=>{var s=o.children[1].children;if(0!==s.length){var a=s[0],a=getPageTitleOfNode(a);if(void 0!==a){switch(a){case"TODO":e||(o.textContent="",l=todoCheckboxTemplate.cloneNode(!0),o.appendChild(l));break;case"DONE":if(!e){o.textContent="";const m=todoCheckboxTemplate.cloneNode(!0);m.checked=!0,o.appendChild(m)}break;case"video":if(!e){if(2!==s.length)return;if("url"===s[1].className){const u=videoEmbedTemplate.cloneNode(!0);u.src=youtubeLinkToEmbed(s[1].innerText),o.textContent="",o.appendChild(u)}}break;case"query":var n={op:"root"};console.log(s);let t=n;for(let e=1;e<s.length;e++){const f={},o=s[e];var r=getPageTitleOfNode(o);if(r){if(f.title=r,f.op="page",void 0===t.l)t.l=f;else{if(void 0!==t.r)return void console.error("page ref with no operator");t.r=f}f.p=t,t=f}else{var i=queryOperationOrder[o.className];if(void 0!==i){f.op=o.className;let e=void 0;for(;queryOperationOrder[t.op]>i;)e=t,t=t.p;f.l=e,e.p=f,t.l===e?t.l=f:t.r=f,f.p=t,t=f}}}n=n.l,console.log(n);var l=performance.now();const c=store.refs[store.titles.query];n=Object.keys(queryAstObjectSetStrategy(n)).filter(e=>!c.includes(e));console.log(`query took ${performance.now()-l}`),console.log(n);l=queryFrameTemplate.cloneNode(!0);renderBackrefs(l,n);const d=o.closest(".block"),p=d.querySelector(".query-frame");p&&p.remove(),d.appendChild(l);break;default:return}o.className="compute"}}},queryAstArrayStrategy=e=>{if(void 0===e)return[];var t=queryAstArrayStrategy(e.r);let o=queryAstArrayStrategy(e.l);switch(e.op){case"compute-and":const n=[];for(var s of t)o.includes(s)&&n.push(s);return n;case"compute-or":for(var a of t)o.push(a);return o;case"page":return[...store.refs[store.titles[e.title]]||[]]}},queryAstObjectSetStrategy=e=>{if(void 0===e)return{};var t,o=queryAstObjectSetStrategy(e.r);let s=queryAstObjectSetStrategy(e.l),a={};switch(e.op){case"compute-and":for(var n in o)1===s[n]&&(a[n]=1);return a;case"compute-or":for(var r in o)s[r]=1;return s;case"page":for(t of store.refs[store.titles[e.title]])a[t]=1;return a}},idOfYoutubeURL=e=>{e=e.match(/^https:\/\/www\.youtube.com\/watch\?v=([a-zA-Z0-9]+)(&t=.+)?$/);if(e)return e[1]},embedLinkOfYoutubeId=e=>`https://www.youtube.com/embed/${e}`,youtubeLinkToEmbed=e=>embedLinkOfYoutubeId(idOfYoutubeURL(e)),reset=()=>{localStorage.clear();indexedDB.deleteDatabase("microroam");window.location.href=window.location.href},syncEditsWithBasicBitchServer=async()=>{if(0!==masterCommitInProgress.length){const s=new Headers;s.set("h",user.h);var e=newUUID(),t={id:e,t:intToBase64(Date.now()),edits:masterCommitInProgress};masterCommitInProgress=[],s.set("body",JSON.stringify(t)),s.set("synccommitid",user.s.syncCommitId);var o=await fetch(`${basicBitchServerUrl}/edit/${store.graphName}`,{headers:s});200===o.status?user.s.syncCommitId=e:409===o.status?(console.log("conflicting edit"),invalidateLocal()):masterCommitInProgress=[...t.edits,...masterCommitInProgress]}},saveStoreToBasicBitchServer=async e=>{var t=performance.now();const o=new Headers;o.set("h",user.h);var s=user.s.commitId;o.set("commitid",s),o.set("synccommitid",user.s.syncCommitId);e=await fetch(`${basicBitchServerUrl}/put/${store.graphName}`,{method:"POST",body:e,headers:o});200===e.status||304===e.status?(user.s.syncCommitId=s,store.syncCommitId=s,console.log(`save confirmed in ${performance.now()-t}`)):console.warn("failed to save to server")},getStoreFromBasicBitchServer=async e=>{var t,o=performance.now();const s=await fetch(`${basicBitchServerUrl}/get/${e}`,{headers:{passwordHash:user.h}});200===reponse.status?(t=await s.json(),hydrateFromBlox(e,t),console.log(`got in ${performance.now()-o}`)):console.warn("failed to get store")},saveSettingsToBasicBitchServer=async()=>{const e=new Headers;e.set("h",user.h),e.set("body",JSON.stringify(user.s)),200!==(await fetch(`${basicBitchServerUrl}/settings`,{headers:e})).status&&console.log("failed to save settings")},middlePepper="76pCgT0lW6ES9yjt01MeH",beginPepper="CeoPPOv9rIq6O7YiYlSFX",endPepper="Rzw1dagomQGpoo2s7iGE3lYL2yruaJDGrUk6bFCvz",hashPassword=async(e,t)=>{var t=`${beginPepper}${e}${middlePepper}${t}${endPepper}`,t=textEncoder.encode(t),t=await crypto.subtle.digest("SHA-512",t),o=new Uint8Array(t);let s="";for(let e=0;e<o.length;e++)s+=String.fromCharCode(o[e]);return s=btoa(s),s=s.replaceAll("/","-").replaceAll("+","_").replaceAll("=",""),s};loginForm.addEventListener("submit",async e=>{e.preventDefault();var t=loginEmailElement.value;loginEmailElement.value="";e=loginPasswordElement.value;loginPasswordElement.value="";t=await hashPassword(e,t);const o=await fetch(`${basicBitchServerUrl}/auth`,{method:"POST",headers:{h:t}});200===o.status?(user=await o.json(),saveUser(),invalidateLocal(),console.log(user)):notifyText("Don't know that username + password.")}),signupForm.addEventListener("submit",async e=>{e.preventDefault();var t=signupEmailElement.value;signupEmailElement.value="";var o=signupUsernameElement.value;signupUsernameElement.value="";e=signupPasswordElement.value;signupPasswordElement.value="";e=await hashPassword(e,t),t=JSON.stringify({h:e,u:o,e:t,s:user.s});console.log(t);const s=new Headers;alert(t),s.set("body",t);const a=await fetch(`${basicBitchServerUrl}/signup`,{method:"POST",headers:s});200===a.status?(console.log(a),user=await a.json(),saveUser(),invalidateLocal(),console.log("signed up")):(t=await a.json(),notifyText(t))});const addGraph=async()=>{const e=new Headers;e.set("h",user.h),e.set("commitid",user.s.commitId);var t=user.s.commitId;(await fetch(`${basicBitchServerUrl}/creategraph/${store.graphName}`,{headers:e,method:"POST",body:JSON.stringify(store.blox)})).ok?(user.s.syncCommitId=t,store.syncCommitId=t):notifyText("failed to add graph")},focusBlockEnd=e=>{sessionState.focusId=e.dataset.id,sessionState.position=store.blox[sessionState.focusId].s.length,focusIdPosition(),console.log("focusblockend")},focusBlockStart=e=>{sessionState.focusId=e.dataset.id,sessionState.position=0,focusIdPosition(),console.log("focusblockstartt")},focusBlockVerticalOffset=(e,t=focusBlock,o=!1)=>{const s=Array.from(document.querySelectorAll(".block"));e=s[s.indexOf(t)+e];e&&(o?focusBlockStart:focusBlockEnd)(e)},getChildren=e=>("block"===e.className?e.children[2]:e.children[1]).children,downloadHandler=()=>{console.log("download");var e=storeToRoamJSON(store),e=new Blob([e],{type:"text/json"}),e=URL.createObjectURL(e);downloadButton.setAttribute("href",e),downloadButton.setAttribute("download",`${store.graphName}-${formatDateYMD(new Date(Date.now()))}.json`)},downloadMd=()=>{console.log("download md");var e=storeToMdZip(),e=URL.createObjectURL(e);const t=document.createElement("a");t.setAttribute("href",e),t.setAttribute("download",`${store.graphName}-md-${formatDateYMD(new Date(Date.now()))}.zip`),t.click()},expandTemplate=()=>{var e=focusSuggestion.dataset.id,t=store.blox[sessionState.focusId];if(void 0===t.k||0===t.k.length){var o=store.blox[sessionState.focusId].p,s=store.blox[e].k,a=store.blox[o].k.indexOf(sessionState.focusId);macros.nocommit.delete(sessionState.focusId,!1);var n=focusBlock.parentNode;focusBlock.remove();for(let e=0;e<s.length;e++){var r=s[e],i=a+e,r=macros.nocommit.copyBlock(r,o,i),i=renderBlock(n,r,i);0===e&&focusBlockEnd(i)}commit()}else notifyText("can't use a template inside a block that has children");templateList.style.display="none"},pasteBlocks=()=>{var o=store.blox[sessionState.focusId].p;let s=store.blox[o].k.indexOf(sessionState.focusId);var a=focusBlock.parentNode;if(""===focusBlockBody.innerText?(macros.nocommit.delete(sessionState.focusId),focusBlock.remove()):s+=1,clipboardData.dragSelect.rooted){var e=macros.nocommit.copyBlock(clipboardData.dragSelect.root,o,s),e=renderBlock(a,e,s);focusBlockEnd(e)}else{let t=null;for(let e=0;e<clipboardData.dragSelect.endIdx+1-clipboardData.dragSelect.startIdx;e++){var n=store.blox[clipboardData.dragSelect.root].k[e+clipboardData.dragSelect.startIdx],n=macros.nocommit.copyBlock(n,o,e+s),n=renderBlock(a,n,e+s);t=n}focusBlockEnd(t)}commit()},autocomplete=()=>{const e=store.blox[sessionState.focusId].s;var t,o,s;"tag"===editingLink.className?(o=editingLink.childNodes[0],/[^\/a-zA-Z0-9_-]/.test(focusSuggestion.dataset.title)?(t=e.slice(0,o.startIdx)+"[["+focusSuggestion.dataset.title+"]]"+e.slice(o.endIdx),sessionState.position=o.startIdx+focusSuggestion.dataset.title.length+4,setFocusedBlockString(t)):(s=e.slice(0,o.startIdx)+"#"+focusSuggestion.dataset.title+e.slice(o.endIdx),sessionState.position=o.startIdx+focusSuggestion.dataset.title.length+1,setFocusedBlockString(s))):(o=editingLink.children[1].childNodes[0],s=e.slice(0,o.startIdx)+focusSuggestion.dataset.title+e.slice(o.endIdx),console.log(s),sessionState.position=o.startIdx+focusSuggestion.dataset.title.length+2,setFocusedBlockString(s)),autocompleteList.style.display="none"},indentFocusedBlock=()=>{var e,t,o=sessionState.focusId;const s=focusBlock.previousElementSibling;s&&s.dataset&&s.dataset.id&&(e=s.dataset.id,console.log(e),t=store.blox[e].k&&store.blox[e].k.length||0,macros.move(o,e,t),s.children[2].appendChild(focusBlock),getSelection().collapse(focusNode,focusOffset))},dedentFocusedBlock=()=>{var e=sessionState.focusId,t=store.blox[e].p,o=store.blox[t];if(o){o=o.p,t=store.blox[o].k.indexOf(t);macros.move(e,o,t+1);t=focusBlock.parentNode.parentNode;const s=t.parentNode;t=t.nextElementSibling;t?s.insertBefore(focusBlock,t):s.appendChild(focusBlock),getSelection().collapse(focusNode,focusOffset)}};document.addEventListener("input",s=>{var e,a;if(sessionState.isFocused)if(updateCursorPosition()," "!==focusBlockBody.innerText&&""!==focusBlockBody.innerText){let t=focusBlockBody.innerText,o=null!==s.data&&1===s.data.length&&"insertText"===s.inputType;if(null!==s.data)if("["===s.data){var n,r=s.target.querySelectorAll(".page-ref-close-missing-open");let e=!1;for(n of r)if(console.log(n),n.childNodes[0].startIdx>sessionState.position){e=!0;break}e||(t=t.substring(0,sessionState.position)+"]"+t.substring(sessionState.position),o=!1)}else"]"===s.data&&"]"===t[sessionState.position]&&(t=t.substring(0,sessionState.position-1)+t.substring(sessionState.position),o=!1);let e={d:store.blox[sessionState.focusId].s,i:t};o&&(e=sessionState.position===t.length?{i:s.data}:{i:s.data,s:sessionState.position-1}),setFocusedBlockString(t,e),editingCommandElement&&(r=matchInlineCommand(editingCommandElement.innerText.substring(1)),renderResultSet(editingCommandElement,r,inlineCommandList,0)),editingTitle&&(a=titleExactFullTextSearch(editingTitle),renderResultSet(editingLink,a,autocompleteList,0)),editingTemplateExpander&&(console.log("editingTemplateExpander"),a=editingTemplateExpander.innerText.substring(2),a=searchTemplates(a),renderResultSet(editingTemplateExpander,a,templateList,0))}else macros.write(sessionState.focusId,"");else"search-input"===s.target.id?(e=exactFullTextSearch(s.target.value),renderResultSet(searchInput,e,searchResultList,0)):"page__title"===s.target.className&&(console.log("edit title"),e=s.target.parentNode.dataset.id,macros.writePageTitle(e,s.target.innerText))});const globalHotkeys={"hide top bar":{key:"b",control:!0,fn:()=>{"0px"===topBar.style.marginTop?user.s.topBar="hidden":user.s.topBar="visible",saveUser()}},escape:{key:"Escape",fn:()=>{autocompleteList.style.display="none",templateList.style.display="none"}},upload:{key:"d",control:!0,fn:()=>{uploadInput.click()}},download:{key:"s",control:!0,shift:!0,fn:downloadHandler},save:{key:"s",control:!0,fn:debouncedSaveStore},"toggle color theme":{key:"m",control:!0,fn:()=>{"light"===document.body.className?user.s.theme="dark":user.s.theme="light",saveUser()}},search:{key:"u",control:!0,fn:()=>{"0px"!==topBar.style.marginTop&&(topBar.style.marginTop="0px"),searchInput.focus()}},open:{key:"o",control:!0,fn:e=>{editingTitle?goto("pageTitle",editingTitle):editingUrlElement&&editingUrlElement.click()}},"daily notes":{key:"d",alt:!0,fn:()=>{goto("dailyNotes")}},undo:{key:"z",control:!0,fn:()=>{0<undoCommitList.length&&(undo(),renderSessionState())}},"delete block":{key:"k",control:!0,shift:!0,fn:()=>{var e=store.blox[sessionState.focusId];void 0===e.k||0===e.k.length?(focusBlock.remove(),focusBlockVerticalOffset(-1),macros.delete(sessionState.focusId)):notifyText('no "delete block" for blocks with children (at least right now)')}},terminal:{key:"i",control:!0,alt:!0,fn:()=>{"none"===terminalElement.style.display?(terminalElement.style.display="block",terminalElement.focus()):terminalElement.style.display="none"}},p:{key:"p",control:!0,fn:()=>{console.log("at least it wasn't print")}}};document.addEventListener("keydown",event=>{for(var hotkeyName in globalHotkeys){const hotkey=globalHotkeys[hotkeyName];if(event.key.toLowerCase()===hotkey.key&&event.shiftKey===!!hotkey.shift&&event.ctrlKey===!!hotkey.control&&event.altKey===!!hotkey.alt)return hotkey.fn(event),void event.preventDefault()}if(dragSelect){let did=!1;if(("c"===event.key||"x"===event.key)&&event.ctrlKey){let text="";console.log("copy blocks");const id=dragSelect.root.dataset.id;if(dragSelect.rooted)text=blocToMd(id);else{const kids=store.blox[id].k;for(let i=dragSelect.startIdx;i<dragSelect.endIdx+1;i++)text+=blocToMd(kids[i])}clipboardData={dragSelect:{root:id,startIdx:dragSelect.startIdx,endIdx:dragSelect.endIdx,rooted:dragSelect.rooted},text:text},console.log(clipboardData),navigator.clipboard.writeText(text),did=!0}if("Backspace"===event.key||"Delete"===event.key||"x"===event.key&&event.ctrlKey){if(console.log(dragSelect),dragSelect.rooted)focusBlockVerticalOffset(-1,dragSelect.root),macros.nocommit.delete(dragSelect.root.dataset.id),document.querySelectorAll(`.block[data-id="${dragSelect.root.dataset.id}"]`).forEach(e=>e.remove());else{const childNodes=getChildren(dragSelect.root);focusBlockVerticalOffset(-1,childNodes[dragSelect.startIdx]),console.log(`cnl ${childNodes.length} start ${dragSelect.startIdx} end ${dragSelect.endIdx}`);for(let i=dragSelect.endIdx;i>=dragSelect.startIdx;i--){const node=childNodes[i];macros.nocommit.delete(node.dataset.id),document.querySelectorAll(`.block[data-id="${node.dataset.id}"]`).forEach(e=>e.remove())}commit()}dragSelect=null,did=!0}did&&event.preventDefault()}else if("none"!==autocompleteList.style.display)"Enter"===event.key&&(autocomplete(),event.preventDefault()),updownythingey(editingLink,autocompleteList,titleExactFullTextSearchCache,focusSuggestion)&&event.preventDefault();else if("none"!==templateList.style.display)"Tab"!==event.key&&"Enter"!==event.key||(expandTemplate(),event.preventDefault()),updownythingey(editingTemplateExpander,templateList,templateSearchCache,focusSuggestion)&&event.preventDefault();else if("none"!==inlineCommandList.style.display)"Tab"!==event.key&&"Enter"!==event.key||(execInlineCommand(),event.preventDefault()),updownythingey(editingCommandElement,inlineCommandList,commandSearchCache,focusSuggestion)&&event.preventDefault();else if(sessionState.isFocused){let blocks,newActiveBlock;switch(event.key){case"Enter":if(!event.shiftKey){let idx=store.blox[store.blox[sessionState.focusId].p].k.indexOf(sessionState.focusId);event.ctrlKey||(idx+=1),console.log(idx);const newBlockUid=newUid();commitEdit("cr",newBlockUid,store.blox[sessionState.focusId].p,idx);const newBlockElement=renderBlock(focusBlock.parentNode,newBlockUid,idx);newBlockElement.children[1].focus(),event.preventDefault()}break;case"Tab":(event.shiftKey?dedentFocusedBlock:indentFocusedBlock)(),event.preventDefault();break;case"Backspace":if(0===sessionState.position){const parent=store.blox[store.blox[sessionState.focusId].p];if(void 0!==parent.p||1!==parent.k.length){const currentFocusBlock=focusBlock;focusBlockVerticalOffset(-1),macros.delete(currentFocusBlock.dataset.id),currentFocusBlock.remove(),event.preventDefault()}}break;case"ArrowDown":if(event.altKey&&event.shiftKey){const parentId=store.blox[sessionState.focusId].p,parentElement=focusBlock.parentNode,currentIdx=store.blox[parentId].k.indexOf(sessionState.focusId);focusBlock.nextElementSibling&&(macros.move(sessionState.focusId,parentId,currentIdx+1),focusBlock.nextElementSibling.nextElementSibling?parentElement.insertBefore(focusBlock,focusBlock.nextElementSibling.nextElementSibling):parentElement.appendChild(focusBlock),getSelection().collapse(focusNode,focusOffset),event.preventDefault())}else event.shiftKey||event.altKey||(focusBlockVerticalOffset(1),event.preventDefault());break;case"ArrowUp":if(event.altKey&&event.shiftKey){const parentId=store.blox[sessionState.focusId].p,parentElement=focusBlock.parentNode,currentIdx=store.blox[parentId].k.indexOf(sessionState.focusId);focusBlock.previousElementSibling&&(macros.move(sessionState.focusId,parentId,currentIdx-1),parentElement.insertBefore(focusBlock,focusBlock.previousElementSibling),getSelection().collapse(focusNode,focusOffset),event.preventDefault())}else event.shiftKey||event.altKey||(focusBlockVerticalOffset(-1),event.preventDefault());break;case"ArrowLeft":event.shiftKey&&event.altKey?dedentFocusedBlock():0===sessionState.position?(focusBlockVerticalOffset(-1),event.preventDefault()):--sessionState.position;break;case"ArrowRight":event.shiftKey&&event.altKey?indentFocusedBlock():sessionState.position===focusBlockBody.innerText.length?(focusBlockVerticalOffset(1,focusBlock,!0),event.preventDefault()):sessionState.position+=1;break;case"c":event.ctrlKey&&(clipboardData=null)}}if(document.activeElement&&"search-input"===document.activeElement.id){if("Enter"===event.key)return!event.ctrlKey&&focusSuggestion?focusSuggestion.dataset.title?goto("pageTitle",focusSuggestion.dataset.title):goto("block",focusSuggestion.dataset.id):goto("pageTitle",event.target.value),void event.preventDefault();const didUpDowny=updownythingey(searchInput,searchResultList,exactFullTextSearchCache,focusSuggestion);didUpDowny&&event.preventDefault()}if("none"!==terminalElement.style.display&&"Enter"===event.key&&!event.ctrlKey&&!event.shiftKey&&!event.altKey){const string=event.target.innerText,first=string.match(/^[a-z]+/);if(first&&terminalCommands[first[0]]){const fn=terminalCommands[first[0]];fn(string.substring(first[0].length)),event.preventDefault(),terminalElement.style.display="none",terminalElement.innerHTML=""}else try{eval(string),event.ctrlKey||(terminalElement.style.display="none",terminalElement.innerHTML="")}catch(error){console.log(error),event.preventDefault()}}print(sessionState)}),document.addEventListener("paste",e=>{if(console.log(e),clipboardData){const t=e.clipboardData.getData("text");t.replaceAll(/\r/g,"")==clipboardData.text?(pasteBlocks(),e.preventDefault()):clipboardData=void 0}});const updownythingey=(e,t,o,s)=>{var a="ArrowUp"===event.key||"Tab"===event.key&&event.shiftKey?-1:("ArrowDown"===event.key||"Tab"===event.key)&&1;if(a){const n=-1===a?s.previousElementSibling:s.nextElementSibling;return n?(n.dataset.selected="true",focusSuggestion=n,delete s.dataset.selected):(s=parseInt(t.dataset.resultStartIdx),s=clamp(s+a*SEARCH_RESULT_LENGTH,0,o.length-SEARCH_RESULT_LENGTH),renderResultSet(e,o,t,s),-1===a&&(delete t.firstElementChild.dataset.selected,t.lastElementChild.dataset.selected=!0)),!0}},getPageTitleOfNode=e=>{const t=e.closest(".tag");if(t)return t.innerText.substring(1);const o=e.closest(".attribute");if(o)return o.innerText.substring(0,o.innerText.length-2);e=e.closest(".page-ref");return e?e.children[1].innerText:void 0};document.addEventListener("mousedown",t=>{var o=getPageTitleOfNode(t.target);if(o)goto("pageTitle",o);else{var s=t.target.closest(".block__bullet");if("search-result"!==t.target.className){"search-input"!==t.target.id&&(searchResultList.style.display="none");var a=t.target.closest(".breadcrumb-page"),o=t.target.closest(".breadcrumb-block");if(s)goto("block",s.parentNode.dataset.id);else if("block-ref"===t.target.className)goto("block",t.target.dataset.id);else if("url"===t.target.className){const e=document.createElement("a");e.target="_blank",e.href=t.target.innerText,e.click()}else if("download-button"===t.target.id)downloadHandler();else if("template__suggestion"===t.target.className)focusSuggestion&&(focusSuggestion.dataset.selected=!1),t.target.dataset.selected=!0,focusSuggestion=t.target,expandTemplate();else if("upload-button"===t.target.id)uploadInput.click();else if("daily-notes-button"===t.target.id)goto("dailyNotes");else if("options-button"===t.target.id)notifyText("Options coming soon");else if("autocomplete__suggestion"===t.target.className)focusSuggestion&&(focusSuggestion.dataset.selected=!1),t.target.dataset.selected=!0,autocomplete();else if("help-button"===t.target.id)goto("pageTitle","Welcome to Micro Roam");else if(a)goto("pageTitle",a.dataset.title);else if(o)goto("block",o.dataset.id);else if("exit-to-main"==t.target.className)signupElement.style.display="none",loginElement.style.display="none";else if("command__suggestion"===t.target.className)execInlineCommand();else if("image-embed"===t.target.className)focusBlockStart(t.target.closest(".block")),t.preventDefault();else if("todo-checkbox"===t.target.className){s=t.target.checked?"TODO":"DONE",a=t.target.closest(".block").dataset.id,o=t.target.closest(".compute");let e=store.blox[a].s;e=e.substring(0,o.startIdx)+"[["+s+"]]"+e.substring(o.endIdx),macros.write(a,e);const n=t.target.closest(".block__body");n.textContent="",renderBlockBody(n,e),t.preventDefault()}}else t.target.dataset.title?goto("pageTitle",t.target.dataset.title):goto("block",t.target.dataset.id)}});const commonAncestorNode=(e,t)=>{const o=[];for(;void 0!==e.dataset.id;)o.push(e.dataset.id),e=e.parentNode.parentNode;const s=[];for(;void 0!==t.dataset.id;){if(s.push(t.dataset.id),-1!==o.indexOf(t.dataset.id)){var a=o[o.indexOf(t.dataset.id)-1],n=s[s.length-2];const i=store.blox[t.dataset.id].k;var r=i?i.indexOf(n):-1,n=i?i.indexOf(a):-1,a=Math.max(n,r);return{root:t,startIdx:Math.max(Math.min(n,r),0),endIdx:-1===a?i.length:a,rooted:-1===r||-1===n}}t=t.parentNode.parentNode}},setDragSelected=t=>{if(dragSelect)if(dragSelect.rooted)dragSelect.root.dataset.selected=t;else{const o=getChildren(dragSelect.root);for(let e=dragSelect.startIdx;e<dragSelect.endIdx+1;e++)o[e].dataset.selected=t}},mouseMoveListener=e=>{setDragSelected(!1);e=e.target.closest(".block");e&&e!==dragSelectStartBlock?(getSelection().empty(),(e=commonAncestorNode(dragSelectStartBlock,e))&&(dragSelect=e,setDragSelected(!0))):dragSelect=null};document.addEventListener("mousedown",e=>{setDragSelected(!1),dragSelect=null,e.target.closest(".block")&&(document.addEventListener("mousemove",mouseMoveListener),dragSelectStartBlock=e.target.closest(".block"))}),document.addEventListener("mouseup",e=>{null!==dragSelectStartBlock&&(document.removeEventListener("mousemove",mouseMoveListener),dragSelectStartBlock=null)}),document.addEventListener("selectionchange",e=>{if(focusNode=getSelection().focusNode,focusOffset=getSelection().focusOffset,focusNode){var t=focusNode.parentNode.closest(".block");if(t&&canWriteBloc(t.dataset.id))return sessionState.isFocused=!0,sessionState.position=(focusNode.startIdx||0)+focusOffset,void(t.dataset.id!==sessionState.focusId&&(sessionState.focusId=t.dataset.id,focusIdPosition()))}sessionState.isFocused=!1}),document.addEventListener("visibilitychange",e=>{console.log("focusin")},!1),document.addEventListener("visibilitychange",e=>{console.log("focusout")},!0);const showTopBarFn=()=>{user.s.topBar="visible",saveUser()};let showTopBarTimeout=null;topBarHiddenHitbox.addEventListener("mouseover",()=>{clearTimeout(showTopBarTimeout),showTopBarTimeout=setTimeout(showTopBarFn,400)}),topBarHiddenHitbox.addEventListener("mouseout",()=>{clearTimeout(showTopBarTimeout),showTopBarTimeout=null}),uploadInput.addEventListener("change",e=>{const t=e.target.files[0];console.log(t);const{name:o,ext:s}=splitFileName(t.name);console.log(`name ${o} extension ${s}`),"zip"===s?t.arrayBuffer().then(e=>{e=zipToFiles(e);if(console.log(e),1===e.length&&"json"===e[0].ext)store=roamJsonToStore(e[0].name,e[0].text),preprocessNewStore();else throw notifyText("Markdown import doesn't work yet. Upload a .json file, or a .zip file containing a .json file instead.",12),new Error("md import doesn't work")}):"json"===s?t.text().then(e=>{user.s.graphName=o,store=roamJsonToStore(o,e),preprocessNewStore()}):notifyText("Micro Roam only accepts a .json file or .zip file containing 1 .json file")});const preprocessNewStore=async()=>{startFn=()=>gotoNoHistory("dailyNotes");const e=await fetch("./default-store.json");var t=await e.json();mergeStore(t),await addGraph(),start()};signupButton.addEventListener("click",e=>{focusSignup(),e.stopPropagation(),e.preventDefault()});const focusSignup=()=>{signupElement.style.display="block",loginElement.style.display="none",signupEmailElement.focus()},focusLogin=()=>{loginElement.style.display="block",signupElement.style.display="none",loginEmailElement.focus()};switchToSignup.addEventListener("click",focusSignup),switchToLogin.addEventListener("click",focusLogin);const rwlClickOutListener=e=>{console.log("rwlclick"),null===e.target.closest(".really-want-to")&&(reallyWantToLeaveElement.style.display="none",document.removeEventListener("click",rwlClickOutListener))};signOutButton.addEventListener("click",()=>{isSynced()?reset():(reallyWantToLeaveElement.style.display="flex",document.addEventListener("click",e=>rwlClickOutListener(e)),event.stopPropagation())}),reallyWantToLeaveElement.children[0].addEventListener("click",reset);const initialDailyNotes=5,renderSessionState=()=>{switch(searchResultList.style.display="none",pageFrameOuter.removeEventListener("scroll",dailyNotesInfiniteScrollListener),pageFrame.innerHTML="",searchInput.value="",sessionState.pageFrame){case"pageTitle":let e=store.titles[sessionState.page];void 0===e&&(e=macros.createPage(sessionState.page)),renderPage(pageFrame,e);break;case"block":const n=blockFocusFrameTemplate.cloneNode(!0);pageFrame.appendChild(n),renderBreadcrumb(n.children[0],sessionState.block),renderBlock(n.children[1],sessionState.block);const r=store.refs[sessionState.block];if(r){r.sort((e,t)=>store.blox[t].et-store.blox[e].et);var o,s=backrefListTemplate.cloneNode(!0);n.children[2].appendChild(s);for(o of r)renderBlock(s.children[1],o)}break;case"dailyNotes":pageFrameOuter.addEventListener("scroll",dailyNotesInfiniteScrollListener),sessionState.oldestDate=new Date(Date.now());let t=0;void 0===store.titles[formatDate(sessionState.oldestDate)]&&macros.createPage(formatDate(sessionState.oldestDate));for(let e=0;e<1e3;e++){var a=store.titles[formatDate(sessionState.oldestDate)];if(a){renderPage(pageFrame,a);const i=document.createElement("div");if(i.className="page-break",pageFrame.appendChild(i),t+=1,t>=initialDailyNotes)break}sessionState.oldestDate.setDate(sessionState.oldestDate.getDate()-1)}t<initialDailyNotes&&pageFrame.lastChild.remove()}var e;sessionState.isFocused?console.log(`SESSION STATE ALREADY FOCUSED ON ${sessionState.focusId}`):(e=pageFrame.querySelector(".block"),sessionState.position=0,sessionState.focusId=e.dataset.id),focusIdPosition(),pageFrameOuter.scrollTop=sessionState.scroll||0},gotoNoHistory=(e,...t)=>{switch(e){case"dailyNotes":sessionState.pageFrame="dailyNotes";break;case"pageTitle":sessionState.pageFrame="pageTitle",sessionState.page=t[0];break;case"block":sessionState.pageFrame="block",sessionState.block=t[0]}renderSessionState()},goto=(...e)=>{sessionState.scroll=pageFrameOuter.scrollTop;const t=JSON.parse(JSON.stringify(sessionState));sessionState.isFocused=!1,sessionState.scroll=0,gotoNoHistory(...e),setTimeout(()=>{history.replaceState(t,"Micro Roam"),history.pushState(sessionState,"Micro Roam")},0)},gotoReplaceHistory=(...e)=>{gotoNoHistory(...e),history.replaceState(sessionState,"Micro Roam")};window.addEventListener("popstate",e=>{console.log(e.state),e.state&&(sessionState=e.state,renderSessionState())});const dailyNotesInfiniteScrollListener=()=>{if(pageFrame.getBoundingClientRect().bottom-innerHeight<700)for(let e=0;e<100;e++){sessionState.oldestDate.setDate(sessionState.oldestDate.getDate()-1);var t=store.titles[formatDate(sessionState.oldestDate)];if(t){renderPage(pageFrame,t);const o=document.createElement("div");o.className="page-break",pageFrame.appendChild(o);break}}},parseStackTrace=e=>{const t=[];var o;for(o of e.matchAll(/([^ ]+) \(([^\)]+):([0-9]+):([0-9]+)\)(?:\n|$)/g))t.push({function:o[1],file:o[2],line:o[3],column:o[4]});return t},logError=(e,t,o,s,a)=>{e={line:o,file:t,stack:parseStackTrace(a.stack),message:e,column:s},s=localStorage.getItem("error_log");if(s){const n=JSON.parse(s);n.push(e),localStorage.setItem("error_log",JSON.stringify(n))}else localStorage.setItem("error_log",JSON.stringify([e]));return!1};window.onerror=logError;const showTopBar=()=>{topBar.style.marginTop="0px",topBarHiddenHitbox.style.display="none"},hideTopBar=()=>{topBar.style.marginTop="-43px",topBarHiddenHitbox.style.display="block"},saveUser=()=>{document.body.className=user.s.theme,("visible"===user.s.topBar?showTopBar:hideTopBar)(),user.h?(signOutButton.style.display="block",signupButton.style.display="none"):(signOutButton.style.display="none",signupButton.style.display="block"),saveUserJustLocalStorage(),saveSettingsToBasicBitchServer()},saveUserJustLocalStorage=()=>{localStorage.setItem("user",JSON.stringify(user))};dataLoaded&&start(),scriptsLoaded=!0;const ptest=()=>{var e=performance.now();for(let e=0;e<100;e++)generateInnerOuterRefs();e=performance.now()-e;console.log(`thing took ${e}`)}</script><script async>const roamBloxProps={children:"k",string:"s",title:"s","create-time":"ct","edit-time":"et",":create/user":"cu",":edit/user":"eu",uid:"uid",refs:"",":block/refs":""},roamJsonToStore=(e,r)=>{console.log("roamJsontostore");var o=performance.now();const n=intToBase64(Date.now());var t,r=JSON.parse(r);store=blankStore(),store.graphName=e,r[0][":edit/user"]&&(store.ownerRoamId=r[0][":edit/user"][":user/uid"]),ownerRoamId=store.ownerRoamId;const s=(r,e)=>{var o,t=intToBase64(r["create-time"])||n;const a={s:r.string,p:e,ct:t,et:intToBase64(r["edit-time"])||t};for(o in store.blox[r.uid]=a,r[":create/user"]&&r[":create/user"][":user/uid"]!==ownerRoamId?a.cu=r[":create/user"][":user/uid"]:delete a.cu,r[":edit/user"]&&r[":edit/user"][":user/uid"]!==ownerRoamId?a.eu=r[":edit/user"][":user/uid"]:delete a.eu,r.children&&(a.k=r.children.map(e=>e.uid),r.children.forEach(e=>s(e,r.uid))),r)o in roamBloxProps||(store.roamProps[r.uid]||(store.roamProps[r.uid]={}),store.roamProps[r.uid][o]=r[o])};for(t of r){store.titles[t.title]=t.uid;var a,l=intToBase64(t["create-time"])||n;const c={s:t.title,ct:l,et:intToBase64(t["edit-time"])||l};for(a in store.blox[t.uid]=c,t)a in roamBloxProps||(store.roamProps[t.uid]||(store.roamProps[t.uid]={}),store.roamProps[t.uid][a]=t[a]);if(t[":create/user"]&&t[":create/user"][":user/uid"]!==ownerRoamId?c.cu=t[":create/user"][":user/uid"]:delete c.cu,t[":edit/user"]&&t[":edit/user"][":user/uid"]!==ownerRoamId?c.eu=t[":edit/user"][":user/uid"]:delete c.eu,void 0!==t.children){const d=[];c.k=d;for(let e=0;e<t.children.length;e++){var i=t.children[e];d.push(i.uid),s(i,t.uid)}}}return generateRefs(),store.commitId="MYVERYFIRSTCOMMITEVER",user.s.commitId=store.commitId,console.log(`roamJsonToStore took ${performance.now()-o}`),console.log(store),store},storeToRoamJSON=t=>{const e=[],a=e=>{const r=t.blox[e],o={uid:e,string:r.s};r.ct&&(o["create-time"]=base64ToInt(r.ct)),r.et&&(o["edit-time"]=base64ToInt(r.et));e=t.roamProps[e];return e&&Object.assign(o,e),r.k&&(o.children=r.k.map(a)),o[":create/user"]={":user/uid":t.ownerRoamId},o[":edit/user"]={":user/uid":t.ownerRoamId},r.cu&&(o[":create/user"]={":user/uid":r.cu}),r.eu&&(o[":edit/user"]={":user/uid":r.eu}),o};for(var r in t.titles){var o=t.titles[r];const n=t.blox[o];r=t.roamProps[o];const s={uid:o,title:n.s};n.ct&&(s["create-time"]=base64ToInt(n.ct)),n.et&&(s["edit-time"]=base64ToInt(n.et)),e.push(s),Object.assign(s,r),n.k&&(s.children=n.k.map(a)),s[":create/user"]={":user/uid":t.ownerRoamId},s[":edit/user"]={":user/uid":t.ownerRoamId},n[":create/user"]&&(s[":create/user"]={":user/uid":n[":create/user"]}),n[":edit/user"]&&(s[":edit/user"]={":user/uid":n[":edit/user"]})}return console.log(e),JSON.stringify(e)},oldStoreToRoamJSON={4:t=>{const e=[],a=e=>{const r={uid:e},o=t.blocks[e];return Object.assign(r,o),o.children&&(r.children=o.children.map(a)),r[":create/user"]={":user/uid":t.ownerRoamId},r[":edit/user"]={":user/uid":t.ownerRoamId},o[":create/user"]&&(r[":create/user"]={":user/uid":o[":create/user"]}),o[":edit/user"]&&(r[":edit/user"]={":user/uid":o[":edit/user"]}),o.refs&&(r.refs=o.refs.map(e=>({uid:e}))),o[":block/refs"]&&(r[":block/refs"]=o[":block/refs"].map(e=>({":block/uid":e}))),delete r.backRefs,delete r.parent,r};for(var r in t.pages){const o=t.pages[r],n={uid:r};e.push(n),Object.assign(n,o),delete n.backRefs,o.children&&(n.children=o.children.map(a)),n[":create/user"]={":user/uid":t.ownerRoamId},n[":edit/user"]={":user/uid":t.ownerRoamId},o[":create/user"]&&(n[":create/user"]={":user/uid":o[":create/user"]}),o[":edit/user"]&&(n[":edit/user"]={":user/uid":o[":edit/user"]})}return console.log(e),JSON.stringify(e)}},mdToStore=e=>{const o=intToBase64(Date.now());store;const t={};store=blankStore();var r,a;for(r of e){var n=r.name;const c=r.text;var s=(a=n,store.pagesByTitle[a]||newUid());const d={"create-time":o,title:n};if(store.pages[s]=d,store.pagesByTitle[n]=s,0<c.length){d.children=[];var l,i=e=>{var r=newUid();t[e]=r;e={"create-time":o,string:e};store.blocks[r]=e,d.children.push(r)},s=(d,c.matchAll(/\n((?:    )*)- /g));let e=2;for(l of s)i(c.substring(e,l.index)),e=l.index+l[0].length;i(c.substring(e))}}console.log(store)},parseMdBlock=e=>{},blocToMd=e=>{let a="";const n=(e,r)=>{const o=store.blox[e];void 0===o&&console.log(e);for(let e=0;e<r;e++)a+="    ";a+="- "+o.s.replaceAll(/\(\(([a-zA-Z0-9\-_]+)\)\)/g,(e,r)=>{return store.blox[r]?'"'+store.blox[r].s+'"':e})+"\n";for(var t of o.k||[])n(t,r+1)};return n(e,0),a},storeToMdObjects=()=>{const r=[];for(var o in store.titles){var t,a=store.blox[store.titles[o]];let e="";for(t of a.k||[])e+=blocToMd(t);r.push({fullName:o+".md",text:e})}return r},storeToMdZip=()=>filesToZip(storeToMdObjects()),LOCAL_FILE_SIGNATURE=67324752,LOCAL_FILE_HEADER_LENGTH=30,END_CENTRAL_DIR_SIGNATURE=101010256,END_CENTRAL_DIR_HEADER_LENGTH=46,CENTRAL_FILE_SIGNATURE=33639248,ARCHIVE_EXTRA_RECORD_SIGNATURE=134630224,CRC_32_MAGIC=2869187666,splitFileName=e=>{var r=e.match(/\.([a-z]+)$/);return{name:e.substring(0,r.index),ext:r[1]}},zipToFiles=e=>{var r=new Uint8Array(e);let o=0;const t=[];for(;o<r.length;){var a=new ArrayBuffer(4);const d=new Uint8Array(a);for(let e=0;e<4;e++)d[e]=r[o+e];var n=new Uint32Array(a)[0];if(n!==LOCAL_FILE_SIGNATURE){if(n===END_CENTRAL_DIR_SIGNATURE){console.log("got end central dir signature");break}console.log(`got signature ${n}`);break}var s=new Uint16Array(e,8,1)[0];if(0!==s)return console.log(s),void notifyText("Micro Roam can't handle .zip files that are actually compressed. use a .json file or an uncompressed .zip file, like ones exported by Roam Research or Micro Roam",10);{var l=new ArrayBuffer(12);const u=new Uint8Array(l);for(let e=0;e<12;e++)u[e]=r[e+18+o];var i=new Uint32Array(l),c=(i[0],i[1]),a=i[2];if(1441805<=a)break;const m=new TextDecoder;var n=m.decode(new Uint8Array(e,o+30,a)),{name:s,ext:l}=splitFileName(n),i=m.decode(new Uint8Array(e,o+30+a,c));t.push({name:s,ext:l,text:i,fullName:n}),o+=30+a+c}}return t};let crcTable=null;const makeCRCTable=()=>{let r;crcTable=[];for(let e=0;e<256;e++){r=e;for(let e=0;e<8;e++)r=1&r?3736805603^r>>>1:r>>>1;crcTable[e]=r}};function crc32(r,o,t){null===crcTable&&makeCRCTable();let a=-1;for(let e=o;e<t;e++)a=a>>>8^crcTable[255&(a^r[e])];return(-1^a)>>>0}const dateUnixToMsDosFormat=e=>{const r=new Date(e);let o=r.getDate()+(r.getMonth()+1<<5)+(r.getFullYear()-1980<<9);return console.log(o),console.log(o.toString(2)),o},writeU16ToU8Array=(e,r,o)=>{e[r]=o<<24>>>24,e[r+1]=o<<16>>>24},writeIntToU8Array=(e,r,o)=>{e[r]=o<<24>>>24,e[r+1]=o<<16>>>24,e[r+2]=o<<8>>>24,e[r+3]=o>>>24},ZIP_VERSION=10,blankLocalHeader=new Uint8Array(30);writeIntToU8Array(blankLocalHeader,0,LOCAL_FILE_SIGNATURE),writeIntToU8Array(blankLocalHeader,14,CRC_32_MAGIC),writeU16ToU8Array(blankLocalHeader,4,ZIP_VERSION);const blankCentralHeader=new Uint8Array(46);writeIntToU8Array(blankCentralHeader,0,CENTRAL_FILE_SIGNATURE),writeU16ToU8Array(blankCentralHeader,4,16),writeU16ToU8Array(blankCentralHeader,6,ZIP_VERSION);const copyBuffer=(r,o,t,a,n)=>{for(let e=0;e<n;e++)t[a+e]=r[o+e]},filesToZip=e=>{var r,o=Date.now(),t=dateUnixToMsDosFormat(o),a=performance.now();let n="",s=0;for(r of e)n+=r.fullName+r.text,s+=30+r.fullName.length+r.text.length;o=textEncoder.encode(n).length+LOCAL_FILE_HEADER_LENGTH*e.length+END_CENTRAL_DIR_HEADER_LENGTH;console.log(n.length-s),console.log(`mstime ${performance.now()-a}`);var l,o=new ArrayBuffer(o);let i=new Uint8Array(o),c=0;for(l of e){var d=c;copyBuffer(blankLocalHeader,0,i,c,blankLocalHeader.length),writeU16ToU8Array(i,d+10,t),writeU16ToU8Array(i,d+12,t),c+=blankLocalHeader.length;var u=i.subarray(c),{read:m}=textEncoder.encodeInto(l.fullName,u);c+=m;var g=i.subarray(c),{read:u}=textEncoder.encodeInto(l.text,g),g=crc32(i,c,c+u);writeIntToU8Array(i,d+14,g),c+=u,writeIntToU8Array(i,d+18,u),writeIntToU8Array(i,d+22,u),writeU16ToU8Array(i,d+26,m)}o=new Blob([o]);return console.log(`filestozip ${performance.now()-a}`),o},testRoundTrip=()=>{var e=storeToRoamJSON(store);store=roamJsonToStore(store.graphName,e);var r=storeToRoamJSON(store);e===r?console.log("Round trip test passed!"):(console.log(e),console.log(r),console.error("round trip failed"))},createPageTest=()=>{var e=store;store=blankStore(),macros.createPage("Test Page"),store=e};let testSTime;const renderMulti=(e,r=void 0,o=100,t=!1)=>{t||(testSTime=performance.now()),0<o?e(r)||setTimeout(()=>renderMulti(e,r,o-1,!0),0):console.log(`test func took ${performance.now()-testSTime}`)},benchmarkPageLoad=()=>renderMulti(()=>goto("pageTitle","Welcome to Micro Roam"));let benchmarkRandomWalkSTime=null;const benchmarkRandomWalk=()=>renderMulti(()=>{let e=[];var r,o,t,a=document.querySelectorAll(".page-ref"),n=document.querySelectorAll(".tag"),s=document.querySelectorAll(".breadcrumb-page");for(r of a)e.push(r.children[1].innerText);for(o of n)e.push(o.innerText.substring(1));for(t of s)e.push(t.innerText);e=e.filter(e=>store.titles[e]&&store.blox[store.titles[e]]);s=e[Math.floor(Math.random()*(e.length-1))];goto("pageTitle",s)}),benchmarkRenderAll=async()=>{var e,r=performance.now();let o=0,t=0;for(e in store.titles){var a=performance.now();gotoNoHistory("pageTitle",e),o+=performance.now()-a,t+=1,await new Promise(e=>setTimeout(e,0))}r=performance.now()-r,r=`rendered ${t} pages in ${Math.round(r)}ms, avg ${Math.round(r/t)}ms
function time avg ${Math.round(o/t)}`;console.log(r),notifyText(r,10)},testAll=()=>{testRoundTrip(),benchmarkPageLoad(),benchmarkRandomWalk(),benchmarkRenderAll()},benchmarkGen=()=>{var e=performance.now();for(let e=0;e<100;e++)generateInnerRefs();console.log(`gen took ${performance.now()-e}`)},log=()=>{user.s.logging=!0,saveUser()},nolog=()=>{user.s.logging=!1,saveUser()},flash=benchmarkRenderAll,blank=(e="default")=>{store=blankStore(),store.graphName=e,user={s:{graphName:"default",theme:window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",topBar:"visible",logging:!1,spellcheck:!1}},user.s.graphName=e,saveUser(),debouncedSaveStore(),goto("dailyNotes")},pr=()=>{console.log(JSON.stringify(store))},downloadBinary=()=>{var e=storeToBinary(),e=new Blob([e],{type:"application/x-micro-roam"}),e=URL.createObjectURL(e);const r=document.createElement("a");r.setAttribute("href",e),r.setAttribute("download",`${store.graphName}.mrm`),r.click()},monitor=string=>{const js=`setInterval(()=>console.log(${string}), 500)`;eval(js)},terminalCommands={blank:blank,reset:reset,flash:flash,log:log,page:page,nolog:nolog,pr:pr,downloadBinary:downloadBinary,monitor:monitor}</script>