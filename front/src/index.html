<script>
  let idb = null
  let store = null
  let r

  const basicBitchServerUrl = "http://localhost:3000"

  let user
  let userText = localStorage.getItem("user")
  let usingLocalStore = true

  let startFn = () => gotoNoHistory("dailyNotes")

  let dataLoaded = false
  let scriptsLoaded = false
  const setDataLoaded = () => {
    if (scriptsLoaded)
      start()
    dataLoaded = true
  }

  const start = () => {
    saveUser()
    startFn()
    if (user.h && user.s.commitId !== user.s.syncCommitId)
      debouncedSaveStore()
  }

  const invalidateLocal = () => {
    const r = indexedDB.deleteDatabase("microroam")
    console.error(`Local replica invalid. Resetting from server`)
    user.s.commitId = undefined
    user.s.syncCommitId = undefined
    localStorage.setItem("user",JSON.stringify(user))
    localStorage.removeItem('store')
    window.location.href = window.location.href
  }

  if (userText) {
    user = JSON.parse(userText)
    if (user.h) {
      const headers = new Headers()
      headers.set('h',user.h)
      if (user.s.commitId) headers.set('commitid',user.s.commitId)
      let reqUrl = `${basicBitchServerUrl}/startup/${user.s.graphName}`
      fetch(reqUrl,{ method: 'POST',headers: headers }).then(async (res) => {
        if (res.status === 304) {
          console.log(`already up to date`)
          return
        }
        if (res.status !== 200) {
          console.log(`STORE NOT ON SERVER`)
          return
        }
        usingLocalStore = false
        res.json().then(blox => {
          console.log('got blox')
          hydrateFromBlox(user.s.graphName,blox)
          setTimeout(generateInnerOuterRefs,160)
          setDataLoaded() // todo catch code loading after this
          debouncedSaveStore()
        })
      })
    }

    const lsStore = localStorage.getItem('store')
    if (lsStore) {
      try {
        store = JSON.parse(lsStore)
        setDataLoaded()
      } catch (e) {
        invalidateLocal()
      }
      r = indexedDB.open("microroam",5)
      r.onsuccess = (e1) => idb = e1.target.result
    } else {
      r = indexedDB.open("microroam",5)
      r.onsuccess = (e1) => {
        console.log("normal success")
        idb = e1.target.result
        if (usingLocalStore === true) {
          try {
            idb.transaction(["stores"],"readonly").objectStore("stores").get(user.graphName).onsuccess = (e) => {
              if (usingLocalStore === true) {
                if (e.target.result) {
                  try {
                    store = JSON.parse(e.target.result.store)
                    setDataLoaded()
                  } catch (e) {
                    invalidateLocal()
                  }
                } else {
                  console.log("adding default graph")

                }
              }
            }
          } catch (e) {

          }
        }
      }
    }
  } else {
    user = { s: { graphName: "default",theme: window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? "dark" : "light",topBar: "visible",logging: false,spellcheck: false } }
    fetch("./default-store.json").then(text => {
      text.json().then(json => {
        store = json
        startFn = () => gotoNoHistory("pageTitle","Welcome to Micro Roam")
        setDataLoaded()
      })
    })
    r = indexedDB.open("microroam",5)
    r.onsuccess = (e1) => idb = e1.target.result
  }

  r.onupgradeneeded = (event) => {
    console.log("upgradeneeded")
    const db = r.result
    const stores = Array.from(db.objectStoreNames)
    if (!stores.includes("stores")) {
      db.createObjectStore("stores",{ keyPath: "graphName" })
    } else {
      console.log(event)
      console.log(db)

      r.onsuccess = () => {
        console.log("new success")
        idb = event.target.result
        const storeStore = db.transaction(["stores"],"readonly").objectStore("stores")
        storeStore.get(user.s.graphName).onsuccess = (e) => {
          store = e.target.result.store
          const roamJSON = oldStoreToRoamJSON[db.version](store)
          roamJsonToStore(user.s.graphName,roamJSON)
          saveStore()
          setDataLoaded()
        }
      }
    }
  }
  r.onerror = (e) => {
    console.log("error")
    console.log(e)
    alert(`In order to save your notes between sessions, Micro Roam needs access to IndexedDB. 
      You can allow access by exiting "private browsing" mode, or by using a newer browser, or by changing browser settings`)
  }
</script>

<body class="dark">
  <div id="app">
    <div id="top-bar" style="margin-top:-43px">
      <a id="report-issue-button" target="_blank" href="mailto:taoroalin@gmail.com?subject=You Made Micro Roam Wrong"
        tabindex="-1">
        Report Issue
      </a>
      <button id="help-button" tabindex="-1">
        Help
      </button>
      <button id="daily-notes-button" tabindex="-1">
        Daily Notes
      </button>
      <input id="search-input" placeholder="search" tabindex="-1">
      <button id="upload-button" tabindex="-1">
        <input style="display:none" type="file" id="upload-input">
        Upload
      </button>
      <a id="download-button" tabindex="-1">
        Download
      </a>
      <button id="signup-button" tabindex="-1">
        Sign up
      </button>
      <button id="signout-button" tabindex="-1" style="display:none">
        Sign Out
      </button>
    </div>

    <div id="top-bar-hidden-hitbox" style="position:fixed;height:20px;width:100%;display:none;"></div>

    <script>

      document.body.className = user.s.theme

      const topBar = document.getElementById("top-bar")
      const topBarHiddenHitbox = document.getElementById("top-bar-hidden-hitbox")

      if (user.s.topBar === 'visible') {
        topBar.style.marginTop = "0px"
        topBarHiddenHitbox.style.display = "none"
      }
      setTimeout(() => topBar.className = "top-bar-transition",200)
    </script>

    <div id="terminal" contenteditable="true" style="display:none"></div>

    <div id="page-frame-outer">
      <div id="page-frame">

      </div>
    </div>

    <!-- inline styles on this site are all edited directly by js -->
    <div id="autocomplete-list" style="display:none"></div>
    <div id="command-list" style="display:none"></div>
    <div id="search-result-list" style="display:none"></div>
    <div id="template-list" style="display:none"></div>

    <div id="login" style="display:none">
      <p>Login</p>
      <form id="login-form">
        <input type="email" id="login-email" placeholder="email">
        <input type="password" id="login-password" placeholder="password">
        <input type="submit" style="height:0px" tabindex="-1">
      </form>
      <button id="switch-to-signup">Sign up</button>
      <button class="exit-to-main">Back</button>
    </div>

    <div id="signup" style="display:none">
      <p>Sign up</p>
      <form id="signup-form">
        <input type="email" id="signup-email" placeholder="email">
        <input type="text" id="signup-username" placeholder="username">
        <input type="password" id="signup-password" placeholder="password">
        <input type="submit" style="height:0px" tabindex="-1">
      </form>
      <button id="switch-to-login">Login</button>
      <button class="exit-to-main">Back</button>
    </div>

    <div id="really-want-to-leave" class="really-want-to" style="display:none">
      Your data will be lost if you sign out now
      <button>Continue</button>
    </div>
  </div>

  <title>Micro Roam</title>

  <link rel="stylesheet" href="css.css">

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata">

  <template id="page">
    <div class="page">
      <h1 class="page__title" draggable="false" contenteditable="true" tabindex="-1" spellcheck="false"></h1>

      <div class="page__body">

      </div>
      <div class="page__backlinks">

      </div>
    </div>
  </template>

  <template id="block">
    <div class="block">
      <svg class="block__bullet" width="20" height="20">
        <circle cx="10" cy="10.5" r="3" fill="var(--bullet)" />
      </svg>
      <div class="block__body" draggable="false" contenteditable="true" tabindex="-1" spellcheck="false"></div>
      <div class="block__children">

      </div>
    </div>
  </template>

  <template id="backref-list">
    <div class="backref-list">
      <div class="backref-list__title">Linked References</div>
      <div class="backref-list__body"></div>
    </div>
  </template>

  <template id="page-break">
    <div class="page-break"></div>
  </template>

  <template id="block-focus-frame">
    <div class="block-focus-frame">
      <div class="block-focus-frame__breadcrumb"></div>
      <div class="block-focus-frame__body"></div>
      <div class="block-focus-frame__backlinks"></div>
    </div>
  </template>

  <template id="backref-frame">
    <div class="backref-frame">
      <div class="backref-frame__breadcrumb"></div>
      <div class="backref-frame__body"></div>
    </div>
  </template>

  <template id="page-ref">
    <span class="page-ref"><span class="page-ref__brackets"></span><span class="page-ref__body"></span><span
        class="page-ref__brackets"></span></span>
  </template>

  <template id="autocomplete__suggestion">
    <div class="autocomplete__suggestion"></div>
  </template>


  <template id="command__suggestion">
    <div class="command__suggestion"></div>
  </template>

  <template id="template__suggestion">
    <div class="template__suggestion"></div>
  </template>

  <template id="search-result">
    <div class="search-result"></div>
  </template>

  <template id="breadcrumb-block">
    <span class="breadcrumb-block"><span class="breadcrumb-block__arrow">-></span><span
        class="breadcrumb-block__body"></span></span>
  </template>

  <template id="breadcrumb-page">
    <span class="breadcrumb-page"></span>
  </template>

  <template id="notification">
    <div class="notification"></div>
  </template>

  <script src="declarations.js"></script>
  <script src="front-back-shared.js"></script>
  <script src="utils.js"></script>
  <script src="commands.js"></script>
  <script src="store.js"></script>
  <script src="cursor.js"></script>

  <script src="render.js"></script>

  <script src="client.js"></script>

  <script src="events.js"></script>
  <script src="nav.js"></script>

  <!-- now rendering is done, loading interactive scripts-->

  <script src="convert.js" async></script>
  <script src="test.js" async></script>
</body>